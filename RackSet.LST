CX51 COMPILER V7.50   RACKSET                                                              10/23/2014 09:48:26 PAGE 1   


CX51 COMPILER V7.50, COMPILATION OF MODULE RACKSET
OBJECT MODULE PLACED IN RackSet.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\CX51.EXE RackSet.c LARGE OBJECTADVANCED ROM(HUGE) OPTIMIZE(SIZE) BROWSE DEBUG

line level    source

   1          #define RACK_SET_C
   2          #include "device.h"
   3          #include "global.h"
   4          #include "scheduler.h"
   5          #include "CommonFunction.h"
   6          #include "STRING.h"
   7          #include "RackSet.h"
   8          #include "key.h"
   9          #include "common.h"
  10          #include "mainflow.h"
  11          #include "CommonFunction.h"
  12          //#include "AllMenuStr.h"
  13          //#include "language.h"
  14          #include "debug.h"
  15          
  16          #undef _DEBUG_TRACE
  17          /***********************************/
  18          #ifdef _CHINA_
  19                  const struct StrAndLen code RackParastr[] =
  20                  {       
  21                          { "1.层架编号:", 11 },
  22                          { "2.是否启用:", 11 },
  23                          { "3.最大存货量:", 13 },
  24                          { "4.第一货道:", 11 },
  25                          { "5.第二货道:", 11 },
  26                          { "6.第\xc8\xfd货道:", 11 },
  27                          { "7.第四货道:", 11 },
  28                          { "8.第五货道:", 11 },
  29                          { "9.第六货道:", 11 },
  30                          { "10. 第七货道:", 13 },
  31                          { "11. 第八货道:", 13 },                                                                
  32                  };
  33          #else
                      const struct StrAndLen code RackParastr[] =
                      {       
                              { "1.Tray code:", 12 },
                              { "2.Enabled:", 10 },
                              { "3.Goods Max.:", 13 },
                              { "4.Column 1:", 11 },
                              { "5.Column 2:", 11 },
                              { "6.Column 3:", 11 },
                              { "7.Column 4:", 11 },
                              { "8.Column 5:", 11 },
                              { "9.Column 6:", 11 },
                              { "10.Column 7:", 12 },
                              { "11.Column 8:", 12 },                                                         
                      };
              #endif
  49          
  50          
  51          #ifdef _CHINA_
  52                  const struct StrAndLen code CSTR_Rack[] = 
  53                  {       
  54                          { "请输入密码:", 11 },
  55                          { "密码错误!", 9 }
CX51 COMPILER V7.50   RACKSET                                                              10/23/2014 09:48:26 PAGE 2   

  56                  };
  57          #else
                      const struct StrAndLen code CSTR_Rack[] = 
                      {       
                              { "Input password:", 15 },
                              { "Password error!", 15 }
                      };
              #endif
  64          
  65          
  66          const code RackInputLen[] = { 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1 };
  67          u_char xdata RackNo = 1;
  68          u_char xdata IsModify = 0;
  69          /***********************************/
  70          //读\写内存中的层架设置参数,Num,选中的菜单项编号,len字符串长度,OutInFlag为0时是读,为1时是写
  71          void ReadWriteRactParam( u_char Num,u_char xdata *OutStr,u_char xdata *InStr ,u_char xdata *len, bit OutIn
             -Flag )
  72          {       
  73   1              u_char  xdata Templen = 0;      
  74   1              u_char  xdata  i = 0;
  75   1              uint    xdata temp = 0; 
  76   1      
  77   1              switch( Num )
  78   1              {
  79   2                      case 0: //层架编号      
  80   2                              if( OutInFlag == 0 )
  81   2                              {                               
  82   3                                      sprintf( OutStr, "%bu", iRackSet[RackNo - 1].RackNo );//GoodsWayNoList[m_SetArrayNo].GoodsWayNo)                                
  83   3                                      *len = 2;
  84   3                              }                       
  85   2                      break;
  86   2                      case 1://启用标志
  87   2                              ////////////////////
  88   2                              if( OutInFlag == 0 )
  89   2                              {
  90   3                                      *len = sprintf( OutStr, "%bu", iRackSet[RackNo - 1].UseState );                         
  91   3                              }
  92   2                              else
  93   2                              {
  94   3                                      Templen = *len;
  95   3                                      if( Templen == 0 )
  96   3                                              break;
  97   3                                      if( Templen > 1 )
  98   3                                              Templen = 1;
  99   3                                      iRackSet[RackNo - 1].UseState = 0;
 100   3                                      for( i = 0; i < Templen; i ++ )
 101   3                                      {                                       
 102   4                                              if( ( *( InStr + i ) >= 0 ) && ( *( InStr + i ) <= 9 ) )
 103   4                                                      iRackSet[RackNo - 1].UseState = *( InStr + i );                                 
 104   4                                      }                                       
 105   3                              }                       
 106   2                      break;
 107   2                      case 2://最大货品存量                           
 108   2                              if(  OutInFlag == 0 )                                                   
 109   2                                      *len = sprintf( OutStr, "%bu", iRackSet[RackNo - 1].GoodsMax );                                         
 110   2                              else//存入
 111   2                              {
 112   3                                      Templen = *len;
 113   3                                      if( Templen == 0 )
 114   3                                              break;
 115   3                                      if( Templen > 2 )
 116   3                                              Templen = 2;    
CX51 COMPILER V7.50   RACKSET                                                              10/23/2014 09:48:26 PAGE 3   

 117   3                                      iRackSet[RackNo - 1].GoodsMax = 0;      
 118   3                                      for( i = 0; i < Templen; i ++ )
 119   3                                      {                                       
 120   4                                              if( ( *( InStr + i ) >= 0 ) && ( *( InStr + i ) <= 9 ) )
 121   4                                                      iRackSet[RackNo - 1].GoodsMax = iRackSet[RackNo - 1].GoodsMax*10 + *( InStr + i );                                      
 122   4                                      }                               
 123   3                              }                                               
 124   2                      break;  
 125   2                      case 3:// 货道1开启状态
 126   2                              if(  OutInFlag == 0 )                                                   
 127   2                                      *len = sprintf( OutStr, "%bu", iRackColumnSet[RackNo - 1][0].UseState );                        
 128   2                              else//存入
 129   2                              {
 130   3                                      Templen = *len;
 131   3                                      if( Templen == 0 )
 132   3                                              break;
 133   3                                      if( Templen > 1 )
 134   3                                              Templen = 1;    
 135   3                                      iRackColumnSet[RackNo - 1][0].UseState = 0;     
 136   3                                      for( i = 0; i < Templen; i ++ )
 137   3                                      {                                       
 138   4                                              if( ( *( InStr + i ) >= 0 ) && ( *( InStr + i ) <= 9 ) )
 139   4                                                      iRackColumnSet[RackNo - 1][0].UseState = *( InStr + i );                                        
 140   4                                      }                       
 141   3                              }                       
 142   2                      break;  
 143   2                      case 4:// 货道2开启状态
 144   2                              if(  OutInFlag == 0 )                                                   
 145   2                                      *len = sprintf( OutStr, "%bu", iRackColumnSet[RackNo - 1][1].UseState );                        
 146   2                              else//存入
 147   2                              {
 148   3                                      Templen = *len;
 149   3                                      if( Templen == 0 )
 150   3                                              break;
 151   3                                      if( Templen > 1 )
 152   3                                              Templen = 1;    
 153   3                                      iRackColumnSet[RackNo - 1][1].UseState = 0;     
 154   3                                      for( i = 0; i < Templen; i ++ )
 155   3                                      {                                       
 156   4                                              if( ( *( InStr + i ) >= 0 ) && ( *( InStr + i ) <= 9 ) )
 157   4                                                      iRackColumnSet[RackNo - 1][1].UseState = *( InStr + i );                                        
 158   4                                      }                       
 159   3                              }                       
 160   2                      break;  
 161   2                      case 5:// 货道3开启状态
 162   2                              if(  OutInFlag == 0 )                                                   
 163   2                                      *len = sprintf( OutStr, "%bu", iRackColumnSet[RackNo - 1][2].UseState );                        
 164   2                              else//存入
 165   2                              {
 166   3                                      Templen = *len;
 167   3                                      if( Templen == 0 )
 168   3                                              break;
 169   3                                      if( Templen > 1 )
 170   3                                              Templen = 1;    
 171   3                                      iRackColumnSet[RackNo - 1][2].UseState = 0;     
 172   3                                      for( i = 0; i < Templen; i ++ )
 173   3                                      {                                       
 174   4                                              if( ( *( InStr + i ) >= 0 ) && ( *( InStr + i ) <= 9 ) )
 175   4                                                      iRackColumnSet[RackNo - 1][2].UseState = *( InStr + i );                                        
 176   4                                      }                       
 177   3                              }                       
 178   2                      break;
CX51 COMPILER V7.50   RACKSET                                                              10/23/2014 09:48:26 PAGE 4   

 179   2                      case 6:// 货道4开启状态
 180   2                              if(  OutInFlag == 0 )                                                   
 181   2                                      *len = sprintf( OutStr, "%bu", iRackColumnSet[RackNo - 1][3].UseState );                        
 182   2                              else//存入
 183   2                              {
 184   3                                      Templen = *len;
 185   3                                      if( Templen == 0 )
 186   3                                              break;
 187   3                                      if( Templen > 1 )
 188   3                                              Templen = 1;    
 189   3                                      iRackColumnSet[RackNo - 1][3].UseState = 0;     
 190   3                                      for( i = 0; i < Templen; i ++ )
 191   3                                      {                                       
 192   4                                              if( ( *( InStr + i ) >= 0 ) && ( *( InStr + i ) <= 9 ) )
 193   4                                                      iRackColumnSet[RackNo - 1][3].UseState = *( InStr + i );                                        
 194   4                                      }                       
 195   3                              }                       
 196   2                      break;
 197   2                      case 7:// 货道5开启状态
 198   2                              if(  OutInFlag == 0 )                                                   
 199   2                                      *len = sprintf( OutStr, "%bu", iRackColumnSet[RackNo - 1][4].UseState );                        
 200   2                              else//存入
 201   2                              {
 202   3                                      Templen = *len;
 203   3                                      if( Templen == 0 )
 204   3                                              break;
 205   3                                      if( Templen > 1 )
 206   3                                              Templen = 1;    
 207   3                                      iRackColumnSet[RackNo - 1][4].UseState = 0;     
 208   3                                      for( i = 0; i < Templen; i ++ )
 209   3                                      {                                       
 210   4                                              if( ( *( InStr + i ) >= 0 ) && ( *( InStr + i ) <= 9 ) )
 211   4                                                      iRackColumnSet[RackNo - 1][4].UseState = *( InStr + i );                                        
 212   4                                      }                       
 213   3                              }                       
 214   2                      break;
 215   2                      case 8:// 货道6开启状态
 216   2                              if(  OutInFlag == 0 )                                                   
 217   2                                      *len = sprintf( OutStr, "%bu", iRackColumnSet[RackNo - 1][5].UseState );                        
 218   2                              else//存入
 219   2                              {
 220   3                                      Templen = *len;
 221   3                                      if( Templen == 0 )
 222   3                                              break;
 223   3                                      if( Templen > 1 )
 224   3                                              Templen = 1;    
 225   3                                      iRackColumnSet[RackNo - 1][5].UseState = 0;     
 226   3                                      for( i = 0; i < Templen; i ++ )
 227   3                                      {                                       
 228   4                                              if( ( *( InStr + i ) >= 0 ) && ( *( InStr + i ) <= 9 ) )
 229   4                                                      iRackColumnSet[RackNo - 1][5].UseState = *( InStr + i );                                        
 230   4                                      }                       
 231   3                              }                       
 232   2                      break;
 233   2                      case 9:// 货道7开启状态
 234   2                              if(  OutInFlag == 0 )                                                   
 235   2                                      *len = sprintf( OutStr, "%bu", iRackColumnSet[RackNo - 1][6].UseState );                        
 236   2                              else//存入
 237   2                              {
 238   3                                      Templen = *len;
 239   3                                      if( Templen == 0 )
 240   3                                              break;
CX51 COMPILER V7.50   RACKSET                                                              10/23/2014 09:48:26 PAGE 5   

 241   3                                      if( Templen > 1 )
 242   3                                              Templen = 1;    
 243   3                                      iRackColumnSet[RackNo - 1][6].UseState = 0;     
 244   3                                      for( i = 0; i < Templen; i ++ )
 245   3                                      {                                       
 246   4                                              if( ( *( InStr + i ) >= 0 ) && ( *( InStr + i ) <= 9 ) )
 247   4                                                      iRackColumnSet[RackNo - 1][6].UseState = *( InStr + i );                                        
 248   4                                      }                       
 249   3                              }                       
 250   2                      break;
 251   2                      case 10:// 货道8开启状态
 252   2                              if(  OutInFlag == 0 )                                                   
 253   2                                      *len = sprintf( OutStr, "%bu", iRackColumnSet[RackNo - 1][7].UseState );                        
 254   2                              else//存入
 255   2                              {
 256   3                                      Templen = *len;
 257   3                                      if( Templen == 0 )
 258   3                                              break;
 259   3                                      if( Templen > 1 )
 260   3                                              Templen = 1;    
 261   3                                      iRackColumnSet[RackNo - 1][7].UseState = 0;     
 262   3                                      for( i = 0; i < Templen; i ++ )
 263   3                                      {                                       
 264   4                                              if( ( *( InStr + i ) >= 0 ) && ( *( InStr + i ) <= 9 ) )
 265   4                                                      iRackColumnSet[RackNo - 1][7].UseState = *( InStr + i );                                        
 266   4                                      }                       
 267   3                              }                       
 268   2                      break;
 269   2              }
 270   1      }
 271          
 272          /***********************************/
 273          /*y为行号,Num为菜单项序号,flag为是否显示值*/
 274          void  DisplayRackMenuAndVal( u_char line, u_char Num, bit flag )
 275          {
 276   1              u_char  xdata y_displaystr[22]; 
 277   1              u_char   xdata  len ;
 278   1      
 279   1          if( flag == 0 ) flag = 0;
 280   1      
 281   1              len = 0;        
 282   1              memset( y_displaystr,0,sizeof( y_displaystr ) );        
 283   1              memcpy( y_displaystr, RackParastr[Num].str, RackParastr[Num].len );                                     
 284   1              ReadWriteRactParam( Num, y_displaystr + RackParastr[Num].len  , 0, &len, 0 );//得到菜单对应的值                 
 285   1              DisplayStr( 0, line, 1, y_displaystr, RackParastr[Num].len + len  );//显示菜单                  
 286   1      }       
 287          
 288          /***********************************/
 289          /*编辑选中项,Num为选中的菜单编号,line为编辑行号*/
 290          bit  EditRackParam( u_char Num, u_char line )
 291          {
 292   1              u_char  xdata Inputstr[10];
 293   1              u_char  xdata  key;
 294   1              u_char  xdata  Inputlen;
 295   1              
 296   1              key = 0;        
 297   1              Inputlen = RackInputLen[Num];
 298   1              memset( Inputstr, 0, sizeof( Inputstr ) );      
 299   1              key = GetLine( RackParastr[Num].str, RackParastr[Num].len, line, Inputstr, &Inputlen );                 
 300   1              ClearKey();             
 301   1              if( key == 1 )//Enter   
 302   1              {               
CX51 COMPILER V7.50   RACKSET                                                              10/23/2014 09:48:26 PAGE 6   

 303   2                      DisplayCursorState( 0, 0, 0, 0, 1 );            
 304   2                      //Trace( "selected Enter \n" );                 
 305   2                      ReadWriteRactParam( Num, 0, Inputstr ,&Inputlen, 1 );   
 306   2                      IsModify = 1;   
 307   2                      ClearKey();             
 308   2              }               
 309   1              //Trace( "edit one SysParanMenu end\n" );
 310   1              return 0;
 311   1      }
 312          
 313          /************************************/
 314          /*光标在菜单中移动或选择,SelectedNum当前光标所在的菜单编号,
 315                  CursorLine，当前光标所覆盖的行,值为1或2,MoveRange,菜单翻动的范围
 316          */
 317          void  Rack_MenuSelected( u_char xdata *SelectedNum, u_char xdata *CursorLine, u_char MoveRange )
 318          {
 319   1              u_char xdata  MenuNum = *SelectedNum;
 320   1              u_char xdata  Cursor = *CursorLine;
 321   1              bit        data  flag = 1;
 322   1              u_char xdata  key = 0xff;
 323   1              u_char  xdata  len = 0; 
 324   1      
 325   1              while( flag )
 326   1              {
 327   2                      key = GetKey();
 328   2                      switch( key )           
 329   2                      {
 330   3                              case KEY_CANCEL:
 331   3                                      flag = 0;
 332   3                                      *SelectedNum = 100;                             
 333   3                                      break;
 334   3                              case KEY_UP://上移                              
 335   3                                      if( Cursor == 2 )//选中标记上移
 336   3                                      {                       
 337   4                                              DisplayCursorState( 0, 0, 1, 2, 1 );//第一行整光标                                      
 338   4                                              Cursor = 1;
 339   4                                              if( MenuNum == 0 )
 340   4                                                      MenuNum = MoveRange;                                    
 341   4                                              else                                                                        
 342   4                                                      MenuNum--;                                      
 343   4                                      }
 344   3                                      else//菜单上翻
 345   3                                      {                                               
 346   4                                              DisplayRackMenuAndVal( 1, MenuNum, 1 );                                 
 347   4                                              if( MenuNum == 0 )
 348   4                                                      MenuNum = MoveRange;                                    
 349   4                                              else                                                                        
 350   4                                                      MenuNum--;                                      
 351   4                                              DisplayRackMenuAndVal( 0, MenuNum , 1 );                                                                                                                                                                        
 352   4                                              Cursor = 1;                                             
 353   4                                      }
 354   3                                      break;
 355   3                              case KEY_DOWN://下移                                            
 356   3                                      if( Cursor == 1 )//选中标记下移
 357   3                                      {
 358   4                                              DisplayCursorState( 0, 1, 1, 2, 1 );//第二行整光标
 359   4                                              if( MenuNum == MoveRange )
 360   4                                                      MenuNum = 0;                                    
 361   4                                              else                                                                                                                    
 362   4                                                      MenuNum++;                                   
 363   4                                              Cursor = 2;                                             
 364   4                                      }
CX51 COMPILER V7.50   RACKSET                                                              10/23/2014 09:48:26 PAGE 7   

 365   3                                      else//菜单下翻
 366   3                                      {                                       
 367   4                                              DisplayRackMenuAndVal( 0, MenuNum, 1 );                                         
 368   4                                              if( MenuNum == MoveRange )
 369   4                                                      MenuNum = 0;                                    
 370   4                                              else                                                                        
 371   4                                                      MenuNum++;                                      
 372   4                                              DisplayRackMenuAndVal( 1, MenuNum , 1 );                                                                                                                                                                        
 373   4                                              Cursor = 2;
 374   4                                      }
 375   3                                      break;
 376   3                              case KEY_SUBMIT://Enter,选中了某项菜单
 377   3                                      {                       
 378   4                                              *SelectedNum = MenuNum;
 379   4                                              *CursorLine = Cursor;                                   
 380   4                                              flag = 0;       
 381   4                                      }
 382   3                                      break;                  
 383   3                      }
 384   2                      CoreProcessCycle();//让出时间片
 385   2                      DelayMs( 5 );
 386   2              }
 387   1              ClearKey();             
 388   1      }
 389          
 390          /***********************************/
 391          ////////////////
 392          bit RackParamManage()           
 393          {
 394   1              u_char  xdata fristNum ;//一级菜单编号
 395   1              u_char  xdata LineNum ;//选中屏幕的行号 
 396   1              u_char  xdata key = 0;
 397   1              u_char xdata  i = 0;
 398   1              u_char xdata Tempstr[8];
 399   1              u_char xdata len = 0;   
 400   1              struct PassWordLog xdata TempPassWd;
 401   1              u_char  xdata password[9];
 402   1          u_char xdata ErrFlag = 0;
 403   1      
 404   1              ClearKey();             
 405   1              //输入货道编号
 406   1              RackNo = 0;
 407   1              IsModify = 0;
 408   1      
 409   1          //------------------------------------------------------------------------------------
 410   1              //Check the password firstly
 411   1              memset( &TempPassWd, 0, sizeof(struct PassWordLog) );
 412   1              {
 413   2              TempPassWd.passwdlen = 8;
 414   2                      TempPassWd.checkbyte = 0;
 415   2                      TempPassWd.PassWordByte[0] = 8;
 416   2              TempPassWd.PassWordByte[1] = 3;
 417   2                      TempPassWd.PassWordByte[2] = 7;
 418   2                      TempPassWd.PassWordByte[3] = 1;
 419   2              TempPassWd.PassWordByte[4] = 8;
 420   2              TempPassWd.PassWordByte[5] = 5;
 421   2                      TempPassWd.PassWordByte[6] = 5;
 422   2                      TempPassWd.PassWordByte[7] = 7;
 423   2                      for( i=0; i<8; i++ )
 424   2                      {
 425   3                              TempPassWd.checkbyte += TempPassWd.PassWordByte[i];
 426   3                  }
CX51 COMPILER V7.50   RACKSET                                                              10/23/2014 09:48:26 PAGE 8   

 427   2          }
 428   1              DisplayStr( 0, 0, 1, "   ", 3 );
 429   1              DisplayStr( 0, 1, 1, " ", 1 );
 430   1              while( 1 )
 431   1              {               
 432   2                      WaitForWork( 100, NULL );
 433   2                      memset(password , 0 , sizeof(password));
 434   2                      key = 8;
 435   2                      ErrFlag = GetLine_1(CSTR_Rack[ 0 ].str , CSTR_Rack[ 0 ].len, 0, password , &key, 1 );           
 436   2                      ClearKey();     
 437   2                      if(ErrFlag == 0)       //超时或cancel
 438   2                      {
 439   3                              DisplayCursorState( 0, 0, 0, 0, 1 );//无光标                            
 440   3                              return 0;       
 441   3                      }
 442   2                      ErrFlag = 0;    
 443   2                      if( key == TempPassWd.passwdlen )               
 444   2                              ErrFlag = memcmp( TempPassWd.PassWordByte, password, TempPassWd.passwdlen );
 445   2                      else
 446   2                              ErrFlag = 1;
 447   2                      
 448   2                      //密码错误,退出
 449   2                      if( ErrFlag != 0 )      
 450   2                      {                               
 451   3                              DisplayCursorState( 0, 0, 0, 0, 1 );     //无光标               
 452   3                              DisplayStr( 0, 0, 1, CSTR_Rack[ 1 ].str, CSTR_Rack[ 1 ].len );
 453   3                              DisplayStr( 0, 1, 1, "    ", 4 );                               
 454   3                              WaitForWork( 2000, NULL );                              
 455   3                      }
 456   2                      else
 457   2                              break;
 458   2              }
 459   1              //=====================================================================================
 460   1      
 461   1              while( 1 )
 462   1              {               
 463   2                      ClearKey();     
 464   2                      //输入货道编号
 465   2                      RackNo = 0;
 466   2                      //////////////////////////              
 467   2                      while( 1 )
 468   2                      {               
 469   3                              ClearDisplayLine( 1 );
 470   3                              ClearDisplayLine( 2 );          
 471   3                              len = 1;
 472   3                              memset( Tempstr,0, sizeof( Tempstr ) ); 
 473   3                       #ifdef _CHINA_
 474   3                              key = GetLine( "输入层架编号:", 13 , 0, Tempstr, &len );
 475   3                       #else
                                      key = GetLine( "Input Tray code:", 16 , 0, Tempstr, &len );
                               #endif
 478   3                              WaitForWork( 500, NULL );       
 479   3                              ClearKey();                             
 480   3                              if( key == 1 )//Enter   
 481   3                              {                       
 482   4                                      DisplayCursorState( 0, 0, 0, 0, 1 );                    
 483   4                                      for( i = 0; i < len; i ++ )
 484   4                                      {
 485   5                                              if( ( Tempstr[i] >= 0 ) && ( Tempstr[i] <= 9 ) )
 486   5                                              {
 487   6                                                      RackNo = Tempstr[i];                            
 488   6                                                      break;
CX51 COMPILER V7.50   RACKSET                                                              10/23/2014 09:48:26 PAGE 9   

 489   6                                              }
 490   5                                      }                               
 491   4                                      ClearKey();     
 492   4                                              
 493   4                                      if( ( RackNo <= 0 ) || ( RackNo > RACKNUM ))
 494   4                                  {
 495   5                                              #ifdef _CHINA_
 496   5                                                      DisplayStr( 0, 0, 1, "编号输入错误", 12 );
 497   5                                                      DisplayStr( 0, 1, 1, "请输入其它编号", 14 );
 498   5                                              #else
                                                              DisplayStr( 0, 0, 1, "Input code error", 16 );
                                                              DisplayStr( 0, 1, 1, "Input other code", 16 );                          
                                                      #endif                                                                  
 502   5                                              WaitForWork( 2000, NULL );
 503   5                                              continue;
 504   5                                      }
 505   4                                      else
 506   4                                              break;
 507   4                              }
 508   3                              else
 509   3                              {
 510   4                                      Trace( "\n IsModify = %bu", IsModify );
 511   4                                      if( IsModify == 0 )
 512   4                                              return 0;
 513   4                                      ////层架配置完成，设置号道参数
 514   4                                      LineNum = 0;//总的开启货道数
 515   4                                      RackNo = 0;//开启层数
 516   4                                      //memset( InputGoodsWayList, 0, sizeof( InputGoodsWayList )*GOODSWAYNUM ); //Disabled by Andy 2011.3.2
 517   4                      memset( InputGoodsWayList, 0, sizeof( InputGoodsWayList ) );
 518   4                                      for( i = 0; i < RACKNUM; i++ )//货架层数
 519   4                                      {
 520   5                                              if( iRackSet[ i ].UseState == 1 )//如果此层开启了
 521   5                                              {
 522   6                                                      key = iRackSet[ i ].GoodsMax;//此层中各货道最大存货量
 523   6                                                      fristNum = 1;//辑逻货道编号的个位       
 524   6                                                      for( len = 0; len < RACKCOLUMNNUM; len ++ )//检索每层中开启的货道数
 525   6                                                      {
 526   7                                                              Trace("\n iRackColumnSet[ %bu ][ %bu ].UseState = %bu", i, len, iRackColumnSet[i][len].UseState  );
 527   7                                                              if( iRackColumnSet[i][len].UseState == 1)
 528   7                                                              {
 529   8                                                                      InputGoodsWayList[ LineNum ].GoodsWayNo = ( RackNo + 1 ) * 10 + fristNum;//逻辑货道  
 530   8                                                                      Trace("\n InputGoodsWayList[ %bu ].GoodsWayNo = %bu", LineNum, InputGoodsWayList[ LineNum ].GoodsW
             -ayNo);
 531   8                                                              //      InputGoodsWayList[ LineNum ].SetArrayNo = i*RACKCOLUMNNUM + len + 1 ;//物理货道
 532   8                                                                      InputGoodsWayList[ LineNum ].SetArrayNo = 64 - i*RACKCOLUMNNUM - 8 + len + 1;//物理货道
 533   8                                                                      Trace("\n InputGoodsWayList[ %bu ].SetArrayNo = %bu", LineNum, InputGoodsWayList[ LineNum ].SetArr
             -ayNo);
 534   8                                                                      InputGoodsWayList[ LineNum ].UseState = 1;//开启状态
 535   8                                                                      Trace("\n InputGoodsWayList[ %bu ].UseState = %bu", LineNum, InputGoodsWayList[ LineNum ].UseState
             -);
 536   8                                                                      InputGoodsWayList[ LineNum ].GoodsMax = key;//最大存货量
 537   8                                                                      Trace("\n InputGoodsWayList[ %bu ].GoodsMax = %bu", LineNum, InputGoodsWayList[ LineNum ].GoodsMax
             -);
 538   8                                                                      LineNum += 1;                                                           
 539   8                                                                      fristNum += 1;
 540   8                                                              }                                                       
 541   7                                                      }
 542   6                                                      RackNo += 1;
 543   6                                              }
 544   5                                              else
 545   5                                              {
 546   6                                                      iRackSet[i].GoodsMax = 0;
CX51 COMPILER V7.50   RACKSET                                                              10/23/2014 09:48:26 PAGE 10  

 547   6                                                      memset( iRackColumnSet[i], 0, 16 );
 548   6                                              }
 549   5                                      }
 550   4                                      memset( GoodsWaySetVal, 0, sizeof( struct WaySet ) * GOODSWAYNUM );
 551   4                                      Trace("\n EnableNum = %bu", LineNum);
 552   4                                      for( i = 0; i < LineNum; i ++ )
 553   4                                  {
 554   5                                              GoodsWaySetVal[i].WayNo = InputGoodsWayList[ i ].GoodsWayNo;
 555   5                                              Trace("\n GoodsWaySetVal[ %bu ].WayNo = %bu", i, GoodsWaySetVal[ i ].WayNo);
 556   5                                              GoodsWaySetVal[i].WayState = 0;                                 
 557   5                                              GoodsWaySetVal[i].GoodsCurrentSum = 0;
 558   5                          //-----------------------------------------------
 559   5                          //GoodsWaySetVal[i].Price = 0;
 560   5                          GoodsWaySetVal[i].Price = SystemParameter.curUnit;
 561   5                          //===============================================
 562   5                                      }
 563   4                                      //保存货架设置和货道开启设置
 564   4                                      SaveGoodsSet();
 565   4                                      SaveRackSet();
 566   4                                      SaveRackColumnSet();
 567   4                                      return 0;
 568   4                              }
 569   3                      }
 570   2                      //////////////////////////              
 571   2                      DisplayRackMenuAndVal( 0, 0, 1 );       
 572   2                      DisplayRackMenuAndVal( 1, 1, 1 );               
 573   2                      DisplayCursorState( 0, 1, 1, 2, 1 );//设置光标在第二行上且为整行光标状态
 574   2                      fristNum = 1;
 575   2                      LineNum = 2;
 576   2                      WaitForWork( 300, NULL );
 577   2                      while( 1 )
 578   2                      {               
 579   3                              /*判断按下何键*/                        
 580   3                              Rack_MenuSelected( &fristNum, &LineNum, MENU_COUNT( RackParastr ) - 1 );                        
 581   3                              //选中了某项菜单                                
 582   3                              if( fristNum == 100 )//选中退出                                                                 
 583   3                                      break;          
 584   3                              else if( fristNum == 0 )//没有选中退出
 585   3                                      continue;
 586   3                              else
 587   3                              {                               
 588   4                                      ClearKey();     
 589   4                                      if( iRackSet[RackNo - 1].UseState == 1 )
 590   4                                              EditRackParam( fristNum, LineNum - 1 ); 
 591   4                                      else if( fristNum == 1 ) 
 592   4                                              EditRackParam( fristNum, LineNum - 1 );                 
 593   4                                      //重新显示此项参数的值                  
 594   4                                      if( LineNum == 2 )
 595   4                                      {                       
 596   5                                              if( fristNum == 0 )
 597   5                                                      DisplayRackMenuAndVal( 0, MENU_COUNT( RackParastr ) - 1, 1 );
 598   5                                              else                                            
 599   5                                                      DisplayRackMenuAndVal( 0, fristNum-1, 1 );                                              
 600   5                                              DisplayRackMenuAndVal( 1, fristNum, 1 );        
 601   5                                      }
 602   4                                      else
 603   4                                      {                                                                       
 604   5                                              if( fristNum == ( MENU_COUNT( RackParastr ) - 1 ) )
 605   5                                                      DisplayRackMenuAndVal( 1, 0, 1 );       
 606   5                                              else                                            
 607   5                                                      DisplayRackMenuAndVal( 1, fristNum + 1, 1 );    
 608   5                                              DisplayRackMenuAndVal( 0, fristNum, 1 );
CX51 COMPILER V7.50   RACKSET                                                              10/23/2014 09:48:26 PAGE 11  

 609   5                                      }                       
 610   4                                      DisplayCursorState( 0, LineNum - 1, 1, 2, 1 );//设置光标为整行状态                      
 611   4                              }                                       
 612   3                      }
 613   2              }
 614   1              return 0;
 615   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   4350    ----
   CONSTANT SIZE    =    291    ----
   XDATA SIZE       =      2      94
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       3
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


CX51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
