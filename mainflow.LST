CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 1   


CX51 COMPILER V7.50, COMPILATION OF MODULE MAINFLOW
OBJECT MODULE PLACED IN mainflow.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\CX51.EXE mainflow.c LARGE OBJECTADVANCED ROM(HUGE) OPTIMIZE(SIZE) BROWSE DEBUG

line level    source

   1          //#undef _DEBUG_TRACE
   2          #include "Debug.h"
   3          #include "device.h"
   4          //#include "global.h"
   5          #include "mainflow.h"
   6          #include "IOInput.h"
   7          #include "DataExchange.h"
   8          #include "scheduler.h"
   9          #include "key.h"
  10          #include "Clock.h"
  11          #include "common.h"
  12          #include "language.h"
  13          #include "CommonFunction.h"
  14          #include "string.h"
  15          #include "timer.h"
  16          #include "maintmenu.h"
  17          #include "devicecheck.h"
  18          #include "initialization.h"
  19          #include "serial.h"
  20          #include <math.h>
  21          #include "procotol.h"
  22          //#include "Mobile.h"
  23          #include "communication.h"
  24          #include "ShortMsg.h"
  25          #include "VMC_PC.h"
  26          #include "ITL.h"
  27          #include "BusCard.h"
  28          #include "Countermaint.h"//120419 by cq TotalSell
  29          
  30          
  31          
  32          #define MAX_CHAR_NUMBER 20
  33          #define DEFAULT_COMM_TIMEOUT  60
  34          #define DEFAULT_INPUT_CODE_TIMEOUT 30//输入货道超时控制
  35          #define DEFAULT_INSERT_BILL_TIMEOUT 40
  36          #define DEFAULT_GET_BILL_TIMEOUT 10
  37          #define DEFAULT_DISPENSE_COIN_TIMEOUT 30
  38          #define LIGHT_BLINK_TIME 3      /* 出货灯闪烁次数，每次持续２秒钟 */
  39          #define DEFAULT_PRESSKEY_TIMEOUT 15
  40          #define __LINE0__        0
  41          #define __LINE1__        1
  42          
  43          
  44          struct DEVICESTATUS xdata DeviceStatus;
  45          struct SYSTEMPARAMETER xdata SystemParameter;//
  46          struct RackSet  xdata iRackSet[RACKNUM];//货架配置
  47          struct RackColumnSet xdata iRackColumnSet[RACKNUM][RACKCOLUMNNUM]; //每层货道启用配置
  48          struct WaySet  xdata GoodsWaySetVal[GOODSWAYNUM]; //各货道的参数设置
  49          struct HopperSet xdata HopperSetList[HOPPERNUM];  //0存放最大面值,1存放第二大面值,依此类推
  50          struct TRADECOUNTER xdata TradeCounter;
  51          //struct TRADELOG xdata TradeLog[GOODSWAYNUM];//各货道的交易统计
  52          struct COLUMNTEST xdata WayCheck;
  53          
  54          u_char xdata COLUMN_NUM_SET = 0;
  55          
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 2   

  56          //----------------------------------------------------------------
  57          //struct GoodsMatrix xdata sysGoodsMatrix[124];
  58          struct VP_Mission  xdata sysVPMission;
  59          struct ITL_Mission xdata sysITLMission;
  60          struct BC_Mission  xdata sysBCMission;
  61          struct MDB_Mission xdata sysMDBMission;
  62          //================================================================
  63          
  64          //u_char xdata CurrentTransType = 0; /* 1 = 正在交易， 0 = 空闲*/
  65          //u_char xdata LightBlinkFlag = 0;
  66          
  67          //是否有短信进来,0为无，1为有
  68          u_char IsShortMessageIn;
  69          
  70          //短信查询命令
  71          //bit0为1表示是查设备状态
  72          //bit1为1表示查询交易统计记录
  73          //bit2为1表示已发送了开机自检或维护后自检警报
  74          //bit6为1表示警报短信有分页,需要再次组短信包
  75          //bit7为1表示查设备状态有分页,需要再次组短信包
  76          u_char xdata SMSQuery = 0;
  77          
  78          //货币设备报警验证字节，各bit为1表示对应的故障已报警,具体定义为：
  79          //bit7验证纸币器，bit6验证硬币器
  80          //bit0-bit1验证hopper1,bit0验证缺币、bit1验证设备故障,下面类推
  81          //bit2-bit3验证hopper2
  82          //bit4-bit5验证hopper3
  83          unsigned char xdata  MoneyDevAlarm;
  84          
  85          //其它故障报警验证字节，各bit为1表示对应的故障已报警,具体定义为：
  86          //bit0验证暂停服务,bit1验证系统参数校验,bit2验证主板与显示板通讯
  87          //bit3验证所有货道无货,bit4验证所有货道故障,
  88          //bit5验证所有货道均不能正常工作,bit6验证主板与货道驱动板通讯故障
  89          //bit7保留
  90          unsigned char xdata  SystemErrorAlarm;//货道参数保存
  91          
  92          //待发的短信队列
  93          struct SMSMessageList xdata SMSMessage[MAX_SMS_LIST];
  94          //短信序列号
  95          //unsigned char xdata ListIndex = 0;
  96          
  97          const struct StrAndLen code QueryCmd[]=    
  98          {       
  99                   {"VMDEV", 5 }, //状态查询
 100                   {"VMREC", 5 }  //交易记录查询
 101          };
 102          
 103          
 104          u_char xdata CurrentStockCode;  //当前货道编号
 105          u_char xdata CurrentInputStockCode;
 106          u_int xdata  CurrentPayed = 0;
 107          u_int xdata  CurrentDispenseCoin;               /*该变量用作出币总额*/
 108          u_char xdata SystemStatus = 1;          //1-正常服务等待状态、2-暂停服务
 109          u_char xdata DisplayBuffer [ MAX_CHAR_NUMBER ];
 110          u_char xdata DisplayLine=0;
 111          u_char xdata UpdataDisp;
 112          u_char xdata goodsCodeBack;
 113          
 114          extern u_char xdata ZhkKeyPermission;
 115          
 116          /*
 117          故障位定义： 
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 3   

 118          // ff: undefinition error
 119          // bit0－f1：纸、码币器全故障0x0001
 120          // bit1－f2：硬币器故障；0x0002 
 121          // bit2－f3：hopper故障；0x0004
 122          // bit3－f4：hopper无币；0x0008
 123          // bit4－f5：所有货道无货；0x0010
 124          // bit5－f6：所有货道故障；0x0020
 125          // bit6－f7：所有货道驱动板与主板通讯故障0x0040
 126          // bit7--f8：所有货道不能工作0x0080
 127          // bit8--f9：参数校验错误0x0100
 128          // bit9--fa：LCD通讯故障0x0200
 129          // bit10-fb：开启的某个货道单价设置为0 0x0400
 130          // bit11-fc: GOC dev error:   0x0800
 131          // bit12-fd: selection error: 0x1000 ---- 0xEFFF
 132          // bit13-fe: PC com error:    0x2000 ---- 0xDFFF
 133          // bit14-e1: ACDC error:      0x4000 ---- 0xBFFF 
 134          // ---------------------------------------------
 135          // System error definition( 2011.7.18 )
 136          // F1: 纸币器、硬币器故障（通信）
 137          // F2: 硬币器(找币器)故障（通信）
 138          // F4: 找零不足，低于投币上限则自动关闭纸币器，(扣除下限值)5角低于3枚或总的找币金额小于5元则退出服务
 139          // F7: 货道驱动板通信故障
 140          // F8: 无可用货道
 141          // F9: 系统参数故障
 142          // FA: LCD通信故障
 143          // FD: 选货按键板故障
 144          // FE: PC通信故障
 145          // F0: 多找币故障//by gzz 20110810
 146          */
 147          
 148          u_int  xdata HardWareErr=0; 
 149          
 150          u_char xdata AlarmTime = 0;      //短信报警的次数
 151          
 152          bit  data       KeyLockFlag = 0;     //键盘锁定标志
 153          //bit  data  SystemSave = 0;     //系统是否保存
 154          bit  data       DisableFlag = 0;     //收币器禁能标志
 155          bit  data       IsCanInCashFlag = 1; //收纸币标志
 156          bit  data       IOUFlag = 0;         //本次退出服务时是否有欠钱
 157          u_char xdata errInputMoney = 0;
 158          bit      data   QueryFlag = 0;       //记录是否有顾客想查询货道状态
 159          
 160          u_char DispWelOrOutServ();
 161          u_char DispenseCoin(unsigned char flag );
 162          void GetHopperList();
 163          u_char CheckGoodsSumAndLoad();
 164          bit Selection1Query( void );
 165          bit Selection2Query( void );
 166          bit Selection3Query( void );
 167          u_char changeCNY(unsigned char* results, u_int money);
 168          
 169          
 170          //--------------------------------------------------
 171          u_char VP_GameKeyPoll( u_int xdata msTime )
 172          {
 173   1          
 174   1          #define VP_GAMEKEY_POLL  30
 175   1      
 176   1          u_char xdata result = 0;
 177   1          u_int  xdata i = 0;
 178   1          u_int  xdata pollTime = 0;
 179   1      
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 4   

 180   1              pollTime = msTime/3;
 181   1          if( pollTime < 1 ) pollTime = 1;
 182   1      
 183   1              sysVPMission.msTimer3  =  VP_GAMEKEY_POLL;
 184   1      
 185   1          //sysVPMission.msGameTimer1 = time*1000/10;
 186   1          sysVPMission.msGameTimer1 = msTime/10;
 187   1              while( sysVPMission.msGameTimer1 )
 188   1              {
 189   2                  //----------------------------------------------------
 190   2                      //Send the game key and poll pc in speciall time
 191   2                  if( IfGameKeyOn() )
 192   2                      {
 193   3                              VPMission_Button_RPT( VP_BUT_GAME, VP_BUT_NUMBER );
 194   3                      //Beep();
 195   3                      }
 196   2      
 197   2              /*
 198   2                      i++;
 199   2                      if( i >= pollTime )
 200   2                      {
 201   2                          i = 0;
 202   2                              result = VPMission_Poll();
 203   2                      }
 204   2                      */
 205   2              if( sysVPMission.msTimer3 == 0 )
 206   2                      {
 207   3                          //sysVPMission.msTimer3  =  VP_GAMEKEY_POLL;
 208   3                          //if( ( sysVPMission.vendCmd == 0 )&&(sysVPMission.changeCmd == 0)&&(sysVPMission.costCmd == 0)&&(sy
             -sVPMission.returnCmd == 0) )
 209   3                                      result = VPMission_Poll();
 210   3                      }
 211   2                      //===============================
 212   2              }
 213   1          return 0;
 214   1      }
 215          
 216          u_char VP_UpdateChnagerStatus( void )
 217          {
 218   1          u_char xdata flag = 0;
 219   1          
 220   1          #ifdef MACHINE_SET_MDB
 221   1              if( sysVPMission.sTimerChanger1 >= 10 )
 222   1                      {
 223   2                              sysVPMission.sTimerChanger1 = 0;
 224   2                              flag = MDB_Coin_TubeSta_API();
 225   2                              sysVPMission.tubeCoinMoney = sysMDBMission.coinAllValue;//保存硬币斗可找零金额
 226   2                      }
 227   1              #else
                              //1. 
                          if( SystemParameter.HopperCoinPrice1 >= 1 )
                              {
                                  //||(DeviceStatus.ChangeUnit1 == 0x01);by gzz 20110506
                                      //if(sysVPMission.hopperComErr[0]!=1)   
                                  if( ((DeviceStatus.ChangeUnit1 == 0x02) ||(DeviceStatus.ChangeUnit1 == 0x04) ||(DeviceStatus.ChangeU
             -nit1 == 0x01))&&(sysVPMission.hopperComErr[0]!=1) )   //low coin      
                                      {
                                              if( sysVPMission.VPDevCtr & 0x02 )
                                              {
                                                  if( sysVPMission.sTimerChanger1 >= VPM_DEVUPDATE_CHANGER1 )
                                                      {
                                                              sysVPMission.sTimerChanger1 = 0;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 5   

                                                              flag = GetHardWareDeviceState( 1, &Hopper1 );                   
                                                              if( flag != 1 )
                                                              {                                       
                                                                      if( Hopper1.State & 0x50 )        //系统故障
                                                                      {                                                                                                                                                       
                                                                              DeviceStatus.ChangeUnit1 = 1;
                                                                      }
                                                                      else if( Hopper1.State & 0x08 )
                                                                      {
                                                                          DeviceStatus.ChangeUnit1 = 4;
                                                                      }
                                                                      else if( Hopper1.State & 0x20 )   //光测无币或实际无币
                                                                      {       
                                                                              DeviceStatus.ChangeUnit1 = 2;  
                                                                      }
                                                                      else
                                                                      {
                                                                              DeviceStatus.ChangeUnit1 = 0;
                                                                              //HopperSetList[0].HopperState = 1;
                                                  sysVPMission.hopperComErr[0] = 0;
                                                                      }
                                                              }       
                                                              else
                                                              {
                                                                      DeviceStatus.ChangeUnit1 = 1;
                                                                      sysVPMission.hopperComErr[0] = 1;
                                                              }
                                          GetHopperList();
                       
                                                      }
                                              }
                                              else
                                              {
                                                      sysVPMission.VPDevCtr |= 0x02;
                                              }
                                      }
                              }
                      
                              //2.
                              if( SystemParameter.HopperCoinPrice2 >= 1 )
                              {
                                  //|| (DeviceStatus.ChangeUnit2 == 0x01);by gzz 20110506
                                  //if(sysVPMission.hopperComErr[1]!=1)
                                  if( ((DeviceStatus.ChangeUnit2 == 0x02) || (DeviceStatus.ChangeUnit2 == 0x04) || (DeviceStatus.Chang
             -eUnit2 == 0x01))&&(sysVPMission.hopperComErr[1]!=1) )   //low coin   
                                      {
                                              if( sysVPMission.VPDevCtr & 0x04 )
                                              {
                                                  if( sysVPMission.sTimerChanger2 >= VPM_DEVUPDATE_CHANGER2 )
                                                      {
                                                              sysVPMission.sTimerChanger2 = 0;
                                                              flag = GetHardWareDeviceState( 2, &Hopper2 );                   
                                                              if( flag != 1 )
                                                              {                                       
                                                                      if( Hopper2.State & 0x50 )        //系统故障
                                                                      {                                                                                                                                                       
                                                                              DeviceStatus.ChangeUnit2 = 1;
                                                                      }
                                                                      else if( Hopper2.State & 0x08 )
                                                                      {
                                                                          DeviceStatus.ChangeUnit2 = 4;
                                                                      }
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 6   

                                                                      else if( Hopper2.State & 0x20 )   //光测无币或实际无币
                                                                      {       
                                                                              DeviceStatus.ChangeUnit2 = 2; 
                                                                      }
                                                                      else
                                                                      {
                                                                              DeviceStatus.ChangeUnit2 = 0;
                                                                              //HopperSetList[1].HopperState = 1;
                                                  sysVPMission.hopperComErr[1] = 0;
                                                                      }
                                                              }       
                                                              else
                                                              {
                                                                      DeviceStatus.ChangeUnit2 = 1;
                                                                      sysVPMission.hopperComErr[1]=1;
                                                              }
                                          GetHopperList();
                       
                                                      }
                                              }
                                              else
                                              {
                                                      sysVPMission.VPDevCtr |= 0x04;
                                              }
                                      }
                      
                              }
                      
                          //3.
                          if( SystemParameter.HopperCoinPrice3 >= 1 )
                              {
                                  //||(DeviceStatus.ChangeUnit3==0x01);by gzz 20110506
                                      //if(sysVPMission.hopperComErr[2]!=1)
                                  if( ((DeviceStatus.ChangeUnit3==0x02) ||(DeviceStatus.ChangeUnit3==0x04) ||(DeviceStatus.ChangeUnit3
             -==0x01))&&(sysVPMission.hopperComErr[2]!=1) )   //low coin 
                                      {
                                              if( sysVPMission.VPDevCtr & 0x08 )
                                              {
                                                  if( sysVPMission.sTimerChanger3 >= VPM_DEVUPDATE_CHANGER3 )
                                                      {
                                                              sysVPMission.sTimerChanger3 = 0;
                                                              flag = GetHardWareDeviceState( 3, &Hopper3 );                   
                                                              if( flag != 1 )
                                                              {                                       
                                                                      if( Hopper3.State & 0x50 )        //系统故障
                                                                      {                                                                                                                                                       
                                                                              DeviceStatus.ChangeUnit3 = 1;
                                                                      }
                                                                      else if( Hopper3.State & 0x08 )
                                                                      {
                                                                          DeviceStatus.ChangeUnit3 = 4; 
                                                                      }
                                                                      else if( Hopper3.State & 0x20 )   //光测无币或实际无币
                                                                      {       
                                                                              DeviceStatus.ChangeUnit3 = 2; 
                                                                      }
                                                                      else
                                                                      {
                                                                              DeviceStatus.ChangeUnit3 = 0;
                                                                              //HopperSetList[2].HopperState = 1;
                                                  sysVPMission.hopperComErr[2] = 0;
                                                                      }
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 7   

                                                              }       
                                                              else
                                                              {
                                                                      DeviceStatus.ChangeUnit3 = 1;
                                                                      sysVPMission.hopperComErr[2]=1;
                                                              }
                                          GetHopperList();
                                                      }
                                              }
                                              else
                                              {
                                                      sysVPMission.VPDevCtr |= 0x08;
                                              }
                                      }
                      
                              }
                      #endif
 379   1          return 0;
 380   1      
 381   1      }
 382          //==================================================
 383          
 384          /////////////////////////////////////////////
 385          ///             公用涵数                                                /////
 386          /////////////////////////////////////////////
 387          u_char CheckHardWare( u_char i)
 388          {
 389   1              u_char xdata j = 0;
 390   1      //#ifndef _DEBUG_TRACE
 391   1      //#ifdef _HAVE_CASHER   
 392   1      //      Trace( "\n CheckHardWare i= %bu", i );
 393   1              if( SystemParameter.BillNo == 1 )
 394   1              {
 395   2                      if( i == 3 )
 396   2                      {       
 397   3                              if( HardWareErr & 0x0001)                       
 398   3                                      GetDeviceStatus( 0  );//取纸币器状态            
 399   3                              else if( HardWareErr & 0x0004 )
 400   3                              {
 401   4                                      GetDeviceStatus( 2  );//#1退币器测试                            
 402   4                                      GetDeviceStatus( 3  );//#2退币器测试            
 403   4                                      GetDeviceStatus( 4  );//#3退币器测试
 404   4                                      i = 0;
 405   4                              }       
 406   3                      }
 407   2                      else
 408   2                      {
 409   3                              if( i == 0 )
 410   3                                      GetDeviceStatus( 0  );//取纸币器状态
 411   3                              else if( IsCanInCashFlag == 1 /*HopperSetList[0].HopperState == 1*/ )
 412   3                                      GetDeviceStatus( 0  );//取纸币器状态
 413   3                              if ( i == 0 )
 414   3                              {
 415   4                                      GetDeviceStatus( 2  );//#1退币器测试
 416   4                                      GetDeviceStatus( 3  );//#2退币器测试
 417   4                                      GetDeviceStatus( 4  );//#3退币器测试
 418   4                              }
 419   3                      }
 420   2                      /*
 421   2                      if( ( DeviceStatus.BillAccepter != 0 ) && ( DeviceStatus.CoinAccepter != 0 ) )
 422   2                      //      HardWareErr = ERR_BILL_COIN;                            
 423   2                              HardWareErr |= 0x0001;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 8   

 424   2                      else if( ( ( DeviceStatus.BillAccepter != 0 ) || ( IsCanInCashFlag == 0 ) ) && ( DeviceStatus.CoinAccept
             -er != 0 ) )
 425   2                      {
 426   2                              //HardWareErr = ERR_COIN;                               
 427   2                              HardWareErr |= 0x0002;
 428   2                      }
 429   2                      else if( ( DeviceStatus.CoinAccepter == 0 ) || ( ( DeviceStatus.BillAccepter == 0 ) && ( IsCanInCashFlag
             - == 1 ) ) )
 430   2                      {
 431   2                              //HardWareErr = 0;  //2011.1.22
 432   2                      }
 433   2                      */
 434   2              }
 435   1              else
 436   1              {
 437   2                      if( i == 3 )
 438   2                      {                               
 439   3      //                      if( HardWareErr & 0x0002 )
 440   3      //                              GetDeviceStatus( 1  );//取硬币器状态
 441   3                              //else if( HardWareErr == ERR_HOPPER )
 442   3                              if( HardWareErr & 0x0004 )
 443   3                              {
 444   4                                      GetDeviceStatus( 2  );//#1退币器测试                            
 445   4                                      GetDeviceStatus( 3  );//#2退币器测试            
 446   4                                      GetDeviceStatus( 4  );//#3退币器测试
 447   4                              }       
 448   3                      }
 449   2                      else
 450   2                      {               
 451   3      //                      GetDeviceStatus( 1  );//取硬币器状态
 452   3                              if ( i == 0 )
 453   3                              {
 454   4                                      GetDeviceStatus( 2  );//#1退币器测试
 455   4                                      GetDeviceStatus( 3  );//#2退币器测试
 456   4                                      GetDeviceStatus( 4  );//#3退币器测试
 457   4                              }
 458   3                      }                               
 459   2              
 460   2                       if( DeviceStatus.CoinAccepter != 0 )
 461   2                       {
 462   3                      //      HardWareErr = ERR_COIN; 
 463   3                      //      HardWareErr |= 0x0002;
 464   3                       }
 465   2                       else
 466   2                       {                      
 467   3                              //      HardWareErr = 0;        
 468   3                              if( HardWareErr & 0x0002 )                      
 469   3                                      HardWareErr &= ( 0xffff - 0x00002 );            
 470   3                       }
 471   2      //               Trace( "\n CheckHardWare HardWareErr2= %bu", HardWareErr );
 472   2              }
 473   1              if ( i == 0 )
 474   1              {                       
 475   2                      for( i = 0; i < 3; i ++ )
 476   2                      {
 477   3                              switch( HopperSetList[i].HopperIndex )
 478   3                              {
 479   4                                      case 1:
 480   4                                              if( DeviceStatus.ChangeUnit1 == 2 )
 481   4                                                      continue;       //break;
 482   4                                              if( DeviceStatus.ChangeUnit1 == 1 )
 483   4                                                      HopperSetList[i].HopperState = 2;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 9   

 484   4                          else if( (DeviceStatus.ChangeUnit1==4)||(DeviceStatus.ChangeUnit1==2) )
 485   4                              HopperSetList[i].HopperState = 2;
 486   4                                              else
 487   4                                                      HopperSetList[i].HopperState = 1;
 488   4                                      break;
 489   4                                      case 2:
 490   4                                              if( DeviceStatus.ChangeUnit2 == 2 )
 491   4                                                      continue;       //break;
 492   4                                              if( DeviceStatus.ChangeUnit2 == 1 )
 493   4                                                      HopperSetList[i].HopperState = 2;
 494   4                          else if( (DeviceStatus.ChangeUnit2==4)||(DeviceStatus.ChangeUnit2==2) )
 495   4                              HopperSetList[i].HopperState = 2;
 496   4                                              else
 497   4                                                      HopperSetList[i].HopperState = 1;
 498   4                                      break;
 499   4                                      case 3:
 500   4                                              if( DeviceStatus.ChangeUnit3 == 2 )
 501   4                                                      continue;       //break;
 502   4                                              if( DeviceStatus.ChangeUnit3 == 1 )
 503   4                                                      HopperSetList[i].HopperState = 2;
 504   4                          else if( (DeviceStatus.ChangeUnit3==4)||(DeviceStatus.ChangeUnit3==2) )
 505   4                              HopperSetList[i].HopperState = 2;
 506   4                                              else
 507   4                                                      HopperSetList[i].HopperState = 1;
 508   4                                      break;
 509   4                                      default:
 510   4                                              continue;       
 511   4                              }
 512   3                      }
 513   2                      for( j = 0; j < 3; j ++ )
 514   2                      {
 515   3                              if( HopperSetList[j].price == 0 )
 516   3                                      break;
 517   3                      }
 518   2                      if( ( j > 0 ) && ( HopperSetList[j - 1].HopperState != 1 ) )            
 519   2                              IsCanInCashFlag = 0;
 520   2              }
 521   1      //      Trace( "\n CheckHardWare HardWareErr = %bu", HardWareErr );     
 522   1      //#endif
 523   1      
 524   1          //----------------------------------------------------------------------
 525   1              //
 526   1          //if( (SystemParameter.busCardOn==0x01)&&(DeviceStatus.BusCard==0x00) )
 527   1          //{
 528   1          //  BCMission_Inq();
 529   1          //}
 530   1          //=======================================================================
 531   1      
 532   1              return( 0 );
 533   1      }
 534          
 535          u_char RejectBill()
 536          {       
 537   1              u_char xdata i = 0;
 538   1              u_char xdata j = 0;
 539   1              u_char xdata flag = 0;
 540   1          
 541   1              if( sysITLMission.ITLSet == 1 )
 542   1              {
 543   2                  flag = ITLMission_Reject();
 544   2                      if( flag == ITL_ERR_NULL )
 545   2                      {
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 10  

 546   3                          return 0;
 547   3                      }
 548   2                      else
 549   2                      {
 550   3                              return 1;
 551   3                      }
 552   2              }
 553   1              else
 554   1              {
 555   2                      i = CasherReject();
 556   2                      while( j < 3 )
 557   2                      {
 558   3                              if( i == 0 )
 559   3                              {
 560   4                                      WaitForWork( 500, NULL );
 561   4                                      i = CasherReject();
 562   4                                      j++;
 563   4                              }
 564   3                              else
 565   3                                      break;
 566   3                      }
 567   2                      if( ( j >= 3 ) && ( i == 0 ) )
 568   2                              return 1;
 569   2                      while( ! ( i || j ) )
 570   2                      {
 571   3                              WaitForWork( 100, NULL );
 572   3                              i = TestDeviceTimeOut( &Casher );
 573   3                              j = TestDeviceCommOK( &Casher );                
 574   3                      }
 575   2                      if( i ) 
 576   2                              return 1;//超时，故障
 577   2              }
 578   1              return 0;//正常 
 579   1      }
 580          
 581          //禁能纸、硬币器
 582          u_char DisableBillDev()
 583          {
 584   1              //DisplayStr( 0, 0, 1, "2", 1 );  
 585   1              //WaitForWork(2000,NULL);
 586   1              //if(sysVPMission.billCoinEnable == 0)
 587   1              {
 588   2                      //DisplayStr( 0, 0, 1, "3", 1 );  
 589   2                  //WaitForWork(2000,NULL);
 590   2                  #ifdef MACHINE_SET_MDB                  
 591   2                              if(( SystemParameter.BillNo == 1 )&&( sysITLMission.ITLSet == 1 ))      
 592   2                              { 
 593   3                                      if( sysMDBMission.billIsEnable == 1 )
 594   3                                      {
 595   4                              MDBMission_Bill_Disable();
 596   4                                      }
 597   3                      }
 598   2      
 599   2                              if(sysMDBMission.coinIsEnable == 1)
 600   2                              {
 601   3                                      MDBMission_Coin_Disable();
 602   3                              }
 603   2                      #else
                                      //if( !DisableFlag )    //2011.1.20 changed.
                                      {
                                              if( SystemParameter.BillNo == 1 )
                                              {
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 11  

                                                  if( sysITLMission.ITLSet == 1 )
                                                      {
                                                              ITLMission_Disable();    
                                                      }
                                                  else
                                                      {
                                                              CasherQueryDisable();
                                                      }
                                              }
                                              //CoinerDisable();      
                                              MDBMission_Coin_Disable(); 
                                              WaitForWork( 20 , NULL );
                                              DisableFlag = 1;
                                      }
                          #endif
 623   2              }
 624   1              return 0;
 625   1      }
 626          
 627          
 628          //使能纸、硬币器
 629          u_char EnableBillDev()
 630          {       
 631   1      
 632   1              if(sysVPMission.billCoinEnable == 1)
 633   1              {
 634   2                  //static u_char xdata cFullFlag = 0;
 635   2                      #ifdef MACHINE_SET_MDB
 636   2                              //DisplayStr( 0, __LINE0__ , 1 , "4", 1 );
 637   2                              //WaitForWork( 2000, NULL );  //500-50-100-200              
 638   2                  //纸币器使能操作；by gzz 20110811
 639   2                              //if(( sysMDBMission.billDeviceStatus == 0x00 )&&( SystemParameter.BillNo == 1 )&&( sysITLMission.ITLSe
             -t == 1 ))
 640   2                              if(( SystemParameter.BillNo == 1 )&&( sysITLMission.ITLSet == 1 ))
 641   2                  {
 642   3                      //只有纸币器目前是禁能或者是故障时，才予以重新使能;by gzz 20110920
 643   3                      if(( sysMDBMission.billDeviceStatus == 0x01 )||( sysMDBMission.billIsEnable == 0 ))
 644   3                      {
 645   4                                              MDBMission_Bill_Enable();
 646   4                      }       
 647   3                              }                       
 648   2      
 649   2                  //只有硬币器目前是禁能或者是故障时，才予以重新使能;by gzz 20110920
 650   2                  if(( sysMDBMission.coinDeviceStatus == 0x01 )||( sysMDBMission.coinIsEnable == 0 ))
 651   2                              {
 652   3                                      MDBMission_Coin_Enable();       
 653   3                              }
 654   2                  #else
                                      if( (DisableFlag)&&(HardWareErr==0) )
                                      {               
                                              if( SystemParameter.BillNo == 1 )
                                              {       
                                                  if( sysITLMission.ITLSet == 1 )
                                                      {
                                                          if( DeviceStatus.BillAccepter == 0 )
                                                              {
                                                                      //ITLMission_Enable();
                                                                      if((sysITLMission.billSta&ITL_BILL_SJAM)||(sysITLMission.billSta& ITL_BILL_UJAM ))
                                                                      {
                                                                              sysITLMission.billJamedFlag = 1;
                                                                              if( sysITLMission.billJamedTime >= ITL_TIME_JAMED_DISABLE )
                                                                              {
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 12  

                                                                                      sysITLMission.billJamedTime = 0;
                                                          ITLMission_Disable();
                                                                              }
                                                                      }
                                                                      else
                                                                      {
                                                                          sysITLMission.billJamedFlag = 0;
                                                                              ITLMission_Init_1();
                                                                      }
                                                      }
                                                      }
                                                  else
                                                  {
                                                              if( DeviceStatus.BillAccepter == 0 )
                                                              {
                                                                      CasherQueryEnable();
                                                              }
                                                      }
                                              }
                              
                                              if( DeviceStatus.CoinAccepter == 0 )
                                              {
                                                      //CoinerEnable();           //使能硬币器
                                                      MDBMission_Coin_Init();
                                              }
                                              else
                                              {
                                                      //CoinerDisable();//禁能硬币器
                                                      MDBMission_Coin_Disable();
                                              }
                                              WaitForWork( 20 , NULL );
                                              DisableFlag = 0;
                                      }
                                  //
                                  if( IfCoinHopperFull() )
                                  {
                                      if( cFullFlag == 0 )
                                      {
                                              cFullFlag = 1;
                                      }
                                  }
                                  else
                                  {
                                      if( cFullFlag == 1 )
                                      {
                                              cFullFlag = 0;
                                          //CoinerEnable();
                                                      MDBMission_Coin_Init();//使能硬币器
                                      }
                                  }
                              #endif
 720   2              }
 721   1              if(sysVPMission.ErrFlag2 == 0)
 722   1              {
 723   2                      if(sysVPMission.ErrFlag==1)
 724   2                      {
 725   3                              sysVPMission.ErrFlag=0;
 726   3                              sysMDBMission.billCashBuf = 0;
 727   3                              sysVPMission.DevErrFlag = 0;
 728   3                              VPMission_Status_RPT();
 729   3                              MDB_Coin_TubeSta_API();
 730   3                      }
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 13  

 731   2              }
 732   1              return 0;
 733   1      }
 734          
 735          u_char SetOffFlag()
 736          {
 737   1          //Trace( "\n SetOffFlag");
 738   1              SystemStatus = 2; /* 标志设为OUT_OF_SERVICES状态 */
 739   1              //DisableBillDev();     
 740   1              //DisplayStr( 0, __LINE0__ , 1 , "1", 1 );
 741   1              //WaitForWork( 2000, NULL );  //500-50-100-200
 742   1              KeyLock();
 743   1              return 1;
 744   1      }
 745          
 746          //设为非现金交易模式;by gzz 20110727
 747          u_char SetCashLessFlag()
 748          {
 749   1          //Trace( "\n SetOffFlag");
 750   1              SystemStatus = 2; /* 标志设为OUT_OF_SERVICES状态 */
 751   1              sysVPMission.SystemState = 1; 
 752   1              //DisableBillDev();
 753   1              //DisplayStr( 0, __LINE0__ , 1 , "2", 1 );
 754   1              //WaitForWork( 2000, NULL );  //500-50-100-200
 755   1              //KeyLock();
 756   1              return 1;
 757   1      }
 758          
 759          u_char LogicOpen()
 760          {
 761   1          //Trace( "\n LogicOpen");
 762   1              SystemStatus = 1;
 763   1          //isShowLcd = 1;
 764   1              if( sysVPMission.VPMode == 0 )
 765   1              {
 766   2                      if( KeyLockFlag == 1 )
 767   2                      {
 768   3                              KeyUnLock(); /* 打开键盘，允许客户进行交易,硬币和纸币在运行过程中再打开 */
 769   3                              KeyLockFlag = 0;
 770   3                      }
 771   2              }
 772   1              if(sysVPMission.SystemState == 1)
 773   1                      sysVPMission.SystemState = 0;
 774   1              return 1;
 775   1      
 776   1      }
 777          
 778          
 779          /*
 780          u_char CheckKeyPress()
 781          {
 782                  if (  SystemStatus == 2 ) 
 783                          return 0; // 系统关闭，按键不理,当做没按 
 784                  if ( GetKey() != KEY_NULL ) 
 785                          return 1;
 786                  else
 787                          return 0;
 788          }
 789          */
 790          
 791          //用于显示确定或取消并返回用记选择值,返回值，确定返回0,取消返回1,超时返回2
 792          u_char ChooseReturn( )
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 14  

 793          {
 794   1      //      u_char xdata length = 0;
 795   1              u_char xdata pt= 0;
 796   1              u_char xdata MyKey = 0;
 797   1      
 798   1              ClearKey();     
 799   1              //显示字符      
 800   1              DisplayLine = STR_OK_NOT;        
 801   1              DisplayStr( 0, __LINE1__ , 1, DispInformationTable[     DisplayLine ].str , DispInformationTable[ DisplayLine
             - ].len );
 802   1          
 803   1              //等待选择
 804   1              LzjSecTimer= DEFAULT_PRESSKEY_TIMEOUT;
 805   1              while( LzjSecTimer )
 806   1              {
 807   2                      SchedulerProcess();
 808   2                      MyKey = GetKey();
 809   2                      if ( MyKey == KEY_NULL ) 
 810   2                              continue;
 811   2                      switch ( MyKey )
 812   2                      {                       
 813   3                              case    KEY_SUBMIT:                     
 814   3                                      return 0 ;                      
 815   3                              case KEY_CANCEL:                                
 816   3                                      return 1 ;                                      
 817   3                              default:
 818   3                                      continue;
 819   3                      }       
 820   2              }
 821   1              return 2;
 822   1      }
 823          
 824          u_char Cal( u_int Money , u_char* m_Hopper1, u_char* m_Hopper2, u_char* m_Hopper3 )
 825          {
 826   1              u_char xdata m_L = 0;
 827   1              u_char xdata m_H = 0;   
 828   1      
 829   1          //Trace( "\n in Cal");      
 830   1          //Trace( "\n Money = %d", Money );  
 831   1      
 832   1              if( Money < HopperSetList[2].price )//无法配币
 833   1                      return 1;
 834   1              
 835   1              m_L = Money / HopperSetList[0].price;                   
 836   1              m_H = m_L;
 837   1          //Trace("\n HopperSetList[0].HopperState = %bu", HopperSetList[0].HopperState );
 838   1          //Trace("\n HopperSetList[0].HopperIndex = %bu", HopperSetList[0].HopperIndex );
 839   1              if( HopperSetList[0].HopperState == 1 )
 840   1              {
 841   2                      switch( HopperSetList[0].HopperIndex )
 842   2                      {
 843   3                              case 1:                                                                                 
 844   3                                      *m_Hopper1 = m_L;                       
 845   3                              break;
 846   3                              case 2:                 
 847   3                                      *m_Hopper2 = m_L;
 848   3                              break;
 849   3                              case 3:                         
 850   3                                      *m_Hopper3 = m_L;
 851   3                              break;
 852   3                      }
 853   2              }
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 15  

 854   1              else
 855   1              {
 856   2                      switch( HopperSetList[0].HopperIndex )
 857   2                      {
 858   3                              case 1:                                         
 859   3                                      *m_Hopper1 = 0;
 860   3                                      m_H = 0;                
 861   3                              break;
 862   3                              case 2:
 863   3                                      *m_Hopper2 = 0;
 864   3                                      m_H = 0;
 865   3                              break;
 866   3                              case 3:
 867   3                                      *m_Hopper3 = 0;
 868   3                                      m_H = 0;
 869   3                              break;
 870   3                      }       
 871   2              }
 872   1      
 873   1              Money = Money - m_H * HopperSetList[0].price;                   
 874   1              m_H = 0;
 875   1              m_L = 0;
 876   1      
 877   1              m_L = Money / HopperSetList[1].price;                   
 878   1              m_H = m_L;
 879   1      //      Trace("\n HopperSetList[1].HopperState = %bu", HopperSetList[1].HopperState );
 880   1      //      Trace("\n HopperSetList[1].HopperIndex = %bu", HopperSetList[1].HopperIndex );
 881   1              if( HopperSetList[1].HopperState == 1 )
 882   1              {
 883   2                      switch( HopperSetList[1].HopperIndex )
 884   2                      {
 885   3                              case 1:                 
 886   3                                      *m_Hopper1 = m_L;
 887   3                              break;
 888   3                              case 2:                         
 889   3                                      *m_Hopper2 = m_L;
 890   3                              break;
 891   3                              case 3:                         
 892   3                                      *m_Hopper3 = m_L;
 893   3                              break;
 894   3                      }
 895   2              }
 896   1              else
 897   1              {
 898   2                      switch( HopperSetList[1].HopperIndex )
 899   2                      {
 900   3                              case 1:                                         
 901   3                                      *m_Hopper1 = 0;
 902   3                                      m_H = 0;                
 903   3                              break;
 904   3                              case 2:
 905   3                                      *m_Hopper2 = 0;
 906   3                                      m_H = 0;
 907   3                              break;
 908   3                              case 3:
 909   3                                      *m_Hopper3 = 0;
 910   3                                      m_H = 0;
 911   3                              break;
 912   3                      }       
 913   2              }
 914   1      
 915   1              Money = Money - m_H * HopperSetList[1].price;                   
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 16  

 916   1              m_H = 0;
 917   1              m_L = 0;
 918   1              
 919   1      //      Trace("\n HopperSetList[2].HopperState = %bu", HopperSetList[2].HopperState );
 920   1      //      Trace("\n HopperSetList[2].HopperIndex = %bu", HopperSetList[2].HopperIndex );
 921   1              m_L = Money / HopperSetList[2].price;
 922   1              if( HopperSetList[2].HopperState == 1 )
 923   1              {                       
 924   2                      switch( HopperSetList[2].HopperIndex )
 925   2                      {
 926   3                              case 1:                                         
 927   3                                      *m_Hopper1 = m_L;
 928   3                              break;
 929   3                              case 2:                                                 
 930   3                                      *m_Hopper2 = m_L;
 931   3                              break;
 932   3                              case 3:                                         
 933   3                                      *m_Hopper3 = m_L;
 934   3                              break;
 935   3                      }
 936   2              }
 937   1              else
 938   1              {
 939   2                      switch( HopperSetList[2].HopperIndex )
 940   2                      {
 941   3                              case 1:                                         
 942   3                                      *m_Hopper1 = 0;
 943   3                                      m_H = 0;                
 944   3                              break;
 945   3                              case 2:
 946   3                                      *m_Hopper2 = 0;
 947   3                                      m_H = 0;
 948   3                              break;
 949   3                              case 3:
 950   3                                      *m_Hopper3 = 0;
 951   3                                      m_H = 0;
 952   3                              break;
 953   3                      }       
 954   2              }
 955   1                      
 956   1      
 957   1      //      Trace( "\n *Hopper1 = %bu", *m_Hopper1 );
 958   1      //      Trace( "\n *Hopper2 = %bu", *m_Hopper2 );
 959   1      //      Trace( "\n *Hopper3 = %bu", *m_Hopper3 );       
 960   1              if (( *m_Hopper1 == 0) && ( *m_Hopper2 == 0 ) && ( *m_Hopper3 == 0) ) 
 961   1              // 配币错误 
 962   1                      return 1;       
 963   1              return 0 ;              
 964   1      }
 965          
 966          u_char DisplayCurrentMoney( u_int Money )
 967          {
 968   1              u_char xdata length = 0;
 969   1              u_int  xdata moneyBuf= 0;
 970   1      
 971   1              if( sysITLMission.billHoldingFlag == 1 )
 972   1              {
 973   2                      Money += sysITLMission.billHoldingValue;
 974   2              }
 975   1      
 976   1              if( Money <= 0 )
 977   1              {
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 17  

 978   2                      return 0;
 979   2              }
 980   1          //DisplayLine = STR_CUSTOM_PAYED;   
 981   1              DisplayLine = STR_BALANCE;
 982   1              memset( DisplayBuffer , 0 , sizeof( DisplayBuffer ));
 983   1              length = DispInformationTable[DisplayLine].len;
 984   1              memcpy( DisplayBuffer , DispInformationTable[DisplayLine].str , DispInformationTable[DisplayLine].len );
 985   1              DisplayBuffer[ length ] = ' ';  
 986   1              switch( SystemParameter.curUnit )
 987   1              {
 988   2                      case 1:
 989   2                              length += sprintf( DisplayBuffer + length + 1 , "%u" , Money ); 
 990   2                      break;                          
 991   2                      case 10:
 992   2                              length += sprintf( DisplayBuffer + length + 1 , "%u.%u" , (Money / SystemParameter.curUnit),( Money %Sy
             -stemParameter.curUnit));      
 993   2                      break;
 994   2                      case 100:
 995   2                              length += sprintf( DisplayBuffer + length + 1 , "%u.%02u" , (Money / SystemParameter.curUnit),( Money %
             -SystemParameter.curUnit));    
 996   2                      break;          
 997   2              }               
 998   1              length++;       
 999   1              DisplayStr( 0, 0, 1, DisplayBuffer, length );
1000   1          
1001   1              if( Money  >= SystemParameter.BanknoteMax )
1002   1              {
1003   2                  DisplayLine = STR_VP_SELECTGOODS;
1004   2              DisplayStr( 0, 1, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].len 
             -);
1005   2                      //
1006   2                      if( sysITLMission.billHoldingFlag == 1 )
1007   2                      {
1008   3                              
1009   3                  MDBMission_Coin_Disable();
1010   3                      }
1011   2      
1012   2              }
1013   1              else
1014   1              {
1015   2                  DisplayLine = STR_INPUT_GOODS;
1016   2                      DisplayStr( 0, 1, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].len );  //
             --1        
1017   2              }
1018   1              //WaitForWork( 100 , &Lcd );
1019   1      
1020   1          //----------------------------------------------------------------------------------
1021   1              //payin report
1022   1              if( sysVPMission.payInCoinFlag == 1 )
1023   1              {
1024   2                  VPMission_Payin_RPT( VP_DEV_COIN, sysVPMission.payInCoinMoney );
1025   2                      sysVPMission.payInCoinFlag = 0;
1026   2              sysVPMission.payInCoinMoney = 0;
1027   2              
1028   2              }
1029   1              if( sysVPMission.payInBillFlag == 1 )
1030   1              {
1031   2                  VPMission_Payin_RPT( VP_DEV_BILL, sysVPMission.payInBillMoney );
1032   2                      sysVPMission.payInBillFlag = 0;
1033   2              sysVPMission.payInBillMoney = 0;      
1034   2              }
1035   1              if( sysVPMission.escrowInFlag == 1 )
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 18  

1036   1          {
1037   2                  VPMission_Payin_RPT( VP_DEV_ESCROWIN, sysVPMission.escrowMoney );
1038   2                      sysVPMission.escrowInFlag = 0;
1039   2              sysVPMission.escrowMoney = 0;     
1040   2              }
1041   1              if( sysVPMission.escrowOutFlag == 1 )
1042   1          {
1043   2                  VPMission_Payin_RPT( VP_DEV_ESCROWOUT, sysVPMission.escrowMoney );
1044   2                      sysVPMission.escrowOutFlag = 0;
1045   2              sysVPMission.escrowMoney = 0;     
1046   2              }
1047   1              //==================================================================================
1048   1              return( 0 );
1049   1      }
1050          
1051          void GetHopperList()
1052          {               
1053   1              u_int xdata i = 0;
1054   1              u_int xdata j = 0;
1055   1              u_int xdata z = 0;      
1056   1      
1057   1               i = SystemParameter.HopperCoinPrice1;
1058   1               j = SystemParameter.HopperCoinPrice2;
1059   1               z = SystemParameter.HopperCoinPrice3;
1060   1               
1061   1              //找出最大的斗          
1062   1              if( ( i >= j ) && ( i >= z ) )
1063   1              {       
1064   2                      HopperSetList[0].price = i;
1065   2                      HopperSetList[0].HopperIndex = 1;
1066   2                      if( j >= z )
1067   2                      {
1068   3                              HopperSetList[1].price = j;
1069   3                              HopperSetList[1].HopperIndex = 2;               
1070   3                              HopperSetList[2].price = z;
1071   3                              HopperSetList[2].HopperIndex = 3;
1072   3                      }
1073   2                      else
1074   2                      {               
1075   3                              HopperSetList[1].price = z;
1076   3                              HopperSetList[1].HopperIndex = 3;               
1077   3                              HopperSetList[2].price = j;
1078   3                              HopperSetList[2].HopperIndex = 2;
1079   3                      }
1080   2              }
1081   1              else if( ( i >= j ) && ( i <= z ) )
1082   1              {
1083   2                      HopperSetList[0].price = z;
1084   2                      HopperSetList[0].HopperIndex = 3;
1085   2                      HopperSetList[1].price = i;
1086   2                      HopperSetList[1].HopperIndex = 1;       
1087   2                      HopperSetList[2].price = j;
1088   2                      HopperSetList[2].HopperIndex = 2;
1089   2              }
1090   1              else if( ( j >= i ) && ( i >= z ) )
1091   1              {       
1092   2                      HopperSetList[0].price = j;
1093   2                      HopperSetList[0].HopperIndex = 2;       
1094   2                      HopperSetList[1].price = i;
1095   2                      HopperSetList[1].HopperIndex = 1;
1096   2                      HopperSetList[2].price = z;
1097   2                      HopperSetList[2].HopperIndex = 3;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 19  

1098   2              }
1099   1              else if( ( j >= i ) && ( i <= z ) )
1100   1              {               
1101   2                      HopperSetList[2].price = i;
1102   2                      HopperSetList[2].HopperIndex = 1;
1103   2                      if( j >= z )
1104   2                      {
1105   3                              HopperSetList[0].price = j;
1106   3                              HopperSetList[0].HopperIndex = 2;
1107   3                              if( (DeviceStatus.ChangeUnit2==1)||(DeviceStatus.ChangeUnit2==2)||(DeviceStatus.ChangeUnit2==4) )
1108   3                                      HopperSetList[0].HopperState = 2;
1109   3                              HopperSetList[1].price = z;
1110   3                              HopperSetList[1].HopperIndex = 3;
1111   3                              if( (DeviceStatus.ChangeUnit2==1)||(DeviceStatus.ChangeUnit2==2)||(DeviceStatus.ChangeUnit2==4) )
1112   3                                      HopperSetList[0].HopperState = 2;
1113   3                      }
1114   2                      else
1115   2                      {
1116   3                              HopperSetList[0].price = z;
1117   3                              HopperSetList[0].HopperIndex = 3;                       
1118   3                              HopperSetList[1].price = j;
1119   3                              HopperSetList[1].HopperIndex = 2;
1120   3                      }
1121   2              }
1122   1      
1123   1              for( i = 0; i < 3; i ++ )
1124   1              {
1125   2                      if( HopperSetList[i].price == 0 )               
1126   2                              break;
1127   2              }
1128   1              if( i > 0 )
1129   1                      i--;
1130   1              for( j = 0; j < 3; j ++ )
1131   1              {
1132   2                      switch( HopperSetList[j].HopperIndex )
1133   2                      {
1134   3                              case 1:
1135   3                                      if( SystemParameter.HopperCoinPrice1 == 0 )
1136   3                                              break;                  
1137   3                                      if( DeviceStatus.ChangeUnit1 == 1 )
1138   3                                              HopperSetList[j].HopperState = 2;
1139   3                                      //---------------------------------------------------
1140   3                                      else if( (DeviceStatus.ChangeUnit1 == 4)||(DeviceStatus.ChangeUnit1 == 2) )
1141   3                                          HopperSetList[j].HopperState = 2;
1142   3                                      //===================================================
1143   3                                      else
1144   3                                              HopperSetList[j].HopperState = 1;
1145   3                                      if( ( j == i ) && ( DeviceStatus.ChangeUnit1 != 0 ) )
1146   3                                              IsCanInCashFlag = 0;                            
1147   3                              break;
1148   3                              case 2:
1149   3                                      if( SystemParameter.HopperCoinPrice2 == 0 )
1150   3                                              break;                  
1151   3                                      if( DeviceStatus.ChangeUnit2 == 1 )
1152   3                                              HopperSetList[j].HopperState = 2;
1153   3                                      //---------------------------------------------------
1154   3                                      else if( (DeviceStatus.ChangeUnit2 == 4)||(DeviceStatus.ChangeUnit2 == 2) )
1155   3                                          HopperSetList[j].HopperState = 2;
1156   3                                      //===================================================
1157   3                                      else
1158   3                                              HopperSetList[j].HopperState = 1;
1159   3                                      if( ( j == i ) && ( DeviceStatus.ChangeUnit2 != 0 ) )
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 20  

1160   3                                              IsCanInCashFlag = 0;
1161   3                              break;
1162   3                              case 3:
1163   3                                      if( SystemParameter.HopperCoinPrice3 == 0 )
1164   3                                              break;                  
1165   3                                      if( DeviceStatus.ChangeUnit3 == 1 )
1166   3                                              HopperSetList[j].HopperState = 2;
1167   3                                      //---------------------------------------------------
1168   3                                      else if( (DeviceStatus.ChangeUnit3==4)||(DeviceStatus.ChangeUnit3==2) )
1169   3                                          HopperSetList[j].HopperState = 2;
1170   3                                      //===================================================
1171   3                                      else
1172   3                                              HopperSetList[j].HopperState = 1;
1173   3                                      if( ( j == i ) && ( DeviceStatus.ChangeUnit3 != 0 ) )
1174   3                                              IsCanInCashFlag = 0;
1175   3                              break;
1176   3                              default:
1177   3                                      continue;       
1178   3                      }
1179   2              }
1180   1              //如果HOPPER内的面值为0则此HOPPER不能参数配币
1181   1              for( i = 0; i < 3; i ++ )
1182   1              {
1183   2                      if( HopperSetList[i].price == 0 )               
1184   2                              HopperSetList[i].HopperState = 2;                               
1185   2              }
1186   1              //如果HOPPER内的面值为0则此HOPPER不能参数配币
1187   1              for( i = 0; i < 3; i ++ )
1188   1              {
1189   2                      if( HopperSetList[i].price == 0 )               
1190   2                              break;
1191   2              }
1192   1              if( ( i > 0 )&& ( HopperSetList[i - 1].HopperState != 1 ) )
1193   1                      IsCanInCashFlag = 0;
1194   1      
1195   1              if( HardWareErr & 0x0004 )
1196   1              {
1197   2                      //HardWareErr = 0;  //2011.1.22
1198   2              }
1199   1      
1200   1      }
1201          
1202          
1203          //得到面值最小的使能HHOPPER
1204          u_char GetMinHopper()
1205          {
1206   1              if( HopperSetList[2].price != 0 )
1207   1                      return 2;
1208   1              else if( HopperSetList[1].price != 0 )
1209   1                      return 1;
1210   1              else
1211   1                      return 0;
1212   1      }
1213          
1214          //是否还能找币
1215          u_char IsCanChange()
1216          {
1217   1              u_char i = 0;
1218   1      
1219   1              for(i = 0; i < 3; i ++ )
1220   1              {
1221   2                      if( ( HopperSetList[i].HopperState == 1 ) && ( HopperSetList[i].price != 0 ) )
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 21  

1222   2                              break;
1223   2              }
1224   1              if( i == 3 )
1225   1                      return 0;
1226   1              else
1227   1                      return 1;
1228   1      }
1229          
1230          //是否还有货道可服务
1231          //by gzz 20110614
1232          u_char ColnumIsCanServer()
1233          {
1234   1              u_char i = 0;    
1235   1              for( i = 0; i < GOODSWAYNUM; i ++ )
1236   1              {
1237   2              if( SystemParameter.GOCOn != 0x01 )
1238   2                      {
1239   3                              if(( GoodsWaySetVal[i].GoodsCurrentSum != 0 ) && ( ( GoodsWaySetVal[i].WayState & 0x0A ) == 0x00 ) && (
             - GoodsWaySetVal[i].Price != 0 ) )
1240   3                                      break;
1241   3                      }
1242   2                      else
1243   2                      {
1244   3                          //if(( (GoodsWaySetVal[i].WayState & 0x04) == 0 )&&( ( GoodsWaySetVal[i].WayState & 0x0A ) == 0x00 )
             -&&( GoodsWaySetVal[i].Price != 0 ) )
1245   3                              if( ( GoodsWaySetVal[i].GoodsCurrentSum != 0 ) && ( (GoodsWaySetVal[i].WayState & 0x04) == 0 )&&( ( Goo
             -dsWaySetVal[i].WayState & 0x0A ) == 0x00 )&&( GoodsWaySetVal[i].Price != 0 ) )
1246   3                                      break;
1247   3                      }
1248   2              //----------------------------------------------------
1249   2              //原先用于判断是否有货道可用，如果有，则跳出循环
1250   2                      //if( ( ( GoodsWaySetVal[i].WayState & 0x01 ) == 0x01 ) && ( ( GoodsWaySetVal[i].WayState & 0x0A ) == 0x
             -00 ) && ( GoodsWaySetVal[i].GoodsCurrentSum != 0 ) /*&& ( GoodsWaySetVal[i].Price != 0 )*/ )
1251   2                      //      break;
1252   2              //====================================================
1253   2              }
1254   1              if( i == GOODSWAYNUM )
1255   1          {
1256   2                      return 0;
1257   2          }
1258   1          //-----------------------------------------------------
1259   1          /*
1260   1          //UpdateGoodsMatrixStatus();
1261   1              for( i=0; i<GOODSTYPEMAX; i++ )
1262   1              {
1263   1                      //if( sysGoodsMatrix[i].NextColumn != 0xff )
1264   1                      //      break;
1265   1              if( (sysGoodsMatrix[i].NextColumn != GOODS_MATRIX_NONE)&&(sysGoodsMatrix[i].Price != 0) )
1266   1                      {
1267   1                              break;
1268   1                      }
1269   1              }
1270   1              if( i >= GOODSTYPEMAX )
1271   1              {
1272   1                      return 0;
1273   1              }
1274   1              */
1275   1              //===================================================== 
1276   1              return 1;
1277   1      }
1278          
1279          u_char  ScanIsSendAlarm()
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 22  

1280          {
1281   1              return 0;
1282   1      }
1283          
1284          //查询回应信息打包函数
1285          //查询命令回应信息打包函数
1286          u_char  ScanDeviceStatus()
1287          {
1288   1              return 0;
1289   1      }
1290          
1291          //交易记录信息
1292          u_char  TradePack()
1293          {
1294   1              return 0;
1295   1      }
1296          
1297          
1298          
1299          
1300          /////////////////////////////////
1301          ///             流 程 函 数                     /////
1302          /////////////////////////////////
1303          // 系统启动
1304          u_char SystemInit()
1305          {    
1306   1              u_char xdata i = 0;  
1307   1      
1308   1              memset( &SystemParameter, 0, sizeof( SystemParameter ) );
1309   1          //-------------------------------------------------------
1310   1          memset( &sysVPMission, 0, sizeof( sysVPMission ) );
1311   1              //memset( &sysGoodsMatrix, 0, sizeof( sysGoodsMatrix ) );
1312   1          //sysVPMission.VPMode = 1;
1313   1          sysVPMission.returnKeyLock = 1;
1314   1          sysVPMission.gameKeyLock = 1;
1315   1          memset( &sysITLMission, 0, sizeof( sysITLMission ) );
1316   1          sysITLMission.ITLSet = 1;
1317   1              memset( &sysBCMission, 0, sizeof( sysBCMission ) );
1318   1              //=======================================================
1319   1              WaitForWork( 100, NULL );
1320   1              //memset(&sysMDBMission.coinBuf,0,sizeof(sysMDBMission.coinBuf));
1321   1              //memset(&sysMDBMission.billBuf,0,sizeof(sysMDBMission.billBuf));
1322   1          memset( &sysMDBMission, 0, sizeof(sysMDBMission) );
1323   1      
1324   1              
1325   1              //-------------------------------------------------------
1326   1              //ClearDisplayLine( 1 );
1327   1          //ClearDisplayLine( 2 );
1328   1              DisplayCursorState( 0, 0, 1, 0, 1 );//无光标
1329   1              DisplayCursorState( 1, 0, 1, 0, 1 );//无光标
1330   1              //=======================================================
1331   1          //Trace( "\n Begin" );
1332   1              DisplayStr( 0, 0, 1, DispInformationTable[ STR_TYPE_VER ].str, DispInformationTable[ STR_TYPE_VER ].len )
             -;        
1333   1              DisplayStr( 0, 1, 1, DispInformationTable[ STR_INSERT_MONEY ].str, DispInformationTable[ STR_INSERT_MONEY
             - ].len );        
1334   1              WaitForWork( 100, NULL );
1335   1              return 0;
1336   1      }
1337          
1338          // 初始化设备工作状态(如允许查询状态，自动开启广告灯等等)
1339          u_char DeviceDefaultSetting()
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 23  

1340          {       
1341   1              u_char xdata i = 0;
1342   1          u_char xdata j = 0;
1343   1              u_char xdata x = 0 ;
1344   1              u_char xdata y = 0;
1345   1              u_char xdata z = 0;
1346   1              u_char xdata iRack = 0;
1347   1      
1348   1              WaitForWork( 100, NULL );
1349   1              memset( &WayCheck, 0, sizeof( WayCheck ));
1350   1              memset( &DeviceStatus, 0, sizeof( DeviceStatus ) );
1351   1          //----------------------------------------------------------
1352   1          //Trace( "\n SysInitParam" );
1353   1              for( i = 0; i < 50; i++ )
1354   1                      CoreProcessCycle();
1355   1      
1356   1              IsCanInCashFlag = 1;
1357   1              // 如果不是新机器,这里要从flash里把东西读出来,变量初始化 
1358   1              memset( HopperSetList, 0, sizeof( HopperSetList ) );    
1359   1              LoadGlobalParam(); // 获取全程变量参数
1360   1      
1361   1              //检验系统参数的校验位
1362   1              i = 0;
1363   1              i = sizeof( struct SYSTEMPARAMETER ) - 1;
1364   1              x = 0;
1365   1              for( j = 0; j < i; j++ )        
1366   1                      x ^= (( u_char* )&SystemParameter)[j];          
1367   1              if( x != SystemParameter.Checkbyte )
1368   1              {
1369   2                      //参数校验错
1370   2                      Trace( "\n SysParam check error" );
1371   2                      HardWareErr |= 0x0100;//ERR_SYSTEM_CHECK;//ERR_SYSPARAMETER_ERR;        
1372   2              }
1373   1          //根据层架设置来配置货道设置
1374   1              memset( InputGoodsWayList, 0, sizeof( InputGoodsWayList )*GOODSWAYNUM );
1375   1              z = 0;
1376   1      
1377   1              ///根据flash值确定物理货道与逻辑货道的关系
1378   1              for( i = 0; i < RACKNUM; i++ )//货架层数
1379   1                      iRackSet[ i ].RackNo = i + 1;
1380   1              iRack = 0;
1381   1              for( i = 0; i < RACKNUM; i++ )//货架层数
1382   1              {
1383   2                      if( iRackSet[ i ].UseState == 1 )//如果此层开启了
1384   2                      {
1385   3                              j = iRackSet[ i ].GoodsMax;//此层中各货道最大存货量
1386   3                              x = 1;//辑逻货道编号的个位      
1387   3                              for( y = 0; y < RACKCOLUMNNUM; y ++ )//检索每层中开启的货道数
1388   3                              {
1389   4                                      if( iRackColumnSet[i][y].UseState == 1)
1390   4                                      {
1391   5                                              InputGoodsWayList[ z ].GoodsWayNo = ( iRack + 1 ) * 10 + x;//逻辑货道                   
1392   5                                              InputGoodsWayList[ z ].SetArrayNo = 64 - i*RACKCOLUMNNUM - 8 + y + 1;//物理货道
1393   5                                              InputGoodsWayList[ z ].UseState = 1;//开启状态
1394   5                                              InputGoodsWayList[ z ].GoodsMax = j;//最大存货量
1395   5                                              x += 1;
1396   5                                              z += 1;
1397   5                                      }
1398   4                              }
1399   3                              iRack++;
1400   3                      }
1401   2              }       
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 24  

1402   1      
1403   1              //货道数组中的货道代码初始化,确认逻辑货道的参数值       
1404   1              for( i = 0; i < GOODSWAYNUM; i++ )
1405   1              {               
1406   2                      GoodsWaySetVal[i].WayNo = InputGoodsWayList[i].GoodsWayNo;      
1407   2      #ifdef _DEBUG_TRACE
                              GoodsWaySetVal[i].WayState = 0x01;      
              #else   
1410   2              //-----------------------------------------------------------------------------
1411   2              //In GOC check mode, clear the column's error flag when power on.       
1412   2              if( SystemParameter.GOCOn == 1 )
1413   2              {
1414   3                      GoodsWaySetVal[i].WayState &= 0xfb;
1415   3              }
1416   2              //=============================================================================         
1417   2                      if( (SystemParameter.GOCOn != 0x01)&&( GoodsWaySetVal[i].GoodsCurrentSum != 0 )&&( ( GoodsWaySetVal[i].W
             -ayState & 0x0B ) == 0x01 ) )
1418   2                              GoodsWaySetVal[i].WayState = 0x01;
1419   2                      else if( (SystemParameter.GOCOn==0x01) && ( ( GoodsWaySetVal[i].WayState & 0x0B ) == 0x01 ) )
1420   2                          GoodsWaySetVal[i].WayState = 0x01;
1421   2                      else
1422   2                              GoodsWaySetVal[i].WayState = ( GoodsWaySetVal[i].WayState & 0x0F );
1423   2      #endif
1424   2              }               
1425   1              /*
1426   1              for( i = 0; i < GOODSWAYNUM; i ++ )     
1427   1              {
1428   1                      if( ( GoodsWaySetVal[i].WayNo == InputGoodsWayList[i].GoodsWayNo ) && 
1429   1                              ( InputGoodsWayList[ i ].UseState == 1 ) &&
1430   1                              ( GoodsWaySetVal[i].Price == 0 ) )
1431   1                      {
1432   1                              HardWareErr |= 0x0400;
1433   1                              break;
1434   1                      }
1435   1              }
1436   1          */
1437   1          IOUFlag = 0;        
1438   1              UpdataDisp = 0;
1439   1              SystemErrorAlarm = 0;
1440   1              MoneyDevAlarm = 0;
1441   1              AlarmTime = 0;
1442   1              QueryFlag = 0;
1443   1              memset( SMSMessage, 0, sizeof( struct SMSMessageList )* MAX_SMS_LIST );
1444   1          //ListIndex = 0;
1445   1              
1446   1          //==========================================================                
1447   1              return 0;
1448   1      }
1449          
1450          //显示退出服务
1451          u_char DisplayOutServer()
1452          {       
1453   1              SetOffFlag();
1454   1          //DispWelOrOutServ();       
1455   1              KeyLock();              //锁定键盘，不让客户按键
1456   1              KeyLockFlag = 1;
1457   1          if( HardWareErr != 0 )
1458   1          {
1459   2              if( IsModeOff() )   //是否模式开关处于关闭状态
1460   2              //if( 0 )   //是否模式开关处于关闭状态
1461   2                  {   
1462   3                  KeyUnLock();
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 25  

1463   3                              return 1;
1464   3                  }   
1465   2          }
1466   1              return 0;
1467   1      }
1468          
1469          //初始化系统参数
1470          u_char SysInitParam()
1471          {       
1472   1              u_char xdata i = 0;
1473   1              u_char xdata j = 0;
1474   1              u_char xdata x = 0 ;
1475   1              u_char xdata y = 0;
1476   1              u_char xdata z = 0;
1477   1              u_char xdata iRack = 0;
1478   1              
1479   1              GetHopperList();
1480   1              CheckHardWare( 0 );
1481   1              GetHopperList();      //获取Hopper的排序列表.
1482   1      
1483   1              //if( ( ( DeviceStatus.BillAccepter != 0 ) || ( IsCanInCashFlag == 0 ) ) && ( DeviceStatus.CoinAccepter !
             -= 0 ) )
1484   1              //      HardWareErr |= 0x0002;
1485   1      
1486   1              //清货道控制板的SN
1487   1              if( ChannelTask( 0, CHANNEL_CLEAR ) == 2 )
1488   1              {
1489   2                      //执行命令超时,应是主板与货道驱动板通讯故障
1490   2                      Trace("\n Channel are break");
1491   2                      /*
1492   2                      //Disabled by Andy on 2010.10.26
1493   2                      for( i = 0; i < GOODSWAYNUM; i ++ )     
1494   2                              GoodsWaySetVal[i].WayState = 0x09;
1495   2                      */
1496   2                      HardWareErr |= 0x0040;
1497   2                      DeviceStatus.Driver64 |= 0x01;
1498   2              }
1499   1          else
1500   1          {
1501   2              //ChannelTask( 0, CHANNEL_QUERY );
1502   2          }
1503   1              //ITLMission_Init();
1504   1              if( SystemParameter.ACDCModule == 1 )
1505   1              {
1506   2                      sysVPMission.ACDCLedCtr = 1;         //Open by default.
1507   2                      if(SystemParameter.CompModule == 1)
1508   2                      sysVPMission.ACDCCompressorCtr = 1;  //Open by default.
1509   2                  else
1510   2                              sysVPMission.ACDCCompressorCtr = 0;  //Open by default. 
1511   2                      ACDCMission();
1512   2              }
1513   1              //获取货道数
1514   1              for( i=0,j=0; i<RACKNUM; i++ )
1515   1              {
1516   2                      if(iRackSet[i].UseState == 1)
1517   2                      j++;
1518   2              }
1519   1              COLUMN_NUM_SET=j*8;
1520   1              
1521   1              return 0;       
1522   1      
1523   1      }
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 26  

1524          
1525          //加快按键反应速度;by gzz 20110721  
1526          u_char GetKeyOperStatus()
1527          {       
1528   1          u_char xdata key;
1529   1      
1530   1          //-------------------------------------------------
1531   1          //Feed the watch dog
1532   1              FeedWatchDog();
1533   1              #ifdef   _SHUPING_        
1534   1                      if( IsModeOff() )            //是否模式开关处于关闭状态
1535   1                  {   
1536   2                              return 1;
1537   2                  }
1538   1                      sysVPMission.VPMode = 0;
1539   1                      ZhkKeyPermission = 1;
1540   1                      key = 0;
1541   1              #else   
                          //================================================= 
                          //if( (sysVPMission.menuKeyNum==3)&&(sysVPMission.menuTimer>0)&&((sysVPMission.menuKey[0]==KEY_BACK)&
             -&(sysVPMission.menuKey[1]==KEY_DOT)&&(sysVPMission.menuKey[2]==KEY_SUBMIT)) )
                              //if( (sysVPMission.menuKeyNum==1)&&(sysVPMission.menuTimer>0)&&((sysVPMission.menuKey[0]==KEY_SUBMIT)) 
             -)
                              if( (sysVPMission.menuKeyNum==5)&&(sysVPMission.menuTimer>0)&&((sysVPMission.menuKey[0]==KEY_1)&&(sysVPM
             -ission.menuKey[1]==KEY_2)&&(sysVPMission.menuKey[2]==KEY_3)&&(sysVPMission.menuKey[3]==KEY_4)&&(sysVPMission.menuKey[4]=
             -=KEY_SUBMIT)) )
                              {
                                  sysVPMission.menuTimer  = 0;
                                      sysVPMission.menuKeyNum = 0;
                              sysVPMission.menuKey[0] = KEY_NULL;
                              sysVPMission.menuKey[1] = KEY_NULL;
                                      sysVPMission.menuKey[2] = KEY_NULL;
                                      sysVPMission.menuKey[3] = KEY_NULL;
                                      sysVPMission.menuKey[4] = KEY_NULL;
                                      return 1;
                              }
                              else
                              {
                                  
                                  if(sysVPMission.menuKeyNum==1)
                                      {
                                              if(sysVPMission.menuKey[0]!=KEY_1)
                                          {
                                                      sysVPMission.menuTimer = 0;
                                                      sysVPMission.menuKeyNum = 0;
                                              sysVPMission.menuKey[0] = KEY_NULL;
                                              sysVPMission.menuKey[1] = KEY_NULL;
                                                      sysVPMission.menuKey[2] = KEY_NULL;
                                                      sysVPMission.menuKey[3] = KEY_NULL;
                                              sysVPMission.menuKey[4] = KEY_NULL;
                                                      return 0;       
                                              }
                                      }
                              if(sysVPMission.menuKeyNum==2)
                                      {
                                              if(sysVPMission.menuKey[1]!=KEY_2)
                                          {
                                                      sysVPMission.menuTimer = 0;
                                                      sysVPMission.menuKeyNum = 0;
                                              sysVPMission.menuKey[0] = KEY_NULL;
                                              sysVPMission.menuKey[1] = KEY_NULL;
                                                      sysVPMission.menuKey[2] = KEY_NULL;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 27  

                                                      sysVPMission.menuKey[3] = KEY_NULL;
                                              sysVPMission.menuKey[4] = KEY_NULL;
                                                      return 0;       
                                              }
                                      }
                                      if(sysVPMission.menuKeyNum==3)
                                      {
                                              if(sysVPMission.menuKey[2]!=KEY_3)
                                          {
                                                      sysVPMission.menuTimer = 0;
                                                      sysVPMission.menuKeyNum = 0;
                                              sysVPMission.menuKey[0] = KEY_NULL;
                                              sysVPMission.menuKey[1] = KEY_NULL;
                                                      sysVPMission.menuKey[2] = KEY_NULL;
                                                      sysVPMission.menuKey[3] = KEY_NULL;
                                              sysVPMission.menuKey[4] = KEY_NULL;
                                                      return 0;       
                                              }
                                      }
                              if(sysVPMission.menuKeyNum==4)
                                      {
                                              if(sysVPMission.menuKey[3]!=KEY_4)
                                          {
                                                      sysVPMission.menuTimer = 0;
                                                      sysVPMission.menuKeyNum = 0;
                                              sysVPMission.menuKey[0] = KEY_NULL;
                                              sysVPMission.menuKey[1] = KEY_NULL;
                                                      sysVPMission.menuKey[2] = KEY_NULL;
                                                      sysVPMission.menuKey[3] = KEY_NULL;
                                              sysVPMission.menuKey[4] = KEY_NULL;
                                                      return 0;       
                                              }
                                      }
                                              
                                      
                                  sysVPMission.VPMode = 0;
                                      ZhkKeyPermission = 1;
                                      key = GetKey();
                                      sysVPMission.VPMode = 1;
                                //if( (sysVPMission.menuKeyNum<3)&&((key==KEY_BACK)||(key==KEY_DOT)||(key==KEY_SUBMIT)) )
                                      if( (sysVPMission.menuKeyNum<5)&&((key==KEY_1)||(key==KEY_2)||(key==KEY_3)||(key==KEY_4)||(key==KEY_SUB
             -MIT)) )
                                      {   
                                              sysVPMission.menuKey[sysVPMission.menuKeyNum++] = key;
                                  sysVPMission.menuTimer  = 6;
                                  ClearKey(); 
                                      }        
                                      else if(key!=KEY_NULL)
                                      {
                                              sysVPMission.menuTimer  = 0;
                                              sysVPMission.menuKeyNum = 0;
                                      sysVPMission.menuKey[0] = KEY_NULL;
                                      sysVPMission.menuKey[1] = KEY_NULL;
                                              sysVPMission.menuKey[2] = KEY_NULL;
                                              sysVPMission.menuKey[3] = KEY_NULL;
                                      sysVPMission.menuKey[4] = KEY_NULL;
                                  return 0;
                                      }  
                              if(sysVPMission.menuTimer==0)
                                      {
                                              sysVPMission.menuTimer = 0;
                                              sysVPMission.menuKeyNum = 0;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 28  

                                      sysVPMission.menuKey[0] = KEY_NULL;
                                      sysVPMission.menuKey[1] = KEY_NULL;
                                              sysVPMission.menuKey[2] = KEY_NULL;
                                              sysVPMission.menuKey[3] = KEY_NULL;
                                      sysVPMission.menuKey[4] = KEY_NULL;
                                              return 0;
                                      }      
                              }
                      #endif
1652   1              return 0;
1653   1      }
1654          
1655          u_char EndMission()
1656          {
1657   1                  CurrentPayed = 0;            //用户付款计数清零 
1658   1                  //DisplayStr( 0, __LINE0__ , 1 , "1", 1 );
1659   1                      //WaitForWork( 2000, NULL );  //500-50-100-200  
1660   1                  sysVPMission.inBillMoney = 0;
1661   1              //CurrentTransType = 0;      //设置空闲状态     
1662   1                  CasherGetMachineState( 0 );  //空闲状态
1663   1                  return 0;
1664   1      }            
1665          //查看机器是否维护状态
1666          u_char CheckOperStatus()
1667          {       
1668   1          u_char xdata key;
1669   1      
1670   1          //-------------------------------------------------
1671   1          //Feed the watch dog
1672   1              FeedWatchDog();
1673   1          //=================================================
1674   1          //
1675   1          {
1676   2                  //CurrentPayed = 0;            //用户付款计数清零 
1677   2                  sysVPMission.inBillMoney = 0;
1678   2              //CurrentTransType = 0;      //设置空闲状态     
1679   2                  CasherGetMachineState( 0 );  //空闲状态
1680   2                  key = 0;
1681   2                  WaitForWork( 10, NULL );
1682   2          }
1683   1              //if( IsModeOff() )            //是否模式开关处于关闭状态
1684   1          //{ 
1685   1              //      return 1;
1686   1          //}
1687   1      
1688   1              #ifdef   _SHUPING_
1689   1                      if( IsModeOff() )            //是否模式开关处于关闭状态
1690   1                  {   
1691   2                              return 1;
1692   2                  }
1693   1                      sysVPMission.VPMode = 0;
1694   1                      ZhkKeyPermission = 1;
1695   1              #else   
                          //if( (sysVPMission.menuKeyNum==3)&&(sysVPMission.menuTimer>0)&&((sysVPMission.menuKey[0]==KEY_BACK)&
             -&(sysVPMission.menuKey[1]==KEY_DOT)&&(sysVPMission.menuKey[2]==KEY_SUBMIT)) )
                              //if( (sysVPMission.menuKeyNum==1)&&(sysVPMission.menuTimer>0)&&((sysVPMission.menuKey[0]==KEY_SUBMIT)) 
             -)
                              if( (sysVPMission.menuKeyNum==5)&&(sysVPMission.menuTimer>0)&&((sysVPMission.menuKey[0]==KEY_1)&&(sysVPM
             -ission.menuKey[1]==KEY_2)&&(sysVPMission.menuKey[2]==KEY_3)&&(sysVPMission.menuKey[3]==KEY_4)&&(sysVPMission.menuKey[4]=
             -=KEY_SUBMIT)) )
                              {
                                  sysVPMission.menuTimer  = 0;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 29  

                                      sysVPMission.menuKeyNum = 0;
                              sysVPMission.menuKey[0] = KEY_NULL;
                              sysVPMission.menuKey[1] = KEY_NULL;
                                      sysVPMission.menuKey[2] = KEY_NULL;
                                      sysVPMission.menuKey[3] = KEY_NULL;
                                      sysVPMission.menuKey[4] = KEY_NULL;
                                      return 1;
                              }
                              else
                              {
                                  
                                  if(sysVPMission.menuKeyNum==1)
                                      {
                                              if(sysVPMission.menuKey[0]!=KEY_1)
                                          {
                                                      sysVPMission.menuTimer = 0;
                                                      sysVPMission.menuKeyNum = 0;
                                              sysVPMission.menuKey[0] = KEY_NULL;
                                              sysVPMission.menuKey[1] = KEY_NULL;
                                                      sysVPMission.menuKey[2] = KEY_NULL;
                                                      sysVPMission.menuKey[3] = KEY_NULL;
                                              sysVPMission.menuKey[4] = KEY_NULL;
                                                      return 0;       
                                              }
                                      }
                              if(sysVPMission.menuKeyNum==2)
                                      {
                                              if(sysVPMission.menuKey[1]!=KEY_2)
                                          {
                                                      sysVPMission.menuTimer = 0;
                                                      sysVPMission.menuKeyNum = 0;
                                              sysVPMission.menuKey[0] = KEY_NULL;
                                              sysVPMission.menuKey[1] = KEY_NULL;
                                                      sysVPMission.menuKey[2] = KEY_NULL;
                                                      sysVPMission.menuKey[3] = KEY_NULL;
                                              sysVPMission.menuKey[4] = KEY_NULL;
                                                      return 0;       
                                              }
                                      }
                                      if(sysVPMission.menuKeyNum==3)
                                      {
                                              if(sysVPMission.menuKey[2]!=KEY_3)
                                          {
                                                      sysVPMission.menuTimer = 0;
                                                      sysVPMission.menuKeyNum = 0;
                                              sysVPMission.menuKey[0] = KEY_NULL;
                                              sysVPMission.menuKey[1] = KEY_NULL;
                                                      sysVPMission.menuKey[2] = KEY_NULL;
                                                      sysVPMission.menuKey[3] = KEY_NULL;
                                              sysVPMission.menuKey[4] = KEY_NULL;
                                                      return 0;       
                                              }
                                      }
                              if(sysVPMission.menuKeyNum==4)
                                      {
                                              if(sysVPMission.menuKey[3]!=KEY_4)
                                          {
                                                      sysVPMission.menuTimer = 0;
                                                      sysVPMission.menuKeyNum = 0;
                                              sysVPMission.menuKey[0] = KEY_NULL;
                                              sysVPMission.menuKey[1] = KEY_NULL;
                                                      sysVPMission.menuKey[2] = KEY_NULL;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 30  

                                                      sysVPMission.menuKey[3] = KEY_NULL;
                                              sysVPMission.menuKey[4] = KEY_NULL;
                                                      return 0;       
                                              }
                                      }
                                              
                                      
                                  sysVPMission.VPMode = 0;
                                      ZhkKeyPermission = 1;
                                      key = GetKey();
                                      sysVPMission.VPMode = 1;
                                //if( (sysVPMission.menuKeyNum<3)&&((key==KEY_BACK)||(key==KEY_DOT)||(key==KEY_SUBMIT)) )
                                      if( (sysVPMission.menuKeyNum<5)&&((key==KEY_1)||(key==KEY_2)||(key==KEY_3)||(key==KEY_4)||(key==KEY_SUB
             -MIT)) )
                                      {   
                                              sysVPMission.menuKey[sysVPMission.menuKeyNum++] = key;
                                  sysVPMission.menuTimer  = 6;
                                  ClearKey(); 
                                      }        
                                      else if(key!=KEY_NULL)
                                      {
                                              sysVPMission.menuTimer  = 0;
                                              sysVPMission.menuKeyNum = 0;
                                      sysVPMission.menuKey[0] = KEY_NULL;
                                      sysVPMission.menuKey[1] = KEY_NULL;
                                              sysVPMission.menuKey[2] = KEY_NULL;
                                              sysVPMission.menuKey[3] = KEY_NULL;
                                      sysVPMission.menuKey[4] = KEY_NULL;
                                  return 0;
                                      }  
                              if(sysVPMission.menuTimer==0)
                                      {
                                              sysVPMission.menuTimer = 0;
                                              sysVPMission.menuKeyNum = 0;
                                      sysVPMission.menuKey[0] = KEY_NULL;
                                      sysVPMission.menuKey[1] = KEY_NULL;
                                              sysVPMission.menuKey[2] = KEY_NULL;
                                              sysVPMission.menuKey[3] = KEY_NULL;
                                      sysVPMission.menuKey[4] = KEY_NULL;
                                              return 0;
                                      }      
                              }
                      #endif
1805   1              
1806   1              return 0;
1807   1      }
1808          
1809          //查询硬件状态值,硬件包括键盘、液晶屏、电源，无故障返回0,有故障返回1并退出服务
1810          u_char CheckHardwareState()     
1811          {          
1812   1          //Trace( "\n HardWareErr1 = %u", HardWareErr );     
1813   1          //#ifndef _DEBUG_TRACE      
1814   1      
1815   1              /*
1816   1              if( CasherRealTimeState() == 1 )
1817   1                      DeviceStatus.BillAccepter = 1;
1818   1              else 
1819   1                      DeviceStatus.BillAccepter = 0;
1820   1          */
1821   1          u_char xdata i = 0;
1822   1              u_char xdata ch = 0;
1823   1              //u_char xdata errStat = 0;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 31  

1824   1              static u_char xdata errGOC = 0,errCoin = 0,errTube = 0,errCash = 0,errBill = 0;
1825   1              //unsigned int xdata CurrentMoney=0;
1826   1      
1827   1              UpdateSelectionLed_GoodsSta();//空闲时更新
1828   1      
1829   1              
1830   1      
1831   1      
1832   1              
1833   1              if( (SystemParameter.GOCOn==0x01)&&(DeviceStatus.GOCStatus != 0x00) /*&&(SystemParameter.SVC_GOCErr==0)*/
             - )
1834   1              {
1835   2                      //HardWareErr |= 0x0800;   //Disabled by Andy 2011.7.17
1836   2                      //errStat = 1;
1837   2                      if(errGOC==0)
1838   2                              errGOC = 1;
1839   2              }
1840   1              else
1841   1              {
1842   2                  HardWareErr &= 0xF7FF;
1843   2                      if(errGOC==2)
1844   2                              errGOC = 3;
1845   2              }
1846   1          
1847   1              //------------------------------------------------------
1848   1              if( IfGameKeyOn() )
1849   1              {
1850   2                      VPMission_Button_RPT( VP_BUT_GAME, VP_BUT_NUMBER );
1851   2              //Beep();
1852   2              }
1853   1              //If coin hopper full
1854   1              if( IfCoinHopperFull() )
1855   1              {
1856   2                      sysVPMission.coinFull = 1;
1857   2                      DeviceStatus.CoinAccepter |= 0x02;
1858   2              }
1859   1              else
1860   1              {
1861   2                      sysVPMission.coinFull = 0;
1862   2                      DeviceStatus.CoinAccepter &= 0xFD;
1863   2              }/*
1864   1          //If PC error
1865   1          if(  sysVPMission.comErrNum >= VP_TIME_OUNT_NUM )
1866   1          {           
1867   1                       HardWareErr |= 0x2000; 
1868   1                       
1869   1               MDB_Bill_EscrowCtr(0);  //Added 2011.7.19
1870   1                       if( ( CurrentPayed > 0 ) )
1871   1                       {
1872   1                          CurrentDispenseCoin = CurrentPayed; 
1873   1                              CurrentPayed = 0;
1874   1                  DisableBillDev();
1875   1                              DispenseCoin();
1876   1                  UpdateSelectionLed_GoodsSta();
1877   1                       }
1878   1                       
1879   1              }
1880   1              else
1881   1              {
1882   1               if( sysVPMission.comErrNum == 0 )  HardWareErr &= 0xdfff;
1883   1              }*/
1884   1              //If selection error
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 32  

1885   1          //if( (DeviceStatus.Selection[0] != 0) && (DeviceStatus.Selection[1] != 0) && (DeviceStatus.Selection[
             -2] != 0) )
1886   1          if( (DeviceStatus.Selection[0] != 0) || (DeviceStatus.Selection[1] != 0) || (DeviceStatus.Selection[2]
             - != 0) )
1887   1          {
1888   2              #ifdef   _SHUPING_
1889   2                              HardWareErr &= 0xEFFF;
1890   2                      #else
                                      HardWareErr |= 0x1000;                  
              
                                      ch = GetSelectionState( 1, &Selection1 );
                                  if( ch == 0 )
                                      {
                                          DeviceStatus.Selection[0] &= 0xfe;                  
                                      }
                                      else
                                      {
                                              DeviceStatus.Selection[0] |= 0x01;                      
                                      }
                                      ch = GetSelectionState( 2, &Selection2 );
                                  if( ch == 0 )
                                      {
                                          DeviceStatus.Selection[1] &= 0xfe;                  
                                      }
                                      else
                                      {
                                              DeviceStatus.Selection[1] |= 0x01;                      
                                      }
                                      ch = GetSelectionState( 3, &Selection3 );
                                  if( ch == 0 )
                                      {
                                          DeviceStatus.Selection[2] &= 0xfe;                  
                                      }
                                      else
                                      {
                                              DeviceStatus.Selection[2] |= 0x01;                      
                                      }
                              #endif
1921   2              }
1922   1              else
1923   1              {
1924   2                      HardWareErr &= 0xEFFF;
1925   2              }
1926   1      
1927   1              //
1928   1              /*
1929   1          if( SystemParameter.ACDCModule == 1 )
1930   1          {
1931   1              if( DeviceStatus.ACDCModule != 0 )
1932   1              {
1933   1                      //HardWareErr |= 0x4000;
1934   1              }
1935   1              else
1936   1              {
1937   1                              HardWareErr &= 0xBFFF;
1938   1              }
1939   1          }
1940   1              */
1941   1              if(sysVPMission.offLineFlag==1)
1942   1              {
1943   2              HardWareErr |= 0x4000;
1944   2          }
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 33  

1945   1              else
1946   1          {
1947   2                      HardWareErr &= 0xBFFF;
1948   2          }
1949   1      
1950   1              //
1951   1              //MDB_Coin_TubeSta_API();
1952   1          if( SystemParameter.SVC_NoChange != 1 )
1953   1              {
1954   2              //by gzz 20110502
1955   2                      //if(( DeviceStatus.ChangeUnit1 != 0 ) && ( sysVPMission.sTimerHopperEmp >= VPM_DEVUPDATE_HOPPEREMP )) 
1956   2              //{
1957   2                      //      sysVPMission.sTimerHopperEmp = 0;
1958   2                      //      GetDeviceStatus(2);//测试此时的找零器;by gzz 20110430
1959   2                      //}
1960   2      
1961   2                      #ifdef MACHINE_SET_MDB
1962   2                          //if( (sysMDBMission.coinDeviceStatus!=0) || (sysMDBMission.coin5jNum < 3 ) || (sysMDBMission.coinAl
             -lValue<500) )
1963   2                          if( (sysMDBMission.coinDeviceStatus!=0) || (sysMDBMission.coinAllValue<500) )
1964   2                      {
1965   3                              //HardWareErr |=        0x0008;   
1966   3                              //errStat = 1;
1967   3                      }
1968   2                              else
1969   2                              {                
1970   3                                      HardWareErr &=  0xFFF7;
1971   3                              }
1972   2                      #else
                                  if( DeviceStatus.ChangeUnit1 != 0 )
                                      {
                                              //HardWareErr |=        0x0008;
                                              //errStat = 1;
                                      }
                                      else
                                      {
                                              HardWareErr &=  0xFFF7;
                                      }
                              #endif
1983   2      
1984   2              }
1985   1              CheckGoodsSumAndLoad();  //2011.5.11 added
1986   1              
1987   1              //F1 system error
1988   1              if( (sysMDBMission.billDeviceStatus != 0)&&(sysMDBMission.coinDeviceStatus!= 0 ) )
1989   1              {
1990   2                      //HardWareErr |= 0x0001;
1991   2                      //errStat = 1;
1992   2              }
1993   1              else
1994   1              {
1995   2                  HardWareErr &= 0xfffe;
1996   2              }
1997   1          //F2 system error
1998   1              if( sysMDBMission.coinDeviceStatus != 0 )
1999   1              {
2000   2                      //HardWareErr |= 0x0002;
2001   2                      //errStat = 1;
2002   2                      if(errCoin==0)
2003   2                              errCoin = 1;
2004   2              }
2005   1              else
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 34  

2006   1              {
2007   2                  HardWareErr &= 0xfffd;
2008   2                      if(errCoin==2)
2009   2                              errCoin = 3;
2010   2              }
2011   1      
2012   1          //F0 system error
2013   1              if( sysMDBMission.tubeRemoved != 0 )
2014   1              {
2015   2                      //HardWareErr |= 0x8000;
2016   2                      //errStat = 1;
2017   2                      if(errTube==0)
2018   2                              errTube = 1;
2019   2              }
2020   1              else
2021   1              {
2022   2                  HardWareErr &= 0x7fff;
2023   2                      if(errTube==2)
2024   2                      {
2025   3                              errTube = 3;
2026   3                              sysVPMission.sTimerTubeUpdate = 15;
2027   3                      }
2028   2                      else if((errTube==3)&&(sysVPMission.sTimerTubeUpdate==0))
2029   2                      {
2030   3                              errTube=4;
2031   3                      }
2032   2              }
2033   1      
2034   1              //纸币器故障
2035   1              if(sysMDBMission.billCashBuf == 1)//钞箱移除报故障;by gzz 20121224
2036   1          {/*
2037   2              //由于投币后，不会调用这个函数,因此不用判断暂存纸币
2038   2                      if( sysITLMission.billHoldingFlag == 1 )
2039   2                      {
2040   2                              CurrentMoney = CurrentPayed + sysITLMission.billHoldingValue;
2041   2                      }
2042   2                      else
2043   2                      {
2044   2                              CurrentMoney = CurrentPayed;
2045   2                      }
2046   2                      if( (CurrentMoney == 0)&&( sysITLMission.billHoldingFlag == 0 ) )
2047   2                      {
2048   2                              errStat = 1;
2049   2                      }*/     
2050   2                      //errStat = 1;
2051   2                      if(errCash==0)
2052   2                              errCash = 1;
2053   2              }
2054   1              else
2055   1              {
2056   2                      if(errCash==2)
2057   2                              errCash = 3;
2058   2              }
2059   1              
2060   1              if( sysMDBMission.billDeviceStatus != 0 )
2061   1              {
2062   2                      //errStat = 1;
2063   2                      if(errBill==0)
2064   2                              errBill = 1;
2065   2              }       
2066   1              else
2067   1              {
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 35  

2068   2                      if(errBill==2)
2069   2                              errBill = 3;
2070   2              }
2071   1              //===========================================================
2072   1      
2073   1              //设备有故障时及时上报start_rpt         
2074   1              if(errGOC == 1)
2075   1              {
2076   2                      VPMission_Status_RPT();
2077   2                      errGOC = 2;
2078   2              }
2079   1              else if(errGOC == 3)
2080   1              {
2081   2                      VPMission_Status_RPT();
2082   2                      errGOC = 0;
2083   2              }
2084   1              
2085   1              if(errCoin == 1)
2086   1              {
2087   2                      VPMission_Status_RPT();
2088   2                      errCoin = 2;
2089   2              }
2090   1              else if(errCoin == 3)
2091   1              {
2092   2                      VPMission_Status_RPT();
2093   2                      errCoin = 0;
2094   2              }
2095   1      
2096   1              if(errTube == 1)
2097   1              {
2098   2                      VPMission_Status_RPT();
2099   2                      errTube = 2;
2100   2              }
2101   1              else if(errTube == 4)
2102   1              {
2103   2                      VPMission_Status_RPT();
2104   2                      errTube = 0;
2105   2              }
2106   1      
2107   1              if(errCash == 1)
2108   1              {
2109   2                      VPMission_Status_RPT();
2110   2                      errCash = 2;
2111   2              }
2112   1              else if(errCash == 3)
2113   1              {
2114   2                      VPMission_Status_RPT();
2115   2                      errCash = 0;
2116   2              }       
2117   1      
2118   1              if(errBill == 1)
2119   1              {
2120   2                      VPMission_Status_RPT();
2121   2                      errBill = 2;
2122   2              }
2123   1              else if(errBill == 3)
2124   1              {
2125   2                      VPMission_Status_RPT();
2126   2                      errBill = 0;
2127   2              }       
2128   1              /*if(errStat == 1)
2129   1              {
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 36  

2130   1                      if(sysVPMission.DevErrFlag == 0)
2131   1                      {
2132   1                              //DisplayStr( 0, 0, 1, "err=1",5 ); 
2133   1                              VPMission_Status_RPT();
2134   1                              sysVPMission.DevErrFlag = 1;
2135   1                      }
2136   1              }
2137   1              else
2138   1              {
2139   1                      if(sysVPMission.DevErrFlag == 1)
2140   1                      {
2141   1                              //DisplayStr( 0, 0, 1, "err=0",5 );  
2142   1                              VPMission_Status_RPT();
2143   1                              sysVPMission.DevErrFlag = 0;
2144   1                      }
2145   1              }*/
2146   1              //WaitForWork(2000,NULL);
2147   1              
2148   1              
2149   1              //是否进入故障页面
2150   1              if( HardWareErr == 0 )  
2151   1              {
2152   2                  //Added for the column' 0 status error. 2011.5.12
2153   2              /*
2154   2                  for( i=0; i<48; i++ )
2155   2                      {
2156   2                              if( (GoodsWaySetVal[i].WayState&0x01)==0 )
2157   2                              {
2158   2                                      GoodsWaySetVal[i].WayState |= 0x01;
2159   2                              }
2160   2                      }
2161   2              */
2162   2              sysVPMission.hardWareErrShow = 0;//清除运行故障码;by gzz 20111028
2163   2                      LogicOpen();            
2164   2                      if(sysVPMission.ErrFlag2 == 1)
2165   2                      {
2166   3                              /*if( SystemParameter.ACDCModule == 1 )
2167   3                              {
2168   3                                      sysVPMission.ACDCLedCtr = 1;         //Open by default.
2169   3                                      if(SystemParameter.CompModule == 1)
2170   3                                      sysVPMission.ACDCCompressorCtr = 1;  //Open by default.
2171   3                                  else
2172   3                                              sysVPMission.ACDCCompressorCtr = 0;  //Open by default. 
2173   3                                      ACDCMission();
2174   3                              }*/
2175   3                              sysVPMission.billCoinEnable = 1;
2176   3                              sysVPMission.ErrFlag2 = 0;
2177   3                              //if(sysVPMission.ErrFlag==1)
2178   3                              //{
2179   3                                      //sysVPMission.ErrFlag=0;
2180   3                                      //VPMission_Status_RPT();
2181   3                              //}
2182   3                      }               
2183   2                      return 0;
2184   2              }
2185   1              /*
2186   1              //添加非现金交易模式;by gzz 20110727
2187   1              //else if(( HardWareErr & 0x0001 )||( HardWareErr & 0x0002 )||( HardWareErr & 0x0004 )||( HardWareErr & 0
             -x0008 ))
2188   1          //添加f0币管没锁紧;by gzz 20110825
2189   1              else if(( HardWareErr & 0x0001 )||( HardWareErr & 0x0002 )||( HardWareErr & 0x0004 )||( HardWareErr & 0x0
             -008 )||( HardWareErr & 0x8000 ))
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 37  

2190   1          {
2191   1                  if( sysVPMission.systemErr != HardWareErr )
2192   1                      {
2193   1                              GetKey();   //Close the selection ready led
2194   1                  sysVPMission.systemErr = HardWareErr;
2195   1                      }
2196   1                  SetCashLessFlag();
2197   1                      //if(sysVPMission.ErrFlag==0)
2198   1                      //{
2199   1                      //      sysVPMission.ErrFlag=1;
2200   1                      //      VPMission_Status_RPT();
2201   1                      //}
2202   1                      return 1;
2203   1              }
2204   1              */
2205   1              else  
2206   1              {
2207   2                  if( sysVPMission.systemErr != HardWareErr )
2208   2                      {
2209   3                              GetKey();   //Close the selection ready led
2210   3                  sysVPMission.systemErr = HardWareErr;
2211   3                      }
2212   2                  SetOffFlag();
2213   2                      //if(sysVPMission.ErrFlag==0)
2214   2                      //{
2215   2                      //      sysVPMission.ErrFlag=1;
2216   2                      //      VPMission_Status_RPT();
2217   2                      //}             
2218   2                      return 1;
2219   2              }
2220   1      
2221   1      }
2222          
2223          
2224          u_char CheckQureyCmd()
2225          {
2226   1              return 0;
2227   1      }
2228          
2229          u_char CycleSendSMS()
2230          {
2231   1              return 0;
2232   1      }
2233          
2234          //判断清除友宝销售记录
2235          u_char IsTradeClear()
2236          {
2237   1              u_char xdata str[20];
2238   1              u_char xdata cmdlen=0;
2239   1              
2240   1              //1.看是否需要清除友宝销售记录120521 by cq SellAccumulate    
2241   1          PrintTest( "IsNeedClear");
2242   1              WaitForWork( 3000, NULL );      
2243   1              cmdlen=getPcCmd(str);
2244   1              if(cmdlen>0)
2245   1              {
2246   2                      //PrintTest( "\n get,%s",str);                  
2247   2                      if((str[0]=='c')&&(str[1]=='l')&&(str[2]=='e')&&(str[3]=='a')&&(str[4]=='r'))
2248   2                      {
2249   3                              //PrintTest( "\n get clear");                   
2250   3                              TradeCounter.vpSuccessNum = 0;
2251   3                              TradeCounter.vpSuccessMoney = 0;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 38  

2252   3                              TradeCounter.vpCashNum = 0;
2253   3                              TradeCounter.vpCashMoney = 0;
2254   3                              TradeCounter.vpGameNum = 0;
2255   3                              //TradeCounter.vpGameMoney = 0;
2256   3                              TradeCounter.vpCardNum = 0;
2257   3                              //TradeCounter.vpCardMoney = 0;
2258   3                              TradeCounter.vpOnlineNum = 0;
2259   3                              //TradeCounter.vpOnlineMoney = 0;                                                       
2260   3                              //memset( &TradeCounter, 0, sizeof(TradeCounter) );     
2261   3      
2262   3                          //总交易记录
2263   3                              TradeCounter.CoinSum1y = 0;
2264   3                              TradeCounter.CoinSum5j = 0;
2265   3                              TradeCounter.CashSum = 0;
2266   3                              TradeCounter.Hopper1Sum = 0;
2267   3                              TradeCounter.Hopper2Sum = 0;
2268   3                              //区间交易记录
2269   3                              TradeCounter.CoinSum1yBack = 0;
2270   3                              TradeCounter.CoinSum5jBack = 0;
2271   3                              TradeCounter.CashSumBack = 0;
2272   3                              TradeCounter.Hopper1SumBack = 0;
2273   3                              TradeCounter.Hopper2SumBack = 0;
2274   3                              SaveTradeParam();//by gzz 20110610
2275   3                              PrintTest( "ClearOK");
2276   3                      }                       
2277   2              }
2278   1              return 0;
2279   1      }
2280          
2281          //判断货道状态
2282          unsigned char GoodState(u_char i)
2283          {
2284   1              if(( GoodsWaySetVal[i].WayState & 0x01 )!= 0x01)
2285   1              {
2286   2                  //未
2287   2                  return 0;
2288   2              }
2289   1              else if( GoodsWaySetVal[i].WayState & 0x0A )
2290   1              {
2291   2                  //故
2292   2                  return 2;
2293   2              }
2294   1              else if( (GoodsWaySetVal[i].WayState & 0x04) || (GoodsWaySetVal[i].GoodsCurrentSum == 0) )
2295   1              {
2296   2                  //缺
2297   2                  return 3;
2298   2              }
2299   1              else
2300   1              {
2301   2                  //正
2302   2                  return 1;
2303   2              }
2304   1      }
2305          
2306          
2307          unsigned char isEmpty_Goods()//判断整个机器是否有货可以购买,是返回1,否返回0
2308          {
2309   1              u_char xdata i = 0,j=0; 
2310   1              /*
2311   1              for( j=0; j<GOODSTYPEMAX; j++ )
2312   1              {
2313   1                      for( i=0; i<COLUMN_NUM_SET; i++ )
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 39  

2314   1                  {
2315   1                      if(GoodsWaySetVal[i].GoodsType == SystemParameter.selItem[j])
2316   1                      {
2317   1                              if( ( GoodsWaySetVal[i].GoodsCurrentSum > 0 )&&( GoodsWaySetVal[i].Price > 0 ) )
2318   1                              {
2319   1                                      return 1;
2320   1                              }
2321   1                      }
2322   1                      }
2323   1              }*/
2324   1              for( i=0; i<COLUMN_NUM_SET; i++ )
2325   1          {
2326   2                      if( ( GoodsWaySetVal[i].GoodsCurrentSum > 0 )&&( GoodState(i) == 1 ) )
2327   2                      {
2328   3                              return 1;
2329   3                      }
2330   2              }
2331   1              return 0;
2332   1      }
2333          
2334          
2335          //判断货道库存和货道状态
2336          u_char CheckGoodsSumAndLoad()
2337          {
2338   1              u_char xdata i = 0;     
2339   1              u_char xdata j = 0;
2340   1              /*
2341   1          //Trace( "\n CheckCardSumAndLoad" );
2342   1              for( i = 0; i < GOODSWAYNUM; i ++ )
2343   1              {
2344   1                  if( SystemParameter.GOCOn != 0x01 )
2345   1                      {
2346   1                              if(( GoodsWaySetVal[i].GoodsCurrentSum != 0 ) && ( ( GoodsWaySetVal[i].WayState & 0x0A ) == 0x00 ) && 
2347   1                                                              ( GoodsWaySetVal[i].Price != 0 ) )
2348   1                                      break;
2349   1                      }
2350   1                      else
2351   1                      {
2352   1                        //if(( (GoodsWaySetVal[i].WayState & 0x04) == 0 )&&( ( GoodsWaySetVal[i].WayState & 0x0A ) == 0x00 )&&
             -( GoodsWaySetVal[i].Price != 0 ) )
2353   1                              if( ( GoodsWaySetVal[i].GoodsCurrentSum != 0 ) && ( (GoodsWaySetVal[i].WayState & 0x04) == 0 )&&( ( Goo
             -dsWaySetVal[i].WayState & 0x0A ) == 0x00 )&&( GoodsWaySetVal[i].Price != 0 ) )
2354   1                                      break;
2355   1                      }
2356   1              }
2357   1      
2358   1              if( i == GOODSWAYNUM )
2359   1              {
2360   1              //Trace( "\n HardWareErr |= 0x0080 " );
2361   1                      HardWareErr |= 0x0080;
2362   1                      for( i = 0; i < GOODSWAYNUM; i ++ )
2363   1                      {
2364   1                          if( SystemParameter.GOCOn != 0x01 )
2365   1                              {
2366   1                                      if( GoodsWaySetVal[i].GoodsCurrentSum != 0 ) 
2367   1                                              break;
2368   1                              }
2369   1                              else
2370   1                              {
2371   1                                  if( (GoodsWaySetVal[i].WayState & 0x04) == 0 )
2372   1                                          break;
2373   1                              }
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 40  

2374   1                      }
2375   1              
2376   1                      if( i == GOODSWAYNUM )
2377   1                      {
2378   1                              HardWareErr |= 0x0010;          
2379   1                  //Trace( "\n CheckCardSumAndLoad all no goods" );
2380   1                      }
2381   1                      else
2382   1                      {
2383   1                              for( i = 0; i < GOODSWAYNUM; i ++ )
2384   1                              {
2385   1                                      if( ( GoodsWaySetVal[i].WayState & 0x0A ) == 0x00 )
2386   1                                              break;
2387   1                              }
2388   1      
2389   1                              if( i == GOODSWAYNUM )
2390   1                              {                       
2391   1                      //Trace( "\n CheckCardSumAndLoad colnum no ok" );
2392   1                                      HardWareErr |= 0x0020;
2393   1                              }
2394   1                      }               
2395   1              }
2396   1              */
2397   1          //-----------------------------------------------------
2398   1          //UpdateGoodsMatrixStatus();
2399   1          /*
2400   1              for( i=0; i<GOODSTYPEMAX; i++ )
2401   1              {
2402   1                      //if( sysGoodsMatrix[i].NextColumn != 0xff )
2403   1                      //      break;
2404   1              //添加price=0的货道判断;by gzz 20110614
2405   1              if( (sysGoodsMatrix[i].NextColumn != GOODS_MATRIX_NONE)&&(sysGoodsMatrix[i].Price != 0) )
2406   1                      {
2407   1                              break;
2408   1                      }
2409   1              }
2410   1              */
2411   1              //if( i >= GOODSTYPEMAX )
2412   1              if(isEmpty_Goods()==0)
2413   1              {
2414   2                      HardWareErr |= 0x0080;
2415   2              }
2416   1              //=====================================================
2417   1          if( HardWareErr > 0 )
2418   1              {
2419   2                      //if(sysVPMission.ErrFlag==0)
2420   2                      //{
2421   2                      //      sysVPMission.ErrFlag=1;
2422   2                      //      VPMission_Status_RPT();
2423   2                      //}
2424   2                  return 1;
2425   2              }
2426   1              else
2427   1              {
2428   2                  sysVPMission.hardWareErrShow = 0;//清除运行故障码;by gzz 20111028       
2429   2                      if(sysVPMission.ErrFlag2 == 1)
2430   2                      {
2431   3                              /*if( SystemParameter.ACDCModule == 1 )
2432   3                              {
2433   3                                      sysVPMission.ACDCLedCtr = 1;         //Open by default.
2434   3                                      if(SystemParameter.CompModule == 1)
2435   3                                      sysVPMission.ACDCCompressorCtr = 1;  //Open by default.
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 41  

2436   3                                  else
2437   3                                              sysVPMission.ACDCCompressorCtr = 0;  //Open by default. 
2438   3                                      ACDCMission();
2439   3                              }*/
2440   3                              sysVPMission.billCoinEnable = 1;
2441   3                              sysVPMission.ErrFlag2 = 0;
2442   3                              //if(sysVPMission.ErrFlag==1)
2443   3                              //{
2444   3                                      //sysVPMission.ErrFlag=0;
2445   3                                      //VPMission_Status_RPT();
2446   3                              //}
2447   3                      }
2448   2                      return 0;
2449   2              }
2450   1      }
2451          
2452          //检查是否有币插入
2453          u_char  IsInsertBill()
2454          {       
2455   1              u_int  xdata CoinSum = 0;
2456   1              u_char xdata flag = 0;
2457   1              u_char xdata mission = 0;
2458   1          u_char xdata holdFlag = 0;
2459   1              //u_int  xdata coinMoney = 0;
2460   1          u_char xdata coinFlag = 0;
2461   1              u_int  xdata CurrentDomain = 0;
2462   1          u_int  xdata BankMaxBuf = 0;
2463   1          u_char xdata BankMaxFlag = 0;
2464   1              u_char xdata tempTradeTime = 15;
2465   1              //u_char xdata m_str[20];
2466   1              u_char xdata len = 0;
2467   1          u_char xdata length = 0;
2468   1              u_char xdata line[26];
2469   1              u_int  xdata Money = 0;
2470   1              
2471   1              if(SystemParameter.tradeTime==255)
2472   1                      tempTradeTime = 255;
2473   1              else if(SystemParameter.tradeTime>=240)
2474   1                      tempTradeTime = 254;
2475   1              else
2476   1                      tempTradeTime += SystemParameter.tradeTime;
2477   1      
2478   1              if( SystemParameter.BillNo == 0 )
2479   1                      return 0;
2480   1              
2481   1              mission = MDB_Coin_IfDeposited( sysMDBMission.coinBuf, &sysMDBMission.coinBufLen, &sysMDBMission.coinType
             -, &sysMDBMission.coinStock );
2482   1          if( mission == 1 )
2483   1              {
2484   2                      //DisplayStr( 0, 1, 1, "coin2", 4 );
2485   2                      //WaitForWork( 2000, NULL );
2486   2                      CoinSum = SystemParameter.coinValue[sysMDBMission.coinType];
2487   2                      //Update the coin type's coin num and value
2488   2                      if( sysMDBMission.coinType == 0 )
2489   2                      {
2490   3                              sysMDBMission.coin5jNum = sysMDBMission.coinStock;
2491   3                  sysMDBMission.coin5jValue = sysMDBMission.coin5jNum*SystemParameter.coinValue[sysMDBMission.co
             -inType];
2492   3                              sysMDBMission.coinAllValue = sysMDBMission.coin5jValue + sysMDBMission.coin1yValue;
2493   3                      }
2494   2                      else if( sysMDBMission.coinType == 1 )
2495   2                      {
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 42  

2496   3                          sysMDBMission.coin1yNum = sysMDBMission.coinStock;
2497   3                  sysMDBMission.coin1yValue = sysMDBMission.coin1yNum*SystemParameter.coinValue[sysMDBMission.co
             -inType];
2498   3                              sysMDBMission.coinAllValue = sysMDBMission.coin5jValue + sysMDBMission.coin1yValue;
2499   3                      }
2500   2              coinFlag = 1;
2501   2                      flag = 1;
2502   2              #ifdef _COIN_INPUT_PARALLEL     
2503   2                              CurrentPayed += CoinSum;
2504   2                              //TradeCounter.TrueCurrencySum += CoinSum;
2505   2                              //TradeCounter.CoinSum += CoinSum;
2506   2                              /*
2507   2                      if( CoinSum == SystemParameter.coinValue[0] )
2508   2                      {
2509   2                              TradeCounter.CoinSum5j += CoinSum;
2510   2                      }
2511   2                      else
2512   2                      {
2513   2                          TradeCounter.CoinSum1y += CoinSum;
2514   2                      }
2515   2                              */
2516   2                              //------------------------------------------------------
2517   2                              sysVPMission.payInCoinFlag = 1;
2518   2                              sysVPMission.payInCoinMoney += CoinSum;                 
2519   2                              //======================================================
2520   2                      #else
                                      CurrentPayed += CoinSum * COINMULTIPLE ;
                                      //TradeCounter.TrueCurrencySum += CoinSum * COINMULTIPLE;
                                      //TradeCounter.CoinSum += CoinSum * COINMULTIPLE;
                                      /*
                              if( ( CoinSum*COINMULTIPLE ) == SystemParameter.coinValue[0] )
                              {
                                      TradeCounter.CoinSum5j += CoinSum*COINMULTIPLE;
                              }
                              else
                              {
                                  TradeCounter.CoinSum1y += CoinSum*COINMULTIPLE;
                              }
                                      */
                                      //------------------------------------------------------
                                      sysVPMission.payInCoinFlag = 1;
                                      sysVPMission.payInCoinMoney += CoinSum*COINMULTIPLE;                    
                                      //======================================================
                              #endif
2539   2                      //WaitForWork(200,NULL);
2540   2                      MDB_Coin_TubeSta_API();
2541   2                      //WaitForWork(200,NULL);
2542   2              //reset the trade timer
2543   2                  sysVPMission.sTimer1 = tempTradeTime;
2544   2              }
2545   1          //
2546   1          if( coinFlag == 1 )
2547   1              {
2548   2                      if( SystemParameter.coinValue[sysMDBMission.coinType] == SystemParameter.coinValue[0] )
2549   2                      {
2550   3                              //总
2551   3                      //TradeCounter.CoinSum5j += SystemParameter.coinValue[sysMDBMission.coinType];
2552   3                       SellAccumulateMoney(&TradeCounter.CoinSum5j,SystemParameter.coinValue[sysMDBMission.coinType]);
2553   3                              //区间
2554   3                      //TradeCounter.CoinSum5jBack += SystemParameter.coinValue[sysMDBMission.coinType];
2555   3                      SellAccumulateMoney(&TradeCounter.CoinSum5jBack,SystemParameter.coinValue[sysMDBMission.coinType]
             -);
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 43  

2556   3              }
2557   2              else if( SystemParameter.coinValue[sysMDBMission.coinType] == SystemParameter.coinValue[1] )
2558   2              {
2559   3                      //总
2560   3                  //TradeCounter.CoinSum1y += SystemParameter.coinValue[sysMDBMission.coinType];
2561   3                  SellAccumulateMoney(&TradeCounter.CoinSum1y,SystemParameter.coinValue[sysMDBMission.coinType])
             -;
2562   3                              //区间
2563   3                  //TradeCounter.CoinSum1yBack += SystemParameter.coinValue[sysMDBMission.coinType];
2564   3                  SellAccumulateMoney(&TradeCounter.CoinSum1yBack,SystemParameter.coinValue[sysMDBMission.coinTy
             -pe]);
2565   3              }
2566   2                      memset(sysMDBMission.coinBuf,0,sizeof(sysMDBMission.coinBuf));
2567   2                      sysMDBMission.coinBufLen=0;
2568   2                      sysMDBMission.coinType=0;
2569   2                      sysMDBMission.coinStock=0;
2570   2              }
2571   1      
2572   1      
2573   1          //Trace( "\n IsInsertBill" );       
2574   1              if( SystemParameter.BillNo == 1 )
2575   1              {
2576   2                  if( sysITLMission.ITLSet == 1 )
2577   2                      {
2578   3                  
2579   3                              
2580   3                              mission = MDB_Bill_IfSecrow( sysMDBMission.billBuf, &sysMDBMission.billBufLen, &sysMDBMission.billType 
             -);
2581   3                  if( mission == 1 )
2582   3                      {
2583   4                      sysITLMission.billSta &= ~ITL_BILL_READ;    //2011.04.13 added
2584   4                      sysITLMission.billStaCtr |= ITL_BILL_READ;  //2011.04.13 added
2585   4                      //添加不找零模式的判断;by gzz 20111019
2586   4                      //if((sysMDBMission.coin5jValue+sysMDBMission.coin1yValue)>=SystemParameter.BanknoteMax)
2587   4                      if( sysVPMission.tubeCoinMoney > SystemParameter.BanknoteMax )
2588   4                                      {
2589   5                              BankMaxBuf = SystemParameter.BanknoteMax;
2590   5                          BankMaxFlag = 0;
2591   5                      }
2592   4                      else
2593   4                      {
2594   5                              BankMaxBuf = sysVPMission.tubeCoinMoney;
2595   5                          BankMaxFlag = 1;
2596   5                      }
2597   4                                      //硬币器故障纸币全部暂存
2598   4                                      if( ( sysMDBMission.coinDeviceStatus != 0 )||( sysMDBMission.tubeRemoved == 1 ) )
2599   4                                      {
2600   5                                              BankMaxBuf = 0;
2601   5                                      }
2602   4                                      /*
2603   4                      if( CurrentPayed+SystemParameter.billValue[sysMDBMission.billType] > BankMaxBuf )
2604   4                      {
2605   4                                              mission = MDB_Bill_EscrowCtr( 0 );
2606   4                          sysITLMission.billStaCtr &= ~ITL_BILL_READ;  //Added by Andy 2011.5.31
2607   4                          if(BankMaxFlag == 0)
2608   4                          {                                   
2609   4                                  DisplayLine = STR_DOMAIN_ERROR;
2610   4                                                      DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine
             -].len );
2611   4                                                      ClearDisplayLine( 2 );
2612   4                                                      WaitForWork( 1500, NULL );                                      
2613   4                          }
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 44  

2614   4                          else
2615   4                          {                                   
2616   4                                  DisplayLine = STR_COIN_NOT_ENOUGH;
2617   4                                                      DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine
             -].len );
2618   4                                                      DisplayLine = STR_DOMAIN_ERROR;
2619   4                                                      DisplayStr( 0, __LINE1__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine
             -].len );
2620   4                                                      WaitForWork( 1500, NULL );                                      
2621   4                          }
2622   4                                              DisplayCurrentMoney( CurrentPayed );
2623   4                                      }
2624   4                      else
2625   4                      {
2626   4                      */  
2627   4                      //len = sprintf( m_str, "bill=%u.%02u,max=%u.%02u", (CurrentPayed+SystemParameter.billValu
             -e[sysMDBMission.billType])/SystemParameter.curUnit,(CurrentPayed+SystemParameter.billValue[sysMDBMission.billType])%Syst
             -emParameter.curUnit,BankMaxBuf/SystemParameter.curUnit,BankMaxBuf%SystemParameter.curUnit );
2628   4                                      //DisplayStr( 0, 1, 1, m_str, strlen(m_str) );
2629   4                                      //WaitForWork( 500, NULL );
2630   4                                      
2631   4                      if((CurrentPayed+SystemParameter.billValue[sysMDBMission.billType]) >= BankMaxBuf)
2632   4                      {  
2633   5                              sysITLMission.billHoldingFlag = 1;
2634   5                                              sysITLMission.billHoldingValue = SystemParameter.billValue[sysMDBMission.billType];
2635   5                                              sysVPMission.escrowInFlag = 1;
2636   5                                              sysVPMission.escrowMoney = sysITLMission.billHoldingValue;
2637   5                          UpdateSelLed_Trade();
2638   5                                              DisplayCurrentMoney( CurrentPayed/*+sysITLMission.billHoldingValue*/ );                                                         
2639   5                          //reset the trade timer
2640   5                                              sysVPMission.sTimer1 = tempTradeTime;
2641   5                              flag = 1;
2642   5                                              sysITLMission.restartTime = ITL_TIME_RESTART; //reset the timer!
2643   5                                              //----------------------------------------------------------------------
2644   5                                                  //Send the holding message to PC in here!
2645   5                                     
2646   5                                      }
2647   4                      //正常压钞模式
2648   4                      else
2649   4                      {
2650   5                          sysITLMission.billSta    &= ~ITL_BILL_CREDIT;
2651   5                                  sysITLMission.billStaCtr &= ~ITL_BILL_READ;
2652   5                                  mission = MDB_Bill_EscrowCtr( 1 );
2653   5                                              if(mission==0)
2654   5                                              {
2655   6                                                  sysVPMission.billSTimer = TIME_BILL_STACK;
2656   6                                                  while( sysVPMission.billSTimer )
2657   6                                                      {
2658   7                                  mission = MDB_Bill_IfStacked( sysMDBMission.billBuf, &sysMDBMission.billBufLen
             - );
2659   7                                                              if( mission == 1 )
2660   7                                                              {
2661   8                                                                  CurrentDomain = SystemParameter.billValue[sysMDBMission.billType];
2662   8                                                                      Trace( "\n Get in Cash Ok" );
2663   8                                                                      //CurrentDomain = GetCash();
2664   8                                                                      Trace( "\n CurrentDomain = %d",CurrentDomain );         
2665   8                                                                      CurrentPayed += CurrentDomain * BILLMULTIPLE;   
2666   8                                                                      sysVPMission.inBillMoney += CurrentDomain * BILLMULTIPLE;//保存纸币压抄金额;
2667   8                                                                      //TradeCounter.TrueCurrencySum += CurrentDomain * BILLMULTIPLE;
2668   8                                                                      //TradeCounter.CashSum += CurrentDomain * BILLMULTIPLE;
2669   8                                                                      //TradeCounter.CashSumBack += CurrentDomain * BILLMULTIPLE;//区间
2670   8                                                                      SellAccumulateMoney(&TradeCounter.CashSum,CurrentDomain * BILLMULTIPLE);
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 45  

2671   8                                                                      SellAccumulateMoney(&TradeCounter.CashSumBack,CurrentDomain * BILLMULTIPLE);
2672   8                                                                      //------------------------------------------------------
2673   8                                                                      sysVPMission.payInBillFlag = 1;
2674   8                                                                      sysVPMission.payInBillMoney += CurrentDomain * BILLMULTIPLE;
2675   8                                                                      //reset the trade timer
2676   8                                                              sysVPMission.sTimer1 = tempTradeTime;
2677   8                                                                      //======================================================
2678   8                                                                      sysITLMission.restartTime = ITL_TIME_RESTART; //reset the timer!
2679   8                                                                      memset(sysMDBMission.billBuf,0,sizeof(sysMDBMission.billBuf));
2680   8                                                                      sysMDBMission.billBufLen=0;
2681   8                                                                      sysMDBMission.billType=0;
2682   8                                                                      sysMDBMission.billStock=0;
2683   8                                                                      flag = 1;
2684   8                                      break;//压钞成功后，直接跳出时间循环等待;by gzz 20110721 
2685   8                                                              }
2686   7                                                              else
2687   7                                                              {
2688   8                                                                  VP_GameKeyPoll( 200 );
2689   8                                                              }
2690   7                                                      }
2691   6                              //钞箱满，钞箱压钞后就能时，还可以认到纸币;by gzz 20111017
2692   6                              if( sysVPMission.billSTimer == 0 )
2693   6                              {                                                           
2694   7                                                              //检测纸币器钞箱是否已满;by gzz 20111014 
2695   7                                                              WaitForWork(2000,NULL);
2696   7                                  MDB_Bill_Stacker( &sysMDBMission.billBuf[0], &sysMDBMission.billBuf[1] ); 
2697   7                                      if(sysMDBMission.billIsFull==1)
2698   7                                  {
2699   8                                                                  CurrentDomain = SystemParameter.billValue[sysMDBMission.billType];
2700   8                                                                      Trace( "\n Get in Cash Ok" );
2701   8                                                                      //CurrentDomain = GetCash();
2702   8                                                                      Trace( "\n CurrentDomain = %d",CurrentDomain );         
2703   8                                                                      CurrentPayed += CurrentDomain * BILLMULTIPLE;   
2704   8                                                                      //TradeCounter.TrueCurrencySum += CurrentDomain * BILLMULTIPLE;
2705   8                                                                      //TradeCounter.CashSum += CurrentDomain * BILLMULTIPLE;
2706   8                                                                      //TradeCounter.CashSumBack += CurrentDomain * BILLMULTIPLE;//区间
2707   8                                                                      SellAccumulateMoney(&TradeCounter.CashSum,CurrentDomain * BILLMULTIPLE);
2708   8                                                                      SellAccumulateMoney(&TradeCounter.CashSumBack,CurrentDomain * BILLMULTIPLE);
2709   8                                                                      //------------------------------------------------------
2710   8                                                                      sysVPMission.payInBillFlag = 1;
2711   8                                                                      sysVPMission.payInBillMoney += CurrentDomain * BILLMULTIPLE;
2712   8                                                                      //reset the trade timer
2713   8                                                              sysVPMission.sTimer1 = tempTradeTime;
2714   8                                                                      //======================================================
2715   8                                                                      sysITLMission.restartTime = ITL_TIME_RESTART; //reset the timer!
2716   8                                                                      memset(sysMDBMission.billBuf,0,sizeof(sysMDBMission.billBuf));
2717   8                                                                      sysMDBMission.billBufLen=0;
2718   8                                                                      sysMDBMission.billType=0;
2719   8                                                                      sysMDBMission.billStock=0;
2720   8                                                                      flag = 1;                                    
2721   8                                                              }
2722   7                              }
2723   6                                  }
2724   5                                              
2725   5                      }
2726   4                      
2727   4                  }
2728   3                              
2729   3                      }
2730   2                      else
2731   2                      {
2732   3                              if ( CasherIsCashIn())
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 46  

2733   3                              {
2734   4                                      Trace( "\n Casher" ); 
2735   4                                      flag = 1;
2736   4                              }
2737   3                              WaitForWork( 10, NULL );
2738   3                      }
2739   2              }
2740   1          
2741   1                      
2742   1              //WaitForWork( 10, NULL );
2743   1              if( flag == 0 )
2744   1              {       
2745   2              //Trace( "\n NOT Bill Insert" );
2746   2                      if( ( sysVPMission.dspCtr & 0x01 ) )
2747   2                      {
2748   3                              sysVPMission.dspCtr &= 0xfe;
2749   3                              if( sysITLMission.billHoldingFlag == 1 )
2750   3                              {
2751   4                                      if( (CurrentPayed+sysITLMission.billHoldingValue) >= 1 )
2752   4                                      {
2753   5                                              DisplayCurrentMoney( CurrentPayed );
2754   5                                      }
2755   4                              }
2756   3                              else
2757   3                              {
2758   4                                      if( CurrentPayed >= 1 )
2759   4                                      {
2760   5                                              DisplayCurrentMoney( CurrentPayed );
2761   5                                      }
2762   4                              }
2763   3                      }
2764   2      
2765   2                      Money = CurrentPayed;
2766   2                      if( sysITLMission.billHoldingFlag == 1 )
2767   2                      {
2768   3                              Money += sysITLMission.billHoldingValue;
2769   3                      }
2770   2                      
2771   2                      if( (sysVPMission.sTimer1 < 255)&&(Money > 0) )
2772   2                      {
2773   3                              length = sprintf( line , "%s 倒计时[%u]" , DispInformationTable[STR_VP_SELECTGOODS].str,sysVPMission.sT
             -imer1 );
2774   3                              DisplayStr( 0, 1, 1,line, strlen(line) );  
2775   3                              //WaitForWork(200,NULL);
2776   3                      }
2777   2                      return 2;
2778   2              }
2779   1              else
2780   1              {
2781   2              //Trace( "\n Have Bill Insert" );
2782   2                      return  1;
2783   2              }
2784   1      }
2785          
2786          //有数字键输入，返回1,否则返回2
2787          u_char CheckKeyPress()
2788          {
2789   1              u_char xdata key = 0;
2790   1      
2791   1          //Trace( "\n CheckKeyPress" );
2792   1              //if( SystemStatus != 1 )
2793   1              if( (SystemStatus != 1) && (sysVPMission.SystemState != 1) )//只有暂停服务模式，才做这个;by gzz 20110727
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 47  

2794   1          { 
2795   2                  //Added to close the ready led
2796   2                      //2011.7.17 But isn't a good solution here! 
2797   2                  //Selection1Query();
2798   2                      //Selection2Query();
2799   2                      //Selection3Query();
2800   2                  return 2;             //系统关闭，按键不理,当做没按
2801   2          }           
2802   1              key = GetKey();
2803   1          //Trace( "\n CheckKeyPress key1 = %bu", key );
2804   1              //--------------------------------------------------------------
2805   1              //if( ( key > 0 ) && ( key <= 9 ) )
2806   1      #ifdef   _SHUPING_
2807   1              if( ( key > 0 ) && ( key <= 9 ) )
2808   1              {
2809   2      //              Trace( "\n CheckKeyPress key2 = %bu", key );
2810   2                      CurrentStockCode = key + CurrentStockCode*10;
2811   2                      if( QueryFlag == 0 )
2812   2                      {
2813   3                              QueryFlag = 1;
2814   3                              QueryTimer = 30;
2815   3                      }
2816   2                      return 1;
2817   2              }
2818   1      #else
                      if( ( key >= SELECTION_VAL_MIN )&&( key <= SELECTION_VAL_MAX ) )
                      {
                      //Trace( "\n CheckKeyPress key2 = %bu", key );
                              //CurrentStockCode = key + CurrentStockCode*10;
                              //CurrentStockCode = key;
                      //sysVPMission.key = sysVPMission.selItem[key - 1];
                              //sysVPMission.key = SystemParameter.selItem[key - 1];
                              sysVPMission.key = key;
                              sysVPMission.goodsType = key;   //2011.2.23 reenabled for the card trade bug.
                          //===============================================================
                          /*---------------------------------------------------------------
                              Disabled by 2011.6.14
                              if( QueryFlag == 0 )
                              {
                                      QueryFlag = 1;
                                      QueryTimer = 30;
                              }
                              ==================================================================
                              */
                              return 1;
                      }
              #endif
2841   1              else if( key == KEY_CANCEL )
2842   1              {
2843   2                      DisplayCursorState( 0, 1, 1, 0, 1 );
2844   2                      QueryFlag = 0;
2845   2                      QueryTimer = 0;
2846   2                      CurrentStockCode = 0;
2847   2                      UpdataDisp = 6;
2848   2                      return 2;
2849   2              }               
2850   1              else
2851   1              {
2852   2                      if( ( QueryFlag == 1 ) && ( QueryTimer == 0 ) )
2853   2                      {
2854   3                              DisplayCursorState( 0, 1, 1, 0, 1 );
2855   3                              QueryFlag = 0;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 48  

2856   3                              QueryTimer = 0;
2857   3                              CurrentStockCode = 0;
2858   3                              UpdataDisp = 6;
2859   3                      }
2860   2                      return 2;       
2861   2              }
2862   1              return 2;
2863   1      }
2864          
2865          //显示输入的货道，并判断输入是否正确，是否存在此货道,输入正确返回0,输入失败返回1
2866          u_char QueryDisplayInputCode()
2867          {
2868   1              u_char xdata MyKey = 0 ;
2869   1              u_char xdata len = 0;
2870   1      
2871   1              Trace("\n QueryDisplayInputCode" );
2872   1              //--------------------------------------------------
2873   1              #ifdef   _SHUPING_
2874   1                      memset( DisplayBuffer, 0, sizeof( DisplayBuffer ) );                                                                                                                    
2875   1                      DisplayLine = STR_INPUT_GOODSNO;        
2876   1                      if( CurrentStockCode != 0 )
2877   1                      {
2878   2                              len = sprintf( DisplayBuffer,"%s%bu", DispInformationTable[DisplayLine].str, CurrentStockCode );                
2879   2                              DisplayStr( 0, __LINE0__, 1, DisplayBuffer, len + 1 );
2880   2                              if( CurrentStockCode < 10 )
2881   2                              {
2882   3                                      ClearDisplayLine( 2 );
2883   3                                      DisplayCursorState( len, __LINE0__, 1, 1, 1 );                                  
2884   3                                      return 1;
2885   3                              }
2886   2                              else
2887   2                                      DisplayCursorState( 0, 1, 1, 0, 1 );
2888   2                      }
2889   1                      else
2890   1                      {
2891   2                              DisplayCursorState( 0, 1, 1, 0, 1 );
2892   2                              QueryFlag = 0;
2893   2                              QueryTimer = 0;
2894   2                              CurrentStockCode = 0;
2895   2                              UpdataDisp = 6;
2896   2                              return 1;
2897   2                      }
2898   1      
2899   1                      ClearKey();
2900   1                      if( ( CurrentStockCode > 99 ) || ( CurrentStockCode <= 0 ) )
2901   1                      {
2902   2                              DisplayCursorState( 0, 1, 1, 0, 1 );
2903   2                              // 客户输入错误                 
2904   2                              DisplayLine = STR_INVAILD_CHOICE;
2905   2                              DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].l
             -en );
2906   2                              DisplayLine = STR_RE_INPUT_GOODS;
2907   2                              DisplayStr( 0, __LINE1__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].l
             -en );
2908   2                              WaitForWork( 2000 , NULL );
2909   2                              QueryFlag = 0;
2910   2                              QueryTimer = 0;
2911   2                              CurrentStockCode = 0;
2912   2                              UpdataDisp = 6;
2913   2                              return 1 ;
2914   2                      }       
2915   1                      //输入规则正确  
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 49  

2916   1                      MyKey = 0;
2917   1                      for( len = 0; len < GOODSWAYNUM; len ++ )
2918   1                      {
2919   2                              if( CurrentStockCode == InputGoodsWayList[len].GoodsWayNo )
2920   2                              {
2921   3                                      CurrentStockCode = len;//InputGoodsWayList[len].SetArrayNo;
2922   3                                      MyKey = 1;
2923   3                                      break;
2924   3                              }
2925   2                      }
2926   1                      if( MyKey == 0 )
2927   1                      {
2928   2                              DisplayCursorState( 0, 1, 1, 0, 1 );
2929   2                              // 客户输入错误                 
2930   2                              DisplayLine = STR_INVAILD_CHOICE;
2931   2                              DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].l
             -en );
2932   2                              DisplayLine = STR_RE_INPUT_GOODS;
2933   2                              DisplayStr( 0, __LINE1__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].l
             -en );
2934   2                              WaitForWork( 2000 , NULL );
2935   2                              QueryFlag = 0;
2936   2                              QueryTimer = 0;
2937   2                              CurrentStockCode = 0;
2938   2                              UpdataDisp = 6;
2939   2                              return 1;
2940   2                      }
2941   1                      Trace( "\n QueryDisplayInputCode CurrentStockCode = %bu", CurrentStockCode );   
2942   1              #endif
2943   1              return 0;
2944   1              //==================================================
2945   1      }
2946          
2947          //在屏幕上显示各个货道的状态提示
2948          void DispGoodsState(uchar state)
2949          {
2950   1              switch(state)
2951   1              {
2952   2                      //货道故障:
2953   2                      //{"  故障", 8 },                //42                   
2954   2                      case 1:
2955   2                              DisplayLine = STR_COLUMN_ERROR;
2956   2                              DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].l
             -en );
2957   2                              break;
2958   2                      //货没有开启或商品id为ff或商品id为0     
2959   2                      // {"  该货道暂停服务", 16    },      //57
2960   2                      case 2:
2961   2                              DisplayLine = STR_GOODS_WAY_ERR3;       
2962   2                              DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].l
             -en );                        
2963   2                              break;
2964   2                      //单价为0       
2965   2                      //{"  非现金售卖", 16    },      //58
2966   2                      case 3:
2967   2                              DisplayLine = STR_GOODS_WAY_NOSALE;     
2968   2                              DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].l
             -en );
2969   2                              break;
2970   2                      //缺货  
2971   2                      //{"  商品已售完", 12 },//14    
2972   2                      case 4:
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 50  

2973   2                              Beep();
2974   2                              WaitForWork(200,NULL);
2975   2                              Beep();
2976   2                              DisplayLine = STR_GOODS_SOLDOUT;
2977   2                              DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].l
             -en );
2978   2                              break;
2979   2              }
2980   1              //{"  请选择其它商品", 16 },       //25
2981   1              DisplayLine = STR_INPUT_WAY_NO;
2982   1              DisplayStr( 0, __LINE1__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].len
             - );                
2983   1              WaitForWork( 2000, NULL );   //3000, 2000,
2984   1      }
2985          //判断货道是否正常并显示
2986          u_char QueryIsGoodsWay()
2987          {
2988   1              uchar xdata i = 0;
2989   1              uchar xdata len = 0;
2990   1          uchar xdata dspLine = 0;
2991   1              uchar xdata flag = 0;
2992   1              //u_char xdata str[20];
2993   1      
2994   1              //ClearDisplayLine( 1 );
2995   1              Trace( "\n QueryIsGoodsWay" );  
2996   1              Trace("\n GoodsWayTest GoodsWaySetVal[%bu].WayState = %02bx", CurrentStockCode,GoodsWaySetVal[ CurrentSto
             -ckCode ].WayState );
2997   1              Trace("\n GoodsWaySetVal[%bu].Price = %u", CurrentStockCode,GoodsWaySetVal[CurrentStockCode].Price );
2998   1              memset( DisplayBuffer, 0, sizeof( DisplayBuffer ) );
2999   1              //-------------------------------------------------------------------------------------------------------
             ----------------
3000   1              /*
3001   1          for( len = 0; len < GOODSTYPEMAX; len ++ )
3002   1              {
3003   1                      if( ( CurrentStockCode == sysGoodsMatrix[len].GoodsType ) && ( sysGoodsMatrix[len].ColumnNum > 0 ) )
3004   1                      {
3005   1                          if( sysGoodsMatrix[len].NextColumn == 0xff ) //If none good column left in this matrix, with the def
             -ualt one.
3006   1                              {
3007   1                      CurrentStockCode = sysGoodsMatrix[len].ColumnMatrix[0];    
3008   1                              }
3009   1                              else
3010   1                              {
3011   1                                      CurrentStockCode = sysGoodsMatrix[len].NextColumn;
3012   1                              }
3013   1                              break;
3014   1                      }
3015   1              }
3016   1          
3017   1          for( i=0; i<GOODSTYPEMAX; i++ )
3018   1          {
3019   1              if(sysGoodsMatrix[i].GoodsType == SystemParameter.selItem[sysVPMission.key])
3020   1              {
3021   1                      len = sprintf( str, "%02bu,%02bu", sysVPMission.key,SystemParameter.selItem[sysVPMission.key] );
3022   1                                              DisplayStr( 0, 1, 1, str, len );
3023   1                                              WaitForWork( 2000, NULL );
3024   1                          if( sysGoodsMatrix[i].ColumnNum > 0 )
3025   1                          {
3026   1                              if( sysGoodsMatrix[i].NextColumn != GOODS_MATRIX_NONE )
3027   1                              {
3028   1                                      CurrentStockCode = sysGoodsMatrix[i].NextColumn;
3029   1                                              len = sprintf( str, "%02bu", CurrentStockCode );
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 51  

3030   1                                              DisplayStr( 0, 1, 1, str, len );
3031   1                                              WaitForWork( 2000, NULL );
3032   1                              }        
3033   1                          }
3034   1                          else
3035   1                          {
3036   1                              sysGoodsMatrix[i].NextColumn = GOODS_MATRIX_NONE;
3037   1                          }
3038   1                              break;
3039   1              }
3040   1          }
3041   1              //len = sprintf( str, "%02bu,%02bu,%02bu", sysVPMission.key,SystemParameter.selItem[sysVPMission.key],Cur
             -rentStockCode );
3042   1              //      DisplayStr( 0, 1, 1, str, len );
3043   1              //      WaitForWork( 500, NULL );
3044   1              len = sprintf( str, "%02bu,%02bu", i,sysGoodsMatrix[i].NextColumn );
3045   1                      DisplayStr( 0, 0, 1, str, len );                
3046   1              len = sprintf( str, "%02bu,%02bu,%02bu", sysVPMission.key,SystemParameter.selItem[sysVPMission.key],Curre
             -ntStockCode );
3047   1                      DisplayStr( 0, 1, 1, str, len );
3048   1                      WaitForWork( 2000, NULL );
3049   1              */      
3050   1              #ifdef   _SHUPING_
3051   1                      //按下购物按钮时，予以上报
3052   1                      VPMission_Button_RPT( VP_BUT_GOODS, CurrentStockCode+1 );
3053   1              #else
                              for( i=0; i<COLUMN_NUM_SET; i++ )
                          {
                              if(GoodsWaySetVal[i].GoodsType == SystemParameter.selItem[sysVPMission.key])
                              {
                                      //len = sprintf( str, "%02bu,%02bu", sysVPMission.key,SystemParameter.selItem[sysVPMission.key] );
                                              //              DisplayStr( 0, 1, 1, str, len );
                                              //              WaitForWork( 2000, NULL );
                                              //CurrentStockCode = i;         
                                          if( ( GoodsWaySetVal[i].GoodsCurrentSum > 0 )&&(GoodStateLed(i)==1) )
                                          {                   
                                              CurrentStockCode = i;
                                                      //len = sprintf( str, "%02bu", CurrentStockCode );
                                                      //( 0, 1, 1, str, len );
                                                      //WaitForWork( 2000, NULL );            
                                                      break;
                                          }
                              }
                          }
                              // = sprintf( str, "%02bu", i );
                              //      DisplayStr( 0, 0, 1, str, len );                
                              //len = sprintf( str, "%02bu,%02bu,%02bu", sysVPMission.key,SystemParameter.selItem[sysVPMission.key],Cu
             -rrentStockCode );
                              //      DisplayStr( 0, 1, 1, str, len );
                              //      WaitForWork( 500, NULL );
                          //===================================================================================================
             -==================
                          /*
                              if( (SystemParameter.GOCOn != 0x01)&&(GoodsWaySetVal[CurrentStockCode].GoodsCurrentSum==0) ) //Added by 
             -Andy on 2010.10.26
                              {       
                                      DisplayLine = STR_COLUMN;       
                                      i = sprintf( DisplayBuffer, "%s %bu - %s", DispInformationTable[DisplayLine].str, GoodsWaySetVal[Curren
             -tStockCode].WayNo,
                                                      DispInformationTable[STR_GOODS_OUT].str );                              
                              }
                              else if( (SystemParameter.GOCOn==0x01)&&(GoodsWaySetVal[CurrentStockCode].WayState&0x04) ) //Added by An
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 52  

             -dy on 2010.10.26
                              {
                                      DisplayLine = STR_COLUMN;       
                                      i = sprintf( DisplayBuffer, "%s %bu - %s", DispInformationTable[DisplayLine].str, GoodsWaySetVal[Curren
             -tStockCode].WayNo,
                                                      DispInformationTable[STR_GOODS_OUT].str );
                              }
                              else if( ( ( GoodsWaySetVal[CurrentStockCode].WayState & 0x0A ) != 0x00 ) || 
                                              ( GoodsWaySetVal[CurrentStockCode].Price == 0 ) || ( ( GoodsWaySetVal[CurrentStockCode].WayState & 0x0
             -1 ) != 0x01 ) )
                                              //货道故障或单价为0             
                              {
                                      DisplayLine = STR_COLUMN;       
                                      i = sprintf( DisplayBuffer, "%s %bu - %s", DispInformationTable[DisplayLine].str, GoodsWaySetVal[Curren
             -tStockCode].WayNo,
                                                      DispInformationTable[STR_COLUMN_ERROR].str );                   
                              }
                              */
              
                          //if( sysGoodsMatrix[i].NextColumn == GOODS_MATRIX_NONE )
                          if(i>=COLUMN_NUM_SET)
                          {
                              /*
                                  DisplayLine = STR_COLUMN;   
                                      i = sprintf( DisplayBuffer, "%s%s", DispInformationTable[DisplayLine].str, DispInformationTable[STR_GOO
             -DS_OUT].str );
                              */
                              DispGoodsState(4);
                                      ClearKey();
                                      QueryFlag = 0;
                                      QueryTimer = 0;
                                      CurrentStockCode = 0;
                                      UpdataDisp = 6;
                                      return 0;
              
                          }
                              VPMission_Button_RPT( VP_BUT_GOODS, CurrentStockCode+1 );
                      #endif
3119   1              /*
3120   1              else if( GoodsWaySetVal[CurrentStockCode].GoodsCurrentSum == 0 )
3121   1              {       
3122   1                  
3123   1                      DisplayLine = STR_GOODS_SOLDOUT;
3124   1                      DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].le
             -n );
3125   1                      DisplayLine = STR_INPUT_WAY_NO;
3126   1                      DisplayStr( 0, __LINE1__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].le
             -n );                
3127   1                      WaitForWork( 2000, NULL );
3128   1                      ClearKey();
3129   1                      QueryFlag = 0;
3130   1                      QueryTimer = 0;
3131   1                      CurrentStockCode = 0;
3132   1                      UpdataDisp = 6;
3133   1                      return 0;
3134   1              }
3135   1              else if( ( ( GoodsWaySetVal[CurrentStockCode].WayState & 0x0A ) != 0x00 ) || 
3136   1                              ( ( GoodsWaySetVal[CurrentStockCode].WayState & 0x01 ) != 0x01 ) )
3137   1                              //货道故障或单价为0             
3138   1              {
3139   1                      
3140   1                      DisplayLine = STR_GOODS_SOLDOUT;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 53  

3141   1                      DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].le
             -n );
3142   1                      DisplayLine = STR_INPUT_WAY_NO;
3143   1                      DisplayStr( 0, __LINE1__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].le
             -n );                
3144   1                      WaitForWork( 2000, NULL );
3145   1                      ClearKey();
3146   1                      QueryFlag = 0;
3147   1                      QueryTimer = 0;
3148   1                      CurrentStockCode = 0;
3149   1                      UpdataDisp = 6;
3150   1                      return 0;
3151   1              }
3152   1              */
3153   1              //货道故障:
3154   1              if( GoodsWaySetVal[CurrentStockCode].WayState & 0x0A )
3155   1              {
3156   2                      DispGoodsState(1);
3157   2              }
3158   1              //货没有开启或商品id为ff或商品id为0
3159   1              else if(( GoodsWaySetVal[CurrentStockCode].WayState == 0 ) || ( GoodsWaySetVal[CurrentStockCode].GoodsTyp
             -e == 0xff )|| ( GoodsWaySetVal[CurrentStockCode].GoodsType == 0x00 ))
3160   1              {
3161   2                      DispGoodsState(2);              
3162   2              }
3163   1              //单价为0
3164   1              else if( GoodsWaySetVal[CurrentStockCode].Price == 0 )
3165   1              {
3166   2                      DispGoodsState(3);      
3167   2              }
3168   1              //缺货
3169   1              else if( (GoodsWaySetVal[CurrentStockCode].WayState & 0x04) || (GoodsWaySetVal[CurrentStockCode].GoodsCur
             -rentSum == 0) )
3170   1          {   
3171   2              DispGoodsState(4);                              
3172   2              }       
3173   1              else
3174   1              {               
3175   2                      DisplayLine = STR_PRICE;
3176   2                      switch( SystemParameter.curUnit )
3177   2                      {
3178   3                              case 1:
3179   3                                      i = sprintf( DisplayBuffer, "%s %u", DispInformationTable[DisplayLine].str,     GoodsWaySetVal[CurrentStoc
             -kCode].Price );
3180   3                                      break;                          
3181   3                              case 10:
3182   3                                      i = sprintf( DisplayBuffer, "%s %u.%u", DispInformationTable[DisplayLine].str,
3183   3                                              GoodsWaySetVal[CurrentStockCode].Price/SystemParameter.curUnit,GoodsWaySetVal[CurrentStockCode].Price
             -%SystemParameter.curUnit );                           
3184   3                                      break;
3185   3                              case 100:
3186   3                                      i = sprintf( DisplayBuffer, "%s %u.%02u", DispInformationTable[DisplayLine].str,
3187   3                                              GoodsWaySetVal[CurrentStockCode].Price/SystemParameter.curUnit,GoodsWaySetVal[CurrentStockCode].Price
             -%SystemParameter.curUnit );                           
3188   3                              break;          
3189   3                      }
3190   2              //--------------------------------------------------------------------------------------------
3191   2              //Here is for SELECTION_PAY(Cash or Card)_DISPENSE_MODE
3192   2                      
3193   2                      ClearKey();
3194   2                      QueryFlag = 0;
3195   2                      QueryTimer = 0;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 54  

3196   2                      //CurrentStockCode = 0;
3197   2                      UpdataDisp = 6;
3198   2                      /*
3199   2                //if( ( SystemParameter.busCardOn == 1 ) && ( DeviceStatus.BusCard == 0x00 ) )
3200   2              if( ( SystemParameter.busCardOn == 1 ) && ( (DeviceStatus.BusCard & 0xfb) == 0x00 ) && ( GoodsWayS
             -etVal[CurrentStockCode].Price > 0 ) )
3201   2                      {
3202   2                      DisplayStr( 0, __LINE1__, 1, DisplayBuffer, i );
3203   2                      dspLine = STR_BC_SCAN_CARD;
3204   2                              DisplayStr( 0, __LINE0__ , 1, DispInformationTable[dspLine].str, DispInformationTable[dspLine].len );           
3205   2                  
3206   2                              //WaitForWork( SYS_WAIT_CARD_IN, NULL );
3207   2                  WaitForWork( SystemParameter.BCReadTime*1000, NULL );
3208   2      
3209   2                              TradeCounter.BCTradeSn ++;
3210   2                  flag = BCMission_Trade( GoodsWaySetVal[CurrentStockCode].Price, TradeCounter .BCTradeSn );
3211   2                  
3212   2                              if( flag == BC_ERR_NULL )
3213   2                              {
3214   2                                  if( sysBCMission.recACK == BC_ACK_OK )
3215   2                                      {
3216   2                          Beep();
3217   2                                          VPMission_Card_RPT();
3218   2                                              VPMission_Payin_RPT( VP_DEV_BILLCOIN, GoodsWaySetVal[CurrentStockCode].Price );
3219   2                                              CurrentPayed = GoodsWaySetVal[CurrentStockCode].Price;
3220   2                                              return 1;       
3221   2                                      }
3222   2                                      else if( sysBCMission.recACK == BC_ACK_MONEY_LOW )
3223   2                                      {
3224   2                                          DisplayLine = STR_VP_CARD_MONEYLOW; 
3225   2                          DisplayStr( 0, __LINE0__ , 1 , DispInformationTable[DisplayLine ].str, DispInformation
             -Table[DisplayLine ].len );
3226   2                                          WaitForWork( 2000, NULL );  
3227   2                                      }
3228   2                      else if( (sysBCMission.recACK == BC_ACK_READERR)||(sysBCMission.recACK == BC_ACK_BALCKCARD
             -)||(sysBCMission.recACK == BC_ACK_UNKOWNCARD) )
3229   2                      {
3230   2                          DisplayLine = STR_VP_CARD_READERR;  
3231   2                          DisplayStr( 0, __LINE0__ , 1 , DispInformationTable[DisplayLine ].str, DispInformation
             -Table[DisplayLine ].len );
3232   2                                          WaitForWork( 2000, NULL );  
3233   2                      }
3234   2                              }
3235   2                              else
3236   2                              {
3237   2                                  DisplayLine = STR_VP_CARD_READERR;  
3238   2                      DisplayStr( 0, __LINE0__ , 1 , DispInformationTable[DisplayLine ].str, DispInformationTabl
             -e[DisplayLine ].len );
3239   2                                      WaitForWork( 2000, NULL );              
3240   2                              }
3241   2                      }
3242   2                      //只有非现金交易模式，才进行PC端卡交易;by gzz 20110727
3243   2                      else if( (SystemStatus != 1) && (sysVPMission.SystemState == 1) && ( GoodsWaySetVal[CurrentStockCode].Pr
             -ice > 0 ) )
3244   2              {
3245   2                              DisplayStr( 0, __LINE1__, 1, DisplayBuffer, i );
3246   2                      //dspLine = STR_BC_SCAN_CARD;
3247   2                              //DisplayStr( 0, __LINE0__ , 1, DispInformationTable[dspLine].str, DispInformationTable[dspLine].len );
             -                
3248   2                  
3249   2                              //WaitForWork( SYS_WAIT_CARD_IN, NULL );
3250   2                  WaitForWork( 5000, NULL );  
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 55  

3251   2              } 
3252   2                      else
3253   2                      */
3254   2                      {
3255   3                          DisplayStr( 0, __LINE1__, 1, DisplayBuffer, i );
3256   3                              WaitForWork( 2000, NULL );   //3000-2000
3257   3              } 
3258   2              /*
3259   2                      ClearKey();
3260   2                      QueryFlag = 0;
3261   2                      QueryTimer = 0;
3262   2                      CurrentStockCode = 0;
3263   2                      UpdataDisp = 6;
3264   2                      */
3265   2                      CurrentStockCode = 0;
3266   2                      return 0;
3267   2              //============================================================================================                          
3268   2              }
3269   1              ClearKey();
3270   1              QueryFlag = 0;
3271   1              QueryTimer = 0;
3272   1              CurrentStockCode = 0;
3273   1              UpdataDisp = 6;
3274   1              return 0;
3275   1      }
3276          
3277          u_char DispWelOrOutServ()
3278          {
3279   1              u_char xdata j = 0;
3280   1              
3281   1              #ifdef   _SHUPING_
3282   1                      //显示欢迎信息或暂停服务
3283   1                      if( ( QueryFlag == 1 ) && ( QueryTimer != 0 ) )
3284   1                      {
3285   2                              return 1;
3286   2                      }
3287   1                      else
3288   1                      {
3289   2                              CurrentStockCode = 0;   
3290   2                  }
3291   1              #endif
3292   1         
3293   1              if( HardWareErr == 0 )
3294   1              {
3295   2                      SystemStatus = 1;
3296   2              }
3297   1          //
3298   1              if( SystemStatus == 1)
3299   1              {                               
3300   2              
3301   2                      if( (sysVPMission.dspUpdateFlag==1) &&(sysVPMission.dspTimer1>=VP_DSP_TIME2) )
3302   2                      {
3303   3                           sysVPMission.dspTimer1 = 0x00;
3304   3                               /*
3305   3                               if( ( SystemParameter.busCardOn == 1 ) && ( (DeviceStatus.BusCard & 0xfb) == 0x00 ) )
3306   3                               {
3307   3                                       DisplayLine = STR_VP_CASHLESS_TRADE;   
3308   3                           DisplayStr( 0, __LINE0__ , 1 , DispInformationTable[DisplayLine ].str, DispInformationTable[
             -DisplayLine ].len );
3309   3                                       WaitForWork( 50, NULL );
3310   3                                       DisplayLine = STR_VP_S_C_G;
3311   3                           DisplayStr( 0, __LINE1__ , 1 , DispInformationTable[DisplayLine ].str, DispInformationTable[
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 56  

             -DisplayLine ].len );
3312   3                                       WaitForWork( 50, NULL );
3313   3                           if( GetDisplayState() == 1 )
3314   3                                       {
3315   3                                              DisplayStr( 0, __LINE1__ , 1 , DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLin
             -e].len );
3316   3                                              WaitForWork( 50, NULL );
3317   3                                              if( GetDisplayState() == 1 )
3318   3                                              {
3319   3                                                      Trace( "\n LCD OutTime" );      
3320   3                                                      HardWareErr |= 0x0200;//LCD通讯不通
3321   3                                                      return 1;
3322   3                                              }
3323   3                                       }      
3324   3                               }
3325   3                               else
3326   3                               */
3327   3                               {
3328   4                                   DisplayLine = STR_VP_CASH_TRADE;   
3329   4                           DisplayStr( 0, __LINE0__ , 1 , DispInformationTable[DisplayLine ].str, DispInformationTable[
             -DisplayLine ].len );
3330   4                                       WaitForWork( 50, NULL );
3331   4                                       DisplayLine = STR_VP_M_S_G;
3332   4                           DisplayStr( 0, __LINE1__ , 1 , DispInformationTable[DisplayLine ].str, DispInformationTable[
             -DisplayLine ].len );
3333   4                                       WaitForWork( 50, NULL );
3334   4                           if( GetDisplayState() == 1 )
3335   4                                       {
3336   5                                              DisplayStr( 0, __LINE1__ , 1 , DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLin
             -e].len );
3337   5                                              WaitForWork( 50, NULL );
3338   5                                              if( GetDisplayState() == 1 )
3339   5                                              {
3340   6                                                      Trace( "\n LCD OutTime" );      
3341   6                                                      HardWareErr |= 0x0200;//LCD通讯不通
3342   6                                                      return 1;
3343   6                                              }
3344   5                                       }                       
3345   4                               }
3346   3                      }
3347   2                      else if( (sysVPMission.dspUpdateFlag==1) && (sysVPMission.dspTimer1>=VP_DSP_TIME1) )
3348   2                      {
3349   3                           DisplayLine = STR_VP_CASH_TRADE;   
3350   3                   DisplayStr( 0, __LINE0__ , 1 , DispInformationTable[DisplayLine ].str, DispInformationTable[D
             -isplayLine ].len );
3351   3                               WaitForWork( 50, NULL );
3352   3                               DisplayLine = STR_VP_M_S_G;
3353   3                   DisplayStr( 0, __LINE1__ , 1 , DispInformationTable[DisplayLine ].str, DispInformationTable[D
             -isplayLine ].len );
3354   3                               WaitForWork( 50, NULL );
3355   3                   if( GetDisplayState() == 1 )
3356   3                               {
3357   4                                      DisplayStr( 0, __LINE1__ , 1 , DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine
             -].len );
3358   4                                      WaitForWork( 50, NULL );
3359   4                                      if( GetDisplayState() == 1 )
3360   4                                      {
3361   5                                              Trace( "\n LCD OutTime" );      
3362   5                                              HardWareErr |= 0x0200;//LCD通讯不通
3363   5                                              return 1;
3364   5                                      }
3365   4                               }              
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 57  

3366   3                      }
3367   2      
3368   2              }
3369   1              else if( (SystemStatus != 1) && (sysVPMission.SystemState != 1) )//只有暂停服务模式，才显示暂停服务;by gz
             -z 20110727
3370   1              {               
3371   2                      DisplayLine = STR_OUT_OF_SERVICE;       
3372   2                      DisplayStr( 0, __LINE0__ , 1 , DispInformationTable[DisplayLine ].str, DispInformationTable[DisplayLine 
             -].len );
3373   2              //ClearDisplayLine1();
3374   2                      ClearDisplayLine( 2 );
3375   2                      //WaitForWork( 500, NULL );             
3376   2              }
3377   1              UpdataDisp++;
3378   1      
3379   1              //
3380   1              if( IsInsertBill() == 1 )
3381   1              {
3382   2                      return 2;
3383   2              }
3384   1              else
3385   1              {
3386   2                      //WaitForWork( 500, NULL );
3387   2              WaitForWork( 50, NULL );
3388   2                      return 1;
3389   2              }
3390   1      }
3391          
3392          u_char GetBill( )
3393          {
3394   1              u_int  xdata CurrentDomain = 0;
3395   1              u_int  xdata CoinSum = 0;
3396   1              u_int  xdata coinMoney = 0;
3397   1              u_char xdata coinFlag = 0;
3398   1              u_char xdata mission = 0;
3399   1              //u_char xdata tempTradeTime = 15;
3400   1              /*
3401   1          //Trace( "\n CheckBill");
3402   1              if(SystemParameter.tradeTime==255)
3403   1                      tempTradeTime = 255;
3404   1              else if(SystemParameter.tradeTime>=240)
3405   1                      tempTradeTime = 254;
3406   1              else
3407   1                      tempTradeTime += SystemParameter.tradeTime;
3408   1              */
3409   1              CurrentDomain = 0;
3410   1          //CurrentTransType = 1;   //正在交易
3411   1         
3412   1      
3413   1              if( (sysITLMission.ITLSet != 1) )
3414   1              {
3415   2                      if( CurrentPayed > 0 )    //确实有钱收入了才是进入了服务状态
3416   2                              CasherGetMachineState( 1 );//交易状态
3417   2          }
3418   1      
3419   1              //ClearDisplayLine( 2 );        
3420   1              if( KeyLockFlag )
3421   1              {
3422   2              //Trace( "\n KeyUnLock");
3423   2                      KeyUnLock(); //打开键盘，让客户按键
3424   2                      KeyLockFlag = 0;                
3425   2              }       
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 58  

3426   1              
3427   1              if( QueryFlag == 1 )
3428   1              {
3429   2                      DisplayCursorState( 0, 1, 1, 0, 1 );
3430   2                      QueryFlag = 0;
3431   2                      QueryTimer = 0;
3432   2                      CurrentStockCode = 0;
3433   2              }
3434   1      
3435   1          
3436   1              /*
3437   1              //
3438   1              if( (SystemParameter.BillNo == 1)&&(sysITLMission.ITLSet != 1) )
3439   1              {
3440   1                      if( CasherIsCashIn() )
3441   1                      {
3442   1                              CurrentDomain = GetComingCash( );//读取已检测到的纸币面额       
3443   1                              if( CurrentDomain == 0 )//不可识别的纸币
3444   1                              {
3445   1                                      Trace( "\n Do not know bill" );         
3446   1                                      RejectBill();//退钞                             
3447   1                              }
3448   1                              else
3449   1                              {
3450   1                                      if( CurrentPayed + CurrentDomain*BILLMULTIPLE > SystemParameter.BanknoteMax )
3451   1                                      {
3452   1                                              //收到的钱超出了限制,退出纸币
3453   1                                              DisplayLine = STR_DOMAIN_ERROR;
3454   1                                              DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine]
             -.len );
3455   1                                              ClearDisplayLine( 2 );
3456   1                                              WaitForWork( 1500, NULL );                              
3457   1                                              RejectBill();//退钞                     
3458   1                                              if( CurrentPayed == 0 )
3459   1                                              {
3460   1                                                      UpdataDisp = 0;
3461   1                                                      return 2;
3462   1                                              }
3463   1                                              else
3464   1                                              {
3465   1                                                      DisplayCurrentMoney( CurrentPayed );
3466   1                                                      return 0;
3467   1                                              }
3468   1                                      }
3469   1                                      Trace( "\n Have cash in");              
3470   1                                      Trace( "\n CurrentPayed = %d",CurrentPayed );           
3471   1                                      CasherAccept(); //准备收下              
3472   1                                      LzjSecTimer = DEFAULT_GET_BILL_TIMEOUT;
3473   1                                      while( LzjSecTimer )
3474   1                                      {
3475   1                                              if( CasherIsAcceptOK() )                                                        
3476   1                                                      break;                  
3477   1                                              SchedulerProcess();
3478   1                                      }
3479   1                                      if( LzjSecTimer == 0 )
3480   1                                      {
3481   1                                              Trace( "\n Out Cash" );
3482   1                                              RejectBill();//退钞
3483   1                                              SystemParameter.DoubtCash = CurrentDomain * BILLMULTIPLE;                               
3484   1                                              SaveGlobalParam();
3485   1                                              if( CurrentPayed == 0 )
3486   1                                              {                                       
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 59  

3487   1                                                      UpdataDisp = 0;
3488   1                                                      return 2;       
3489   1                                              }
3490   1                                      }
3491   1                                      else
3492   1                                      {
3493   1                                              Trace( "\n Get in Cash Ok" );
3494   1                                      //CurrentDomain = GetCash();
3495   1                                              Trace( "\n CurrentDomain = %d",CurrentDomain );         
3496   1                                              CurrentPayed += CurrentDomain * BILLMULTIPLE;   
3497   1                                              TradeCounter.TrueCurrencySum += CurrentDomain * BILLMULTIPLE;
3498   1                                              TradeCounter.CashSum += CurrentDomain * BILLMULTIPLE;
3499   1                                              //------------------------------------------------------
3500   1                                              sysVPMission.payInBillFlag = 1;
3501   1                                              sysVPMission.payInBillMoney += CurrentDomain * BILLMULTIPLE;
3502   1                                              //reset the trade timer
3503   1                              sysVPMission.sTimer1 = tempTradeTime;
3504   1                                              //======================================================
3505   1                                      }                       
3506   1                              }       
3507   1                              WaitForWork( 20, NULL );
3508   1                      }
3509   1              }       
3510   1              */
3511   1              
3512   1              //判断收入的金额
3513   1              coinFlag = 0;
3514   1              coinMoney = 0;
3515   1              if( CurrentPayed >= SystemParameter.BanknoteMax )
3516   1              {       
3517   2                  //DisplayStr( 0, 0, 1, "1", 1 );  
3518   2                  //WaitForWork(2000,NULL);
3519   2                      DisableBillDev();              //禁能纸、硬币品
3520   2                      DisplayCurrentMoney( CurrentPayed );
3521   2              //Added 2011.4.13. Update the the goods's led, when the balance exceed the max value.
3522   2              UpdateSelLed_Trade(); 
3523   2                      /*
3524   2                      if( (SystemParameter.BillNo == 1)&&(sysITLMission.ITLSet !=1 ) )
3525   2                      {                       
3526   2                              LzjSecTimer = 1;
3527   2                              while( LzjSecTimer )
3528   2                              {
3529   2                                      if( CasherIsCashIn() ) //是否有纸币进入
3530   2                                      {       
3531   2                                              RejectBill();      //退钞                                                                                                                               
3532   2                                              break;
3533   2                                      }
3534   2                                      WaitForWork( 10, NULL );
3535   2                              }
3536   2                      }               
3537   2                      */
3538   2                      //WaitForWork( 500, NULL );
3539   2                      return 1;               
3540   2              }       
3541   1              else    
3542   1              {
3543   2                      DisplayCurrentMoney( CurrentPayed );
3544   2                      UpdateSelLed_Trade();
3545   2                      return 2;       
3546   2              }
3547   1      }
3548          
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 60  

3549          
3550          
3551          u_char IsInputGoodsNo()
3552          {
3553   1              u_char xdata key = 0;
3554   1              u_int  xdata moneyBuf = 0;
3555   1      
3556   1          //Trace( "\n IsInputGoodsNo" );
3557   1              //if( SystemStatus != 1 ) 
3558   1              if( (SystemStatus != 1) && (sysVPMission.SystemState != 1) )//只有暂停服务模式，才做这个;by gzz 20110727
3559   1                      return 1; // 系统关闭，按键不理,当做没按
3560   1          
3561   1              if( sysITLMission.billHoldingFlag == 1 )
3562   1              {
3563   2              if( (CurrentPayed+sysITLMission.billHoldingValue) <= 0 )
3564   2                      return 2;
3565   2              }
3566   1              else if( CurrentPayed <= 0 )
3567   1              {
3568   2                      return 2;
3569   2              }    
3570   1              WaitForWork( 10, NULL );                
3571   1              key = GetKey();    
3572   1              //------------------------------------------------------
3573   1              //if( ( key >= 0 ) && ( key <= 9 ) )
3574   1      #ifdef   _SHUPING_
3575   1              if( ( key > 0 ) && ( key <= 9 ) )
3576   1              {
3577   2      //              Trace( "\n CheckKeyPress key2 = %bu", key );
3578   2                      CurrentStockCode = key + CurrentStockCode*10;
3579   2                      return 0;
3580   2              }
3581   1              else
3582   1              {
3583   2                      if(key == KEY_CANCEL)
3584   2                      {
3585   3                              CurrentStockCode = 0;
3586   3                              sysVPMission.dspCtr |= 0x01;
3587   3                              DisplayCursorState( 0, 1, 1, 0, 1 );
3588   3                              if( sysITLMission.billHoldingFlag == 1 )
3589   3                              {
3590   4                                      moneyBuf = CurrentPayed + sysITLMission.billHoldingValue;
3591   4                              }
3592   3                              else
3593   3                              {
3594   4                                  moneyBuf = CurrentPayed;
3595   4                              }
3596   3                              if( moneyBuf < SystemParameter.BanknoteMax )
3597   3                  {
3598   4                      EnableBillDev();                
3599   4                  }
3600   3                      }
3601   2                      return 1;
3602   2              }
3603   1      #else
                      if( ( key >= SELECTION_VAL_MIN ) && ( key <= SELECTION_VAL_MAX ) )
                      {
                              //CurrentStockCode = key + 0x30;
                      //CurrentStockCode = key;
                          //sysVPMission.key = sysVPMission.selItem[key - 1];
                              //sysVPMission.key = SystemParameter.selItem[key - 1];
                              sysVPMission.key = key;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 61  

                      sysVPMission.goodsType = key;
                      //Trace( "\n IsInputGoodsNo key = %bu", key );          
                              return 0;
                      }
                      else                            
                              return 1;       
              #endif  
3618   1      }
3619          
3620          /////////////////////////////
3621          //输入货道，并判断输入是否正确，是否存在此货道,输入正确返回0,输入失败返回1
3622          u_char DisplayInputCode()
3623          {
3624   1              u_char xdata MyKey = 0 ;
3625   1              u_char xdata len = 0;
3626   1      
3627   1              Trace("\n QueryDisplayInputCode" );
3628   1              //--------------------------------------------------
3629   1      #ifdef   _SHUPING_
3630   1              memset( DisplayBuffer, 0, sizeof( DisplayBuffer ) );                                                                                                                    
3631   1              DisplayLine = STR_INPUT_GOODSNO;        
3632   1              if( CurrentStockCode != 0 )
3633   1              {
3634   2                      len = sprintf( DisplayBuffer,"%s%bu", DispInformationTable[DisplayLine].str, CurrentStockCode );                
3635   2                      DisplayStr( 0, __LINE0__, 1, DisplayBuffer, len + 1 );
3636   2                      if( CurrentStockCode < 10 )
3637   2                      {
3638   3                              ClearDisplayLine( 2 );
3639   3                              DisplayCursorState( len, __LINE0__, 1, 1, 1 );                                  
3640   3                              return 1;
3641   3                      }
3642   2                      else
3643   2                              DisplayCursorState( 0, 1, 1, 0, 1 );
3644   2              }
3645   1              else
3646   1              {
3647   2                      DisplayCursorState( 0, 1, 1, 0, 1 );
3648   2                      QueryFlag = 0;
3649   2                      QueryTimer = 0;
3650   2                      CurrentStockCode = 0;
3651   2                      UpdataDisp = 6;
3652   2                      return 1;
3653   2              }
3654   1      
3655   1              ClearKey();
3656   1              if( ( CurrentStockCode > 99 ) || ( CurrentStockCode <= 0 ) )
3657   1              {
3658   2                      DisplayCursorState( 0, 1, 1, 0, 1 );
3659   2                      // 客户输入错误                 
3660   2                      DisplayLine = STR_INVAILD_CHOICE;
3661   2                      DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].le
             -n );
3662   2                      DisplayLine = STR_RE_INPUT_GOODS;
3663   2                      DisplayStr( 0, __LINE1__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].le
             -n );
3664   2                      WaitForWork( 2000 , NULL );
3665   2                      QueryFlag = 0;
3666   2                      QueryTimer = 0;
3667   2                      CurrentStockCode = 0;
3668   2                      UpdataDisp = 6;
3669   2                      return 1 ;
3670   2              }       
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 62  

3671   1              //输入规则正确  
3672   1              MyKey = 0;
3673   1              for( len = 0; len < GOODSWAYNUM; len ++ )
3674   1              {
3675   2                      if( CurrentStockCode == InputGoodsWayList[len].GoodsWayNo )
3676   2                      {
3677   3                              CurrentStockCode = len;//InputGoodsWayList[len].SetArrayNo;
3678   3                              MyKey = 1;
3679   3                              break;
3680   3                      }
3681   2              }
3682   1              if( MyKey == 0 )
3683   1              {
3684   2                      DisplayCursorState( 0, 1, 1, 0, 1 );
3685   2                      // 客户输入错误                 
3686   2                      DisplayLine = STR_INVAILD_CHOICE;
3687   2                      DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].le
             -n );
3688   2                      DisplayLine = STR_RE_INPUT_GOODS;
3689   2                      DisplayStr( 0, __LINE1__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].le
             -n );
3690   2                      WaitForWork( 2000 , NULL );
3691   2                      QueryFlag = 0;
3692   2                      QueryTimer = 0;
3693   2                      CurrentStockCode = 0;
3694   2                      UpdataDisp = 6;
3695   2                      return 1;
3696   2              }
3697   1              Trace( "\n QueryDisplayInputCode CurrentStockCode = %bu", CurrentStockCode );   
3698   1      #endif
3699   1              return 0;
3700   1              //==================================================
3701   1      }
3702          
3703          
3704          //判断货道是否正常
3705          u_char IsGoodsWay()
3706          {
3707   1              //u_char xdata str[20];
3708   1              //u_char xdata len = 0;
3709   1              uchar xdata i = 0;
3710   1              uchar xdata chuSet = 0;
3711   1              
3712   1              Trace( "\n CurrentStockCode = %bu, GoodsCurrentSum = %bu", CurrentStockCode, GoodsWaySetVal[CurrentStockC
             -ode].GoodsCurrentSum );       
3713   1              
3714   1              /*
3715   1              判断有这个商品id,该货道有存货数量,货道状态正确
3716   1      
3717   1              否则
3718   1              1.
3719   1              {"  商品已售完", 12 },//14      
3720   1               {"  请选择其它商品", 16 },       //25
3721   1      
3722   1      
3723   1              //2.商品id无效
3724   1              
3725   1              //3.单价为0
3726   1              
3727   1              //4.缺货        
3728   1              */
3729   1              #ifdef   _SHUPING_
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 63  

3730   1                      //按下购物按钮时，予以上报
3731   1                      VPMission_Button_RPT( VP_BUT_GOODS, CurrentStockCode+1 );
3732   1              #else
                          //1.判断是否有货物出货
                              for( i=0; i<COLUMN_NUM_SET; i++ )
                          {
                              if(GoodsWaySetVal[i].GoodsType == SystemParameter.selItem[sysVPMission.key])
                              {
                                      //len = sprintf( str, "%02bu,%02bu", sysVPMission.key,SystemParameter.selItem[sysVPMission.key] );
                                              //              DisplayStr( 0, 1, 1, str, len );
                                              //              WaitForWork( 2000, NULL );
                                              //CurrentStockCode = i;         
                                          if( ( GoodsWaySetVal[i].GoodsCurrentSum > 0 )&&(GoodStateLed(i)==1) )
                                          {                   
                                              CurrentStockCode = i;
                                                      //len = sprintf( str, "%02bu", CurrentStockCode );
                                                      //DisplayStr( 0, 1, 1, str, len );
                                                      //WaitForWork( 2000, NULL );            
                                                      break;
                                          }
                              }
                          }
                              //len = sprintf( str, "%02bu", i );
                              //      DisplayStr( 0, 0, 1, str, len );                
                              //len = sprintf( str, "%02bu,%02bu,%02bu", sysVPMission.key,SystemParameter.selItem[sysVPMission.key],Cu
             -rrentStockCode );
                              //      DisplayStr( 0, 1, 1, str, len );
                              //      WaitForWork( 500, NULL );
              
                          //没有货物出货
                          if(i>=COLUMN_NUM_SET)
                              {
                                      //len = sprintf( str, "%02bu", sysGoodsMatrix[i].NextColumn );
                                      //DisplayStr( 0, 0, 1, str, len );      
                                      //WaitForWork( 2000, NULL );
                                      
                                      DispGoodsState(4);
                                      CurrentStockCode = 0;
                                      sysVPMission.dspCtr |= 0x01;
                              //DisplayCurrentMoney( CurrentPayed );
                                      //ClearDisplayLine( 2 );
                                      return 2;
                              }
                              //len = sprintf( str, "1=%02bu", CurrentStockCode );
                              //DisplayStr( 0, 0, 1, str, len );
                              //WaitForWork( 2000, NULL );
              
                              //2.判断是这次轮流到哪个货道出货
                              while(chuSet==0)
                              {               
                                      for( i=0; i<COLUMN_NUM_SET; i++ )
                                  {
                                      if(GoodsWaySetVal[i].GoodsType == SystemParameter.selItem[sysVPMission.key])
                                      {
                                              //len = sprintf( str, "1=%02bu,%02bu,%02bu", i,GoodsWaySetVal[i].GoodsCurrentSum,GoodsWaySetVal[i]
             -.IsUsed );
                                                      //              DisplayStr( 0, 1, 1, str, len );
                                                      //              WaitForWork( 2000, NULL );
                                                      if( ( GoodsWaySetVal[i].GoodsCurrentSum > 0 )&&(GoodStateLed(i)==1) &&( GoodsWaySetVal[i].IsUsed == 0
             - ) )
                                                  {                   
                                                      CurrentStockCode = i;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 64  

                                                              chuSet = 1;
                                                              //len = sprintf( str, "2=%02bu", i );
                                                              //      DisplayStr( 0, 1, 1, str, len );
                                                              //      WaitForWork( 2000, NULL );              
                                                              break;
                                                  }
                                      }
                                  }
                                      //都已经出货过一次了，重头开始出货
                                  if(i>=COLUMN_NUM_SET)
                                      {
                                              for( i=0; i<COLUMN_NUM_SET; i++ )
                                          {
                                              if(GoodsWaySetVal[i].GoodsType == SystemParameter.selItem[sysVPMission.key])
                                              {
                                                      //len = sprintf( str, "%02bu,%02bu", sysVPMission.key,SystemParameter.selItem[sysVPMission.key] )
             -;
                                                              //              DisplayStr( 0, 1, 1, str, len );
                                                              //              WaitForWork( 2000, NULL );
                                                              //CurrentStockCode = i;         
                                                          if( ( GoodsWaySetVal[i].GoodsCurrentSum > 0 )&&(GoodStateLed(i)==1) )
                                                          {                   
                                                              GoodsWaySetVal[i].IsUsed = 0;    
                                                          }
                                              }
                                          }
                                  }
                              }
                                          
                              VPMission_Button_RPT( VP_BUT_GOODS, CurrentStockCode+1 );
                      #endif
3819   1              /*
3820   1          else if( (GoodsWaySetVal[CurrentStockCode].GoodsCurrentSum == 0) )
3821   1              {                       
3822   1                      DisplayLine = STR_GOODS_SOLDOUT;
3823   1                      DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].le
             -n );
3824   1                      DisplayLine = STR_INPUT_WAY_NO;
3825   1                      DisplayStr( 0, __LINE1__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].le
             -n );                
3826   1                      WaitForWork( 2000, NULL );
3827   1                      CurrentStockCode = 0;
3828   1                      sysVPMission.dspCtr |= 0x01;
3829   1                      return 2;
3830   1              }
3831   1          //====================================================================================================
             -===========
3832   1              //货没有开启或货道故障或单价为0         
3833   1              else if( ( ( GoodsWaySetVal[CurrentStockCode].WayState & 0x01 ) == 0x00 ) || ( ( GoodsWaySetVal[CurrentSt
             -ockCode].WayState & 0x0A ) != 0x00 )  )
3834   1              {
3835   1                  DisplayLine = STR_GOODS_SOLDOUT;
3836   1                      DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].le
             -n );
3837   1                      DisplayLine = STR_INPUT_WAY_NO;
3838   1                      DisplayStr( 0, __LINE1__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].le
             -n );                
3839   1                      WaitForWork( 2000, NULL );
3840   1                      CurrentStockCode = 0;
3841   1                      sysVPMission.dspCtr |= 0x01;
3842   1                      CurrentStockCode = 0;
3843   1                      return 1;               
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 65  

3844   1              }
3845   1              //The price is zero, none respond
3846   1              else if( ( GoodsWaySetVal[CurrentStockCode].Price == 0 ) )
3847   1              {
3848   1                  CurrentStockCode = 0;
3849   1                      //sysVPMission.dspCtr |= 0x01;
3850   1                      CurrentStockCode = 0;
3851   1                      return 1;   
3852   1              }
3853   1              */
3854   1              //货道故障:
3855   1              if( GoodsWaySetVal[CurrentStockCode].WayState & 0x0A )
3856   1              {
3857   2                      DispGoodsState(1);
3858   2                      CurrentStockCode = 0;
3859   2                      sysVPMission.dspCtr |= 0x01;
3860   2                      CurrentStockCode = 0;
3861   2                      if( CurrentPayed < SystemParameter.BanknoteMax )
3862   2              {
3863   3                      EnableBillDev();                
3864   3              }
3865   2                      sysVPMission.sTimer1 = SystemParameter.tradeTime;
3866   2                      ClearKey();//20110622
3867   2                      return 1;       
3868   2              }
3869   1              //货没有开启或商品id为ff或商品id为0     
3870   1              else if(( GoodsWaySetVal[CurrentStockCode].WayState == 0 )|| ( GoodsWaySetVal[CurrentStockCode].GoodsType
             - == 0xff )|| ( GoodsWaySetVal[CurrentStockCode].GoodsType == 0x00 ))
3871   1              {
3872   2                      DispGoodsState(2);
3873   2                      CurrentStockCode = 0;
3874   2                      sysVPMission.dspCtr |= 0x01;
3875   2                      CurrentStockCode = 0;
3876   2                      if( CurrentPayed < SystemParameter.BanknoteMax )
3877   2              {
3878   3                      EnableBillDev();                
3879   3              }
3880   2                      sysVPMission.sTimer1 = SystemParameter.tradeTime;
3881   2                      ClearKey();//20110622
3882   2                      return 1;               
3883   2              }
3884   1              //单价为0
3885   1              else if( GoodsWaySetVal[CurrentStockCode].Price == 0 )
3886   1              {
3887   2                      DispGoodsState(3);
3888   2                      CurrentStockCode = 0;
3889   2                      sysVPMission.dspCtr |= 0x01;
3890   2                      CurrentStockCode = 0;
3891   2                      if( CurrentPayed < SystemParameter.BanknoteMax )
3892   2              {
3893   3                      EnableBillDev();                
3894   3              }
3895   2                      sysVPMission.sTimer1 = SystemParameter.tradeTime;
3896   2                      ClearKey();//20110622
3897   2                      return 1;               
3898   2              }
3899   1              //缺货
3900   1              else if( (GoodsWaySetVal[CurrentStockCode].WayState & 0x04) || (GoodsWaySetVal[CurrentStockCode].GoodsCur
             -rentSum == 0) )
3901   1              {
3902   2                      DispGoodsState(4);
3903   2                      sysVPMission.dspCtr |= 0x01;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 66  

3904   2                      CurrentStockCode = 0;
3905   2                      if( CurrentPayed < SystemParameter.BanknoteMax )
3906   2              {
3907   3                      EnableBillDev();                
3908   3              }
3909   2                      sysVPMission.sTimer1 = SystemParameter.tradeTime;
3910   2                      ClearKey();//20110622
3911   2                      return 2;       
3912   2              }
3913   1              GoodsWaySetVal[CurrentStockCode].IsUsed = 1;
3914   1              return 0;
3915   1      }
3916          
3917          u_char IsMoneyEnough()
3918          {
3919   1          //Trace( "\n Price = %d", GoodsWaySetVal[CurrentStockCode].Price );         
3920   1          //Trace( "\n CurrentPayed = %d", CurrentPayed );
3921   1              u_char xdata i = 0;     
3922   1              u_int  xdata moneyBuf = 0;
3923   1              u_int  xdata CurrentDomain = 0;
3924   1              u_char xdata flag = 0;
3925   1              u_char xdata mission = 0;
3926   1              u_int  xdata tempPrice;
3927   1              u_int  xdata inBilltemp;
3928   1              u_char xdata resultdisp[2] = {0, 0};
3929   1              u_char xdata escrowFlag = 0;    
3930   1      
3931   1          if( sysITLMission.billHoldingFlag == 1 )
3932   1              {
3933   2                      moneyBuf = CurrentPayed + sysITLMission.billHoldingValue;
3934   2              }
3935   1              else
3936   1              {
3937   2                  moneyBuf = CurrentPayed;
3938   2              }
3939   1      
3940   1        
3941   1              //if( GoodsWaySetVal[CurrentStockCode].Price > CurrentPayed )
3942   1              if( GoodsWaySetVal[CurrentStockCode].Price > moneyBuf )
3943   1              {
3944   2              DisplayLine = STR_VP_BALANCE_LOW;
3945   2                      DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].le
             -n );
3946   2              //
3947   2                      DisplayLine = STR_PRICE;
3948   2                      switch( SystemParameter.curUnit )
3949   2                      {
3950   3                              case 1:
3951   3                                      i = sprintf( DisplayBuffer, "%s %u", DispInformationTable[DisplayLine].str,     GoodsWaySetVal[CurrentStoc
             -kCode].Price );
3952   3                                      break;                          
3953   3                              case 10:
3954   3                                      i = sprintf( DisplayBuffer, "%s %u.%u", DispInformationTable[DisplayLine].str,
3955   3                                              GoodsWaySetVal[CurrentStockCode].Price/SystemParameter.curUnit,GoodsWaySetVal[CurrentStockCode].Price
             -%SystemParameter.curUnit );                           
3956   3                                      break;
3957   3                              case 100:
3958   3                                      i = sprintf( DisplayBuffer, "%s %u.%02u", DispInformationTable[DisplayLine].str,
3959   3                                              GoodsWaySetVal[CurrentStockCode].Price/SystemParameter.curUnit,GoodsWaySetVal[CurrentStockCode].Price
             -%SystemParameter.curUnit );                           
3960   3                              break;          
3961   3                      }
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 67  

3962   2              DisplayStr( 0, __LINE1__, 1, DisplayBuffer, i );
3963   2                      WaitForWork( 1500, NULL );
3964   2                      CurrentStockCode = 0;
3965   2                  sysVPMission.dspCtr |= 0x01;
3966   2                      return 1;       
3967   2              }
3968   1              //硬币器故障时只能扣款或购买与暂存纸币等额的商品
3969   1              if( ( sysMDBMission.coinDeviceStatus != 0 )||( sysMDBMission.tubeRemoved == 1 ) )
3970   1              {
3971   2                      if(GoodsWaySetVal[CurrentStockCode].Price > 0)
3972   2                      {
3973   3                              if(GoodsWaySetVal[CurrentStockCode].Price != moneyBuf )
3974   3                              {
3975   4                              DisplayLine = STR_COIN_NOT_ENOUGH;
3976   4                                      DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].
             -len );
3977   4                              //                              
3978   4                                      WaitForWork( 1500, NULL );
3979   4                                      CurrentStockCode = 0;
3980   4                                  sysVPMission.dspCtr |= 0x01;
3981   4                                      return 1;       
3982   4                              }
3983   3                      }
3984   2              }
3985   1      
3986   1          //是否可以找零
3987   1              if(GoodsWaySetVal[CurrentStockCode].Price > CurrentPayed)
3988   1              {
3989   2                      tempPrice = GoodsWaySetVal[CurrentStockCode].Price - CurrentPayed;
3990   2                      if( sysITLMission.billHoldingFlag == 1 )
3991   2                      {
3992   3                              tempPrice = sysITLMission.billHoldingValue - tempPrice;
3993   3                              inBilltemp = tempPrice;
3994   3                              tempPrice = tempPrice/10;
3995   3                              mission =changeCNY(resultdisp,tempPrice);
3996   3                              if(mission)
3997   3                              {
3998   4                                      escrowFlag = 1;
3999   4                                      sysVPMission.inBillMoney = inBilltemp;
4000   4                              }
4001   3                              else
4002   3                              {
4003   4                                      DisplayLine = STR_COIN_UNPAY;
4004   4                                      DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].
             -len );
4005   4                                      DisplayLine = STR_INPUT_WAY_NO;
4006   4                                      DisplayStr( 0, __LINE1__, 1, " ", 1 );          
4007   4                                      WaitForWork( 2000, NULL );
4008   4                                      CurrentStockCode = 0;
4009   4                                      sysVPMission.dspCtr |= 0x01;
4010   4                                      return 1;
4011   4                              }
4012   3                      }
4013   2              }
4014   1              else
4015   1              {               
4016   2                      tempPrice = CurrentPayed - GoodsWaySetVal[CurrentStockCode].Price;
4017   2                      tempPrice = tempPrice/10;
4018   2                      mission =changeCNY(resultdisp,tempPrice);
4019   2                      if(mission == 0)                
4020   2                      {
4021   3                              DisplayLine = STR_COIN_UNPAY;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 68  

4022   3                              DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].l
             -en );
4023   3                              DisplayLine = STR_INPUT_WAY_NO;
4024   3                              DisplayStr( 0, __LINE1__, 1, " ", 1 );          
4025   3                              WaitForWork( 2000, NULL );
4026   3                              CurrentStockCode = 0;
4027   3                              sysVPMission.dspCtr |= 0x01;
4028   3                              return 1;
4029   3                      }
4030   2              }
4031   1      
4032   1          //Before vending, stack the holding bill
4033   1              if(( sysITLMission.billHoldingFlag == 1 )&&(escrowFlag == 1))
4034   1              {
4035   2                  
4036   2              flag = MDB_Bill_EscrowCtr( 1 );
4037   2                      if(flag==0)
4038   2                      {
4039   3                          sysVPMission.billSTimer = TIME_BILL_STACK;
4040   3                          while( sysVPMission.billSTimer )
4041   3                              {
4042   4                      mission = MDB_Bill_IfStacked( sysMDBMission.billBuf, &sysMDBMission.billBufLen );
4043   4                                      if( mission == 1 )
4044   4                                      {
4045   5                                          CurrentDomain = sysITLMission.billHoldingValue;                                     
4046   5                                              Trace( "\n Get in Cash Ok" );
4047   5                                              //CurrentDomain = GetCash();
4048   5                                              Trace( "\n CurrentDomain = %d",CurrentDomain );         
4049   5                                              CurrentPayed += CurrentDomain * BILLMULTIPLE;   
4050   5                                              //TradeCounter.TrueCurrencySum += CurrentDomain * BILLMULTIPLE;
4051   5                                              //TradeCounter.CashSum += CurrentDomain * BILLMULTIPLE;
4052   5                                              //TradeCounter.CashSumBack += CurrentDomain * BILLMULTIPLE;//区间
4053   5                                              SellAccumulateMoney(&TradeCounter.CashSum,CurrentDomain * BILLMULTIPLE);
4054   5                                              SellAccumulateMoney(&TradeCounter.CashSumBack,CurrentDomain * BILLMULTIPLE);
4055   5                                              //------------------------------------------------------
4056   5                                              sysVPMission.payInBillFlag = 1;
4057   5                                              sysVPMission.payInBillMoney += CurrentDomain * BILLMULTIPLE;
4058   5                                              //reset the trade timer
4059   5                                      //sysVPMission.sTimer1 = SystemParameter.tradeTime;
4060   5                                              //======================================================
4061   5                                              //sysITLMission.restartTime = ITL_TIME_RESTART; //reset the timer!
4062   5                                              memset(sysMDBMission.billBuf,0,sizeof(sysMDBMission.billBuf));
4063   5                                              sysMDBMission.billBufLen=0;
4064   5                                              sysMDBMission.billType=0;
4065   5                                              sysMDBMission.billStock=0;
4066   5                                  sysITLMission.billHoldingFlag = 0;
4067   5                                              sysITLMission.billHoldingValue = 0;
4068   5                                  //payin report
4069   5                                              if( sysVPMission.payInCoinFlag == 1 )
4070   5                                              {
4071   6                                                  VPMission_Payin_RPT( VP_DEV_COIN, sysVPMission.payInCoinMoney );
4072   6                                                      sysVPMission.payInCoinFlag = 0;
4073   6                                              sysVPMission.payInCoinMoney = 0;
4074   6                                              
4075   6                                              }
4076   5                                              if( sysVPMission.payInBillFlag == 1 )
4077   5                                              {
4078   6                                                  VPMission_Payin_RPT( VP_DEV_BILL, sysVPMission.payInBillMoney );
4079   6                                                      sysVPMission.payInBillFlag = 0;
4080   6                                              sysVPMission.payInBillMoney = 0;      
4081   6                                              }
4082   5                          break;//压钞成功后，直接跳出时间循环等待;by gzz 20110721
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 69  

4083   5                                      }
4084   4                                      else
4085   4                                      {
4086   5                                              VP_GameKeyPoll( 200 );
4087   5                                      }
4088   4                  }
4089   3                              if( sysVPMission.billSTimer == 0 )
4090   3                              {
4091   4                      //钞箱满，钞箱压钞后就能时，还可以认到纸币;by gzz 20111017 
4092   4                                  //检测纸币器钞箱是否已满;by gzz 20111014 
4093   4                                      WaitForWork(2000,NULL);
4094   4                      MDB_Bill_Stacker( &sysMDBMission.billBuf[0], &sysMDBMission.billBuf[1] ); 
4095   4                      if(sysMDBMission.billIsFull==1)
4096   4                                      {
4097   5                                          CurrentDomain = sysITLMission.billHoldingValue;
4098   5                                              Trace( "\n Get in Cash Ok" );
4099   5                                              //CurrentDomain = GetCash();
4100   5                                              Trace( "\n CurrentDomain = %d",CurrentDomain );         
4101   5                                              CurrentPayed += CurrentDomain * BILLMULTIPLE;   
4102   5                                              //TradeCounter.TrueCurrencySum += CurrentDomain * BILLMULTIPLE;
4103   5                                              //TradeCounter.CashSum += CurrentDomain * BILLMULTIPLE;
4104   5                                              //TradeCounter.CashSumBack += CurrentDomain * BILLMULTIPLE;//区间
4105   5                                              SellAccumulateMoney(&TradeCounter.CashSum,CurrentDomain * BILLMULTIPLE);
4106   5                                              SellAccumulateMoney(&TradeCounter.CashSumBack,CurrentDomain * BILLMULTIPLE);
4107   5                                              //------------------------------------------------------
4108   5                                              sysVPMission.payInBillFlag = 1;
4109   5                                              sysVPMission.payInBillMoney += CurrentDomain * BILLMULTIPLE;
4110   5                                              //reset the trade timer
4111   5                                      //sysVPMission.sTimer1 = SystemParameter.tradeTime;
4112   5                                              //======================================================
4113   5                                              //sysITLMission.restartTime = ITL_TIME_RESTART; //reset the timer!
4114   5                                              memset(sysMDBMission.billBuf,0,sizeof(sysMDBMission.billBuf));
4115   5                                              sysMDBMission.billBufLen=0;
4116   5                                              sysMDBMission.billType=0;
4117   5                                              sysMDBMission.billStock=0;
4118   5                                  sysITLMission.billHoldingFlag = 0;
4119   5                                              sysITLMission.billHoldingValue = 0;
4120   5                                  //payin report
4121   5                                              if( sysVPMission.payInCoinFlag == 1 )
4122   5                                              {
4123   6                                                  VPMission_Payin_RPT( VP_DEV_COIN, sysVPMission.payInCoinMoney );
4124   6                                                      sysVPMission.payInCoinFlag = 0;
4125   6                                              sysVPMission.payInCoinMoney = 0;
4126   6                                              
4127   6                                              }
4128   5                                              if( sysVPMission.payInBillFlag == 1 )
4129   5                                              {
4130   6                                                  VPMission_Payin_RPT( VP_DEV_BILL, sysVPMission.payInBillMoney );
4131   6                                                      sysVPMission.payInBillFlag = 0;
4132   6                                              sysVPMission.payInBillMoney = 0;      
4133   6                                              }                    
4134   5                                      }
4135   4                                      else
4136   4                                      { 
4137   5                                              //...   
4138   5                                              //调整顺序，billHoldingFlag==0放在sysVPMission之上;by gzz 20110721
4139   5                                              sysVPMission.escrowMoney = sysITLMission.billHoldingValue;
4140   5                                              sysITLMission.billHoldingFlag = 0;
4141   5                                              sysITLMission.billHoldingValue = 0;
4142   5                                              //Need better solutoin. 
4143   5                                              //Maybe cheated by man
4144   5                                  //CurrentPayed += sysITLMission.billHoldingValue;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 70  

4145   5                                              //-----------------------------------------------------
4146   5                                          sysVPMission.escrowOutFlag = 1;                                 
4147   5                                              if( sysVPMission.escrowOutFlag == 1 )
4148   5                                          {
4149   6                                                  VPMission_Payin_RPT( VP_DEV_ESCROWOUT, sysVPMission.escrowMoney );
4150   6                                                      sysVPMission.escrowOutFlag = 0;
4151   6                                              sysVPMission.escrowMoney = 0;     
4152   6                                              }
4153   5                                          //=====================================================
4154   5                                              DisplayCurrentMoney( CurrentPayed );
4155   5                                              if( GoodsWaySetVal[CurrentStockCode].Price > CurrentPayed )
4156   5                                              {
4157   6                                                      return 1;
4158   6                                              }
4159   5                      }       
4160   4                              }
4161   3              }
4162   2              else
4163   2                      {
4164   3                              //...
4165   3                              //调整顺序，billHoldingFlag==0放在sysVPMission之上;by gzz 20110721
4166   3                              sysVPMission.escrowMoney = sysITLMission.billHoldingValue;
4167   3                              sysITLMission.billHoldingFlag = 0;
4168   3                              sysITLMission.billHoldingValue = 0;
4169   3                              //Need better solutoin. 
4170   3                              //Maybe cheated by man
4171   3                  //CurrentPayed += sysITLMission.billHoldingValue;
4172   3                              //-----------------------------------------------------
4173   3                              sysVPMission.escrowOutFlag = 1;                 
4174   3                              if( sysVPMission.escrowOutFlag == 1 )
4175   3                          {
4176   4                                  VPMission_Payin_RPT( VP_DEV_ESCROWOUT, sysVPMission.escrowMoney );
4177   4                                      sysVPMission.escrowOutFlag = 0;
4178   4                              sysVPMission.escrowMoney = 0;     
4179   4                              }
4180   3                              //=====================================================
4181   3                              DisplayCurrentMoney( CurrentPayed );
4182   3                              if( GoodsWaySetVal[CurrentStockCode].Price > CurrentPayed )
4183   3                              {
4184   4                                      return 1;
4185   4                              }
4186   3                      }
4187   2          }
4188   1          else
4189   1              {
4190   2                      //若此时还有插币，等压钞结束后再判断;by gzz 20110429 
4191   2                      //WaitForWork( NULL, 1000 );
4192   2              /*
4193   2                  if((SystemParameter.BillNo==1)&&(sysITLMission.ITLSet==1))
4194   2                  {      
4195   2                     if(sysITLMission.billStaCtr & ITL_BILL_READ)
4196   2                     {        
4197   2                              
4198   2                        return 1;          
4199   2                     }
4200   2                  }
4201   2              */ 
4202   2              }
4203   1              //
4204   1              {
4205   2              sysITLMission.billStaCtr = 0;
4206   2              sysITLMission.billSta = 0;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 71  

4207   2                      /*
4208   2              WaitForWork( 300, NULL );
4209   2                      MDB_Bill_EscrowCtr( 0 );
4210   2                      */
4211   2              //sysITLMission.billStaCtr |= ITL_BILL_VEDNING;
4212   2              }
4213   1              return 0;
4214   1      }
4215          
4216          //显示货道故障并让客户确定
4217          u_char GoodsWayErr()
4218          {
4219   1              //u_char xdata MyKey ;
4220   1              //------------------------------------------------------------
4221   1              DisplayLine = STR_GOODS_WAY_ERR2;
4222   1              #ifdef _CHINA_
4223   1                      DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].le
             -n - 3 );
4224   1              #else
                              DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].le
             -n - 1 );
                      #endif
4227   1              WaitForWork( 2000, NULL );
4228   1              ClearKey();     
4229   1              CurrentStockCode = 0;
4230   1              return 0;
4231   1              //============================================================
4232   1      
4233   1      }
4234          
4235          //判断是否支付过款，没有返回1,有返回0
4236          u_char  CheckIsPayment()
4237          {
4238   1              if( CurrentPayed ==  0 )
4239   1                      return 1;
4240   1              else
4241   1                      return 0;
4242   1      }
4243          
4244          //出货
4245          //0 - trade mode
4246          //1 - free vend
4247          //2 - card
4248          unsigned char OutGoods( unsigned char type )
4249          {
4250   1              u_char   xdata flag = 0 ;
4251   1              u_char   xdata length = 0;
4252   1              u_char   xdata result = 0;
4253   1              u_int    xdata moneyBuf = 0;
4254   1              //u_char xdata str[20];
4255   1              //u_char xdata len = 0;
4256   1          
4257   1              //Trace( "\n OutGoods" );
4258   1              //1.Disable the device...
4259   1              //ITLMission_Reject();
4260   1              //WaitForWork(100,NULL);
4261   1              DisableBillDev();
4262   1              //WaitForWork(100,NULL);
4263   1      
4264   1              if( sysITLMission.billHoldingFlag == 1 )
4265   1              {
4266   2                      moneyBuf = CurrentPayed + sysITLMission.billHoldingValue;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 72  

4267   2              }
4268   1              else
4269   1              {
4270   2                  moneyBuf = CurrentPayed;
4271   2              }
4272   1          //if( (type==0)||(type==2) )   //type==1
4273   1          {
4274   2              sysVPMission.boughtFlag = 1;            
4275   2          }
4276   1      
4277   1          if( (type==0) )
4278   1          {   
4279   2                      DisplayLine = STR_TRANCE_ING;
4280   2                      DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].le
             -n );                
4281   2                      memset( DisplayBuffer, 0, sizeof( DisplayBuffer ) );    
4282   2                      switch( SystemParameter.curUnit )
4283   2                      {
4284   3                              case 1: 
4285   3                                      length = sprintf( DisplayBuffer, "%s%u", DispInformationTable[STR_BALANCE].str,moneyBuf );      
4286   3                              break;                          
4287   3                              case 10:
4288   3                                      length = sprintf( DisplayBuffer, "%s%u.%u", DispInformationTable[STR_BALANCE].str,
4289   3                                              moneyBuf / SystemParameter.curUnit, moneyBuf % SystemParameter.curUnit );       
4290   3                              break;
4291   3                              case 100:
4292   3                                      length = sprintf( DisplayBuffer, "%s%u.%02u", DispInformationTable[STR_BALANCE].str,
4293   3                                              moneyBuf / SystemParameter.curUnit, moneyBuf % SystemParameter.curUnit );       
4294   3                              break;          
4295   3                      }       
4296   2                      DisplayStr( 0, __LINE1__, 1, DisplayBuffer, length );
4297   2                      WaitForWork( 100 , NULL );       //500,100
4298   2                      Trace("\n InputGoodsWayList[CurrentStockCode].SetArrayNo = %bu", InputGoodsWayList[CurrentStockCode].Set
             -ArrayNo );
4299   2              sysVPMission.vendColumn = CurrentStockCode;
4300   2              sysVPMission.vendType = 0;
4301   2              sysVPMission.vendCost = GoodsWaySetVal[ CurrentStockCode].Price;
4302   2              }
4303   1              else if( type==2 )
4304   1              {
4305   2                  DisplayLine = STR_TRANCE_ING;
4306   2                      DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].le
             -n );                
4307   2                      memset( DisplayBuffer, 0, sizeof( DisplayBuffer ) );    
4308   2                      switch( SystemParameter.curUnit )
4309   2                      {
4310   3                              case 1: 
4311   3                                      length = sprintf( DisplayBuffer, "%s%lu", DispInformationTable[STR_VP_CARD_BALANCE].str,sysBCMission.b
             -alance );        
4312   3                              break;                          
4313   3                              case 10:
4314   3                                      length = sprintf( DisplayBuffer, "%s%lu.%lu", DispInformationTable[STR_VP_CARD_BALANCE].str,
4315   3                                              sysBCMission.balance/SystemParameter.curUnit, sysBCMission.balance%SystemParameter.curUnit );   
4316   3                              break;
4317   3                              case 100:
4318   3                                      length = sprintf( DisplayBuffer, "%s%lu.%02lu", DispInformationTable[STR_VP_CARD_BALANCE].str,
4319   3                                              sysBCMission.balance/SystemParameter.curUnit, sysBCMission.balance%SystemParameter.curUnit );   
4320   3                              break;          
4321   3                      }       
4322   2                      DisplayStr( 0, __LINE1__, 1, DisplayBuffer, length );
4323   2                      WaitForWork( 100 , NULL );       //500,100
4324   2                      Trace("\n InputGoodsWayList[CurrentStockCode].SetArrayNo = %bu", InputGoodsWayList[CurrentStockCode].Set
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 73  

             -ArrayNo );
4325   2              sysVPMission.vendColumn = CurrentStockCode;
4326   2              sysVPMission.vendType = 0;
4327   2              sysVPMission.vendCost = GoodsWaySetVal[ CurrentStockCode].Price;
4328   2              }
4329   1          else if( type==1 )
4330   1          {
4331   2              DisplayLine = STR_TRANCE_ING;
4332   2                      DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].le
             -n );
4333   2              /*              
4334   2                      memset( DisplayBuffer, 0, sizeof( DisplayBuffer ) );    
4335   2                      switch( SystemParameter.curUnit )
4336   2                      {
4337   2                              case 1: 
4338   2                                      length = sprintf( DisplayBuffer, "%s%u", DispInformationTable[STR_BALANCE].str,moneyBuf );      
4339   2                              break;                          
4340   2                              case 10:
4341   2                                      length = sprintf( DisplayBuffer, "%s%u.%u", DispInformationTable[STR_BALANCE].str,
4342   2                                              moneyBuf / SystemParameter.curUnit, moneyBuf % SystemParameter.curUnit );       
4343   2                              break;
4344   2                              case 100:
4345   2                                      length = sprintf( DisplayBuffer, "%s%u.%02u", DispInformationTable[STR_BALANCE].str,
4346   2                                              moneyBuf / SystemParameter.curUnit, moneyBuf % SystemParameter.curUnit );       
4347   2                              break;          
4348   2                      }       
4349   2                      DisplayStr( 0, __LINE1__, 1, DisplayBuffer, length );
4350   2              */
4351   2              ClearDisplayLine( 2 );
4352   2                      WaitForWork( 100 , NULL );       //500, 100
4353   2              CurrentStockCode = sysVPMission.vendColumn;
4354   2                      Trace("\n InputGoodsWayList[CurrentStockCode].SetArrayNo = %bu", InputGoodsWayList[CurrentStockCode].Set
             -ArrayNo );
4355   2              //sysVPMission.vendCost = GoodsWaySetVal[ CurrentStockCode].Price;
4356   2           
4357   2          }
4358   1          //---------------------------------------------------------------------------------
4359   1          sysVPMission.vendSta = 0;
4360   1          
4361   1              //Added for testing
4362   1          //ITLMission_Reject();
4363   1      
4364   1              #ifdef   _SJJ_//升降机
4365   1                      flag = ChannelLifterTask( InputGoodsWayList[CurrentStockCode].GoodsWayNo, CHANNEL_EXEC );               
4366   1              #else         //普通货道
                      flag = ChannelTask( InputGoodsWayList[CurrentStockCode].SetArrayNo, CHANNEL_EXEC );
                              if( flag == 7 )
                              {
                                      //接收到的命令包有错误，但货没有出
                                      flag = 0;
                                      flag = ChannelTask( InputGoodsWayList[CurrentStockCode].SetArrayNo, CHANNEL_EXEC );
                              }               
                      #endif
4375   1          
4376   1              Trace( "\n OutGoods flag = %bu", flag );
4377   1              VPMission_Act_RPT(VP_ACT_CHUHUO,0);
4378   1      //MAIN_TAB_VEND_NEXT:
4379   1              switch( flag )
4380   1              {
4381   2                      case 0:   //出货成功    
4382   2                      case 5:   //在限定的时间内电机不能到位（但货已出成功，货道有硬件故障）
4383   2                      {       
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 74  

4384   3              
4385   3                              Trace( "\n OutGoods 11" );
4386   3                              if( (type == 0) || (type==2)  )
4387   3                              {
4388   4                                      CurrentPayed = CurrentPayed - GoodsWaySetVal[CurrentStockCode].Price;
4389   4                              }
4390   3      
4391   3                  if( ( type == 1 ) )
4392   3                  {
4393   4                      if( CurrentPayed >= sysVPMission.vendCost )
4394   4                      {
4395   5                          CurrentPayed -= sysVPMission.vendCost;
4396   5                      }
4397   4                  }
4398   3                              DisplayLine = STR_TAKE_GOODS;
4399   3                              DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].l
             -en );
4400   3                  
4401   3                  //--------------------------------------------------------------------------------------------
             ----------------
4402   3                  if( type == 0 )
4403   3                  {
4404   4                                      if( ( IsCanChange() == 0 ) && ( ( SystemParameter.IsMuliVerd != 1 ) || \
4405   4                                      ( ( SystemParameter.IsMuliVerd == 1 ) && ( CurrentPayed < SystemParameter.Min ) ) ) )
4406   4                                      ClearDisplayLine( 2 );
4407   4                                      else
4408   4                                      {
4409   5                                              memset( DisplayBuffer, 0, sizeof(DisplayBuffer ));
4410   5                                              switch( SystemParameter.curUnit )
4411   5                                              {
4412   6                                                      case 1: 
4413   6                                                              length = sprintf( DisplayBuffer, "%s%u", DispInformationTable[STR_BALANCE].str,moneyBuf );      
4414   6                                                      break;                          
4415   6                                                      case 10:
4416   6                                                              length = sprintf( DisplayBuffer, "%s%u.%u", DispInformationTable[STR_BALANCE].str,
4417   6                                                                      moneyBuf / SystemParameter.curUnit, moneyBuf % SystemParameter.curUnit );       
4418   6                                                      break;
4419   6                                                      case 100:
4420   6                                                              length = sprintf( DisplayBuffer, "%s%u.%02u", DispInformationTable[STR_BALANCE].str,
4421   6                                                                      moneyBuf / SystemParameter.curUnit, moneyBuf % SystemParameter.curUnit );       
4422   6                                                      break;          
4423   6                                              }
4424   5                                              DisplayStr( 0, __LINE1__, 1, DisplayBuffer, length );
4425   5                                              WaitForWork( 200 , NULL );          //1500-200  
4426   5                                      }
4427   4                  }
4428   3                              GoodsWaySetVal[CurrentStockCode].WayState = 0x01;
4429   3                              //if( SystemParameter.GOCOn != 0x01 )
4430   3                              if(GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum > 0)
4431   3                              {
4432   4                                      GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum --;
4433   4                                      if( GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum == 0 )
4434   4                                              GoodsWaySetVal[CurrentStockCode].WayState = 0x05;
4435   4                                      //length = sprintf( DisplayBuffer, "%u", GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum);
4436   4                                      //DisplayStr( 0, __LINE1__, 1, DisplayBuffer, length );
4437   4                                      WaitForWork( 2000 , NULL );         //1500-200  
4438   4                                      
4439   4                  }
4440   3      
4441   3                              if( flag == 5 )
4442   3                              {
4443   4                                      //GoodsWaySetVal[CurrentStockCode].WayState |= 0x02;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 75  

4444   4                                      //VPMission_ColumnSta_RPT();
4445   4                              }
4446   3                              SaveGoodsSet(); 
4447   3                              //TradeCounter.TradeCurrencySum += GoodsWaySetVal[ CurrentStockCode].Price;   //正常交易的总金额
4448   3                              //TradeCounter.GoodTraceSum ++ ;             //正常交易次数
4449   3                              //TradeLog[ CurrentStockCode].TraceSum += 1; //此货道正常交易次数
4450   3                              SaveTradeCounter();
4451   3                              if( type == 1 )
4452   3                              {
4453   4                      UpdateGoodsMatrixStatus( sysVPMission.goodsType2 );
4454   4                              }
4455   3                              else
4456   3                              {
4457   4                                  UpdateGoodsMatrixStatus( sysVPMission.goodsType );
4458   4                              }
4459   3                              //
4460   3                  sysVPMission.vendSta = 0;
4461   3                              if(sysVPMission.offLineFlag == 1)
4462   3                              {
4463   4                                      TradeCounter.offLineNum++;
4464   4                                      TradeCounter.offLineMoney += sysVPMission.vendCost; 
4465   4                                      //len = sprintf( str, "1=%02bu,2=%02bu", TradeCounter.offLineNum,TradeCounter.offLineMoney);
4466   4                                      //DisplayStr( 0, 0, 1, str, strlen(str) ); 
4467   4                                      //WaitForWork(2000,NULL);                               
4468   4                              }
4469   3                              //len = sprintf( str, "2=%02bu,%02bu", CurrentStockCode, sysVPMission.vendColumn );
4470   3                      //DisplayStr( 0, 0, 1, str, len );
4471   3                          //WaitForWork( 2000, NULL );
4472   3                  VPMission_Vendout_RPT( sysVPMission.vendSta, sysVPMission.vendColumn, sysVPMission.vendType, s
             -ysVPMission.vendCost,GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum );
4473   3                              SaveTradeParam(); 
4474   3                              //--------------------------------------------------------
4475   3                              //if( (type == 0) || (type==2)  )
4476   3                              {
4477   4                                      sysVPMission.msGameTimer1 = 100; //200-100
4478   4                                      while( sysVPMission.msGameTimer1 )
4479   4                                      {
4480   5                                              //----------------------------------------------------
4481   5                                      //Send the game key and poll pc in speciall time
4482   5                                      if( IfGameKeyOn() )
4483   5                                              {
4484   6                                                      VPMission_Button_RPT( VP_BUT_GAME, VP_BUT_NUMBER );
4485   6                                              //Beep();
4486   6                                              }
4487   5                                              //if( ( sysVPMission.vendCmd == 0 )&&(sysVPMission.changeCmd == 0)&&(sysVPMission.costCmd == 0)&&(sys
             -VPMission.returnCmd == 0) )
4488   5                                              result = VPMission_Poll();
4489   5                                      //===============================
4490   5                                      }
4491   4                              }
4492   3                              //=========================================================
4493   3                              return 0;
4494   3                      }
4495   2                      break;
4496   2                      //命令失败和超时都是有疑问的交易
4497   2                      case 2:   //超时,货道板和主机通讯有问题,可认为整个出货统有问题          
4498   2                      case 1:   //命令失败，但失败原因不明，只能当疑问处理了
4499   2                      {
4500   3                              Trace( "\n OutGoods 12" );
4501   3                              // 出货超时
4502   3                              DisplayLine = STR_GOODS_WAY_ERR1;
4503   3                              DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].l
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 76  

             -en );                        
4504   3                              //GoodsWaySetVal[CurrentStockCode].WayState |= 0x02;
4505   3                              if(GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum > 0)
4506   3                              {
4507   4                                      GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum --;
4508   4                                      if( GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum == 0 )
4509   4                                              GoodsWaySetVal[CurrentStockCode].WayState = 0x05;
4510   4                                      //length = sprintf( DisplayBuffer, "%u", GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum);
4511   4                                      //DisplayStr( 0, __LINE1__, 1, DisplayBuffer, length );
4512   4                                      WaitForWork( 2000 , NULL );         //1500-200  
4513   4                                      
4514   4                  }
4515   3                              VPMission_ColumnSta_RPT();
4516   3              
4517   3                              if( (type == 0) || (type==2)  )
4518   3                              {
4519   4                                      if( IsCanChange() == 1 )
4520   4                                      {
4521   5                                              memset( DisplayBuffer, 0, sizeof( DisplayBuffer ) );                            
4522   5                                              switch( SystemParameter.curUnit )
4523   5                                              {
4524   6                                                      case 1: 
4525   6                                                              length = sprintf( DisplayBuffer, "%s%u", DispInformationTable[STR_BALANCE].str,CurrentPayed );  
4526   6                                                      break;                          
4527   6                                                      case 10:
4528   6                                                              length = sprintf( DisplayBuffer, "%s%u.%u", DispInformationTable[STR_BALANCE].str,
4529   6                                                                      CurrentPayed / SystemParameter.curUnit, CurrentPayed % SystemParameter.curUnit );       
4530   6                                                      break;
4531   6                                                      case 100:
4532   6                                                              length = sprintf( DisplayBuffer, "%s%u.%02u", DispInformationTable[STR_BALANCE].str,
4533   6                                                                      CurrentPayed / SystemParameter.curUnit, CurrentPayed % SystemParameter.curUnit );       
4534   6                                                      break;          
4535   6                                              }                               
4536   5                                              DisplayStr( 0, __LINE1__, 1, DisplayBuffer, length );
4537   5                                              WaitForWork( 1000 , NULL );
4538   5                                      }
4539   4                                      else
4540   4                                      {
4541   5                                              ClearDisplayLine( 2 );
4542   5                                              WaitForWork( 1000 , NULL );     
4543   5                                      }
4544   4                                      CurrentDispenseCoin = CurrentPayed;     
4545   4                                      CurrentPayed = 0;
4546   4                                      //DisplayStr( 0, __LINE0__ , 1 , "2", 1 );
4547   4                                      //WaitForWork( 2000, NULL );  //500-50-100-200  
4548   4                                      DispenseCoin(0);
4549   4                      }
4550   3                  //=====================================================================
4551   3                              //GoodsWaySetVal[CurrentStockCode].WayState |= 0x02;
4552   3                  SaveGoodsSet();                                 //Added by Andy on 2010.9.2
4553   3                              //---------------------------------------------------------------------                                                 
4554   3                              //TradeCounter.GoodDoubtTraceSum ++ ;             //有疑问出货交易次数计数              
4555   3                              //TradeLog[ CurrentStockCode].DoubtTraceSum ++;   //此货道有疑问交易次数
4556   3                              SaveTradeCounter();
4557   3                              SaveTradeParam();
4558   3                              if( type == 1 )
4559   3                              {
4560   4                      UpdateGoodsMatrixStatus( sysVPMission.goodsType2 );
4561   4                              }
4562   3                              else
4563   3                              {
4564   4                                  UpdateGoodsMatrixStatus( sysVPMission.goodsType );
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 77  

4565   4                              }
4566   3                              //
4567   3                              sysVPMission.vendSta = 2;
4568   3                              VPMission_Vendout_RPT( sysVPMission.vendSta, sysVPMission.vendColumn, sysVPMission.vendType, sysVPMissi
             -on.vendCost,GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum );
4569   3                              return 2;                                               
4570   3                      }
4571   2                      break;
4572   2                      //出货失败，如果不能找零，则看其它货道是否能服务，如能则让顾额选其它货
4573   2                      case 3:   //在转动前电机没有到位，没有出货，此货道已不能工作了
4574   2                      case 4:   //电机没有转动，没有出货，可以重试一次
4575   2                      case 7:   //接收到的命令包有错误，但货没有出
4576   2                      {       
4577   3                              Trace( "\n OutGoods 13" );
4578   3                              DisplayLine = STR_GOODS_WAY_ERR1;
4579   3                              DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].l
             -en );                        
4580   3                              //=====================================================================
4581   3                              GoodsWaySetVal[CurrentStockCode].WayState = 0x03;
4582   3                              GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum = 0;
4583   3                              //if(GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum > 0)
4584   3                              //{
4585   3                                      //GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum = 0;
4586   3                                      //GoodsWaySetVal[CurrentStockCode].WayState = 0x05;
4587   3                                      //length = sprintf( DisplayBuffer, "%u", GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum);
4588   3                                      //DisplayStr( 0, __LINE1__, 1, DisplayBuffer, length );
4589   3                                      WaitForWork( 2000 , NULL );         //1500-200  
4590   3                                      
4591   3                  //}
4592   3                  SaveGoodsSet();                  //Added by Andy on 2010.9.2
4593   3                  VPMission_ColumnSta_RPT();
4594   3                              if( type == 1 )
4595   3                              {
4596   4                      UpdateGoodsMatrixStatus( sysVPMission.goodsType2 );
4597   4                              }
4598   3                              else
4599   3                              {
4600   4                                  UpdateGoodsMatrixStatus( sysVPMission.goodsType );
4601   4                              }
4602   3                              //---------------------------------------------------------------------
4603   3                              //After wrong dispense, payout automaticly.
4604   3                              {
4605   4                                  {
4606   5                                              //ClearDisplayLine( 2 );
4607   5                                              //WaitForWork( 2500 , NULL );
4608   5                                      }
4609   4                                  sysVPMission.vendSta = 2;
4610   4                                      VPMission_Vendout_RPT( sysVPMission.vendSta, sysVPMission.vendColumn, sysVPMission.vendType, sysVPMiss
             -ion.vendCost,GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum );
4611   4                      WaitForWork( 2500 , NULL );
4612   4                                      return 0;
4613   4                              }
4614   3                              //=====================================================================
4615   3                              //---------------------------------------------------------------------                 
4616   3                              /*if( sysGoodsMatrix[goodsCodeBack].NextColumn == 0xff ) //In the goods matrix, if none good column lef
             -t, ask for another one!
4617   3                              {
4618   3                                      {
4619   3                                              //ClearDisplayLine( 2 );
4620   3                                              //WaitForWork( 2500 , NULL );
4621   3                                      }
4622   3                      sysVPMission.vendSta = 2;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 78  

4623   3                                      VPMission_Vendout_RPT( sysVPMission.vendSta, sysVPMission.vendColumn, sysVPMission.vendType, sysVPMiss
             -ion.vendCost,GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum );
4624   3                                      return 0;
4625   3                              }
4626   3                              else  //Automaticly vend the next good column's goods.
4627   3                              {
4628   3                                  //
4629   3                                      CurrentStockCode = sysGoodsMatrix[goodsCodeBack].NextColumn;
4630   3                                      sysVPMission.vendColumn = CurrentStockCode;
4631   3                      sysVPMission.vendSta = 0;
4632   3                      sysVPMission.vendCost = GoodsWaySetVal[ CurrentStockCode].Price;
4633   3                                      //
4634   3                      flag = 0;
4635   3                              flag = ChannelTask( InputGoodsWayList[CurrentStockCode].SetArrayNo, CHANNEL_EXEC );
4636   3                          Trace( "\n OutGoods flag = %bu", flag );
4637   3                                      goto MAIN_TAB_VEND_NEXT;
4638   3                              }*/
4639   3                      }
4640   2                      break;
4641   2                      case 8:   //The goods cann't pass the check position
4642   2                      {       
4643   3                              Trace( "\n OutGoods 13" );
4644   3                              DisplayLine = STR_GOODS_WAY_ERR1;
4645   3                              DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].l
             -en );                        
4646   3                              //=====================================================================
4647   3                  //#ifdef SYS_GOOS_SOLDOUT_CTR
4648   3                              //      GoodsWaySetVal[CurrentStockCode].WayState |= 0x04;   //Need?
4649   3                  //#endif
4650   3                  if(GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum > 0)
4651   3                              {
4652   4                                      GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum --;
4653   4                                      if( GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum == 0 )
4654   4                                              GoodsWaySetVal[CurrentStockCode].WayState = 0x05;
4655   4                                      //length = sprintf( DisplayBuffer, "%u", GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum);
4656   4                                      //DisplayStr( 0, __LINE1__, 1, DisplayBuffer, length );
4657   4                                      WaitForWork( 2000 , NULL );         //1500-200  
4658   4                                      
4659   4                  }
4660   3                  SaveGoodsSet();                  
4661   3                          if( type == 1 )
4662   3                              {
4663   4                      UpdateGoodsMatrixStatus( sysVPMission.goodsType2 );
4664   4                              }
4665   3                              else
4666   3                              {
4667   4                                  UpdateGoodsMatrixStatus( sysVPMission.goodsType );
4668   4                              }
4669   3                              //---------------------------------------------------------------------
4670   3                              //After wrong dispense, payout automaticly.
4671   3                              {
4672   4                                  {
4673   5                                              //ClearDisplayLine( 2 );
4674   5                                              //WaitForWork( 2500 , NULL );
4675   5                                      }
4676   4                                  sysVPMission.vendSta = 2;
4677   4                                      VPMission_Vendout_RPT( sysVPMission.vendSta, sysVPMission.vendColumn, sysVPMission.vendType, sysVPMiss
             -ion.vendCost,GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum );
4678   4                                      WaitForWork( 1000 , NULL );   //2500, 1000
4679   4                                      return 0;
4680   4                              }
4681   3                              //=====================================================================
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 79  

4682   3                              /*
4683   3                              //---------------------------------------------------------------------
4684   3                              if( sysGoodsMatrix[goodsCodeBack].NextColumn == 0xff ) //In the goods matrix, if none good column left,
             - ask for another one!
4685   3                              {
4686   3                                      {
4687   3                                              //ClearDisplayLine( 2 );
4688   3                                              //WaitForWork( 2500 , NULL );
4689   3                                      }
4690   3                                      sysVPMission.vendSta = 2;
4691   3                                      VPMission_Vendout_RPT( sysVPMission.vendSta, sysVPMission.vendColumn, sysVPMission.vendType, sysVPMiss
             -ion.vendCost,GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum );
4692   3                                      return 0;
4693   3                              }
4694   3                              else  //Automaticly vend the next good column's goods.
4695   3                              {
4696   3                                  //
4697   3                                      CurrentStockCode = sysGoodsMatrix[goodsCodeBack].NextColumn;
4698   3                                      sysVPMission.vendColumn = CurrentStockCode;
4699   3                      sysVPMission.vendSta = 0;
4700   3                      sysVPMission.vendCost = GoodsWaySetVal[ CurrentStockCode].Price;
4701   3                                      //
4702   3                      flag = 0;
4703   3                              flag = ChannelTask( InputGoodsWayList[CurrentStockCode].SetArrayNo, CHANNEL_EXEC );
4704   3                          Trace( "\n OutGoods flag = %bu", flag );
4705   3                                      goto MAIN_TAB_VEND_NEXT;
4706   3                              }
4707   3                              */
4708   3                              //return 0;
4709   3                      }
4710   2                      break;
4711   2                      default: break;
4712   2              }
4713   1              VPMission_Vendout_RPT( sysVPMission.vendSta, sysVPMission.vendColumn, sysVPMission.vendType, sysVPMission
             -.vendCost,GoodsWaySetVal[ CurrentStockCode].GoodsCurrentSum );
4714   1              return 0;
4715   1      }
4716          
4717          //确定是否断续购买商品,返回0,不继续购买，进行找零；返回1则继续购买
4718          u_char ReBuy()
4719          {
4720   1              u_char xdata i = 0;     
4721   1              u_char xdata j = 0;
4722   1              u_char xdata result = 0;
4723   1              u_int  xdata moneyBuf = 0;
4724   1      
4725   1              CurrentStockCode = 0;
4726   1              //----------------------------------------------------
4727   1              //Send the game key and poll pc in speciall time
4728   1          if( IfGameKeyOn() )
4729   1              {
4730   2                      VPMission_Button_RPT( VP_BUT_GAME, VP_BUT_NUMBER );
4731   2              //Beep();
4732   2              }
4733   1              //if( ( sysVPMission.vendCmd == 0 )&&(sysVPMission.changeCmd == 0)&&(sysVPMission.costCmd == 0)&&(sysVPMi
             -ssion.returnCmd == 0) )
4734   1                      result = VPMission_Poll();
4735   1              //====================================================
4736   1      
4737   1              if( sysITLMission.billHoldingFlag == 1 )
4738   1              {
4739   2                      moneyBuf = CurrentPayed + sysITLMission.billHoldingValue;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 80  

4740   2              }
4741   1              else
4742   1              {
4743   2                  moneyBuf = CurrentPayed;
4744   2              }
4745   1              sysVPMission.inBillMoney = CurrentPayed;
4746   1              if( moneyBuf == 0 ) 
4747   1                      return 0;
4748   1              //判断是否允许再次购买
4749   1              if( SystemParameter.IsMuliVerd != 1 ) 
4750   1              {
4751   2                      i = 0;
4752   2                      if( IsCanChange() == 1 ) 
4753   2                      {
4754   3                  
4755   3                              ClearDisplayLine( 1 );
4756   3                  /*
4757   3                              memset( DisplayBuffer,0,sizeof(DisplayBuffer) );
4758   3                              switch( SystemParameter.curUnit )
4759   3                              {
4760   3                                      case 1:
4761   3                                              i = sprintf( DisplayBuffer, "%s%u", DispInformationTable[STR_CHANGE].str, CurrentPayed );
4762   3                                      break;                          
4763   3                                      case 10:
4764   3                                              i = sprintf( DisplayBuffer, "%s%u.%u", DispInformationTable[STR_CHANGE].str,
4765   3                                                      CurrentPayed/SystemParameter.curUnit,CurrentPayed%SystemParameter.curUnit );   //"%s%u.%02u--"%s%u.%
             -u"                                
4766   3                                      break;
4767   3                                      case 100:
4768   3                                              i = sprintf( DisplayBuffer, "%s%u.%02u", DispInformationTable[STR_CHANGE].str,
4769   3                                                      CurrentPayed/SystemParameter.curUnit,CurrentPayed%SystemParameter.curUnit );                            
4770   3                                      break;          
4771   3                              }                                       
4772   3                              DisplayStr( 0, __LINE1__, 1, DisplayBuffer, i );
4773   3                              WaitForWork( 200 , NULL );          //2000-200-
4774   3                  */
4775   3                      }
4776   2                      return 0;
4777   2              }       
4778   1              //先判断余钱是否超过再次购物的标准,如超过则让用户确定是否断续购物
4779   1          //取消SystemParameter.Min != 0判断;by gzz 20110624
4780   1              //if( ( CurrentPayed >= SystemParameter.Min ) && ( SystemParameter.Min != 0  )) 
4781   1          if( moneyBuf > SystemParameter.Min ) 
4782   1              {               
4783   2                      if( ColnumIsCanServer() == 1 )
4784   2                      {
4785   3                          //--------------------------------------------------------- 
4786   3                              //Added for EV736-UB by Andy 2011.6.3
4787   3                          DisplayCurrentMoney(CurrentPayed);
4788   3                              //UpdateGoodsMatrixStatus( sysVPMission.goodsType );
4789   3                              UpdateSelLed_Trade();
4790   3                  if( moneyBuf < SystemParameter.BanknoteMax )
4791   3                  {
4792   4                      EnableBillDev();                
4793   4                  }
4794   3                              sysVPMission.sTimer1 = SystemParameter.tradeTime;
4795   3                              SaveTradeParam();  //2011.6.10 added: Update the sale data in flash!
4796   3                              ClearKey();//20110622
4797   3                              return 1;
4798   3                  //=========================================================
4799   3      
4800   3                              //还有好的货道可以服务,则询问顾客是否还买货                     
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 81  

4801   3                              //显示字符
4802   3                      #ifdef _CHINA_
4803   3                              DisplayStr( 0, 0, 1, DispInformationTable[STR_RE_BUY].str, DispInformationTable[STR_RE_BUY ].len );
4804   3                      #else
                                      DisplayStr( 0, 0, 1, DispInformationTable[STR_RE_BUY].str, DispInformationTable[STR_RE_BUY ].len );
                              #endif
4807   3                      #ifdef _CHINA_
4808   3                              DisplayStr( 0, 1, 1, DispInformationTable[STR_OK_NOT].str, DispInformationTable[STR_OK_NOT ].len );
4809   3                      #else
                                      DisplayStr( 0, 1, 1, DispInformationTable[STR_OK_NOT].str, DispInformationTable[STR_OK_NOT ].len );
                              #endif                      
4812   3                              //等待选择
4813   3                              SgwSecTimer= 30;
4814   3                              while( SgwSecTimer )
4815   3                              {
4816   4                                      WaitForWork( 50, NULL ); 
4817   4                                      i = GetKey();           
4818   4                                      switch ( i )
4819   4                                      {
4820   5                                              case KEY_SUBMIT:        
4821   5                                                      DisplayCurrentMoney(CurrentPayed);
4822   5                                                      return 1 ;      //确定再继续            
4823   5                                              case KEY_CANCEL:        
4824   5                                                      i = 0;
4825   5                                                      if( IsCanChange() == 1 )
4826   5                                                      {
4827   6                                                              ClearDisplayLine( 1 );
4828   6                                                              memset( DisplayBuffer,0,sizeof(DisplayBuffer) );
4829   6                                                              switch( SystemParameter.curUnit )
4830   6                                                              {
4831   7                                                                      case 1:
4832   7                                                                              i = sprintf( DisplayBuffer, "%s%u", DispInformationTable[STR_CHANGE].str, CurrentPayed );
4833   7                                                                      break;                          
4834   7                                                                      case 10:
4835   7                                                                              i = sprintf( DisplayBuffer, "%s%u.%u", DispInformationTable[STR_CHANGE].str,
4836   7                                                                                      CurrentPayed/SystemParameter.curUnit,CurrentPayed%SystemParameter.curUnit );    //                      
4837   7                                                                      break;
4838   7                                                                      case 100:
4839   7                                                                              i = sprintf( DisplayBuffer, "%s%u.%02u", DispInformationTable[STR_CHANGE].str,
4840   7                                                                                      CurrentPayed/SystemParameter.curUnit,CurrentPayed%SystemParameter.curUnit );                            
4841   7                                                                      break;          
4842   7                                                              }                                                                                                       
4843   6                                                              DisplayStr( 0, __LINE1__, 1, DisplayBuffer, i );
4844   6                                                              WaitForWork( 1500 , NULL );
4845   6                                                      }
4846   5                                                      return 0 ;//确定不不买了
4847   5                                              default:
4848   5                                                      continue;
4849   5                                      }       
4850   4                              }
4851   3                              //等待超时，直接找零了
4852   3                              if( IsCanChange() == 1 )
4853   3                              {
4854   4                                      i = 0;
4855   4                                      ClearDisplayLine( 1 );                          
4856   4                                      memset( DisplayBuffer,0,sizeof(DisplayBuffer) );
4857   4                                      switch( SystemParameter.curUnit )
4858   4                                      {
4859   5                                              case 1:
4860   5                                                      i = sprintf( DisplayBuffer, "%s%u", DispInformationTable[STR_CHANGE].str, CurrentPayed );
4861   5                                              break;                          
4862   5                                              case 10:
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 82  

4863   5                                                      i = sprintf( DisplayBuffer, "%s%u.%u", DispInformationTable[STR_CHANGE].str,
4864   5                                                              CurrentPayed/SystemParameter.curUnit,CurrentPayed%SystemParameter.curUnit );                            
4865   5                                              break;
4866   5                                              case 100:
4867   5                                                      i = sprintf( DisplayBuffer, "%s%u.%02u", DispInformationTable[STR_CHANGE].str,
4868   5                                                              CurrentPayed/SystemParameter.curUnit,CurrentPayed%SystemParameter.curUnit );                            
4869   5                                              break;          
4870   5                                      }                                       
4871   4                              
4872   4                                      DisplayStr( 0, __LINE1__, 1, DisplayBuffer, i );
4873   4                                      WaitForWork( 1500 , NULL );
4874   4                              }
4875   3                              return 0;
4876   3                      }               
4877   2                      else
4878   2                      {
4879   3                  UpdateSelLed_Trade();//更新指示灯;by gzz 20110617
4880   3                              //已无货道可以服务了，直接找零
4881   3                              if( IsCanChange() == 1 )
4882   3                              {
4883   4                                      i = 0;
4884   4                                      ClearDisplayLine( 1 );
4885   4                                      ///////////////
4886   4                                      memset( DisplayBuffer,0,sizeof(DisplayBuffer) );
4887   4                                      switch( SystemParameter.curUnit )
4888   4                                      {
4889   5                                              case 1:
4890   5                                                      i = sprintf( DisplayBuffer, "%s%u", DispInformationTable[STR_CHANGE].str, CurrentPayed );
4891   5                                              break;                          
4892   5                                              case 10:
4893   5                                                      i = sprintf( DisplayBuffer, "%s%u.%u", DispInformationTable[STR_CHANGE].str,
4894   5                                                              CurrentPayed/SystemParameter.curUnit,CurrentPayed%SystemParameter.curUnit );                            
4895   5                                              break;
4896   5                                              case 100:
4897   5                                                      i = sprintf( DisplayBuffer, "%s%u.%02u", DispInformationTable[STR_CHANGE].str,
4898   5                                                              CurrentPayed/SystemParameter.curUnit,CurrentPayed%SystemParameter.curUnit );                            
4899   5                                              break;          
4900   5                                      }                       
4901   4                                      DisplayStr( 0, __LINE1__, 1, DisplayBuffer, i );
4902   4                                      WaitForWork( 1500 , NULL );
4903   4                              }
4904   3                              return 0;
4905   3                      }               
4906   2              }
4907   1              else  //直接找零
4908   1              {
4909   2                      if( IsCanChange() == 1 )
4910   2                      {
4911   3                              i = 0;
4912   3                              ClearDisplayLine( 1 );                  
4913   3                              memset( DisplayBuffer,0,sizeof(DisplayBuffer) );
4914   3                              switch( SystemParameter.curUnit )
4915   3                              {
4916   4                                      case 1:
4917   4                                              i = sprintf( DisplayBuffer, "%s%u", DispInformationTable[STR_CHANGE].str, CurrentPayed );
4918   4                                      break;                          
4919   4                                      case 10:
4920   4                                              i = sprintf( DisplayBuffer, "%s%u.%u", DispInformationTable[STR_CHANGE].str,
4921   4                                                      CurrentPayed/SystemParameter.curUnit,CurrentPayed%SystemParameter.curUnit );                            
4922   4                                      break;
4923   4                                      case 100:
4924   4                                              i = sprintf( DisplayBuffer, "%s%u.%02u", DispInformationTable[STR_CHANGE].str,
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 83  

4925   4                                                      CurrentPayed/SystemParameter.curUnit,CurrentPayed%SystemParameter.curUnit );                            
4926   4                                      break;          
4927   4                              }                                                                                       
4928   3                              DisplayStr( 0, __LINE1__, 1, DisplayBuffer, i );
4929   3                              WaitForWork( 2000 , NULL );
4930   3                      }
4931   2                      return 0;
4932   2              }
4933   1      }
4934          
4935          u_char TestHardWare()
4936          {
4937   1          //bit data z = 0;   
4938   1              if( HardWareErr )
4939   1              {       
4940   2                      CheckHardWare( 3 ); //查检硬件故障
4941   2              }
4942   1              return 0 ;
4943   1      }
4944          
4945          /**
4946          * 计算找零方案
4947          * @param in length 数组的长度
4948           
4949          * @param in coins
4950          * @param in lefts
4951           
4952          可找零币种
4953          每种币剩余量
4954           
4955          * @param out results 找零结果（返回结果"成功"时有效）
4956          * @param in money
4957           
4958          * @return
4959           
4960          返回1：成功；返回0：失败
4961           
4962          */
4963          u_char MakeChange(int length, unsigned char* coins,
4964          unsigned char* lefts, unsigned char* results, int money)
4965          {
4966   1          unsigned char  i=0;
4967   1          unsigned char  count;
4968   1          //printf("allMoney=%d\n", money);
4969   1      
4970   1          for(i=0; i<length; ++i)
4971   1          {
4972   2              unsigned char coin = coins[i];
4973   2              unsigned char left = lefts[i];
4974   2      
4975   2              if(left <= 0 || coin > money)
4976   2              {
4977   3                  continue;
4978   3              }
4979   2              count = money / coin;
4980   2      
4981   2              if(count > left)
4982   2              {
4983   3                  count = left;
4984   3              }
4985   2              lefts[i] = left - count;
4986   2      
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 84  

4987   2              //printf("%d=%d\n",coin,count);
4988   2              results[i] = count;
4989   2      
4990   2              money -= count*coin;
4991   2              if(money == 0)
4992   2              {
4993   3                  break;
4994   3              }
4995   2          }
4996   1      
4997   1          if(money == 0)
4998   1          {
4999   2              return 1;
5000   2          }
5001   1          else
5002   1          {
5003   2              for(i=0; i<length; ++i)
5004   2              {
5005   3                  results[i] = 0;
5006   3              }
5007   2              return 0;
5008   2          }
5009   1      }
5010          
5011          //找零美分
5012          void changeUSD()
5013          {
5014   1          //*可找零硬币面额（美分）（面额从大到小）
5015   1          unsigned char xdata coins[5] = {100, 50, 25, 10, 5};
5016   1          //*每种面额硬币可找零个数（硬币只支持255个，超过255也只填255*
5017   1          unsigned char xdata lefts[5] = {0, 3, 5, 1, 0};
5018   1          //*找零结果（确保传入MakeChange前，results被清零）*
5019   1          unsigned char xdata results[5] = {0, 0, 0, 0, 0};
5020   1          if(MakeChange(5, coins, lefts, results, 335))
5021   1          {
5022   2              //*找零335美分 *
5023   2              //printf("USA Success\n");
5024   2          }
5025   1          else
5026   1          {
5027   2              //printf("USA Fail\n");
5028   2          }
5029   1      }
5030          
5031          
5032          //找零人民币/*找零money元,即3.5元=35(money)*/
5033          u_char changeCNY(unsigned char* results, u_int money)
5034          {               
5035   1          //*可找零硬币面额（人民币角）（面额从大到小）*
5036   1          unsigned char xdata coins[2] = {10, 5};
5037   1          //*每种面额硬币剩余个数 *
5038   1          unsigned char xdata lefts[2] = {0, 0};
5039   1              //u_char xdata len = 0;
5040   1              //u_char xdata str[20];
5041   1              
5042   1              lefts[0] = sysMDBMission.coin1yNum;
5043   1              lefts[1] = sysMDBMission.coin5jNum;
5044   1          //unsigned char xdata results[2] = {0, 0};
5045   1          //len = sprintf( str, "2.1:%u.%02u,%u,%u", money/10,money%10,lefts[0],lefts[1] );
5046   1              //DisplayStr( 0, 0, 1, str, len );
5047   1              //WaitForWork( 5000, NULL );
5048   1              
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 85  

5049   1          if(MakeChange(2, coins, lefts, results, money))
5050   1          {
5051   2              
5052   2              //printf("CNY Success\n");
5053   2              //DisplayStr( 0, 0, 1, "2CNY Success",12 );
5054   2                      //WaitForWork( 2000, NULL );
5055   2              return 1;
5056   2          }
5057   1          else
5058   1          {
5059   2              //printf("CNY Fail\n");
5060   2              //DisplayStr( 0, 0, 1, "2CNY Fail",9 );
5061   2                      //WaitForWork( 2000, NULL );
5062   2              return 0;
5063   2          }
5064   1      
5065   1      }
5066          
5067          
5068          u_char DispenseCoin(unsigned char flag )
5069          {
5070   1              u_char xdata tHopper1 = 0;
5071   1              u_char xdata tHopper2 = 0;
5072   1              u_char xdata tHopper3 = 0;
5073   1              u_char xdata ret = 0 ;
5074   1              uint   xdata outMoney = 0;
5075   1              u_char xdata i = 0;
5076   1              u_char xdata coin1flag = 1;
5077   1              u_char xdata coin2flag = 1;
5078   1              u_char xdata coin3flag = 1;
5079   1              u_char xdata m_Errorflag = 0;
5080   1              u_char xdata result = 0;
5081   1              u_char xdata mission;
5082   1              //u_char xdata tempMoney;
5083   1          u_int xdata dispenseValue = 0;
5084   1              u_char xdata dispensedNum = 0;
5085   1          u_char xdata trymis = 0;
5086   1              u_char xdata resultdisp[2] = {0, 0};
5087   1              u_char xdata tempdisp = 0;
5088   1              u_int  xdata  temppayOutMoney1=0;
5089   1              u_int  xdata  temppayOutMoney2=0;
5090   1              //u_char xdata str[20];
5091   1              //u_char xdata len = 0;
5092   1              
5093   1              Trace( "\n DispenseCoin" );
5094   1              Trace( "\n CurrentDispenseCoin = %d", CurrentDispenseCoin );    
5095   1              WaitForWork( 500 , NULL );  
5096   1              VPMission_Act_RPT(VP_ACT_PAYOUT,0);
5097   1              WaitForWork( 100 , NULL );  
5098   1          
5099   1              /*
5100   1              if( ( IsCanChange() != 1 ) && ( ColnumIsCanServer() == 1 ) )
5101   1              {
5102   1                      return 0;
5103   1              }
5104   1          */
5105   1          
5106   1          MDBMission_Coin_Disable();
5107   1              MDBMission_Bill_Disable();
5108   1          //1.Judge the payout value
5109   1              //if( CurrentDispenseCoin > (SystemParameter.BanknoteMax + 200) )
5110   1              //{
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 86  

5111   1              //      CurrentDispenseCoin = SystemParameter.BanknoteMax + 200;        
5112   1              //}
5113   1          //2.
5114   1          DisplayLine = STR_TAKE_COIN;
5115   1              DisplayStr( 0, __LINE0__ , 1 , DispInformationTable[ DisplayLine ].str, DispInformationTable[ DisplayLine
             - ].len );
5116   1              WaitForWork( 50 , NULL ); 
5117   1              memset( DisplayBuffer,0,sizeof(DisplayBuffer) );
5118   1              switch( SystemParameter.curUnit )
5119   1              {
5120   2                      case 1:
5121   2                              i = sprintf( DisplayBuffer, "%s%u", DispInformationTable[STR_CHANGE].str, CurrentDispenseCoin );
5122   2                      break;                          
5123   2                      case 10:
5124   2                              i = sprintf( DisplayBuffer, "%s%u.%u", DispInformationTable[STR_CHANGE].str,
5125   2                                      CurrentDispenseCoin/SystemParameter.curUnit,CurrentDispenseCoin%SystemParameter.curUnit );   //"%s%u.%
             -02u--"%s%u.%u"                                
5126   2                      break;
5127   2                      case 100:
5128   2                              i = sprintf( DisplayBuffer, "%s%u.%02u", DispInformationTable[STR_CHANGE].str,
5129   2                                      CurrentDispenseCoin/SystemParameter.curUnit,CurrentDispenseCoin%SystemParameter.curUnit );                              
5130   2                      break;          
5131   2              }                                       
5132   1              DisplayStr( 0, __LINE1__, 1, DisplayBuffer, i );
5133   1              WaitForWork( 50 , NULL );          
5134   1      
5135   1      
5136   1          sysVPMission.changeFlag = 1;
5137   1              //--------------------------------------------------------------
5138   1              sysVPMission.payOutMoney1 = 0;
5139   1          sysVPMission.payOutMoney2 = 0;
5140   1          //==============================================================
5141   1      
5142   1      
5143   1              /*
5144   1              //用于Hopper找零
5145   1              tHopper2= CurrentDispenseCoin/100;
5146   1              tHopper1= CurrentDispenseCoin%100/10/5;
5147   1          mission=MDB_Coin_Dispense(0,tHopper1);
5148   1          DelayMs( 100 );
5149   1              //if(mission==0)
5150   1          //{
5151   1              VP_GameKeyPoll( 1000 );
5152   1                      outMoney = 0;                       
5153   1              do
5154   1                      {
5155   1                          mission=MDB_Coin_IfDispensed(sysMDBMission.coinBuf,&sysMDBMission.coinBufLen,&sysMDBMission.coinType
             -,&tempMoney,&sysMDBMission.coinStock);
5156   1                          outMoney++;
5157   1                              DelayMs(10);
5158   1                      }
5159   1                      while(mission!=0x00);
5160   1              //}
5161   1      
5162   1              mission=MDB_Coin_Dispense(1,tHopper2);
5163   1          DelayMs( 100 );
5164   1              //if(mission==0)
5165   1              //{
5166   1              VP_GameKeyPoll( 1000 );
5167   1                      outMoney=0;
5168   1                      do
5169   1                      {
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 87  

5170   1                          mission=MDB_Coin_IfDispensed(sysMDBMission.coinBuf,&sysMDBMission.coinBufLen,&sysMDBMission.coinType
             -,&tempMoney,&sysMDBMission.coinStock);
5171   1                          outMoney++;
5172   1                              DelayMs(10);
5173   1                      }
5174   1                      while(mission!=0x00);
5175   1              //}
5176   1              memset(sysMDBMission.coinBuf,0,sizeof(sysMDBMission.coinBuf));
5177   1              sysMDBMission.coinBufLen=0;
5178   1              sysMDBMission.coinType=0;
5179   1              sysMDBMission.coinStock=0;
5180   1              */
5181   1              
5182   1              
5183   1      TAB_DISPENSE_RETRY:
5184   1              //用于level3的找零
5185   1              //dispenseValue = CurrentDispenseCoin/50;
5186   1          //mission = MDB_Coin_EXP_Payout( dispenseValue );
5187   1          //用于level2的找零
5188   1              dispenseValue = CurrentDispenseCoin/10;
5189   1              mission =changeCNY(resultdisp,dispenseValue);
5190   1              if(mission == 1)
5191   1              {
5192   2                      for(i=0;i<2;i++)
5193   2                      {
5194   3                              if(resultdisp[i]==0) 
5195   3                                      continue;
5196   3      
5197   3                              //len = sprintf( str, "i=%02bu,%02bu", i, resultdisp[i] );
5198   3                      //DisplayStr( 0, 0, 1, str, len );
5199   3                          //WaitForWork( 5000, NULL );
5200   3                              while(resultdisp[i])
5201   3                              {
5202   4                                      if(resultdisp[i] > 15)
5203   4                                      {
5204   5                                              tempdisp = 15;
5205   5                                              resultdisp[i] -= tempdisp;
5206   5                                      }
5207   4                                      else
5208   4                                      {
5209   5                                              tempdisp = resultdisp[i];
5210   5                                              resultdisp[i] -= tempdisp;
5211   5                                      }
5212   4                                      if(i==0)
5213   4                                              //一元
5214   4                                              mission=MDB_Coin_Dispense(1,tempdisp);
5215   4                                      else if(i==1)
5216   4                                              //5jiao
5217   4                                              mission=MDB_Coin_Dispense(0,tempdisp);
5218   4                                      
5219   4                                      WaitForWork(1000,NULL); 
5220   4                                  if( mission == 0x00 )
5221   4                                      {
5222   5      
5223   5                                          sysVPMission.hopperOutTimer = tempdisp + 20;
5224   5                                          while( sysVPMission.hopperOutTimer )
5225   5                                              {
5226   6                                              mission = MDB_Coin_EXP_PayoutValuePoll( &dispensedNum );
5227   6                                                      if( mission == 0x00 )
5228   6                                                      {
5229   7                                                              mission = MDB_Coin_EXP_PayoutStatus( sysMDBMission.coinBuf, &sysMDBMission.coinBufLen );
5230   7                                                              if( mission == 0x01 )
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 88  

5231   7                                                              {
5232   8                                                                      if(sysMDBMission.coinBuf[0] > 0)
5233   8                                                                      {
5234   9                                                                              sysMDBMission.payout5jNum = sysMDBMission.coinBuf[0];
5235   9                                                                              sysVPMission.payOutMoney1 = sysMDBMission.payout5jNum*50;
5236   9                                                                              temppayOutMoney1 += sysVPMission.payOutMoney1;
5237   9                                                                              //TradeCounter.Hopper1Num += sysMDBMission.payout5jNum;
5238   9                                                                  //TradeCounter.Hopper1Sum += sysVPMission.payOutMoney1;
5239   9                                                                              SellAccumulateMoney(&TradeCounter.Hopper1Sum,sysVPMission.payOutMoney1);
5240   9                                                                  //TradeCounter.ChangeSum += sysVPMission.payOutMoney1;
5241   9                                                                              CurrentDispenseCoin = CurrentDispenseCoin-sysVPMission.payOutMoney1;
5242   9                                          //区间
5243   9                                                                              //TradeCounter.Hopper1SumBack += sysVPMission.payOutMoney1;
5244   9                                                                              SellAccumulateMoney(&TradeCounter.Hopper1SumBack,sysVPMission.payOutMoney1);
5245   9                                                                      }
5246   8                                                                      else if(sysMDBMission.coinBuf[1] > 0)
5247   8                                                                      {
5248   9                                                                              sysMDBMission.payout1yNum = sysMDBMission.coinBuf[1];
5249   9                                                                              sysVPMission.payOutMoney2 = sysMDBMission.payout1yNum*100;
5250   9                                                                              temppayOutMoney2 += sysVPMission.payOutMoney2;
5251   9                                                                              //TradeCounter.Hopper2Num += sysMDBMission.payout1yNum;
5252   9                                                                  //TradeCounter.Hopper2Sum += sysVPMission.payOutMoney2;
5253   9                                                                              SellAccumulateMoney(&TradeCounter.Hopper2Sum,sysVPMission.payOutMoney2);
5254   9                                                                  //TradeCounter.ChangeSum += sysVPMission.payOutMoney2;
5255   9                                                                              CurrentDispenseCoin = CurrentDispenseCoin-sysVPMission.payOutMoney2;
5256   9      
5257   9                                                                              //区间
5258   9                                                                              //TradeCounter.Hopper2SumBack += sysVPMission.payOutMoney2;
5259   9                                                                              SellAccumulateMoney(&TradeCounter.Hopper2SumBack,sysVPMission.payOutMoney2);
5260   9                                                                      }
5261   8                                                                      sysVPMission.hopperOutTimer = 0;                                                        
5262   8                                                              }
5263   7                                                              else
5264   7                                                              {
5265   8                                                                      //VP_GameKeyPoll( 1000 );                
5266   8                                                              }
5267   7                                                      }
5268   6                                                      else
5269   6                                                      {
5270   7                                                              VP_GameKeyPoll( 1000 );         
5271   7                                                              FeedWatchDog(); 
5272   7                                                      }
5273   6                                              }
5274   5                                      }
5275   4                                      else if( mission == 0x80 )
5276   4                                      {
5277   5                                      trymis++;
5278   5                                      if(trymis<3)
5279   5                                      {
5280   6                                                  WaitForWork( 300, NULL );
5281   6                                              goto TAB_DISPENSE_RETRY;
5282   6                                      }
5283   5                                      }
5284   4                              }
5285   3                      }
5286   2              }
5287   1              
5288   1                 
5289   1          if( CurrentDispenseCoin > 0 )
5290   1              {
5291   2                      m_Errorflag = 1;
5292   2                      //如果找零器有多找零情况，保存多找零金额;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 89  

5293   2              //如果有欠款，显示欠款金额;by gzz 20110825
5294   2              if(CurrentDispenseCoin>30000)
5295   2              {
5296   3                      SystemParameter.MuchOutFlag = 1;
5297   3                  SystemParameter.NotOutMax = 65535-CurrentDispenseCoin;
5298   3                              //HardWareErr |= 0x8000;
5299   3              } 
5300   2              else
5301   2              {  
5302   3                  SystemParameter.MuchOutFlag = 0;
5303   3                              SystemParameter.NotOutMax = CurrentDispenseCoin;
5304   3                              VPMission_Debt_RPT(0,0,CurrentDispenseCoin);//上报欠条;by gzz 20110825
5305   3              }
5306   2                      IOUFlag = 1;
5307   2              }
5308   1              else
5309   1              {
5310   2                  m_Errorflag = 0;    
5311   2              }
5312   1      
5313   1          //-------------------------------------------------------------------------------------------
5314   1              //if( (temppayOutMoney1>0) || ( temppayOutMoney2>0 ) )
5315   1              if(flag)
5316   1              {
5317   2                      VPMission_Payout_RPT( VP_DEV_COIN, temppayOutMoney1, temppayOutMoney2  );
5318   2              sysVPMission.payOutMoney1 = 0;
5319   2                      sysVPMission.payOutMoney2 = 0;
5320   2              }
5321   1              else
5322   1              {
5323   2                      VPMission_Payout_RPTNOACK( VP_DEV_COIN, temppayOutMoney1, temppayOutMoney2  );
5324   2              sysVPMission.payOutMoney1 = 0;
5325   2                      sysVPMission.payOutMoney2 = 0;
5326   2              }       
5327   1              //===========================================================================================
5328   1              if( m_Errorflag == 0 )
5329   1              {       
5330   2                  /*
5331   2                      DisplayLine = STR_TAKE_COIN;
5332   2                      DisplayStr( 0, __LINE0__ , 1 , DispInformationTable[ DisplayLine ].str, DispInformationTable[ DisplayLin
             -e ].len );
5333   2              //WaitForWork( 1000, NULL );       //2000-1000
5334   2                      WaitForWork( 100, NULL );
5335   2                      sysVPMission.msGameTimer1 = 100;   //
5336   2                      while( sysVPMission.msGameTimer1 )
5337   2                      {
5338   2                              //----------------------------------------------------
5339   2                      //Send the game key and poll pc in speciall time
5340   2                      if( IfGameKeyOn() )
5341   2                              {
5342   2                                      VPMission_Button_RPT( VP_BUT_GAME, VP_BUT_NUMBER );
5343   2                              //Beep();
5344   2                              }
5345   2                      result = VPMission_Poll();
5346   2                      //====================================================
5347   2                      }
5348   2                  */
5349   2      
5350   2              }
5351   1              else
5352   1              {
5353   2                      SaveGlobalParam();
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 90  

5354   2                      DisplayLine = STR_COIN_NOT_ENOUGH; // 硬币不够 
5355   2                      DisplayStr( 0, __LINE0__ , 1, DispInformationTable[     DisplayLine ].str, DispInformationTable[ DisplayLine
             - ].len );                        
5356   2                      DisplayLine = STR_DUO_MONEY;
5357   2                      memset( DisplayBuffer, 0, sizeof( DisplayBuffer ) );
5358   2                      memcpy( DisplayBuffer, DispInformationTable[DisplayLine ].str, DispInformationTable[ DisplayLine ].len )
             -;
5359   2                      i = DispInformationTable[ DisplayLine ].len;            
5360   2                      switch( SystemParameter.curUnit )
5361   2                      {
5362   3                              case 1:
5363   3                                      i += sprintf( DisplayBuffer + i, "%u", SystemParameter.NotOutMax );
5364   3                              break;                          
5365   3                              case 10:
5366   3                                      i += sprintf( DisplayBuffer + i, "%u.%u", SystemParameter.NotOutMax/SystemParameter.curUnit, SystemPar
             -ameter.NotOutMax%SystemParameter.curUnit );
5367   3                              break;
5368   3                              case 100:
5369   3                              i += sprintf( DisplayBuffer + i, "%u.%02u", SystemParameter.NotOutMax/SystemParameter.curUnit, SystemPa
             -rameter.NotOutMax%SystemParameter.curUnit );                  
5370   3                              break;          
5371   3                      }               
5372   2                      /*if( SystemParameter.NotOutMax >= 100 )                                        
5373   2                              i += LenOfNum( SystemParameter.NotOutMax ) + 1;
5374   2                      else 
5375   2                              i += LenOfNum( SystemParameter.NotOutMax ) + 2;*/
5376   2                      DisplayStr( 0, __LINE1__ , 1, DisplayBuffer, i );                       
5377   2                      //WaitForWork( 2500 , NULL );
5378   2                      /*
5379   2                      WaitForWork( 100, NULL );
5380   2                      sysVPMission.msGameTimer1 = 250;
5381   2                      while( sysVPMission.msGameTimer1 )
5382   2                      {
5383   2                              //----------------------------------------------------
5384   2                      //Send the game key and poll pc in speciall time
5385   2                      if( IfGameKeyOn() )
5386   2                              {
5387   2                                      VPMission_Button_RPT( VP_BUT_GAME, VP_BUT_NUMBER );
5388   2                              //Beep();
5389   2                              }
5390   2                      result = VPMission_Poll();
5391   2                      //====================================================
5392   2                      }
5393   2                      */
5394   2                      VP_GameKeyPoll( 2000 );
5395   2                  //HardWareErr = ERR_HOPPER;
5396   2              }
5397   1         
5398   1      
5399   1              //Update the changer tube status
5400   1              VP_GameKeyPoll( 500 );  
5401   1              MDB_Coin_TubeSta_API();
5402   1              sysVPMission.tubeCoinMoney = sysMDBMission.coinAllValue;//保存硬币斗可找零金额
5403   1              sysVPMission.inBillMoney = 0;
5404   1              if( SystemParameter.SVC_NoChange != 1 )
5405   1              {
5406   2                  #ifdef MACHINE_SET_MDB
5407   2                          //if( (sysMDBMission.coinDeviceStatus!=0) || (sysMDBMission.coin5jNum < 3 ) || (sysMDBMission.coinAl
             -lValue<500) )
5408   2                  if( (sysMDBMission.coinDeviceStatus!=0) || (sysMDBMission.coinAllValue<500))
5409   2                      {
5410   3                              //HardWareErr |=        0x0008;                
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 91  

5411   3                      }
5412   2                              else
5413   2                              {                
5414   3                                      HardWareErr &=  0xFFF7;
5415   3                              }
5416   2                      #else
                                  if( DeviceStatus.ChangeUnit1 != 0 )
                                      {
                                              //HardWareErr |=        0x0008;
                                      }
                                      else
                                      {
                                              HardWareErr &=  0xFFF7;
                                      }
                              #endif
5426   2              }
5427   1              return 0;
5428   1      
5429   1      }
5430          
5431          //上面超时且无金额则返回1,有钱则返回0
5432          u_char CheckTimerOrMoney()
5433          {
5434   1              if ( CurrentPayed == 0 )
5435   1              {
5436   2                      DisplayLine = STR_OPERATION_TIMEOUT;    
5437   2                      DisplayStr( 0, __LINE0__ , 1 , DispInformationTable[DisplayLine ].str, DispInformationTable[DisplayLine 
             -].len );
5438   2              //      ClearDisplayLine1();
5439   2                      ClearDisplayLine( 2 );
5440   2                      WaitForWork( 3000 , NULL );
5441   2                      return 1 ;
5442   2              }
5443   1              return 0;
5444   1      }
5445          
5446          u_char DispInputMoney()
5447          {
5448   1              u_char xdata length = 0;
5449   1              u_char xdata pt= 0;
5450   1      
5451   1              //先显示钞票不足
5452   1              DisplayLine = STR_NOT_ENOUGH_NOTE;
5453   1              DisplayStr( 0, __LINE0__ , 1 , DispInformationTable[DisplayLine ].str, DispInformationTable[DisplayLine ]
             -.len );        
5454   1              pt = 0;
5455   1              pt = ChooseReturn( );
5456   1              if( pt == 0 )//确定
5457   1              {
5458   2                      EnableBillDev();
5459   2                      DisplayCurrentMoney( CurrentPayed );
5460   2                      return 1;
5461   2              }
5462   1              else //取消或超时
5463   1              {
5464   2                      memset( DisplayBuffer , 0 , sizeof( DisplayBuffer ));
5465   2                      DisplayLine = STR_PLEASE_WAIT;          
5466   2                      DisplayStr( 0, __LINE0__ , 1 , DispInformationTable[DisplayLine ].str, DispInformationTable[DisplayLine 
             -].len );
5467   2      //              ClearDisplayLine1();
5468   2                      ClearDisplayLine( 2 );
5469   2                      WaitForWork( 100 , NULL );
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 92  

5470   2                      return 0;
5471   2              }
5472   1      }
5473          
5474          //找更便宜的货物
5475          u_char ExistAnyChoose()
5476          {
5477   1              u_char xdata i;
5478   1              
5479   1              for( i= 0 ; i <= GOODSWAYNUM ; i++)
5480   1              {               
5481   2                      if ( CurrentPayed >= GoodsWaySetVal[i].Price )                  
5482   2                              return 0 ; //找到同类更便宜卡   
5483   2              }
5484   1              //Trace( "\n Cheaper stock Not Found! Ready to Reject Coin=%d" , CurrentPayed );
5485   1              CurrentDispenseCoin = CurrentPayed;
5486   1              return( 1 ); //没的选择，必需要退币 
5487   1      }
5488          
5489          //提示客户是否选择买其它的货，确定返回1并到50节点让用户重新输入，取消或超时返回0
5490          u_char CheaperOnePlz()
5491          {
5492   1      //      u_char xdata length;
5493   1              u_char xdata pt= 0;
5494   1      //      u_int xdata Unicode_buffer[ MAX_CHAR_NUMBER *2 ];
5495   1      
5496   1      //      Trace( "\n CheaperOnePlz");
5497   1              DisplayLine = STR_CHOICE_CHEAPERONE;
5498   1        //  length = DispInformationTable[    DisplayLine ].len;
5499   1        //  memcpy( DisplayBuffer , DispInformationTable[ DisplayLine ].str , length );       
5500   1              DisplayStr( 0, 0, 1, DispInformationTable[      DisplayLine ].str, DispInformationTable[ DisplayLine ].len );
5501   1      //      DisplayInfo( __LINE0__ , 0 , DisplayBuffer );
5502   1      
5503   1              pt = ChooseReturn( );
5504   1              if( pt == 0 )//确定
5505   1              {
5506   2                      ClearKey();     
5507   2                      return 1;
5508   2              }
5509   1              if( pt == 1 ) //取消
5510   1                      return 0;
5511   1              DisplayLine = STR_OPERATION_TIMEOUT;
5512   1              DisplayStr( 0, __LINE0__ , 1 , DispInformationTable[DisplayLine ].str, DispInformationTable[DisplayLine ]
             -.len );
5513   1              ClearDisplayLine( 2 );
5514   1              WaitForWork( 500 , NULL );
5515   1              return 0;
5516   1      }
5517          
5518          //看系统是否允许退币，允许退币且需要退币则退并返0，不允许则返回1反复提示,不需要退币返回2        
5519          u_char CheckChangePermit()
5520          {
5521   1      //      Trace( "\n CheckChangePermit");
5522   1      //      ClearDisplayLine1();    
5523   1              u_char xdata i;
5524   1              if( CurrentPayed > 0 ) 
5525   1              {
5526   2                      if ( SystemParameter.RefundPermission )
5527   2                      {
5528   3                              if( IsCanChange() != 1 )
5529   3                              {
5530   4                                      CurrentDispenseCoin = 0;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 93  

5531   4                                      return 2;
5532   4                              }
5533   3                              //在此设置出币总额
5534   3                              DisplayLine = STR_REFUND_MONEY;
5535   3                              DisplayStr( 0, __LINE0__ , 1 , DispInformationTable[DisplayLine ].str, DispInformationTable[DisplayLine
             - ].len );
5536   3              //              DisplayLine = STR_PLEASE_WAIT;
5537   3              //              DisplayStr( 0, __LINE1__ , 1 , DispInformationTable[DisplayLine ].str, DispInformationTable[DisplayLi
             -ne ].len );
5538   3                              memset( DisplayBuffer , 0 , sizeof( DisplayBuffer ));
5539   3                              //////////////////
5540   3                              memset( DisplayBuffer,0,sizeof(DisplayBuffer) );
5541   3                              switch( SystemParameter.curUnit )
5542   3                              {
5543   4                                      case 1:
5544   4                                              i = sprintf( DisplayBuffer, "%s%u", DispInformationTable[STR_CHANGE].str, CurrentPayed );
5545   4                                      break;                          
5546   4                                      case 10:
5547   4                                              i = sprintf( DisplayBuffer, "%s%u.%02u", DispInformationTable[STR_CHANGE].str,
5548   4                                                      CurrentPayed/SystemParameter.curUnit,CurrentPayed%SystemParameter.curUnit );                            
5549   4                                      break;
5550   4                                      case 100:
5551   4                                              i = sprintf( DisplayBuffer, "%s%u.%02u", DispInformationTable[STR_CHANGE].str,
5552   4                                                      CurrentPayed/SystemParameter.curUnit,CurrentPayed%SystemParameter.curUnit );                            
5553   4                                      break;          
5554   4                              }
5555   3                              DisplayStr( 0, __LINE1__ , 1 , DisplayBuffer, i );
5556   3                              CurrentDispenseCoin = CurrentPayed;
5557   3                              return 0; //退币
5558   3                      }
5559   2                      else
5560   2                              return 1;
5561   2              }
5562   1              else 
5563   1                      return 2;
5564   1      }
5565          
5566          u_char DispGetCoin()
5567          {
5568   1              return( 0 );
5569   1      }
5570          
5571          //找零
5572          u_char ReturnChange()
5573          {
5574   1          u_char xdata result = 0;
5575   1              u_int  xdata moneyBuf = 0;
5576   1              u_char xdata flag = 0;
5577   1      //      Trace( "\n ReturnChange");
5578   1      //      LightBlinkFlag = 0;    
5579   1      //      LightBlinkFlag = 1;                     
5580   1      //      if ( CurrentPayed > GoodsWaySetVal[CurrentStockCode].Price )
5581   1      //      {
5582   1      
5583   1          sysVPMission.boughtFlag = 0; //Clear the bought flag after vending.
5584   1          //----------------------------------------------------
5585   1              //Send the game key and poll pc in speciall time
5586   1          if( IfGameKeyOn() )
5587   1              {
5588   2                      VPMission_Button_RPT( VP_BUT_GAME, VP_BUT_NUMBER );
5589   2              //Beep();
5590   2              }
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 94  

5591   1              //if( ( sysVPMission.vendCmd == 0 )&&(sysVPMission.changeCmd == 0)&&(sysVPMission.costCmd == 0)&&(sysVPMi
             -ssion.returnCmd == 0) )
5592   1                      result = VPMission_Poll();
5593   1              //====================================================
5594   1              sysVPMission.inBillMoney = 0;
5595   1              if( sysITLMission.billHoldingFlag == 1 )
5596   1              {
5597   2                      moneyBuf = CurrentPayed + sysITLMission.billHoldingValue;
5598   2              }
5599   1              else
5600   1              {
5601   2                  moneyBuf = CurrentPayed;
5602   2              }
5603   1              
5604   1          if( moneyBuf > 0 )
5605   1              {
5606   2                      if( sysITLMission.billHoldingFlag == 1 ) 
5607   2                      {
5608   3                          
5609   3                              flag = MDB_Bill_EscrowCtr(0);
5610   3                              //调整顺序，flag==0放在sysVPMission之上;by gzz 20110721
5611   3                              if( flag == 0 )
5612   3                              {
5613   4                                      sysVPMission.escrowMoney = sysITLMission.billHoldingValue;
5614   4                                      sysITLMission.billHoldingFlag = 0;
5615   4                                  sysITLMission.billHoldingValue = 0;
5616   4                              }
5617   3                              else
5618   3                              {
5619   4                                      sysVPMission.escrowMoney = sysITLMission.billHoldingValue;
5620   4                                      //... Need more discussion for better soluton!
5621   4                          sysITLMission.billHoldingFlag = 0;
5622   4                                  sysITLMission.billHoldingValue = 0;
5623   4                              }
5624   3                      //-----------------------------------------------------
5625   3                              sysVPMission.escrowOutFlag = 1;                 
5626   3                              if( sysVPMission.escrowOutFlag == 1 )
5627   3                          {
5628   4                                  VPMission_Payin_RPT( VP_DEV_ESCROWOUT, sysVPMission.escrowMoney );
5629   4                                      sysVPMission.escrowOutFlag = 0;
5630   4                              sysVPMission.escrowMoney = 0;     
5631   4                              }
5632   3                              //=====================================================
5633   3                              //.Send the reject message to PC
5634   3      
5635   3                              if( CurrentPayed > 0 )
5636   3                      {
5637   4                          //UpdateSelLed_Trade();
5638   4                                      //DisplayCurrentMoney( CurrentPayed/*+sysITLMission.billHoldingValue* / );
5639   4                          //by gzz 20110416
5640   4                                      //DisableBillDev();
5641   4                          //EnableBillDev();
5642   4                          //End_by gzz 20110416       
5643   4                              
5644   4                                      
5645   4                      }
5646   3                      else
5647   3                      {
5648   4                          //by gzz 20110416
5649   4                                      //DisableBillDev();
5650   4                          //EnableBillDev();
5651   4                          //End_by gzz 20110416       
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 95  

5652   4                          UpdateSelectionLed_GoodsSta(); 
5653   4                      }
5654   3                      }
5655   2                      CurrentDispenseCoin = CurrentPayed;     // - GoodsWaySetVal[CurrentStockCode].Price; 
5656   2                      CurrentPayed = 0;
5657   2                      //DisplayStr( 0, __LINE0__ , 1 , "3", 1 );
5658   2                      //WaitForWork( 2000, NULL );  //500-50-100-200
5659   2                      if( DispenseCoin(0) == 0 )                                      
5660   2                              return( 0 );            
5661   2                      else                                    
5662   2                              return 1;
5663   2          }
5664   1              else
5665   1              {
5666   2                      return 0;
5667   2              }
5668   1      
5669   1      //      }       
5670   1      //      return  0 ;
5671   1      }
5672          
5673          u_char DispThx()
5674          {
5675   1          /*
5676   1              DisplayLine = STR_THX_YOU_WITHOUT_COIN;
5677   1              DisplayStr( 0, __LINE0__ , 1 , DispInformationTable[DisplayLine ].str, DispInformationTable[DisplayLine ]
             -.len );
5678   1              ClearDisplayLine( 2 );
5679   1              WaitForWork( 100 , NULL );       //1500,500
5680   1          */
5681   1      
5682   1              return( 0 );
5683   1      }
5684          
5685          u_char SellCodeOver()
5686          {       
5687   1              //KeyLock( );           
5688   1              SaveTradeParam();
5689   1      
5690   1              //----------------------------------------------------
5691   1              //2011.5.20 added
5692   1              //After vending, update the goods window led status.
5693   1          UpdateSelectionLed_GoodsSta();
5694   1          //====================================================
5695   1      
5696   1          if( sysITLMission.ITLSet != 1 )
5697   1          {
5698   2                      CasherGetMachineState( 0 );//空闲状态
5699   2                      CasherResetOuttime();
5700   2          }
5701   1              CheckHardWare( 1 );             
5702   1              //KeyUnLock();
5703   1              if(HardWareErr==0)//by gzz 20110419
5704   1              {
5705   2                  /*
5706   2                      ITLMission_Reject();
5707   2                      WaitForWork(100,NULL);
5708   2                      ITLMission_Init_1();
5709   2                      */
5710   2              }
5711   1          //----------------------------------------
5712   1              ClearKey();
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 96  

5713   1              //========================================
5714   1              sysVPMission.VPDevCtr  |= 0x80;
5715   1              sysVPMission.dspTimer1 = VP_DSP_TIME1;
5716   1          //ChangeOver(); 
5717   1          /////////////////////////
5718   1          //LoadGlobalParam();
5719   1          ///////////////////////////    
5720   1              return( 1 );
5721   1      }
5722          
5723          u_char AllGoodsWayError()
5724          {
5725   1              u_char xdata i = 0;
5726   1      
5727   1              SaveTradeParam();
5728   1              
5729   1              /*
5730   1              Disabled by Andy on 2010.10.26
5731   1              for( i = 0; i < GOODSWAYNUM; i ++ )     
5732   1                      GoodsWaySetVal[i].WayState = 0x08;
5733   1              */
5734   1      
5735   1              HardWareErr |= 0x0040;
5736   1              DeviceStatus.Driver64 |= 0x01;
5737   1        //HardWareErr = ERR_GOODSBOARDERR;    
5738   1              DisplayLine = STR_HARDWARE_ERR;
5739   1              DisplayStr( 0, __LINE0__, 1, DispInformationTable[DisplayLine].str, DispInformationTable[DisplayLine].len
             - );        
5740   1              return 1;
5741   1      }
5742          
5743          
5744          u_char MaintFunction()
5745          {       
5746   1              u_char xdata i = 0;
5747   1              u_int  xdata coinBuf = 0;
5748   1      
5749   1              Beep();
5750   1              WaitForWork(200,NULL);
5751   1              Beep(); 
5752   1          //SaveGlobalParam();
5753   1              AlarmSpacing = 0;
5754   1              AlarmTime = 0;
5755   1              if( SystemParameter.BillNo == 1 )
5756   1              {
5757   2                      DisableBillDev();
5758   2              }
5759   1              //MDBMission_Bill_Disable();//by gzz 20120323
5760   1              SystemStatus = 2;
5761   1              if( KeyLockFlag )
5762   1              {
5763   2                      KeyUnLock(); //锁定键盘，不让客户按键
5764   2                      KeyLockFlag = 0;
5765   2              }       
5766   1              #ifdef   _SHUPING_
5767   1              #else
                              sysVPMission.sel1ReadyLed = 0x00;
                          sysVPMission.sel1ErrLed   = 0x00;
                          sysVPMission.sel2ReadyLed = 0x00;
                          sysVPMission.sel2ErrLed   = 0x00;
                          sysVPMission.sel3ReadyLed = 0x00;
                          sysVPMission.sel3ErrLed   = 0x00;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 97  

                              GetKey_M2();
                      #endif  
5776   1              MaintFlag = 1;
5777   1      
5778   1              HardWareErr = 0;   //Changed by GZZ 2011.7.19
5779   1              //--------------------------------------------------------------
5780   1              sysVPMission.VPMode = 0;
5781   1          VPMission_Admin_RPT( VP_ADMIN_ENTER_MENU, 0, 0 );
5782   1              //WaitForWork(1000,NULL);
5783   1              VPMission_Act_RPT(VP_ACT_ADMIN,VP_ACT_ENTERADMIN);
5784   1              //WaitForWork( 800, NULL );
5785   1              sysVPMission.adminType = 1;
5786   1              VPMission_Status_RPT(); 
5787   1              do
5788   1              {
5789   2                      WatchDogDisable();
5790   2                      mainmenu();
5791   2                      //WatchDogInit();
5792   2              }
5793   1              while( IsModeOff() );    //是否模式开关处于维护状态
5794   1      
5795   1              //sysVPMission.VPMode = 1;
5796   1              sysVPMission.VPInit = 1;
5797   1              sysVPMission.VPMode = 1;
5798   1              VPMission_Admin_RPT( VP_ADMIN_QUIT_MENU, 0, 0 );
5799   1              //WaitForWork(1000,NULL);
5800   1              VPMission_Act_RPT(VP_ACT_ADMIN,VP_ACT_OUTADMIN);
5801   1              //WaitForWork( 800, NULL );
5802   1              sysVPMission.adminType = 0;
5803   1              //VP_CMD_GetStatus();   
5804   1              MDB_Coin_TubeSta_API();
5805   1              sysITLMission.billHoldingFlag = 0;
5806   1              sysITLMission.billHoldingValue = 0;
5807   1          //===============================================================
5808   1      
5809   1              MaintFlag = 0;
5810   1              DisplayStr( 0, 0, 1, DispInformationTable[ STR_PLEASE_WAIT ].str, DispInformationTable[ STR_PLEASE_WAIT ]
             -.len );        
5811   1              DisplayStr( 0, 1, 1, " ", 1 );
5812   1              ClearKey();
5813   1              SystemStatus = 1;
5814   1              HardWareErr = 0; //默认硬件无故障，然后自检去真正检查   
5815   1              IsCanInCashFlag = 1;
5816   1              if( KeyLockFlag == 0 )
5817   1              {
5818   2                      KeyLock(); //锁定键盘，不让客户按键
5819   2                      KeyLockFlag = 1;
5820   2              }       
5821   1              //isShowLcd = 1;
5822   1      
5823   1              //扫描单价是否有为0的
5824   1          /*
5825   1              for( i = 0; i < GOODSWAYNUM; i ++ )     
5826   1              {
5827   1                      if( ( GoodsWaySetVal[i].WayNo == InputGoodsWayList[i].GoodsWayNo ) && 
5828   1                              ( InputGoodsWayList[ i ].UseState == 1 ) &&
5829   1                              ( GoodsWaySetVal[i].Price == 0 ) )
5830   1                      {
5831   1                              HardWareErr |= 0x0400;
5832   1                              break;
5833   1                      }
5834   1              }       
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 98  

5835   1              if( i != GOODSWAYNUM )
5836   1              {
5837   1                      UpdataDisp = 0;
5838   1                      ///清除报警标志位       
5839   1                      MoneyDevAlarm = 0;
5840   1                      SystemErrorAlarm = 0;
5841   1                      SMSQuery = 0;
5842   1                      //清除短信发送缓存区内的所有短信
5843   1                      //ClearAllSMSInSMSBuffer();
5844   1                      return 0;
5845   1              }
5846   1          */
5847   1      
5848   1              GetHopperList();
5849   1              CheckHardWare( 0 );
5850   1              GetHopperList();                
5851   1              
5852   1              /*
5853   1              for( i = 0; i < GOODSWAYNUM; i ++ )     
5854   1              {
5855   1                      GoodsWaySetVal[i].WayState &= 0x1f;     
5856   1          }
5857   1          */
5858   1      
5859   1              if( ( ( DeviceStatus.BillAccepter != 0 ) || ( IsCanInCashFlag == 0 ) ) && ( DeviceStatus.CoinAccepter != 
             -0 ) )
5860   1              {       
5861   2                  //HardWareErr |= 0x0002;
5862   2              }
5863   1          
5864   1          //清货道控制板的SN
5865   1              if( ChannelTask( 0, CHANNEL_CLEAR ) == 2 )
5866   1              {
5867   2                      //执行命令超时,应是主板与货道驱动板通讯故障
5868   2                      Trace("\n Channel are break");
5869   2              /*
5870   2              //Disabled by Andy on 2010.10.26
5871   2                      for( i = 0; i < GOODSWAYNUM; i ++ )     
5872   2                              GoodsWaySetVal[i].WayState = 0x09;
5873   2              */
5874   2                      HardWareErr |= 0x0040;
5875   2                      DeviceStatus.Driver64 |= 0x01;
5876   2              }
5877   1          else
5878   1          {
5879   2              //ChannelTask( 0, CHANNEL_QUERY );
5880   2          }
5881   1              UpdataDisp = 0;
5882   1              ///清除报警标志位       
5883   1              MoneyDevAlarm = 0;
5884   1              SystemErrorAlarm = 0;
5885   1              SMSQuery = 0;
5886   1              //清除短信发送缓存区内的所有短信
5887   1              //ClearAllSMSInSMSBuffer();     
5888   1          coinBuf = GetCoin();
5889   1              return 0;
5890   1      }
5891          
5892          void Mission()
5893          {       
5894   1          /*  
5895   1              if ( IsShortMsgIn())
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 99  

5896   1              {       
5897   1                      IsShortMessageIn = 1;
5898   1                      Trace("Have SMS come in ");
5899   1              }
5900   1              */
5901   1      }
5902          
5903          //有金额的时候,不显示故障页面
5904          u_char ShowOutofService()
5905          {       
5906   1              u_int  xdata moneyBuf= 0;
5907   1      
5908   1              if( sysITLMission.billHoldingFlag == 1 )
5909   1              {
5910   2                      moneyBuf = CurrentPayed + sysITLMission.billHoldingValue;
5911   2              }
5912   1              else
5913   1              {
5914   2                      moneyBuf = CurrentPayed;
5915   2              }       
5916   1              //WaitForWork( 1000, NULL );
5917   1              if(moneyBuf)
5918   1              {               
5919   2                      if(errInputMoney==0)
5920   2                              errInputMoney = 1;              
5921   2              }
5922   1              else
5923   1              {
5924   2                      if(errInputMoney==1)
5925   2                              errInputMoney = 0;      
5926   2              }
5927   1              return 0;
5928   1      }
5929          
5930          
5931          //在故障页面判断禁能纸币器硬币器
5932          u_char EnableBillOutofService()
5933          {       
5934   1              u_int  xdata moneyBuf= 0;
5935   1      
5936   1              if( sysITLMission.billHoldingFlag == 1 )
5937   1              {
5938   2                      moneyBuf = CurrentPayed + sysITLMission.billHoldingValue;
5939   2              }
5940   1              else
5941   1              {
5942   2                      moneyBuf = CurrentPayed;
5943   2              }       
5944   1              //WaitForWork( 1000, NULL );
5945   1              if(moneyBuf < SystemParameter.BanknoteMax)
5946   1              {               
5947   2                      EnableBillDev();
5948   2              }       
5949   1              return 0;
5950   1      }
5951          
5952          
5953          
5954          u_char OutofService()
5955          {       
5956   1      
5957   1          //#define CHKTIMES   600    //1000-600
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 100 

5958   1              u_char xdata len = 0;   
5959   1              u_char xdata errcode = 0,errcode2=0;
5960   1              u_char xdata errCodeStr[20];
5961   1              u_char xdata flag = 0;
5962   1              //static  u_int   xdata chkTime   = 0;
5963   1              static  u_char  xdata errUpdate = 0;
5964   1              
5965   1          //Trace( "\n HardWareErr3 = %bu", HardWareErr );
5966   1          //CasherGetMachineState( 1 );//按交易状态处理
5967   1              
5968   1          /*
5969   1              chkTime++;
5970   1              if( (chkTime >= CHKTIMES)&&(HardWareErr & 0x0800) )
5971   1              {
5972   1                      chkTime = 0;
5973   1                  //-------------------------------------------
5974   1                      //Added by Andy on 2010.10.21 for GOC dev.
5975   1                  if( ChannelTask( 1, CHANNEL_QUERY ) == 2 )
5976   1                      {
5977   1                              //执行命令超时,应是主板与货道驱动板通讯故障
5978   1                              DeviceStatus.Driver64 |= 0x01;
5979   1                              HardWareErr |= 0x0040;  
5980   1                      }
5981   1              DisableBillDev();    //Added 2011.1.20
5982   1          }
5983   1          */
5984   1      
5985   1              //if ( isShowLcd == 1 )
5986   1              {               
5987   2                      if(sysVPMission.ErrFlag2 == 0)
5988   2                      {               
5989   3                              /*
5990   3                              if( SystemParameter.ACDCModule == 1 )
5991   3                              {
5992   3                                      //关闭压缩机展示灯
5993   3                                      sysVPMission.ACDCLedCtr = 0; 
5994   3                                      sysVPMission.ACDCCompressorCtr = 0;                     
5995   3                                      ACDCMission();
5996   3                              }
5997   3                              */
5998   3                              //DisplayStr( 0, __LINE0__ , 1 , "close", 5 );
5999   3                              //WaitForWork( 2000, NULL );  //500-50-100-200  
6000   3      
6001   3                              //强制退币
6002   3                              //-----------------------------------------------------------------------------------
6003   3                          //Andy added 2011.4.14.Rject the holding bill.
6004   3                          if( sysITLMission.billHoldingFlag == 1 ) 
6005   3                              {
6006   4                                      flag = MDB_Bill_EscrowCtr(0);
6007   4                                      //调整顺序，flag==0放在sysVPMission之上;by gzz 20110721
6008   4                                      //-----------------------------------------------------
6009   4                                      sysVPMission.escrowOutFlag = 1;
6010   4                                      sysVPMission.escrowMoney = sysITLMission.billHoldingValue;
6011   4                                      sysITLMission.billHoldingFlag = 0;
6012   4                                  sysITLMission.billHoldingValue = 0;
6013   4                                      if( sysVPMission.escrowOutFlag == 1 )
6014   4                                  {
6015   5                                          VPMission_Payin_RPT( VP_DEV_ESCROWOUT, sysVPMission.escrowMoney );
6016   5                                              sysVPMission.escrowOutFlag = 0;
6017   5                                      sysVPMission.escrowMoney = 0;     
6018   5                                      }
6019   4                                      //=====================================================
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 101 

6020   4                                      if( flag == 0 )
6021   4                                      {
6022   5                                              sysITLMission.billHoldingFlag = 0;
6023   5                                          sysITLMission.billHoldingValue = 0;
6024   5                                      }
6025   4                                      else
6026   4                                      {
6027   5                                              //... Need more discussion for better soluton!
6028   5                              sysITLMission.billHoldingFlag = 0;
6029   5                                          sysITLMission.billHoldingValue = 0;
6030   5                                      }
6031   4                                      //.Send the reject message to PC                                
6032   4                              }
6033   3                              if(CurrentPayed>0) 
6034   3                              {
6035   4                                  CurrentDispenseCoin = CurrentPayed; 
6036   4                                      CurrentPayed = 0;
6037   4                                      //DisplayStr( 0, __LINE0__ , 1 , "4", 1 );
6038   4                                      //WaitForWork( 2000, NULL );  //500-50-100-200
6039   4                                      DispenseCoin(0);
6040   4                                      DisableBillDev();                               
6041   4                          SaveTradeParam();  //2011.6.10 added: Update the sale data in flash!
6042   4                          UpdateSelectionLed_GoodsSta();
6043   4                          EnableBillDev(); 
6044   4                                      memset(&sysMDBMission.coinBuf,0,sizeof(sysMDBMission.coinBuf));
6045   4                              memset(&sysMDBMission.billBuf,0,sizeof(sysMDBMission.billBuf));            
6046   4                              }
6047   3                              if( sysVPMission.boughtFlag==1 )
6048   3                              {
6049   4                                      sysVPMission.boughtFlag = 0;
6050   4                              }
6051   3                              if( sysITLMission.billHoldingFlag != 1 )
6052   3                              {
6053   4                                      MDB_Bill_EscrowCtr(0);  //Added to reject the unknown holding bill
6054   4                              }
6055   3                              //关闭纸币器硬币器
6056   3                              DisableBillDev(); 
6057   3                              sysVPMission.billCoinEnable = 0;
6058   3                              sysVPMission.ErrFlag2 = 1;
6059   3                              //上报STATUS_RPT
6060   3                              if(sysVPMission.ErrFlag==0)
6061   3                              {
6062   4                                      sysVPMission.ErrFlag=1;
6063   4                                      VPMission_Status_RPT();
6064   4                              }
6065   3                      }
6066   2                      memset(errCodeStr,0,sizeof(errCodeStr));        
6067   2                      //if( HardWareErr & 0x0001 )
6068   2                      //{
6069   2                              //errcode = 0xF1;
6070   2                              //sprintf( errCodeStr, "%s", "纸硬币器故障" );                  
6071   2                              //sprintf( errCodeStr, "%s", "  请用其它方式购物" );
6072   2      
6073   2                              //sprintf( sysVPMission.hardWareErrStr, "%s", "纸硬币器故障" );                 
6074   2                      //}
6075   2                      //else 
6076   2                      //if( HardWareErr & 0x0002 )
6077   2                      //{
6078   2                              //errcode = 0xF2;
6079   2                              //sprintf( errCodeStr, "%s", "硬币器故障" );                    
6080   2                              //sprintf( errCodeStr, "%s", "  请用其它方式购物" );
6081   2      
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 102 

6082   2                              //sprintf( sysVPMission.hardWareErrStr, "%s", "硬币器故障");
6083   2                      //}
6084   2                      //else if( HardWareErr & 0x0004 )
6085   2                      //{
6086   2                              //errcode = 0xF3;
6087   2                              //sprintf( errCodeStr, "%s", "找币器故障" );                    
6088   2                              //sprintf( errCodeStr, "%s", "  请用其它方式购物" );
6089   2      
6090   2                              //sprintf( sysVPMission.hardWareErrStr, "%s", "找币器故障");
6091   2                      //}
6092   2                      //else if( HardWareErr & 0x0008 )
6093   2                      //{
6094   2                              //errcode = 0xF4;
6095   2                  //sprintf( errCodeStr, "%s", "找币器缺币" );                        
6096   2                              //sprintf( errCodeStr, "%s", "  请用其它方式购物" );
6097   2      
6098   2                              //sprintf( sysVPMission.hardWareErrStr, "%s", "找币器缺币");
6099   2                      //}
6100   2                      //else if( HardWareErr & 0x0010 )
6101   2                      //{
6102   2                              //errcode = 0xF5;                       
6103   2                              //sprintf( errCodeStr, "%s", "  " );
6104   2      
6105   2                              //sprintf( sysVPMission.hardWareErrStr, "%s", "所有货道无货");
6106   2                      //}
6107   2                      //else if( HardWareErr & 0x0020 )
6108   2                      //{
6109   2                              //errcode = 0xF6;
6110   2                              //sprintf( errCodeStr, "%s", "所有货道故障" );                  
6111   2                              //sprintf( errCodeStr, "%s", "  " );
6112   2      
6113   2                              //sprintf( sysVPMission.hardWareErrStr, "%s", "所有货道故障");
6114   2                      //}
6115   2                      //else 
6116   2                      if( HardWareErr & 0x0040 )
6117   2                      {
6118   3                              errcode = 0xF7; 
6119   3                              //sprintf( errCodeStr, "%s", "货道板故障" );                    
6120   3                              //sprintf( errCodeStr, "%s", "  " );
6121   3      
6122   3                              //sprintf( sysVPMission.hardWareErrStr, "%s", "货道板故障");
6123   3                      }
6124   2                      else if( HardWareErr & 0x0080 )
6125   2                      {
6126   3                              errcode = 0xF8;                         
6127   3                              //sprintf( errCodeStr, "%s", "  " );
6128   3      
6129   3                              //sprintf( sysVPMission.hardWareErrStr, "%s", "所有货道不能工作");
6130   3                      }
6131   2                      else if( HardWareErr & 0x0100 )
6132   2                      {
6133   3                              errcode = 0xF9; 
6134   3                              //sprintf( errCodeStr, "%s", "系统参数故障" );                  
6135   3                              //sprintf( errCodeStr, "%s", "  " );
6136   3      
6137   3                              //sprintf( sysVPMission.hardWareErrStr, "%s", "系统参数故障");
6138   3                      }
6139   2                      else if( HardWareErr & 0x0200 )
6140   2                      {
6141   3                              errcode = 0xFA;
6142   3                              //sprintf( errCodeStr, "%s", "LCD 故障" );                      
6143   3                              //sprintf( errCodeStr, "%s", "  " );
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 103 

6144   3      
6145   3                              //sprintf( sysVPMission.hardWareErrStr, "%s", "LCD 故障" );
6146   3                      }
6147   2                      //else if( HardWareErr & 0x0400 )
6148   2                      //{
6149   2                              //errcode = 0xFB;
6150   2                              //sprintf( errCodeStr, "%s", "货道单价异常" );                  
6151   2                              //sprintf( errCodeStr, "%s", "  " );
6152   2      
6153   2                              //sprintf( sysVPMission.hardWareErrStr, "%s", "货道单价异常" );
6154   2                      //}
6155   2                      //else if( HardWareErr & 0x0800 )
6156   2                      //{
6157   2                          //errcode = 0xFC;
6158   2                              //sprintf( errCodeStr, "%s", "出货确认故障" );                  
6159   2                              //sprintf( errCodeStr, "%s", "  " );
6160   2      
6161   2                              //sprintf( sysVPMission.hardWareErrStr, "%s", "出货确认故障" );
6162   2                      //}
6163   2                      else if( HardWareErr & 0x1000 )
6164   2                      {
6165   3                          errcode = 0xFD;
6166   3                              //sprintf( errCodeStr, "%s", "选货模块故障" );                  
6167   3                              //sprintf( errCodeStr, "%s", "  " );
6168   3      
6169   3                              //sprintf( sysVPMission.hardWareErrStr, "%s", "选货模块故障" );
6170   3                      }
6171   2                      else if( HardWareErr & 0x2000 )
6172   2                      {
6173   3                              errcode2 = 0x70;
6174   3                          errcode = 0x02;
6175   3                              //sprintf( errCodeStr, "%s", "PC小数点故障" );                  
6176   3                              //sprintf( errCodeStr, "%s", "  " );
6177   3      
6178   3                              //sprintf( sysVPMission.hardWareErrStr, "%s", "PC小数点故障" );
6179   3                      }
6180   2                      else if( HardWareErr & 0x4000 ) 
6181   2                      {
6182   3                          errcode = 0xE1;
6183   3                              //sprintf( errCodeStr, "%s", "pc离线" );                        
6184   3                              //sprintf( errCodeStr, "%s", "  " );
6185   3      
6186   3                              //sprintf( sysVPMission.hardWareErrStr, "%s", "pc离线" );
6187   3                      }
6188   2              //添加币管没有锁紧故障;by gzz 20110827
6189   2                      //else if( HardWareErr & 0x8000 )       
6190   2                      //{
6191   2                          //errcode = 0xF0;//币管没有锁紧故障
6192   2                              //sprintf( errCodeStr, "%s", "币管未关闭" );                    
6193   2                              //sprintf( errCodeStr, "%s", "  请用其它方式购物" );
6194   2      
6195   2                              //sprintf( sysVPMission.hardWareErrStr, "%s", "币管未关闭" );
6196   2                      //}
6197   2                      else
6198   2                      {
6199   3                              errcode = 0xff;
6200   3                      }
6201   2                      sysVPMission.hardWareErrShow = errcode;
6202   2      
6203   2      
6204   2                      if(errInputMoney==0)
6205   2                      {
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 104 

6206   3                              /*
6207   3                      //if((errcode == 0xF1)||(errcode == 0xF2)||(errcode == 0xF3)||(errcode == 0xF4))
6208   3                      //添加币管f0故障;by gzz 20110825
6209   3                              if((errcode == 0xF1)||(errcode == 0xF2)||(errcode == 0xF3)||(errcode == 0xF4)||(errcode == 0xF0))
6210   3                      {
6211   3                              DisplayLine = STR_OUT_OF_CASHSERVICE;
6212   3                                      DisplayStr( 0, __LINE0__ , 1 , DispInformationTable[DisplayLine ].str, DispInformationTable[DisplayLin
             -e ].len );
6213   3                                      //WaitForWork( 200, NULL );  //500-50-100-200
6214   3                                      WaitForWork( 20, NULL );
6215   3      
6216   3                          len = sprintf( DisplayBuffer, "%s" , errCodeStr );
6217   3                      }
6218   3                      else
6219   3                              */
6220   3                      {
6221   4                                      DisplayLine = STR_OUT_OF_SERVICE;
6222   4                                      DisplayStr( 0, __LINE0__ , 1 , DispInformationTable[DisplayLine ].str, DispInformationTable[DisplayLin
             -e ].len );
6223   4                                      //WaitForWork( 200, NULL );  //500-50-100-200
6224   4                                      WaitForWork( 20, NULL );
6225   4      
6226   4                          //-------------------------------------------------------------------------------------
6227   4                                      //发现如果找币欠款，会显示故障信息，加上欠款金额。由于字符超过第二行显示信息最大值，因此
6228   4                              //出现溢出现象。这时，由于hardwareerr值被覆盖,当hopper补币恢复后，不能重新回到交易状态
6229   4                                      //by gzz 20110811
6230   4                          /*
6231   4                                      if( ( IOUFlag ) && ( SystemParameter.NotOutMax != 0 ) )
6232   4                                      {                       
6233   4                                      #ifdef _CHINA_
6234   4                                              len = sprintf( DisplayBuffer, "[%02bx]  %s" ,errcode, errCodeStr );                     
6235   4                                      #else
6236   4                                              len = sprintf( DisplayBuffer, "Err code=%02bx  " , errcode );                   
6237   4                                  #endif
6238   4                                              DisplayLine = STR_DUO_MONEY;                    
6239   4                                              memcpy( DisplayBuffer + len , DispInformationTable[DisplayLine ].str, DispInformationTable[ DisplayLi
             -ne ].len );
6240   4                                              len += DispInformationTable[ DisplayLine ].len;
6241   4                                              switch( SystemParameter.curUnit )
6242   4                                              {
6243   4                                                      case 1:
6244   4                                                              len += sprintf( DisplayBuffer + len, "%u", SystemParameter.NotOutMax);
6245   4                                                              break;                          
6246   4                                                      case 10:
6247   4                                                              len += sprintf( DisplayBuffer + len, "%u.%u", SystemParameter.NotOutMax/SystemParameter.curUnit, Sy
             -stemParameter.NotOutMax%SystemParameter.curUnit );
6248   4                                                              break;
6249   4                                                      case 100:
6250   4                                                              len += sprintf( DisplayBuffer + len, "%u.%02u", SystemParameter.NotOutMax/SystemParameter.curUnit, 
             -SystemParameter.NotOutMax%SystemParameter.curUnit );
6251   4                                                      break;          
6252   4                                              }                       
6253   4                                              IOUFlag = 0;
6254   4                                      }
6255   4                                      else            
6256   4                                      #ifdef _CHINA_
6257   4                                              len = sprintf( DisplayBuffer, "[%02bx]  %s" , errcode, errCodeStr );                    
6258   4                                      #else
6259   4                                              len = sprintf( DisplayBuffer, "Err code = %02bx  " , errcode );                 
6260   4                                  #endif
6261   4                                      */
6262   4      
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 105 

6263   4                                      #ifdef _CHINA_
6264   4                                              len = sprintf( DisplayBuffer, "[%02bx%02bx]  %s" , errcode2,errcode, errCodeStr );                      
6265   4                                      #else
                                                      len = sprintf( DisplayBuffer, "Err code = %02bx  " , errcode );                 
                                          #endif
6268   4                              
6269   4                              }
6270   3      
6271   3                      //Trace( "\n LEN = %bu", len );
6272   3                              DisplayStr( 0, __LINE1__ , 1, DisplayBuffer, len );
6273   3                              //WaitForWork( 300, NULL );    //500-50-100-200-300
6274   3                              WaitForWork( 20, NULL );
6275   3                      }
6276   2      
6277   2      
6278   2                      errUpdate++;
6279   2                      if( errUpdate >= 2 )
6280   2                      {
6281   3                              //isShowLcd = 0;
6282   3                              errUpdate = 0;
6283   3                      }
6284   2              //--------------------------------------------------------
6285   2                      //SaveGlobalParam();
6286   2                      //SaveGoodsSet();
6287   2                      //ClearKey();
6288   2              //========================================================                      
6289   2              }
6290   1              
6291   1              //111024 by cq 删除
6292   1      
6293   1              /*
6294   1              if( SystemParameter.MobileON == 1 )
6295   1          {
6296   1                      if( ( AlarmTime == 0x00 ) && ( ScanIsSendAlarm() == 0 ) )
6297   1                      {       
6298   1                              Trace("\n The Frist Alarm");                    
6299   1                              AlarmTime = 1;          
6300   1                      }
6301   1                      else 
6302   1                      {
6303   1                              CycleSendSMS();         
6304   1                      }
6305   1          }   
6306   1              */
6307   1          return 1;
6308   1      }
6309          
6310          u_char StackTheBillAPI( void )
6311          {
6312   1          u_char xdata flag = 0;
6313   1              u_char xdata mission = 0;
6314   1          u_int  xdata CurrentDomain = 0;
6315   1              
6316   1              //Before vending, stack the holding bill
6317   1              if( sysITLMission.billHoldingFlag == 1 )
6318   1              { 
6319   2              flag = MDB_Bill_EscrowCtr(1);
6320   2                      if(flag==0)
6321   2                      {
6322   3                          sysVPMission.billSTimer = TIME_BILL_STACK;
6323   3                          while( sysVPMission.billSTimer )
6324   3                              {
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 106 

6325   4                      mission = MDB_Bill_IfStacked( sysMDBMission.billBuf, &sysMDBMission.billBufLen );
6326   4                                      if( mission == 1 )
6327   4                                      {
6328   5                                          CurrentDomain = sysITLMission.billHoldingValue;
6329   5                                              Trace( "\n Get in Cash Ok" );
6330   5                                              Trace( "\n CurrentDomain = %d",CurrentDomain );         
6331   5                                              CurrentPayed += CurrentDomain * BILLMULTIPLE;   
6332   5                                              //TradeCounter.TrueCurrencySum += CurrentDomain * BILLMULTIPLE;
6333   5                                              //TradeCounter.CashSum += CurrentDomain * BILLMULTIPLE;
6334   5                                              //TradeCounter.CashSumBack += CurrentDomain * BILLMULTIPLE;//区间
6335   5                                              SellAccumulateMoney(&TradeCounter.CashSum,CurrentDomain * BILLMULTIPLE);
6336   5                                              SellAccumulateMoney(&TradeCounter.CashSumBack,CurrentDomain * BILLMULTIPLE);
6337   5                                              //------------------------------------------------------
6338   5                                              sysVPMission.payInBillFlag = 1;
6339   5                                              sysVPMission.payInBillMoney += CurrentDomain * BILLMULTIPLE;
6340   5                                              //reset the trade timer
6341   5                                      //sysVPMission.sTimer1 = SystemParameter.tradeTime;
6342   5                                              //======================================================
6343   5                                              //sysITLMission.restartTime = ITL_TIME_RESTART; //reset the timer!
6344   5                                              memset(sysMDBMission.billBuf,0,sizeof(sysMDBMission.billBuf));
6345   5                                  sysITLMission.billHoldingFlag = 0;
6346   5                                              sysITLMission.billHoldingValue = 0;
6347   5                                              /*
6348   5                                  //payin report
6349   5                                              if( sysVPMission.payInCoinFlag == 1 )
6350   5                                              {
6351   5                                                  VPMission_Payin_RPT( VP_DEV_COIN, sysVPMission.payInCoinMoney );
6352   5                                                      sysVPMission.payInCoinFlag = 0;
6353   5                                              sysVPMission.payInCoinMoney = 0;
6354   5                                              
6355   5                                              }
6356   5                                              if( sysVPMission.payInBillFlag == 1 )
6357   5                                              {
6358   5                                                  VPMission_Payin_RPT( VP_DEV_BILL, sysVPMission.payInBillMoney );
6359   5                                                      sysVPMission.payInBillFlag = 0;
6360   5                                              sysVPMission.payInBillMoney = 0;      
6361   5                                              }
6362   5                                              */
6363   5                                              return 1;
6364   5                                      }
6365   4                                      else
6366   4                                      {
6367   5                                              //VP_GameKeyPoll( 200 );
6368   5                                      }
6369   4                  }
6370   3                              if( sysVPMission.billSTimer == 0 )
6371   3                              {
6372   4                      //钞箱满，钞箱压钞后就能时，还可以认到纸币;by gzz 20111017
6373   4                                  //检测纸币器钞箱是否已满;by gzz 20111014 
6374   4                                      WaitForWork(2000,NULL);
6375   4                      MDB_Bill_Stacker( &sysMDBMission.billBuf[0], &sysMDBMission.billBuf[1] ); 
6376   4                      if(sysMDBMission.billIsFull==1)
6377   4                                  {
6378   5                                          CurrentDomain = sysITLMission.billHoldingValue;
6379   5                                              Trace( "\n Get in Cash Ok" );
6380   5                                              Trace( "\n CurrentDomain = %d",CurrentDomain );         
6381   5                                              CurrentPayed += CurrentDomain * BILLMULTIPLE;   
6382   5                                              //TradeCounter.TrueCurrencySum += CurrentDomain * BILLMULTIPLE;
6383   5                                              //TradeCounter.CashSum += CurrentDomain * BILLMULTIPLE;
6384   5                                              //TradeCounter.CashSumBack += CurrentDomain * BILLMULTIPLE;//区间
6385   5                                              SellAccumulateMoney(&TradeCounter.CashSum,CurrentDomain * BILLMULTIPLE);
6386   5                                              SellAccumulateMoney(&TradeCounter.CashSumBack,CurrentDomain * BILLMULTIPLE);
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 107 

6387   5                                              //------------------------------------------------------
6388   5                                              sysVPMission.payInBillFlag = 1;
6389   5                                              sysVPMission.payInBillMoney += CurrentDomain * BILLMULTIPLE;
6390   5                                              //reset the trade timer
6391   5                                      //sysVPMission.sTimer1 = SystemParameter.tradeTime;
6392   5                                              //======================================================
6393   5                                              //sysITLMission.restartTime = ITL_TIME_RESTART; //reset the timer!
6394   5                                              memset(sysMDBMission.billBuf,0,sizeof(sysMDBMission.billBuf));
6395   5                                  sysITLMission.billHoldingFlag = 0;
6396   5                                              sysITLMission.billHoldingValue = 0;
6397   5                                              /*
6398   5                                  //payin report
6399   5                                              if( sysVPMission.payInCoinFlag == 1 )
6400   5                                              {
6401   5                                                  VPMission_Payin_RPT( VP_DEV_COIN, sysVPMission.payInCoinMoney );
6402   5                                                      sysVPMission.payInCoinFlag = 0;
6403   5                                              sysVPMission.payInCoinMoney = 0;
6404   5                                              
6405   5                                              }
6406   5                                              if( sysVPMission.payInBillFlag == 1 )
6407   5                                              {
6408   5                                                  VPMission_Payin_RPT( VP_DEV_BILL, sysVPMission.payInBillMoney );
6409   5                                                      sysVPMission.payInBillFlag = 0;
6410   5                                              sysVPMission.payInBillMoney = 0;      
6411   5                                              }
6412   5                                              */
6413   5                                              return 1;
6414   5                                      }
6415   4                                      else
6416   4                                      {
6417   5                                              //...   
6418   5                                              //调整顺序，billHoldingFlag==0放在sysVPMission之上;by gzz 20110721
6419   5                                              sysVPMission.escrowMoney = sysITLMission.billHoldingValue;
6420   5                                              sysITLMission.billHoldingFlag = 0;
6421   5                                              sysITLMission.billHoldingValue = 0;
6422   5                                              //Need better solutoin. 
6423   5                                              //Maybe cheated by man
6424   5                                  //CurrentPayed += sysITLMission.billHoldingValue;
6425   5                                              //-----------------------------------------------------
6426   5                                          sysVPMission.escrowOutFlag = 1;                                 
6427   5                                              //取消注释,允许对pc发送压钞不成功信息;by gzz 20110721
6428   5                                              if( sysVPMission.escrowOutFlag == 1 )
6429   5                                          {
6430   6                                                  VPMission_Payin_RPT( VP_DEV_ESCROWOUT, sysVPMission.escrowMoney );
6431   6                                                      sysVPMission.escrowOutFlag = 0;
6432   6                                              sysVPMission.escrowMoney = 0;     
6433   6                                              }
6434   5                                              
6435   5                                          //=====================================================
6436   5                                              //DisplayCurrentMoney( CurrentPayed );
6437   5                      }
6438   4                              }
6439   3              }
6440   2              else
6441   2                      {
6442   3                              //...   
6443   3                              //调整顺序，billHoldingFlag==0放在sysVPMission之上;by gzz 20110721
6444   3                              sysVPMission.escrowMoney = sysITLMission.billHoldingValue;      
6445   3                              sysITLMission.billHoldingFlag = 0;
6446   3                              sysITLMission.billHoldingValue = 0;
6447   3                  //Need better solutoin. 
6448   3                              //Maybe cheated by man
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 108 

6449   3                  //CurrentPayed += sysITLMission.billHoldingValue;
6450   3                              //-----------------------------------------------------
6451   3                              sysVPMission.escrowOutFlag = 1;                 
6452   3                              //取消注释,允许对pc发送压钞不成功信息;by gzz 20110721
6453   3                              if( sysVPMission.escrowOutFlag == 1 )
6454   3                          {
6455   4                                  VPMission_Payin_RPT( VP_DEV_ESCROWOUT, sysVPMission.escrowMoney );
6456   4                                      sysVPMission.escrowOutFlag = 0;
6457   4                              sysVPMission.escrowMoney = 0;     
6458   4                              }
6459   3                              
6460   3                              //=====================================================
6461   3                              //DisplayCurrentMoney( CurrentPayed );
6462   3                      }
6463   2          }
6464   1              return 0;
6465   1      
6466   1      }
6467          
6468          u_char VMC_PC_POLL( void )
6469          {
6470   1          u_char xdata i = 0;
6471   1          u_char xdata j = 0;
6472   1          u_char xdata flag = 0;
6473   1              u_char xdata returnflag = 0;
6474   1              //static u_char xdata gocErrTimes = 0;
6475   1              u_int  xdata MoneyBuf = 0;
6476   1              u_int  xdata CurrentDomain = 0;
6477   1              u_char xdata mission = 0;
6478   1          
6479   1          #ifndef MACHINE_SET_VMC_PC
                         return VP_ERR_NULL;
                      #endif
6482   1      
6483   1              //0.
6484   1          if( sysVPMission.VPDevCtr & 0x80 )
6485   1              {
6486   2                  sysVPMission.VPDevCtr &= 0x7F;
6487   2                  flag = VPMission_Poll();
6488   2                      sysVPMission.msTimer1 = VP_TIME_POLL;
6489   2              if( sysVPMission.resetCmd == 1 )
6490   2              {
6491   3                      //VPMission_Init();
6492   3                  //sysVPMission.resetCmd = 0;
6493   3                          returnflag = 1;
6494   3              }
6495   2              }
6496   1      
6497   1          //1.
6498   1          if( sysVPMission.msTimer1 == 0 )
6499   1              {
6500   2                      //if( ( sysVPMission.vendCmd == 0 )&&(sysVPMission.changeCmd == 0)&&(sysVPMission.costCmd == 0)&&(sysVPM
             -ission.returnCmd == 0) )
6501   2                      {
6502   3                      flag = VPMission_Poll();
6503   3                              //sysVPMission.msTimer1 = VP_TIME_POLL;
6504   3                      if( sysVPMission.resetCmd == 1 )
6505   3                      {
6506   4                              //VPMission_Init();
6507   4                          //sysVPMission.resetCmd = 0;
6508   4                                  returnflag = 1;
6509   4                      }
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 109 

6510   3                      }
6511   2                      
6512   2          }
6513   1          
6514   1          //2.
6515   1              if( sysVPMission.requestFlag == 1 )
6516   1              {
6517   2                  VPMission_Request(1);
6518   2                  sysVPMission.requestFlag = 0;       
6519   2              }
6520   1          //3.
6521   1          if( sysVPMission.vendCmd == 1 )
6522   1              {
6523   2                      OutGoods(1);            
6524   2                      if( CurrentPayed > 0 )
6525   2              {
6526   3                  UpdateSelLed_Trade();
6527   3                              DisplayCurrentMoney( CurrentPayed );
6528   3                              if( (HardWareErr==0x00)&&((CurrentPayed+sysITLMission.billHoldingValue)<SystemParameter.BanknoteMax) )
6529   3                              {
6530   4                                      EnableBillDev();
6531   4                              }
6532   3                              sysVPMission.sTimer1 = SystemParameter.tradeTime;
6533   3                      }
6534   2                      sysVPMission.vendCmd = 0;
6535   2                      
6536   2                      //WaitForWork( 10000, NULL );
6537   2              }
6538   1              //4.    
6539   1          if( (sysVPMission.changeCmd == 1)  )
6540   1          {
6541   2              CurrentDispenseCoin = sysVPMission.changeMoney; 
6542   2              sysVPMission.changeMoney = 0;
6543   2              DisableBillDev();
6544   2                      //DisplayStr( 0, __LINE0__ , 1 , "3", 1 );
6545   2                      //WaitForWork( 2000, NULL );  //500-50-100-200
6546   2                      DispenseCoin(1);
6547   2              SaveTradeParam();  //2011.6.10 added: Update the sale data in flash!
6548   2              UpdateSelectionLed_GoodsSta();        
6549   2                      //
6550   2                      if( sysITLMission.billHoldingFlag == 1 )
6551   2                      {
6552   3                              MoneyBuf = CurrentPayed + sysITLMission.billHoldingValue;
6553   3                      }
6554   2                      else
6555   2                      {
6556   3                              MoneyBuf = CurrentPayed;
6557   3                      }
6558   2                      if( MoneyBuf > 0 )
6559   2              {
6560   3                  UpdateSelLed_Trade();
6561   3                              DisplayCurrentMoney( CurrentPayed );
6562   3                              if( (HardWareErr==0x00)&&((CurrentPayed+sysITLMission.billHoldingValue)<SystemParameter.BanknoteMax) )
6563   3                              {
6564   4                                      EnableBillDev();
6565   4                              }
6566   3                              sysVPMission.sTimer1 = SystemParameter.tradeTime;
6567   3                      }
6568   2                      if( (HardWareErr==0x00)&&(MoneyBuf<SystemParameter.BanknoteMax) )               
6569   2              {
6570   3                      EnableBillDev();                
6571   3              }
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 110 

6572   2                      sysVPMission.changeCmd = 0;
6573   2          }
6574   1              
6575   1              //4.接收扣钱命令，进行扣钱操作  
6576   1              if( (sysVPMission.costCmd == 1))
6577   1          {           
6578   2                      //在扣款之前, stack the holding bill
6579   2                      if( ( sysITLMission.billHoldingFlag == 1 )&&(sysVPMission.costMoney > CurrentPayed) )
6580   2                      {
6581   3                          
6582   3                      flag = MDB_Bill_EscrowCtr( 1 );
6583   3                              if(flag==0)
6584   3                              {
6585   4                                  sysVPMission.billSTimer = TIME_BILL_STACK;
6586   4                                  while( sysVPMission.billSTimer )
6587   4                                      {
6588   5                              mission = MDB_Bill_IfStacked( sysMDBMission.billBuf, &sysMDBMission.billBufLen );
6589   5                                              if( mission == 1 )
6590   5                                              {
6591   6                                                  CurrentDomain = sysITLMission.billHoldingValue;
6592   6                                                      Trace( "\n Get in Cash Ok" );
6593   6                                                      //CurrentDomain = GetCash();
6594   6                                                      Trace( "\n CurrentDomain = %d",CurrentDomain );         
6595   6                                                      CurrentPayed += CurrentDomain * BILLMULTIPLE;   
6596   6                                                      //TradeCounter.TrueCurrencySum += CurrentDomain * BILLMULTIPLE;
6597   6                                                      //TradeCounter.CashSum += CurrentDomain * BILLMULTIPLE;
6598   6                                                      //TradeCounter.CashSumBack += CurrentDomain * BILLMULTIPLE;//区间
6599   6                                                      SellAccumulateMoney(&TradeCounter.CashSum,CurrentDomain * BILLMULTIPLE);
6600   6                                                      SellAccumulateMoney(&TradeCounter.CashSumBack,CurrentDomain * BILLMULTIPLE);
6601   6                                                      //------------------------------------------------------
6602   6                                                      sysVPMission.payInBillFlag = 1;
6603   6                                                      sysVPMission.payInBillMoney += CurrentDomain * BILLMULTIPLE;
6604   6                                                      //reset the trade timer
6605   6                                              //sysVPMission.sTimer1 = SystemParameter.tradeTime;
6606   6                                                      //======================================================
6607   6                                                      //sysITLMission.restartTime = ITL_TIME_RESTART; //reset the timer!
6608   6                                                      memset(sysMDBMission.billBuf,0,sizeof(sysMDBMission.billBuf));
6609   6                                                      sysMDBMission.billBufLen=0;
6610   6                                                      sysMDBMission.billType=0;
6611   6                                                      sysMDBMission.billStock=0;
6612   6                                          sysITLMission.billHoldingFlag = 0;
6613   6                                                      sysITLMission.billHoldingValue = 0;
6614   6                                          //payin report
6615   6                                                      if( sysVPMission.payInCoinFlag == 1 )
6616   6                                                      {
6617   7                                                          VPMission_Payin_RPT( VP_DEV_COIN, sysVPMission.payInCoinMoney );
6618   7                                                              sysVPMission.payInCoinFlag = 0;
6619   7                                                      sysVPMission.payInCoinMoney = 0;
6620   7                                                      
6621   7                                                      }
6622   6                                                      if( sysVPMission.payInBillFlag == 1 )
6623   6                                                      {
6624   7                                                          VPMission_Payin_RPT( VP_DEV_BILL, sysVPMission.payInBillMoney );
6625   7                                                              sysVPMission.payInBillFlag = 0;
6626   7                                                      sysVPMission.payInBillMoney = 0;      
6627   7                                                      }
6628   6                              DisplayCurrentMoney( CurrentPayed ); 
6629   6                                  break;//压钞成功后，直接跳出时间循环等待;by gzz 20110721
6630   6                                              }
6631   5                                              else
6632   5                                              {
6633   6                                                      VP_GameKeyPoll( 200 );
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 111 

6634   6                                              }
6635   5                          }
6636   4                                      /*
6637   4                                      if( sysVPMission.billSTimer == 0 )
6638   4                                      {
6639   4                          //钞箱满，钞箱压钞后就能时，还可以认到纸币;by gzz 20111017
6640   4                                          //检测纸币器钞箱是否已满;by gzz 20111014 
6641   4                                              WaitForWork(2000,NULL);
6642   4                              MDB_Bill_Stacker( &sysMDBMission.billBuf[0], &sysMDBMission.billBuf[1] ); 
6643   4                              if(sysMDBMission.billIsFull==1)
6644   4                                              {
6645   4                                                  CurrentDomain = sysITLMission.billHoldingValue;
6646   4                                                      Trace( "\n Get in Cash Ok" );
6647   4                                                      //CurrentDomain = GetCash();
6648   4                                                      Trace( "\n CurrentDomain = %d",CurrentDomain );         
6649   4                                                      CurrentPayed += CurrentDomain * BILLMULTIPLE;   
6650   4                                                      TradeCounter.TrueCurrencySum += CurrentDomain * BILLMULTIPLE;
6651   4                                                      TradeCounter.CashSum += CurrentDomain * BILLMULTIPLE;
6652   4                                                      TradeCounter.CashSumBack += CurrentDomain * BILLMULTIPLE;//区间
6653   4                                                      //------------------------------------------------------
6654   4                                                      sysVPMission.payInBillFlag = 1;
6655   4                                                      sysVPMission.payInBillMoney += CurrentDomain * BILLMULTIPLE;
6656   4                                                      //reset the trade timer
6657   4                                              //sysVPMission.sTimer1 = SystemParameter.tradeTime;
6658   4                                                      //======================================================
6659   4                                                      //sysITLMission.restartTime = ITL_TIME_RESTART; //reset the timer!
6660   4                                                      memset(sysMDBMission.billBuf,0,sizeof(sysMDBMission.billBuf));
6661   4                                                      sysMDBMission.billBufLen=0;
6662   4                                                      sysMDBMission.billType=0;
6663   4                                                      sysMDBMission.billStock=0;
6664   4                                          sysITLMission.billHoldingFlag = 0;
6665   4                                                      sysITLMission.billHoldingValue = 0;
6666   4                                          //payin report
6667   4                                                      if( sysVPMission.payInCoinFlag == 1 )
6668   4                                                      {
6669   4                                                          VPMission_Payin_RPT( VP_DEV_COIN, sysVPMission.payInCoinMoney );
6670   4                                                              sysVPMission.payInCoinFlag = 0;
6671   4                                                      sysVPMission.payInCoinMoney = 0;
6672   4                                                      
6673   4                                                      }
6674   4                                                      if( sysVPMission.payInBillFlag == 1 )
6675   4                                                      {
6676   4                                                          VPMission_Payin_RPT( VP_DEV_BILL, sysVPMission.payInBillMoney );
6677   4                                                              sysVPMission.payInBillFlag = 0;
6678   4                                                      sysVPMission.payInBillMoney = 0;      
6679   4                                                      }
6680   4                              DisplayCurrentMoney( CurrentPayed );                        
6681   4                                              }
6682   4                                              else
6683   4                                              {
6684   4                                                      //...   
6685   4                                                      //调整顺序，billHoldingFlag==0放在sysVPMission之上;by gzz 20110721
6686   4                                                      sysVPMission.escrowMoney = sysITLMission.billHoldingValue;
6687   4                                                      sysITLMission.billHoldingFlag = 0;
6688   4                                                      sysITLMission.billHoldingValue = 0;
6689   4                                                      //Need better solutoin. 
6690   4                                                      //Maybe cheated by man
6691   4                                          //CurrentPayed += sysITLMission.billHoldingValue;
6692   4                                                      //-----------------------------------------------------
6693   4                                                  sysVPMission.escrowOutFlag = 1;                                         
6694   4                                                      if( sysVPMission.escrowOutFlag == 1 )
6695   4                                                  {
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 112 

6696   4                                                          VPMission_Payin_RPT( VP_DEV_ESCROWOUT, sysVPMission.escrowMoney );
6697   4                                                              sysVPMission.escrowOutFlag = 0;
6698   4                                                      sysVPMission.escrowMoney = 0;     
6699   4                                                      }
6700   4                                                  //=====================================================
6701   4                                  DisplayCurrentMoney( CurrentPayed );                                        
6702   4                                                      /*                                      
6703   4                                                      if( GoodsWaySetVal[CurrentStockCode].Price > CurrentPayed )
6704   4                                                      {
6705   4                                                              return 1;
6706   4                                                      }       
6707   4                                  * /
6708   4                          }
6709   4                                      }*/
6710   4                      }
6711   3                      else
6712   3                              {
6713   4                                      /*
6714   4                                      //...
6715   4                                      //调整顺序，billHoldingFlag==0放在sysVPMission之上;by gzz 20110721
6716   4                                      sysVPMission.escrowMoney = sysITLMission.billHoldingValue;
6717   4                                      sysITLMission.billHoldingFlag = 0;
6718   4                                      sysITLMission.billHoldingValue = 0;
6719   4                                      //Need better solutoin. 
6720   4                                      //Maybe cheated by man
6721   4                          //CurrentPayed += sysITLMission.billHoldingValue;
6722   4                                      //-----------------------------------------------------
6723   4                                      sysVPMission.escrowOutFlag = 1;                         
6724   4                                      if( sysVPMission.escrowOutFlag == 1 )
6725   4                                  {
6726   4                                          VPMission_Payin_RPT( VP_DEV_ESCROWOUT, sysVPMission.escrowMoney );
6727   4                                              sysVPMission.escrowOutFlag = 0;
6728   4                                      sysVPMission.escrowMoney = 0;     
6729   4                                      }
6730   4                                      //=====================================================
6731   4                      DisplayCurrentMoney( CurrentPayed );                            
6732   4                                      / *                             
6733   4                                      if( GoodsWaySetVal[CurrentStockCode].Price > CurrentPayed )
6734   4                                      {
6735   4                                              return 1;
6736   4                                      }
6737   4                      */
6738   4                              }
6739   3                  }
6740   2                  else
6741   2                      {
6742   3                              //若此时还有插币，等压钞结束后再判断;by gzz 20110429 
6743   3                              //WaitForWork( NULL, 1000 );
6744   3                      /*
6745   3                          if((SystemParameter.BillNo==1)&&(sysITLMission.ITLSet==1))
6746   3                          {      
6747   3                             if(sysITLMission.billStaCtr & ITL_BILL_READ)
6748   3                             {        
6749   3                                      
6750   3                                return 1;          
6751   3                             }
6752   3                          }
6753   3                      */ 
6754   3                      }
6755   2                      //
6756   2                      {
6757   3                      sysITLMission.billStaCtr = 0;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 113 

6758   3                      sysITLMission.billSta = 0;
6759   3                              /*
6760   3                      WaitForWork( 300, NULL );
6761   3                              MDB_Bill_EscrowCtr( 0 );
6762   3                              */
6763   3                      //sysITLMission.billStaCtr |= ITL_BILL_VEDNING;
6764   3                      }
6765   2      
6766   2                      if(sysVPMission.costMoney > CurrentPayed)
6767   2                  {
6768   3                               sysVPMission.costMoney = 0;
6769   3                      }
6770   2                      else
6771   2                      {
6772   3                              CurrentPayed = CurrentPayed - sysVPMission.costMoney;  
6773   3                      }
6774   2                      
6775   2                      VPMission_Cost_RPT(sysVPMission.costDev, sysVPMission.costMoney, sysVPMission.costType);
6776   2      
6777   2              //---------------------------------------------------        
6778   2              if( CurrentPayed >= 1 )
6779   2                      {
6780   3                              sysVPMission.sTimer1 = SystemParameter.tradeTime;
6781   3                      } 
6782   2                      if( CurrentPayed < SystemParameter.BanknoteMax )
6783   2              {
6784   3                      EnableBillDev();                
6785   3              }
6786   2                      sysVPMission.inBillMoney = CurrentPayed;
6787   2              //显示剩余的金额
6788   2              DisplayCurrentMoney( CurrentPayed );
6789   2                      sysVPMission.costCmd = 0;       
6790   2          }
6791   1                  
6792   1      
6793   1              //5.定时重启纸币器,硬币器;20110510  
6794   1          #ifdef MACHINE_SET_MDB
6795   1          if(( sysITLMission.restartTime == 0)&&( HardWareErr== 0))
6796   1              {
6797   2                  sysITLMission.restartTime = ITL_TIME_RESTART; 
6798   2                  if( (SystemParameter.BillNo==1)&&(sysITLMission.ITLSet==1))  
6799   2                  {
6800   3                              MDBMission_Bill_Enable();
6801   3              }
6802   2              WaitForWork( 500 , NULL );
6803   2              MDBMission_Coin_Enable();               
6804   2          }
6805   1          #endif
6806   1      
6807   1              //6.
6808   1          if( IfReturnKeyOn()||(returnflag==1)||( sysVPMission.sTimer1 == 0 ) )
6809   1              {       
6810   2                      //-----------------------------------------------------------------------------------
6811   2                      sysVPMission.returnCmd=1;
6812   2                  //Andy added 2011.4.14.Rject the holding bill.
6813   2                  if( ((SystemParameter.RefundPermission==1)||(sysVPMission.boughtFlag==1))&&( sysITLMission.billHoldin
             -gFlag == 1 ) )
6814   2                      {
6815   3                              flag = MDB_Bill_EscrowCtr(0);
6816   3                              //调整顺序，flag==0放在sysVPMission之上;by gzz 20110721
6817   3                              //=====================================================
6818   3                              if( flag == 0 )
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 114 

6819   3                              {
6820   4                                      sysVPMission.escrowMoney = sysITLMission.billHoldingValue;
6821   4                                      sysITLMission.billHoldingFlag = 0;
6822   4                                  sysITLMission.billHoldingValue = 0;
6823   4                              }
6824   3                              else
6825   3                              {
6826   4                                      sysVPMission.escrowMoney = sysITLMission.billHoldingValue;
6827   4                                      //... Need more discussion for better soluton!
6828   4                      sysITLMission.billHoldingFlag = 0;
6829   4                                  sysITLMission.billHoldingValue = 0;
6830   4                              }                       
6831   3                              //-----------------------------------------------------
6832   3                              sysVPMission.escrowOutFlag = 1;                                         
6833   3                              if( sysVPMission.escrowOutFlag == 1 )
6834   3                          {
6835   4                                  VPMission_Payin_RPT( VP_DEV_ESCROWOUT, sysVPMission.escrowMoney );
6836   4                                      sysVPMission.escrowOutFlag = 0;
6837   4                              sysVPMission.escrowMoney = 0;     
6838   4                              }
6839   3                              
6840   3                              //.Send the reject message to PC
6841   3                              if( CurrentPayed > 0 )
6842   3                  {
6843   4                      //UpdateSelLed_Trade();
6844   4                                      //DisplayCurrentMoney( CurrentPayed/*+sysITLMission.billHoldingValue* / );
6845   4                      //by gzz 20110416
6846   4                                      //DisableBillDev();
6847   4                      //EnableBillDev();
6848   4                      //End_by gzz 20110416           
6849   4                  }
6850   3                  else
6851   3                  {
6852   4                      //by gzz 20110416
6853   4                                      //DisableBillDev();
6854   4                      //EnableBillDev();
6855   4                      //End_by gzz 20110416   
6856   4                      UpdateSelectionLed_GoodsSta(); 
6857   4                  }
6858   3                      }
6859   2                      if( ((SystemParameter.RefundPermission==1)||(sysVPMission.boughtFlag==1))&&(CurrentPayed>0) )
6860   2                      {
6861   3                          CurrentDispenseCoin = CurrentPayed; 
6862   3                              CurrentPayed = 0;
6863   3                              //DisplayStr( 0, __LINE0__ , 1 , "5", 1 );
6864   3                              //WaitForWork( 2000, NULL );  //500-50-100-200
6865   3                              DispenseCoin(0);
6866   3                              DisableBillDev();
6867   3                              //DisplayStr( 0, __LINE0__ , 1 , "4", 1 );
6868   3                              //WaitForWork( 2000, NULL );  //500-50-100-200
6869   3                  SaveTradeParam();  //2011.6.10 added: Update the sale data in flash!
6870   3                  UpdateSelectionLed_GoodsSta();
6871   3                  EnableBillDev(); 
6872   3                              memset(&sysMDBMission.coinBuf,0,sizeof(sysMDBMission.coinBuf));
6873   3                      memset(&sysMDBMission.billBuf,0,sizeof(sysMDBMission.billBuf));            
6874   3                      }
6875   2                      if( sysVPMission.boughtFlag==1 )
6876   2                      {
6877   3                              sysVPMission.boughtFlag = 0;
6878   3                      }
6879   2                      if( sysITLMission.billHoldingFlag != 1 )
6880   2                      {
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 115 

6881   3                              MDB_Bill_EscrowCtr(0);  //Added to reject the unknown holding bill
6882   3                      }
6883   2                      sysVPMission.returnCmd=0;
6884   2              }
6885   1              if(returnflag==1)
6886   1              {
6887   2                      return 1;
6888   2              }
6889   1              
6890   1              /*
6891   1              //7.
6892   1          if(  sysVPMission.comErrNum >= VP_TIME_OUNT_NUM )
6893   1          {           
6894   1                  //HardWareErr |= 0x2000;
6895   1              MDB_Bill_EscrowCtr(0);  //Added 2011.7.19
6896   1                  if( ( CurrentPayed > 0 ) )
6897   1                  {
6898   1                              CurrentDispenseCoin = CurrentPayed;     
6899   1                              CurrentPayed = 0;
6900   1                      DisableBillDev();
6901   1                              DispenseCoin();
6902   1                  SaveTradeParam();  //2011.6.10 added: Update the sale data in flash!
6903   1                      UpdateSelectionLed_GoodsSta();
6904   1                  }
6905   1                      return 2;
6906   1          }
6907   1              else
6908   1              {
6909   1                      //HardWareErr &= 0xDFFF;
6910   1              }
6911   1              */
6912   1              /*
6913   1              //8.
6914   1              if( (SystemParameter.busCardOn==0x01)&&( DeviceStatus.BusCard!=0x00 ) )
6915   1              {
6916   1                      if( sysVPMission.VPDevCtr & 0x01 )
6917   1              {
6918   1                          if( sysVPMission.sTimerBC >= VPM_DEVUPDATE_BUSCARD ) 
6919   1                              {
6920   1                                      sysVPMission.sTimerBC = 0x00;
6921   1                                      BCMission_Inq();
6922   1                              }
6923   1                      }
6924   1                      else
6925   1                      {
6926   1                              sysVPMission.VPDevCtr |= 0x01;
6927   1                      }
6928   1              }
6929   1              */
6930   1              //9.
6931   1              /*
6932   1              for( i=0; i<GOODSTYPEMAX; i++ )
6933   1              {
6934   1                //if( sysGoodsMatrix[i].NextColumn != GOODS_MATRIX_NONE )
6935   1                      if( (sysGoodsMatrix[i].NextColumn != GOODS_MATRIX_NONE)&&(sysGoodsMatrix[i].Price != 0) )
6936   1                      {
6937   1                              break;
6938   1                      }
6939   1              }
6940   1              if( i >= GOODSTYPEMAX )
6941   1              */
6942   1              if(isEmpty_Goods()==0)
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 116 

6943   1              {
6944   2                      HardWareErr |= 0x0080;
6945   2              }
6946   1              else
6947   1              {
6948   2                  HardWareErr &= 0xFF7F;      
6949   2              }
6950   1          //10.
6951   1              VP_UpdateChnagerStatus();
6952   1          //11.
6953   1          if(IfGameKeyOn())
6954   1              {
6955   2                      VPMission_Button_RPT( VP_BUT_GAME, VP_BUT_NUMBER );
6956   2              //Beep();
6957   2              }
6958   1          //12.
6959   1              //if( (SystemParameter.GOCOn==0x01)&&( DeviceStatus.GOCStatus !=0x00 )&&(gocErrTimes<10) )
6960   1          if( (SystemParameter.GOCOn==0x01)&&( DeviceStatus.GOCStatus !=0x00 ) )
6961   1              {
6962   2                      if( sysVPMission.VPDevCtr & 0x10 )
6963   2              {
6964   3                          if( sysVPMission.sTimerGOC >= VPM_DEVUPDATE_GOC ) 
6965   3                              {
6966   4                      //--------------------------------------------
6967   4                      //出货模块卡货时，每隔一段时间，予以检测，
6968   4                      //如果货物已经掉下，予以恢复;by cq 20110815               
6969   4                      /*
6970   4                                      sysVPMission.sTimerGOC = 0x00;
6971   4                                      if( ChannelTask( 1, CHANNEL_QUERY ) == 2 )
6972   4                                      {
6973   4                                              //执行命令超时,应是主板与货道驱动板通讯故障
6974   4                                              DeviceStatus.Driver64 |= 0x01;
6975   4                                              HardWareErr |= 0x0040;  
6976   4                                      }
6977   4                      DisableBillDev();
6978   4                      
6979   4                                      if( DeviceStatus.GOCStatus == 0x00 )
6980   4                                      {
6981   4                                          gocErrTimes = 0x00; 
6982   4                                      }
6983   4                                      else if( gocErrTimes < 10 )
6984   4                                      {
6985   4                                              gocErrTimes++;  
6986   4                                      }
6987   4                                      */
6988   4                      sysVPMission.sTimerGOC = 0x00;
6989   4                                      
6990   4                                      sysVPMission.GOCTestFlag = 1;//cq
6991   4      
6992   4                                      if( ChannelTask( 1, CHANNEL_QUERY ) == 2 )
6993   4                                      {
6994   5                                              //执行命令超时,应是主板与货道驱动板通讯故障
6995   5                                              DeviceStatus.Driver64 |= 0x01;
6996   5                                              HardWareErr |= 0x0040;  
6997   5                                      }
6998   4                                      
6999   4                                      sysVPMission.GOCTestFlag = 0;//cq
7000   4      
7001   4                                      if( ChannelTask( 1, CHANNEL_QUERY ) == 2 )
7002   4                                      {
7003   5                                              //执行命令超时,应是主板与货道驱动板通讯故障
7004   5                                              DeviceStatus.Driver64 |= 0x01;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 117 

7005   5                                              HardWareErr |= 0x0040;  
7006   5                                      }
7007   4                                      
7008   4                      //DisableBillDev();
7009   4                      //============================================ 
7010   4                                      
7011   4                              }
7012   3                      }
7013   2                      else
7014   2                      {
7015   3                              sysVPMission.VPDevCtr |= 0x10;
7016   3                      }
7017   2              }
7018   1              /*
7019   1              else if( DeviceStatus.GOCStatus ==0x00 )
7020   1              {
7021   1                      gocErrTimes = 0;
7022   1              }
7023   1              */
7024   1          //13.检测到闭管没有关紧，进行重复检测;by gzz 20110827       
7025   1              if( sysVPMission.sTimertubeRemoved >= VPM_DEVUPDATE_TUBEREMOVE ) 
7026   1              {
7027   2                  sysVPMission.sTimertubeRemoved = 0x00;
7028   2                      MDB_Coin_EXP_TubeRemoved();        
7029   2              }
7030   1              //14.
7031   1              //加快按键反应速度;by gzz 20110721  
7032   1              if(GetKeyOperStatus())
7033   1          {
7034   2                      MaintFunction();
7035   2              }
7036   1              //16.
7037   1              if(sysVPMission.billCoinEnable == 0)
7038   1              {
7039   2                      //DisplayStr( 0, __LINE0__ , 1 , "1", 1 );
7040   2                      //WaitForWork( 2000, NULL );  //500-50-100-200  
7041   2                      DisableBillDev();
7042   2                      //DisplayStr( 0, __LINE0__ , 1 , "5", 1 );
7043   2                      //WaitForWork( 2000, NULL );  //500-50-100-200
7044   2              }
7045   1              /*
7046   1              if(sysVPMission.ErrFlag2 == 1)
7047   1              {
7048   1                      DisplayStr( 0, __LINE0__ , 1 , "2", 1 );
7049   1                      WaitForWork( 2000, NULL );  //500-50-100-200
7050   1                      if( (sysVPMission.billCoinEnable == 1)&&( sysMDBMission.billIsEnable == 0 ) )
7051   1                      {
7052   1                              DisplayStr( 0, __LINE0__ , 1 , "3", 1 );
7053   1                              WaitForWork( 2000, NULL );  //500-50-100-200
7054   1                              EnableBillDev();
7055   1                      }
7056   1              }*/
7057   1              //17.
7058   1              if(sysVPMission.offLineFlag==1)
7059   1              {
7060   2              HardWareErr |= 0x4000;
7061   2          }
7062   1              else
7063   1          {
7064   2                      HardWareErr &= 0xBFFF;
7065   2          }
7066   1              //if(sysVPMission.ErrFlag2 == 1)
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 118 

7067   1              //{
7068   1              //      flag = MDB_Coin_IfDeposited( sysMDBMission.coinBuf, &sysMDBMission.coinBufLen, &sysMDBMission.coinType
             -, &sysMDBMission.coinStock );
7069   1              //}
7070   1              
7071   1              //离线售卖时，打开纸币器硬币器
7072   1              //if( (TradeCounter.offLineFlag == 1)&&(sysVPMission.billCoinEnable == 0) )
7073   1              //{
7074   1              //      sysVPMission.billCoinEnable = 1;
7075   1              //}
7076   1              //16.
7077   1              //-------------------------------------------------
7078   1          //Feed the watch dog
7079   1              FeedWatchDog(); 
7080   1          //=================================================         
7081   1          return 0;
7082   1      }
7083          
7084          
7085          u_char VP_TradeIdle( void )
7086          {
7087   1          u_char xdata i = 0;
7088   1          u_char xdata j = 0;
7089   1          u_char xdata flag = 0;
7090   1          u_int  xdata CurrentDomain = 0;
7091   1          u_char xdata mission = 0;
7092   1              u_char xdata returnflag = 0;
7093   1              u_int  xdata MoneyBuf = 0;
7094   1              
7095   1          
7096   1          #ifndef MACHINE_SET_VMC_PC
                         return VP_ERR_NULL;
                      #endif
7099   1      
7100   1          //1.
7101   1          if( sysVPMission.msTimer1 == 0 )
7102   1              {
7103   2                      //if( ( sysVPMission.vendCmd == 0 )&&(sysVPMission.changeCmd == 0)&&(sysVPMission.costCmd == 0)&&(sysVPM
             -ission.returnCmd == 0) )
7104   2                      {
7105   3                      flag = VPMission_Poll();
7106   3                              //sysVPMission.msTimer1 = VP_TIME_POLL;
7107   3                      if( sysVPMission.resetCmd == 1 )
7108   3                      {
7109   4                              //VPMission_Init();
7110   4                          //sysVPMission.resetCmd = 0;
7111   4                                  returnflag = 1;
7112   4                      }
7113   3                      }
7114   2                      
7115   2          }   
7116   1              //1.1.
7117   1              if(sysVPMission.offLineFlag==1)
7118   1              {
7119   2              HardWareErr |= 0x4000;
7120   2                      returnflag = 1;
7121   2          }
7122   1              else
7123   1          {
7124   2                      HardWareErr &= 0xBFFF;
7125   2          }
7126   1              //2.
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 119 

7127   1          if( sysVPMission.vendCmd == 1 )
7128   1              {               
7129   2                      OutGoods(1);            
7130   2                      //sysVPMission.dspCtr |= 0x02;
7131   2                      if( CurrentPayed >= 1 )
7132   2                      {
7133   3                              sysVPMission.sTimer1 = SystemParameter.tradeTime;
7134   3                      }
7135   2                      if( CurrentPayed < SystemParameter.BanknoteMax )
7136   2              {
7137   3                      EnableBillDev();                
7138   3              }
7139   2                      //显示剩余的金额
7140   2              DisplayCurrentMoney( CurrentPayed );
7141   2                      sysVPMission.inBillMoney = CurrentPayed;
7142   2                      sysVPMission.vendCmd = 0;
7143   2                      UpdateSelLed_Trade();
7144   2                      //WaitForWork( 300, NULL );
7145   2              }
7146   1              //3.
7147   1          if( (sysVPMission.changeCmd == 1)  )
7148   1          {
7149   2              CurrentDispenseCoin = sysVPMission.changeMoney; 
7150   2              sysVPMission.changeMoney = 0;
7151   2              DisableBillDev();
7152   2                      DispenseCoin(1);
7153   2              SaveTradeParam();  //2011.6.10 added: Update the sale data in flash!
7154   2              //UpdateSelectionLed_GoodsSta();        
7155   2                      //
7156   2                      
7157   2              //sysVPMission.dspCtr |= 0x02;
7158   2                      if( sysITLMission.billHoldingFlag == 1 )
7159   2                      {
7160   3                              MoneyBuf = CurrentPayed + sysITLMission.billHoldingValue;
7161   3                      }
7162   2                      else
7163   2                      {
7164   3                              MoneyBuf = CurrentPayed;
7165   3                      }
7166   2                      if( MoneyBuf > 0 )
7167   2                      {
7168   3                              sysVPMission.sTimer1 = SystemParameter.tradeTime;
7169   3                      }
7170   2                      if( MoneyBuf < SystemParameter.BanknoteMax )
7171   2              {
7172   3                      EnableBillDev();                
7173   3              }
7174   2                      //显示剩余的金额
7175   2              DisplayCurrentMoney( CurrentPayed );
7176   2                      sysVPMission.changeCmd = 0;
7177   2                      UpdateSelLed_Trade();
7178   2          }
7179   1      
7180   1          //4.接收扣钱命令，进行扣钱操作  
7181   1              if( (sysVPMission.costCmd == 1)  )
7182   1          {           
7183   2                      //在扣款之前, stack the holding bill
7184   2                      if( ( sysITLMission.billHoldingFlag == 1 )&&(sysVPMission.costMoney > CurrentPayed) )
7185   2                      {
7186   3                          
7187   3                      flag = MDB_Bill_EscrowCtr( 1 );
7188   3                              if(flag==0)
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 120 

7189   3                              {
7190   4                                  sysVPMission.billSTimer = TIME_BILL_STACK;
7191   4                                  while( sysVPMission.billSTimer )
7192   4                                      {
7193   5                              mission = MDB_Bill_IfStacked( sysMDBMission.billBuf, &sysMDBMission.billBufLen );
7194   5                                              if( mission == 1 )
7195   5                                              {
7196   6                                                  CurrentDomain = sysITLMission.billHoldingValue;
7197   6                                                      Trace( "\n Get in Cash Ok" );
7198   6                                                      //CurrentDomain = GetCash();
7199   6                                                      Trace( "\n CurrentDomain = %d",CurrentDomain );         
7200   6                                                      CurrentPayed += CurrentDomain * BILLMULTIPLE;   
7201   6                                                      //TradeCounter.TrueCurrencySum += CurrentDomain * BILLMULTIPLE;
7202   6                                                      //TradeCounter.CashSum += CurrentDomain * BILLMULTIPLE;
7203   6                                                      //TradeCounter.CashSumBack += CurrentDomain * BILLMULTIPLE;//区间
7204   6                                                      SellAccumulateMoney(&TradeCounter.CashSum,CurrentDomain * BILLMULTIPLE);
7205   6                                                      SellAccumulateMoney(&TradeCounter.CashSumBack,CurrentDomain * BILLMULTIPLE);
7206   6                                                      //------------------------------------------------------
7207   6                                                      sysVPMission.payInBillFlag = 1;
7208   6                                                      sysVPMission.payInBillMoney += CurrentDomain * BILLMULTIPLE;
7209   6                                                      //reset the trade timer
7210   6                                              //sysVPMission.sTimer1 = SystemParameter.tradeTime;
7211   6                                                      //======================================================
7212   6                                                      //sysITLMission.restartTime = ITL_TIME_RESTART; //reset the timer!
7213   6                                                      memset(sysMDBMission.billBuf,0,sizeof(sysMDBMission.billBuf));
7214   6                                                      sysMDBMission.billBufLen=0;
7215   6                                                      sysMDBMission.billType=0;
7216   6                                                      sysMDBMission.billStock=0;
7217   6                                          sysITLMission.billHoldingFlag = 0;
7218   6                                                      sysITLMission.billHoldingValue = 0;
7219   6                                          //payin report
7220   6                                                      if( sysVPMission.payInCoinFlag == 1 )
7221   6                                                      {
7222   7                                                          VPMission_Payin_RPT( VP_DEV_COIN, sysVPMission.payInCoinMoney );
7223   7                                                              sysVPMission.payInCoinFlag = 0;
7224   7                                                      sysVPMission.payInCoinMoney = 0;
7225   7                                                      
7226   7                                                      }
7227   6                                                      if( sysVPMission.payInBillFlag == 1 )
7228   6                                                      {
7229   7                                                          VPMission_Payin_RPT( VP_DEV_BILL, sysVPMission.payInBillMoney );
7230   7                                                              sysVPMission.payInBillFlag = 0;
7231   7                                                      sysVPMission.payInBillMoney = 0;      
7232   7                                                      }
7233   6                              DisplayCurrentMoney( CurrentPayed ); 
7234   6                                  break;//压钞成功后，直接跳出时间循环等待;by gzz 20110721
7235   6                                              }
7236   5                                              else
7237   5                                              {
7238   6                                                      VP_GameKeyPoll( 200 );
7239   6                                              }
7240   5                          }
7241   4                                      if( sysVPMission.billSTimer == 0 )
7242   4                                      {
7243   5                          //钞箱满，钞箱压钞后就能时，还可以认到纸币;by gzz 20111017
7244   5                                          //检测纸币器钞箱是否已满;by gzz 20111014 
7245   5                                              WaitForWork(2000,NULL);
7246   5                              MDB_Bill_Stacker( &sysMDBMission.billBuf[0], &sysMDBMission.billBuf[1] ); 
7247   5                              if(sysMDBMission.billIsFull==1)
7248   5                                              {
7249   6                                                  CurrentDomain = sysITLMission.billHoldingValue;
7250   6                                                      Trace( "\n Get in Cash Ok" );
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 121 

7251   6                                                      //CurrentDomain = GetCash();
7252   6                                                      Trace( "\n CurrentDomain = %d",CurrentDomain );         
7253   6                                                      CurrentPayed += CurrentDomain * BILLMULTIPLE;   
7254   6                                                      //TradeCounter.TrueCurrencySum += CurrentDomain * BILLMULTIPLE;
7255   6                                                      //TradeCounter.CashSum += CurrentDomain * BILLMULTIPLE;
7256   6                                                      //TradeCounter.CashSumBack += CurrentDomain * BILLMULTIPLE;//区间
7257   6                                                      SellAccumulateMoney(&TradeCounter.CashSum,CurrentDomain * BILLMULTIPLE);
7258   6                                                      SellAccumulateMoney(&TradeCounter.CashSumBack,CurrentDomain * BILLMULTIPLE);
7259   6                                                      //------------------------------------------------------
7260   6                                                      sysVPMission.payInBillFlag = 1;
7261   6                                                      sysVPMission.payInBillMoney += CurrentDomain * BILLMULTIPLE;
7262   6                                                      //reset the trade timer
7263   6                                              //sysVPMission.sTimer1 = SystemParameter.tradeTime;
7264   6                                                      //======================================================
7265   6                                                      //sysITLMission.restartTime = ITL_TIME_RESTART; //reset the timer!
7266   6                                                      memset(sysMDBMission.billBuf,0,sizeof(sysMDBMission.billBuf));
7267   6                                                      sysMDBMission.billBufLen=0;
7268   6                                                      sysMDBMission.billType=0;
7269   6                                                      sysMDBMission.billStock=0;
7270   6                                          sysITLMission.billHoldingFlag = 0;
7271   6                                                      sysITLMission.billHoldingValue = 0;
7272   6                                          //payin report
7273   6                                                      if( sysVPMission.payInCoinFlag == 1 )
7274   6                                                      {
7275   7                                                          VPMission_Payin_RPT( VP_DEV_COIN, sysVPMission.payInCoinMoney );
7276   7                                                              sysVPMission.payInCoinFlag = 0;
7277   7                                                      sysVPMission.payInCoinMoney = 0;
7278   7                                                      
7279   7                                                      }
7280   6                                                      if( sysVPMission.payInBillFlag == 1 )
7281   6                                                      {
7282   7                                                          VPMission_Payin_RPT( VP_DEV_BILL, sysVPMission.payInBillMoney );
7283   7                                                              sysVPMission.payInBillFlag = 0;
7284   7                                                      sysVPMission.payInBillMoney = 0;      
7285   7                                                      }
7286   6                              DisplayCurrentMoney( CurrentPayed );                        
7287   6                                              }
7288   5                                              else
7289   5                                              {
7290   6                                                      //...   
7291   6                                                      //调整顺序，billHoldingFlag==0放在sysVPMission之上;by gzz 20110721
7292   6                                                      sysVPMission.escrowMoney = sysITLMission.billHoldingValue;
7293   6                                                      sysITLMission.billHoldingFlag = 0;
7294   6                                                      sysITLMission.billHoldingValue = 0;
7295   6                                                      //Need better solutoin. 
7296   6                                                      //Maybe cheated by man
7297   6                                          //CurrentPayed += sysITLMission.billHoldingValue;
7298   6                                                      //-----------------------------------------------------
7299   6                                                  sysVPMission.escrowOutFlag = 1;                                         
7300   6                                                      if( sysVPMission.escrowOutFlag == 1 )
7301   6                                                  {
7302   7                                                          VPMission_Payin_RPT( VP_DEV_ESCROWOUT, sysVPMission.escrowMoney );
7303   7                                                              sysVPMission.escrowOutFlag = 0;
7304   7                                                      sysVPMission.escrowMoney = 0;     
7305   7                                                      }
7306   6                                                  //=====================================================
7307   6                                  DisplayCurrentMoney( CurrentPayed );                                        
7308   6                                                      /*                                      
7309   6                                                      if( GoodsWaySetVal[CurrentStockCode].Price > CurrentPayed )
7310   6                                                      {
7311   6                                                              return 1;
7312   6                                                      }       
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 122 

7313   6                                  */
7314   6                          }
7315   5                                      }
7316   4                      }
7317   3                      else
7318   3                              {
7319   4                                      //...
7320   4                                      //调整顺序，billHoldingFlag==0放在sysVPMission之上;by gzz 20110721
7321   4                                      sysVPMission.escrowMoney = sysITLMission.billHoldingValue;
7322   4                                      sysITLMission.billHoldingFlag = 0;
7323   4                                      sysITLMission.billHoldingValue = 0;
7324   4                                      //Need better solutoin. 
7325   4                                      //Maybe cheated by man
7326   4                          //CurrentPayed += sysITLMission.billHoldingValue;
7327   4                                      //-----------------------------------------------------
7328   4                                      sysVPMission.escrowOutFlag = 1;                         
7329   4                                      if( sysVPMission.escrowOutFlag == 1 )
7330   4                                  {
7331   5                                          VPMission_Payin_RPT( VP_DEV_ESCROWOUT, sysVPMission.escrowMoney );
7332   5                                              sysVPMission.escrowOutFlag = 0;
7333   5                                      sysVPMission.escrowMoney = 0;     
7334   5                                      }
7335   4                                      //=====================================================
7336   4                      DisplayCurrentMoney( CurrentPayed );                            
7337   4                                      /*                              
7338   4                                      if( GoodsWaySetVal[CurrentStockCode].Price > CurrentPayed )
7339   4                                      {
7340   4                                              return 1;
7341   4                                      }
7342   4                      */
7343   4                              }
7344   3                  }
7345   2                  else
7346   2                      {
7347   3                              //若此时还有插币，等压钞结束后再判断;by gzz 20110429 
7348   3                              //WaitForWork( NULL, 1000 );
7349   3                      /*
7350   3                          if((SystemParameter.BillNo==1)&&(sysITLMission.ITLSet==1))
7351   3                          {      
7352   3                             if(sysITLMission.billStaCtr & ITL_BILL_READ)
7353   3                             {        
7354   3                                      
7355   3                                return 1;          
7356   3                             }
7357   3                          }
7358   3                      */ 
7359   3                      }
7360   2                      //
7361   2                      {
7362   3                      sysITLMission.billStaCtr = 0;
7363   3                      sysITLMission.billSta = 0;
7364   3                              /*
7365   3                      WaitForWork( 300, NULL );
7366   3                              MDB_Bill_EscrowCtr( 0 );
7367   3                              */
7368   3                      //sysITLMission.billStaCtr |= ITL_BILL_VEDNING;
7369   3                      }
7370   2      
7371   2                      if(sysVPMission.costMoney > CurrentPayed)
7372   2                  {
7373   3                               sysVPMission.costMoney = 0;
7374   3                      }
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 123 

7375   2                      else
7376   2                      {
7377   3                              CurrentPayed = CurrentPayed - sysVPMission.costMoney;  
7378   3                      }
7379   2                      
7380   2                      VPMission_Cost_RPT(sysVPMission.costDev, sysVPMission.costMoney, sysVPMission.costType);
7381   2      
7382   2              //---------------------------------------------------        
7383   2              if( CurrentPayed >= 1 )
7384   2                      {
7385   3                              sysVPMission.sTimer1 = SystemParameter.tradeTime;
7386   3                      } 
7387   2                      if( CurrentPayed < SystemParameter.BanknoteMax )
7388   2              {
7389   3                      EnableBillDev();                
7390   3              }
7391   2                      else
7392   2                      {
7393   3                              DisableBillDev();
7394   3                      }
7395   2                      sysVPMission.inBillMoney = CurrentPayed;
7396   2              //显示剩余的金额
7397   2              DisplayCurrentMoney( CurrentPayed );
7398   2                      sysVPMission.costCmd = 0;
7399   2                      UpdateSelLed_Trade();
7400   2          }
7401   1      
7402   1              /*
7403   1              //5.
7404   1              //if( sysVPMission.dspCtr & 0x02 )
7405   1              //{
7406   1                  //sysVPMission.dspCtr &= 0xfd;
7407   1                      if( CurrentPayed > 0 )
7408   1              {
7409   1                  UpdateSelLed_Trade();
7410   1                              DisplayCurrentMoney( CurrentPayed );
7411   1                              if( (HardWareErr==0x00)&&((CurrentPayed+sysITLMission.billHoldingValue)<SystemParameter.BanknoteMax) )
7412   1                              {
7413   1                                      EnableBillDev();
7414   1                              }
7415   1                              //sysVPMission.sTimer1 = SystemParameter.tradeTime;
7416   1                      }
7417   1              //}
7418   1              */
7419   1              
7420   1              //6.
7421   1          if( sysVPMission.sTimer1 == 0 )
7422   1          {   
7423   2                      //-----------------------------------------------------------------------------------
7424   2                  //Andy added 2011.4.14.Rject the holding bill.
7425   2                  //if( (SystemParameter.RefundPermission==1) && ( sysITLMission.billHoldingFlag == 1 ) )
7426   2                      if( ((SystemParameter.RefundPermission==1)||(sysVPMission.boughtFlag==1))&&( sysITLMission.billHoldingFl
             -ag == 1 ) )
7427   2                      {
7428   3                          
7429   3                              flag = MDB_Bill_EscrowCtr(0);
7430   3                              //调整顺序，flag==0放在sysVPMission之上;by gzz 20110721
7431   3                              if( flag == 0 )
7432   3                              {
7433   4                                      sysVPMission.escrowMoney = sysITLMission.billHoldingValue;
7434   4                                      sysITLMission.billHoldingFlag = 0; 
7435   4                                  sysITLMission.billHoldingValue = 0;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 124 

7436   4                              }
7437   3                              else
7438   3                              {
7439   4                                      sysVPMission.escrowMoney = sysITLMission.billHoldingValue;
7440   4                                      //... Need more discussion for better soluton!
7441   4                      sysITLMission.billHoldingFlag = 0;
7442   4                                  sysITLMission.billHoldingValue = 0;
7443   4                              }
7444   3                  //-----------------------------------------------------
7445   3                              sysVPMission.escrowOutFlag = 1;                 
7446   3                  if( sysVPMission.escrowOutFlag == 1 )
7447   3                          {
7448   4                                  VPMission_Payin_RPT( VP_DEV_ESCROWOUT, sysVPMission.escrowMoney );
7449   4                                      sysVPMission.escrowOutFlag = 0;
7450   4                              sysVPMission.escrowMoney = 0;     
7451   4                              }
7452   3                              //=====================================================
7453   3                              //Send the reject mesage to pc
7454   3                              if( CurrentPayed > 0 )
7455   3                  {
7456   4                      //UpdateSelLed_Trade();
7457   4                                      //DisplayCurrentMoney( CurrentPayed/*+sysITLMission.billHoldingValue* / );
7458   4                      //by gzz 20110416
7459   4                                      //DisableBillDev();
7460   4                      //EnableBillDev();
7461   4                      //End_by gzz 20110416                   
7462   4                                      
7463   4                  }
7464   3                  else
7465   3                  {
7466   4                      //by gzz 20110416
7467   4                                      //DisableBillDev();
7468   4                      //EnableBillDev();
7469   4                      //End_by gzz 20110416
7470   4                      UpdateSelectionLed_GoodsSta(); 
7471   4                  }
7472   3                      }
7473   2                      //if( (SystemParameter.RefundPermission==1) && (CurrentPayed>0) )
7474   2                      if( ((SystemParameter.RefundPermission==1)||(sysVPMission.boughtFlag==1))&&(CurrentPayed>0) )
7475   2                      {
7476   3                          CurrentDispenseCoin = CurrentPayed; 
7477   3                              CurrentPayed = 0;
7478   3                              //DisplayStr( 0, __LINE0__ , 1 , "6", 1 );
7479   3                              //WaitForWork( 2000, NULL );  //500-50-100-200
7480   3                              DispenseCoin(0);
7481   3                              DisableBillDev();
7482   3                  SaveTradeParam();  //2011.6.10 added: Update the sale data in flash!
7483   3                  UpdateSelectionLed_GoodsSta();
7484   3                  EnableBillDev(); 
7485   3                              memset(&sysMDBMission.coinBuf,0,sizeof(sysMDBMission.coinBuf));
7486   3                      memset(&sysMDBMission.billBuf,0,sizeof(sysMDBMission.billBuf));            
7487   3                      }
7488   2                      //MDB_Bill_EscrowCtr(0);    //Added to reject the unknown holding bill
7489   2                      if( sysVPMission.boughtFlag==1 )
7490   2                      {
7491   3                          sysVPMission.boughtFlag = 0;
7492   3                      }
7493   2                      if( sysITLMission.billHoldingFlag != 1 )
7494   2                      {
7495   3                          MDB_Bill_EscrowCtr(0);  //Added to reject the unknown holding bill
7496   3                      }
7497   2          }
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 125 

7498   1          //7.
7499   1              if( IfReturnKeyOn()||(returnflag == 1) )
7500   1              {               
7501   2                  //-----------------------------------------------------------------------------------
7502   2                  sysVPMission.returnCmd=1;
7503   2                  //Andy added 2011.4.14.Rject the holding bill.
7504   2                  //if( (SystemParameter.RefundPermission==1) && ( sysITLMission.billHoldingFlag == 1 ) )
7505   2                      if( ((SystemParameter.RefundPermission==1)||(sysVPMission.boughtFlag==1))&&( sysITLMission.billHoldingFl
             -ag == 1 ) )
7506   2                      {
7507   3                          
7508   3                              flag = MDB_Bill_EscrowCtr(0);
7509   3                              //调整顺序，flag==0放在sysVPMission之上;by gzz 20110721
7510   3                              if( flag == 0 )
7511   3                              {
7512   4                                      sysVPMission.escrowMoney = sysITLMission.billHoldingValue;
7513   4                                      sysITLMission.billHoldingFlag = 0;
7514   4                                  sysITLMission.billHoldingValue = 0;
7515   4                              }
7516   3                              else
7517   3                              {
7518   4                                      //... Need more discussion for better soluton!
7519   4                                      sysVPMission.escrowMoney = sysITLMission.billHoldingValue;
7520   4                      sysITLMission.billHoldingFlag = 0;
7521   4                                  sysITLMission.billHoldingValue = 0;
7522   4                              }
7523   3                  //-----------------------------------------------------
7524   3                              sysVPMission.escrowOutFlag = 1;                 
7525   3                              if( sysVPMission.escrowOutFlag == 1 )
7526   3                          {
7527   4                                  VPMission_Payin_RPT( VP_DEV_ESCROWOUT, sysVPMission.escrowMoney );
7528   4                                      sysVPMission.escrowOutFlag = 0;
7529   4                              sysVPMission.escrowMoney = 0;     
7530   4                              }
7531   3                              //=====================================================
7532   3                              //.Send the reject message to PC
7533   3      
7534   3                              if( CurrentPayed > 0 )
7535   3                  {
7536   4                      //UpdateSelLed_Trade();
7537   4                                      //DisplayCurrentMoney( CurrentPayed/*+sysITLMission.billHoldingValue* / );
7538   4                      //by gzz 20110416
7539   4                                      //DisableBillDev();
7540   4                      //EnableBillDev();
7541   4                      //End_by gzz 20110416   
7542   4                              
7543   4                                      
7544   4                  }
7545   3                  else
7546   3                  {
7547   4                      //by gzz 20110416
7548   4                                      //DisableBillDev();
7549   4                      //EnableBillDev();
7550   4                      //End_by gzz 20110416   
7551   4                      UpdateSelectionLed_GoodsSta(); 
7552   4                  }
7553   3                      }
7554   2                      //if( (SystemParameter.RefundPermission==1) && (CurrentPayed>0))
7555   2                      if( ((SystemParameter.RefundPermission==1)||(sysVPMission.boughtFlag==1))&&(CurrentPayed>0) )
7556   2                      {
7557   3                          CurrentDispenseCoin = CurrentPayed; 
7558   3                              CurrentPayed = 0;
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 126 

7559   3                              //DisplayStr( 0, __LINE0__ , 1 , "7", 1 );
7560   3                              //WaitForWork( 2000, NULL );  //500-50-100-200
7561   3                              DispenseCoin(0);
7562   3                              DisableBillDev();
7563   3                  SaveTradeParam();  //2011.6.10 added: Update the sale data in flash!
7564   3                  UpdateSelectionLed_GoodsSta();
7565   3                  EnableBillDev(); 
7566   3                              memset(&sysMDBMission.coinBuf,0,sizeof(sysMDBMission.coinBuf));
7567   3                      memset(&sysMDBMission.billBuf,0,sizeof(sysMDBMission.billBuf));           
7568   3                      }
7569   2                  //MDB_Bill_EscrowCtr(0);  //Added to reject the unknown holding bill
7570   2                      if( sysVPMission.boughtFlag==1 )
7571   2                      {
7572   3                          sysVPMission.boughtFlag = 0;
7573   3                      }
7574   2                      if( sysITLMission.billHoldingFlag != 1 )
7575   2                      {
7576   3                          MDB_Bill_EscrowCtr(0);  //Added to reject the unknown holding bill
7577   3                      }
7578   2                      sysVPMission.inBillMoney = 0;
7579   2                      sysVPMission.returnCmd=0;
7580   2      
7581   2              }
7582   1              if(returnflag == 1)
7583   1              {
7584   2                      return 1;
7585   2              }
7586   1      
7587   1              /*
7588   1              //8.
7589   1          if(  sysVPMission.comErrNum >= VP_TIME_OUNT_NUM )
7590   1          {
7591   1                  //HardWareErr |= 0x2000;
7592   1              MDB_Bill_EscrowCtr(0);  //Added 2011.7.19
7593   1                  if( ( CurrentPayed > 0 ) )
7594   1                  {
7595   1                              CurrentDispenseCoin = CurrentPayed;     
7596   1                          CurrentPayed = 0;
7597   1                      DisableBillDev();
7598   1                          DispenseCoin();
7599   1                  SaveTradeParam();  //2011.6.10 added: Update the sale data in flash!
7600   1                      UpdateSelectionLed_GoodsSta();
7601   1                  }
7602   1                      return 2;
7603   1          }
7604   1              else
7605   1              {
7606   1                      //HardWareErr &= 0xDFFF;
7607   1              }
7608   1              */
7609   1      
7610   1              //9.
7611   1          if( IfGameKeyOn() )
7612   1              {
7613   2                      VPMission_Button_RPT( VP_BUT_GAME, VP_BUT_NUMBER );
7614   2              //Beep();
7615   2              }
7616   1      
7617   1              
7618   1      
7619   1          //10.
7620   1              //-------------------------------------------------
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 127 

7621   1          //Feed the watch dog
7622   1              FeedWatchDog();
7623   1          //=================================================
7624   1              return 0;
7625   1          
7626   1      }
7627           
7628          //单独作一个永远不会被调用到的节点
7629          //u_char UNUSE_NODE();
7630          
7631          
7632          BEGIN_FLOW( RunFlow )
7633   1              NODE(5)         SystemInit()
7634   1              //硬件全检,其它设备逻辑检测
7635   1              //初始化参数、设备工作状态(如允许查询状态等等)  
7636   1              NODE(15)        DeviceDefaultSetting()          
7637   1              //显示退出服务
7638   1              NODE(16)        DisplayOutServer()      R1(200)
7639   1              NODE(17)    CheckOperStatus()           R1(200)   //Added by Andy 2010.11.04 
7640   1              //初始化系统参数
7641   1              NODE(20)        SysInitParam()
7642   1      
7643   1              NODE(21)        IsTradeClear()
7644   1              
7645   1              //查询是否有货，全无货则为无货，无货返回1并退出服务
7646   1              //NODE(22)      CheckGoodsSumAndLoad()                  R1(400) 
7647   1          //-----------------------------------------------------------------------
7648   1          NODE(23)    VPMission_Init()
7649   1          //=======================================================================
7650   1      
7651   1              //IDLE
7652   1              //return1=维护状态，　0=运行状态,运行相互变量清理工作也放在这里
7653   1              NODE(25)        CheckOperStatus()               R1(200)         
7654   1          //检查是否有查询命令
7655   1              //NODE(26)      CheckQureyCmd()
7656   1              //判断是否有短信需要发送
7657   1              //NODE(27)      CycleSendSMS()
7658   1              
7659   1          NODE(28)    VMC_PC_POLL()       R1(23)  R2(23)
7660   1              //查检是否有按键,有数字键输入，返回1,否则返回2
7661   1              NODE(29)        CheckKeyPress()         R1(42)  R2(30)
7662   1              
7663   1              //查询硬件状态值,硬件包括键盘、液晶屏，无故障返回0,有故障返回1并退出服务
7664   1              NODE(30)        CheckHardwareState()                    R1(400) 
7665   1              //确定找零器中的硬币是否足
7666   1        //NODE(36)    CheckCoinRemain()               R1(400)
7667   1              //查询是否有货，全无货则为无货，无货返回1并退出服务
7668   1        //NODE(40)    CheckGoodsSumAndLoad()                  R1(400) 
7669   1          NODE(33)    GetKeyOperStatus()              R1(200)//加快按键反应速度;by gzz 20110721  
7670   1      
7671   1              //使能收币器
7672   1              NODE(35)        EnableBillDev() 
7673   1              //查检是否有币插入,有返回1,无返回0
7674   1              NODE(36)        IsInsertBill()                  R1(47)                  
7675   1      
7676   1              //查检是否有按键,有数字键输入，返回1,否则返回2
7677   1              NODE(41)        CheckKeyPress()             R1(42)  R2(44)      
7678   1      
7679   1              //显示输入的货道，并判断输入是否正确，是否存在此货道,输入正确返回0,输入失败返回1
7680   1              NODE(42)        QueryDisplayInputCode() R1(44)
7681   1      
7682   1              //判断货道是否正常并显示
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 128 

7683   1              NODE(43)        QueryIsGoodsWay()       R1(62)
7684   1                              
7685   1              //显示服务情况，如是进入服务则判断是否有按键，有返回0，无返回1,
7686   1              NODE(44)        DispWelOrOutServ()              R1(25)  R2(47)
7687   1              
7688   1      
7689   1              //服务　
7690   1              NODE(45)    VP_TradeIdle()          R1(23)  R2(23)
7691   1              //查检是否有币插入,有返回1,无返回0
7692   1              NODE(46)        IsInsertBill()                  R1(47)  //85
7693   1                                  GOTONODE( 49 )
7694   1              //收取纸币并比较和显示，
7695   1              //当金额大于限额时返回1直接去选货，
7696   1              //否则返回0继续等待按键或插钱
7697   1              //第一次收钱失败时返回2
7698   1              NODE(47)        GetBill()               R1(45)  R2(45)   //R1_50_49
7699   1          NODE(48)    UpdateSelLed_Trade()
7700   1              //查检是否有数字按键,有返回0,没有但余额大于零返回1，否则返回2
7701   1              NODE(49)        IsInputGoodsNo()                R1(45)  R2(25)  //105
7702   1      
7703   1              //显示输入货道编号,包括输入正确与否判断和输入超时判断，输入正确返回0，输入错误返回1
7704   1              //输入CANNEL或输入超时返回2并退出服务
7705   1              NODE(50)        DisplayInputCode()          R1( 45 )    R2(46 )
7706   1      
7707   1              //-------------------------------------------------------------------
7708   1              //Changed by Andy on 2010.12.23
7709   1              /*
7710   1              //判断货道是否正常，正常返回0显示货物信息,不正常返回1,货道已无货返回2
7711   1              NODE(55)        IsGoodsWay()    R1(60)          R2(50)
7712   1              //判断插入金额是否够买货，够返回0,不够返回1
7713   1              NODE(58)        IsMoneyEnough()         R1( 65 )//125
7714   1              //转到出货
7715   1                              GOTONODE( 125 )
7716   1              */
7717   1          //判断货道是否正常，正常返回0显示货物信息,不正常返回1,货道已无货返回2
7718   1              NODE(55)        IsGoodsWay()     R1(46)         R2(46)
7719   1              //判断插入金额是否够买货，够返回0,不够返回1
7720   1              //NODE(58)      IsMoneyEnough()  R1( 46 )       //125
7721   1              NODE(58)        IsMoneyEnough()  R1(46) R2(47)  //125
7722   1              //转到出货
7723   1                                  GOTONODE( 125 )
7724   1          //====================================================================
7725   1              
7726   1                      
7727   1              //显示货道故障，询问是否选其它货，选其它货返回0,不选其它货返回1，找零
7728   1              NODE(60)        GoodsWayErr()   R1(115)
7729   1              //户客选其它货
7730   1                              GOTONODE(50)
7731   1              //---------------------------------------------------------------------
7732   1          NODE(62)    OutGoods(2)      R1(46)     R2(355)     
7733   1                      GOTONODE(127)     
7734   1              //=====================================================================
7735   1              
7736   1              //显示金额不足,要求再插币，返回1
7737   1              //提示是否继续插币，确定返回1,取消或超时则返回0
7738   1              NODE(65)        DispInputMoney()                R1( 46 )                //640   
7739   1      
7740   1              //查找同类型更便宜的卡,找到返回0,没有找到返回1
7741   1              NODE(100)       ExistAnyChoose()                R1(110)         R2(135) //650
7742   1              //提示客户是否选择买其它的货，确定返回1并到50节点让用户重新输入，取消或超时返回0
7743   1              NODE(105)       CheaperOnePlz()                 R1(50)          //660
7744   1              //看系统是否允许退币，允许退币且需要退币则退并返0，不允许则返回1反复提示,不需要退币返回2        
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 129 

7745   1              NODE(110)       CheckChangePermit()             R1(65)          R2( 135 )               //700   
7746   1              //找零，配币失败返回1,出币错误返回2,出币正确返回0       
7747   1              NODE(115)       DispenseCoin(0)                 R1(150)         R2(120)         //770
7748   1              NODE(120)       DispGetCoin()           //780
7749   1                              GOTONODE(150)                   
7750   1              //出货,正常出货返回0,出货失败但不能找零且还有其它货道可服务则设置货道故障并返回1,出货超时返回2
7751   1              NODE(125)       OutGoods(0)     R1(46)          R2(355)         //140
7752   1              //确定是否断续购买商品,返回0,不继续购买，进行找零；返回1则继续购买
7753   1              NODE(127)   ReBuy()             R1(46)
7754   1              //找零          
7755   1              NODE(130)       ReturnChange()                  R1(150)         //810   
7756   1              //提示用户取货和找零
7757   1              NODE(135)       DispThx()                           R1(150)             //820
7758   1              //点亮出货灯,并返回1
7759   1        //NODE(140)   LightBlink()                    R1(150)         //830           
7760   1              //结束售货流程并返回1   
7761   1              NODE(150)       SellCodeOver()                                  //990   
7762   1              //故障检查，都用标志位
7763   1              //查询硬件状态值,如有故障,再查硬件故障看是否有清除，无返回
7764   1              NODE(165)       TestHardWare()              R1(25)      
7765   1              //判断货道库存和货道状态
7766   1              NODE(170)       CheckGoodsSumAndLoad()  
7767   1              NODE(172)       ScanIsSendAlarm()
7768   1              NODE(175)       EndMission()
7769   1                              GOTONODE(25)    
7770   1              //维护流程
7771   1              NODE(200)       MaintFunction()
7772   1              //判断货道库存和货道状态
7773   1              NODE(205)       CheckGoodsSumAndLoad()  R1(400) 
7774   1                              GOTONODE(23)                //25-23
7775   1              //货道故障，联系营运商，退出服务
7776   1              NODE(355)       AllGoodsWayError()              R1(172)         
7777   1      
7778   1              NODE(400)       OutofService()  
7779   1              NODE(403)       ShowOutofService()
7780   1              //使能收币器
7781   1              NODE(405)       EnableBillOutofService()
7782   1              //查检是否有币插入,有返回1,无返回0
7783   1              NODE(406)       IsInsertBill()                  R2(25)  
7784   1              NODE(417)       ShowOutofService()
7785   1              NODE(418)       GetBill()
7786   1              GOTONODE( 25 )
7787   1              
7788   1      END_FLOW()
7789          
7790          void main()
7791          {
7792   1              ZhkInit();
7793   1      #ifdef _DEBUG_TRACE
                      TraceInit();
              #endif  
7796   1              RunFlow();
7797   1      
7798   1              //120419 by cq TotalSell
7799   1              /*
7800   1              InitAllCounter_1(); 
7801   1              while(1)
7802   1              {
7803   1                      DisplayStr( 0, 0, 1, "  交易记录清零完毕", 18 );        
7804   1                      DisplayStr( 0, 1, 1, "  可以重新下载软件", 18 );        
7805   1                      WaitForWork( 1000, NULL );
7806   1              }
CX51 COMPILER V7.50   MAINFLOW                                                             10/23/2014 15:38:36 PAGE 130 

7807   1              */
7808   1      }
7809          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =  27389    ----
   CONSTANT SIZE    =   1328    ----
   XDATA SIZE       =   5452     279
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      5    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


CX51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
