CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 1   


CX51 COMPILER V7.50, COMPILATION OF MODULE VMC_PC
OBJECT MODULE PLACED IN VMC_PC.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\CX51.EXE VMC_PC.c LARGE OBJECTADVANCED ROM(HUGE) OPTIMIZE(SIZE) BROWSE DEBUG

line level    source

   1          #define  VMC_PC_C
   2          #include "debug.h" 
   3          #include "device.h"
   4          //#include "serial1.h"
   5          #include "Serial.h"
   6          //#include "procotol.h" 
   7          //#include "scheduler.h"
   8          #include "string.h"
   9          #include "global.h"
  10          #include "VMC_PC.h"
  11          #include "CommonFunction.h"
  12          #include "key.h"
  13          #include "ITL.h"
  14          #include "BusCard.h"
  15          #include "IOInput.h"//by gzz 20110721
  16          #include "Countermaint.h"//120419 by cq TotalSell
  17          
  18          
  19          //------------------------------------------
  20          //extern bit  data      isShowLcd;
  21          extern u_int  xdata CurrentPayed;
  22          extern u_int  xdata HardWareErr;
  23          extern u_int  xdata CurrentPayed;
  24          extern u_int  xdata CurrentDispenseCoin;
  25          extern u_char xdata SystemStatus;
  26          extern struct HopperSet xdata HopperSetList[HOPPERNUM];  //0存放最大面值,1存放第二大面值,依此类推
  27          extern unsigned char OutGoods( unsigned char type );
  28          extern u_char DispenseCoin(unsigned char flag );
  29          extern u_char DisableBillDev();
  30          extern u_char StackTheBillAPI( void );
  31          extern u_char DisplayCurrentMoney( u_int Money );
  32          extern void SellAccumulateNum(unsigned long * ul_num);
  33          extern void SellAccumulateMoney(unsigned long * ul_money, unsigned int ui_cost);
  34          u_char IsCanChange(u_int    Price);
  35          
  36          //==========================================
  37          
  38          unsigned char xdata VPMsgBuf[255];
  39          unsigned char xdata GoodsType[124];
  40                  u_int     xdata Price[124]; 
  41          
  42          /*
  43          extern SERAILPARAM xdata ZhkSerialParam;
  44          SERAILPARAM code VPSerialParam = 
  45          { 
  46                  8, VERIFY_NULL, 1, 0x00, 0x96, 0x00     
  47          };
  48          */
  49          
  50          //121121 by cq PC_VER_3
  51          unsigned short calc_crc(unsigned char * msg, unsigned short len)
  52          {
  53   1              unsigned short i,j;
  54   1              unsigned short crc = 0;
  55   1              unsigned short current;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 2   

  56   1              for(i = 0; i < len; i++)
  57   1              {
  58   2                      current = msg[i] << 8;
  59   2                      for(j = 0; j < 8; j++)
  60   2                      {
  61   3                              if((short)(crc ^ current) < 0)
  62   3                                      crc = (crc << 1) ^ 0x1021;
  63   3                              else
  64   3                                      crc <<= 1;
  65   3                              current <<= 1;
  66   3                      }
  67   2              }
  68   1              return crc;
  69   1      }
  70          
  71          unsigned char g_msg[300];
  72          
  73          
  74          void VPSerialInit( void )
  75          {
  76   1              /*
  77   1          unsigned char data i;
  78   1              for( i=0; i<sizeof( SERAILPARAM ); i++ )
  79   1                      ZhkSerialParam[i] = VPSerialParam[i];
  80   1              ZhkSerialInit();
  81   1          ES = 1;  //2009.03.02 added
  82   1              */
  83   1              memset( VPMsgBuf, 0, sizeof(VPMsgBuf) );
  84   1      }
  85          
  86          //CHK and send the message
  87          unsigned char VPBusTxMsg( void )
  88          {
  89   1              unsigned char  data i   = 0;
  90   1              //unsigned char  data len = 0;
  91   1              //unsigned char  data sum = 0;
  92   1              //unsigned char xdata DataString[255];
  93   1              
  94   1              //1.caculate the CHK
  95   1              //sysVPMission.send.datLen = sysVPMission.send.len - 5;
  96   1          memset(g_msg,0x00,sizeof(g_msg));
  97   1              g_msg[0] = sysVPMission.send.sf;
  98   1              g_msg[1] = sysVPMission.send.len;
  99   1              g_msg[2] = sysVPMission.send.verFlag;
 100   1              g_msg[3] = sysVPMission.send.msgType;
 101   1              g_msg[4] = sysVPMission.send.sn;
 102   1              for( i = 0; i < sysVPMission.send.datLen; i++ )
 103   1              {
 104   2                      g_msg[5+i] += sysVPMission.send.msg[i]; 
 105   2              }
 106   1              
 107   1              sysVPMission.send.chk = calc_crc(g_msg,sysVPMission.send.len);
 108   1              //2.send the message
 109   1              ZhkSerialPutCh( sysVPMission.send.sf );
 110   1              ZhkSerialPutCh( sysVPMission.send.len );
 111   1              ZhkSerialPutCh( sysVPMission.send.verFlag );
 112   1              ZhkSerialPutCh( sysVPMission.send.msgType );
 113   1              ZhkSerialPutCh( sysVPMission.send.sn );
 114   1          for( i=0; i<sysVPMission.send.datLen; i++  )
 115   1              {
 116   2                      ZhkSerialPutCh( sysVPMission.send.msg[i] );
 117   2              }
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 3   

 118   1              ZhkSerialPutCh( sysVPMission.send.chk/256 );
 119   1          ZhkSerialPutCh( sysVPMission.send.chk%256 );
 120   1              return 1;
 121   1      }
 122          
 123          
 124          unsigned char VPBusFrameUnPack( void )
 125          {
 126   1              unsigned char data i=0, j=0, k=0, m=0;
 127   1              unsigned char data len = 0;
 128   1              unsigned int  data sum = 0;
 129   1              
 130   1              while( !ZhkSerialIsRxBufNull() )
 131   1              {
 132   2                      for( i=0; i<sizeof( VPMsgBuf )-1; i++ )
 133   2                      {
 134   3                              VPMsgBuf[i] = VPMsgBuf[i+1];
 135   3                      }
 136   2                      VPMsgBuf[sizeof(VPMsgBuf)-1] = ZhkSerialGetCh();
 137   2      #ifdef _DEBUG_TRACE
                              j ++ ;
              #endif
 140   2              }
 141   1      /*
 142   1      #ifdef _DEBUG_TRACE
 143   1              if( j )
 144   1              {
 145   1                      Trace( "\n Bus Return Str = ");
 146   1                      for( j = 0; j < 32; j++ )
 147   1                              Trace( " %02bx", VPMsgBuf[32+j] );
 148   1                      j = 0;
 149   1              }
 150   1      #endif
 151   1      */
 152   1              for( i=0; i<=sizeof(VPMsgBuf)-7; i++ )
 153   1              {
 154   2                  //Check the SF
 155   2                      if( VPMsgBuf[i] != VP_SF ) 
 156   2                              continue;
 157   2                      //DisplayStr( 0, 0, 1, "A1", 2 );  
 158   2                      //WaitForWork(2000,NULL);
 159   2                      //Check the len
 160   2                      len = VPMsgBuf[i+1];
 161   2                      if( !(len >=5) ) 
 162   2                          continue;
 163   2                      //DisplayStr( 0, 0, 1, "A2", 2 );  
 164   2                      //WaitForWork(2000,NULL);
 165   2                      if( i+len+2 > sizeof( VPMsgBuf ) ) 
 166   2                          break;      
 167   2                      //DisplayStr( 0, 0, 1, "A3", 2 );  
 168   2                      //WaitForWork(2000,NULL);
 169   2                      //Check the CHK
 170   2                      sum = 0;
 171   2                      sum = calc_crc(VPMsgBuf + i, len);
 172   2                      if( (VPMsgBuf[i+len] != sum/256)||(VPMsgBuf[i+len+1] != sum%256)        )
 173   2                      {
 174   3                              continue;
 175   3                  }
 176   2                      //DisplayStr( 0, 0, 1, "A4", 2 );  
 177   2                      //WaitForWork(2000,NULL);
 178   2                      //Check the message type
 179   2              if( !((VPMsgBuf[i+3]>=VP_MT_MIN_RECEIVE) && (VPMsgBuf[i+3]<=VP_MT_MAX_RECEIVE)) )   
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 4   

 180   2                  continue;     
 181   2                      //Save the message
 182   2                      sysVPMission.receive.sf      = VPMsgBuf[i];
 183   2                      sysVPMission.receive.len     = VPMsgBuf[i+1];
 184   2              sysVPMission.receive.verFlag = VPMsgBuf[i+2];
 185   2                  sysVPMission.receive.msgType = VPMsgBuf[i+3];
 186   2                      sysVPMission.receive.sn      = VPMsgBuf[i+4];
 187   2              sysVPMission.receive.datLen  = sysVPMission.receive.len - 5;
 188   2                      for( m=0,k=i+5; k<i+5+sysVPMission.receive.datLen; m++,k++)
 189   2                      {
 190   3                              sysVPMission.receive.msg[m] = VPMsgBuf[k];      
 191   3                      }
 192   2                      sysVPMission.receive.chk = sysVPMission.receive.msg[k]*256 + sysVPMission.receive.msg[k+1];
 193   2                      memset( VPMsgBuf, 0, sizeof(VPMsgBuf) );
 194   2      /*
 195   2      #ifdef _DEBUG_TRACE             
 196   2                      Trace( "\n Bus Return Unpack = ");
 197   2                      for( j = 0; j < 32; j++ )
 198   2                              Trace( " %02bx", VPMsgBuf[32+j] );              
 199   2      #endif
 200   2      */       
 201   2                      return 1;
 202   2              }       
 203   1              return 0;
 204   1      }
 205          
 206          /***********************************************************
 207          vmc内部处理都是以分为单位，但是在上传给pc时需要转换
 208          
 209          decimalPlaces=1以角为单位
 210                  例如，需要上传给pc的是200分,
 211                  200*10=2000
 212                  2000/100=20角，即上传20角
 213                  
 214          decimalPlaces=2以分为单位
 215                  例如，需要上传给pc的是200分,
 216                  200*100=20000
 217                  20000/100=200分，即上传200分    
 218          
 219          decimalPlaces=0以元为单位
 220                  例如，需要上传给pc的是200分,
 221                  200=200
 222                  200/100=2元，即上传2元  
 223          ***************************************************************/
 224          u_int   MoneySend(u_int sendMoney)
 225          {
 226   1              u_int tempMoney;
 227   1              
 228   1              //公式2: 上传ScaledValue = ActualValue元/(10-DecimalPlaces次方)
 229   1              if(sysVPMission.decimalPlaces==1)
 230   1              {
 231   2                      //tempMoney = sendMoney*10;
 232   2                      //tempMoney = tempMoney/100;
 233   2                      tempMoney = sendMoney/10;
 234   2              }
 235   1              else if(sysVPMission.decimalPlaces==2)
 236   1              {
 237   2                      tempMoney = sendMoney;
 238   2              }
 239   1              else if(sysVPMission.decimalPlaces==0)
 240   1              {
 241   2                      //tempMoney = sendMoney;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 5   

 242   2                      //tempMoney = tempMoney/100;
 243   2                      tempMoney = sendMoney/100;
 244   2              }
 245   1              //例如:600分=6元
 246   1              return tempMoney;
 247   1      }
 248          u_long   MoneySendInfo(u_long sendMoney)
 249          {
 250   1              u_long tempMoney;
 251   1              
 252   1              //公式2: 上传ScaledValue = ActualValue元/(10-DecimalPlaces次方)
 253   1              if(sysVPMission.decimalPlaces==1)
 254   1              {
 255   2                      //tempMoney = sendMoney*10;
 256   2                      //tempMoney = tempMoney/100;
 257   2                      tempMoney = sendMoney/10;
 258   2              }
 259   1              else if(sysVPMission.decimalPlaces==2)
 260   1              {
 261   2                      tempMoney = sendMoney;
 262   2              }
 263   1              else if(sysVPMission.decimalPlaces==0)
 264   1              {
 265   2                      //tempMoney = sendMoney;
 266   2                      //tempMoney = tempMoney/100;
 267   2                      tempMoney = sendMoney/100;
 268   2              }
 269   1              //例如:600分=6元
 270   1              return tempMoney;
 271   1      }
 272          
 273          /***********************************************************
 274          vmc内部处理都是以分为单位，所以接收pc传下来的数据时需要转换
 275          
 276          decimalPlaces=1以角为单位
 277                  例如，pc下传是20角,
 278                  20*100=2000
 279                  2000/10=200分，即接收200分
 280                  
 281          decimalPlaces=2以分为单位
 282                  例如，pc下传是200分,
 283                  200*100=20000
 284                  20000/100=200分，即接收200分    
 285          
 286          decimalPlaces=0以元为单位
 287                  例如，pc下传是2元,
 288                  2*100=200
 289                  200=200分，即接收200分
 290          ***************************************************************/
 291          u_int   MoneyRec(unsigned char recMoneyH,unsigned char recMoneyL)
 292          {
 293   1              u_int tempMoney;
 294   1              
 295   1              tempMoney = recMoneyH*256+recMoneyL;
 296   1              //公式1:  ActualValue元 =下载ScaledValue*(10-DecimalPlaces次方)
 297   1              if(sysVPMission.decimalPlaces==1)
 298   1              {
 299   2                      //tempMoney = tempMoney*100;
 300   2                      //tempMoney = tempMoney/10;
 301   2                      tempMoney = tempMoney*10;
 302   2              }
 303   1              else if(sysVPMission.decimalPlaces==2)
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 6   

 304   1              {
 305   2                      tempMoney = tempMoney;
 306   2              }
 307   1              else if(sysVPMission.decimalPlaces==0)
 308   1              {
 309   2                      tempMoney = tempMoney*100;
 310   2                      //tempMoney = tempMoney;
 311   2              }
 312   1              //例如:6元=600分        
 313   1              return tempMoney;
 314   1      }
 315          
 316          
 317          unsigned char VPMsgPackSend( unsigned char msgType, unsigned char flag, unsigned char snCtr )
 318          {
 319   1          
 320   1          unsigned char data i=0,j=0;
 321   1          unsigned int data CurrentMoney=0;
 322   1              u_int tempMoney;
 323   1              unsigned char data tempSend=0;
 324   1              u_long tradeMoney=0;
 325   1              //u_char xdata str[20];
 326   1              //u_char xdata len = 0;
 327   1              u_char xdata salei,salej = 0;
 328   1              u_int xdata saleMoney=0;
 329   1      
 330   1              if( !((msgType>=VP_TEXT_MSG)&&(msgType<=VP_MT_MAX_SEND)) )
 331   1                      return VP_ERR_PAR;
 332   1          if( !((flag>=0)&&(flag<=1)) )
 333   1                  return VP_ERR_PAR;
 334   1      
 335   1              switch( msgType )
 336   1              {
 337   2                      case VP_TEXT_MSG:
 338   2                              {
 339   3                              }
 340   2                              break;
 341   2                      case VP_ACK_RPT:
 342   2                  {
 343   3                                      sysVPMission.send.msgType = VP_ACK_RPT;
 344   3                      sysVPMission.send.datLen = 0;
 345   3                              }
 346   2                              break;
 347   2                      case VP_NAK_RPT:
 348   2                          {
 349   3                                      sysVPMission.send.msgType = VP_NAK_RPT;
 350   3                      sysVPMission.send.datLen = 0;
 351   3                              }
 352   2                              break;
 353   2                      case VP_POLL:
 354   2                          {
 355   3                                  sysVPMission.send.msgType = VP_POLL;
 356   3                      sysVPMission.send.datLen = 0;
 357   3                              }
 358   2                              break;
 359   2                      case VP_STARTUP_RPT:
 360   2                              {
 361   3                                      sysVPMission.send.msgType = VP_STARTUP_RPT;
 362   3                                      sysVPMission.send.datLen = 0;
 363   3                              }
 364   2                              break;
 365   2                      //120419 by cq TotalSell
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 7   

 366   2                      /*
 367   2                      case VP_STARTUP_RPT_1:
 368   2                              {
 369   2                                      sysVPMission.send.msgType = VP_STARTUP_RPT_1;
 370   2                                      sysVPMission.send.datLen = 0;
 371   2                              }
 372   2                              break;
 373   2                      */      
 374   2                      case VP_VMC_SETUP:
 375   2                          {
 376   3                                  sysVPMission.send.msgType = VP_VMC_SETUP;
 377   3                      sysVPMission.send.datLen = 10;       //3,5
 378   3                      sysVPMission.send.msg[0] = sysVPMission.columnNumSet;
 379   3                                      sysVPMission.send.msg[1] = sysVPMission.selectionNumSet;                                
 380   3                                      sysVPMission.send.msg[2] = VP_MAC_SET_H;                                
 381   3                                      #ifdef   _SHUPING_
 382   3                                              sysVPMission.send.msg[3] = 10;
 383   3                                      #else
                                      sysVPMission.send.msg[3] = VP_MAC_SET_L;
                                              #endif
 386   3                                      sysVPMission.send.msg[4] = 0x0;
 387   3                                      sysVPMission.send.msg[5] = 0x0;
 388   3                                      sysVPMission.send.msg[6] = 0x0;
 389   3                                      sysVPMission.send.msg[7] = 0x2;
 390   3                                      sysVPMission.send.msg[8] = 0x87;
 391   3                                      sysVPMission.send.msg[9] = 0x07;//0x87; //
 392   3                              }
 393   2                              break;
 394   2                      case VP_PAYIN_RPT:
 395   2                          {
 396   3                                  sysVPMission.send.msgType = VP_PAYIN_RPT;
 397   3                      sysVPMission.send.datLen = 5;      //3,5
 398   3                                      sysVPMission.send.msg[0] = sysVPMission.payInDev;
 399   3                                      tempMoney = MoneySend(sysVPMission.payInMoney);
 400   3                                      sysVPMission.send.msg[1] = tempMoney/256;
 401   3                                      sysVPMission.send.msg[2] = tempMoney%256;
 402   3                                      //PAYIN_RPT协议中末尾添加两个字节
 403   3                      //Total_Value：表示当前交易投币后，或者出货后，屏幕上显示的金额数 
 404   3                                      //by gzz 20110721
 405   3                                      if( sysITLMission.billHoldingFlag == 1 )
 406   3                                      {
 407   4                                              CurrentMoney = CurrentPayed + sysITLMission.billHoldingValue;
 408   4                                      }
 409   3                                      else
 410   3                                      {
 411   4                                              CurrentMoney = CurrentPayed;
 412   4                                      }
 413   3                                      tempMoney = MoneySend(CurrentMoney);
 414   3                      sysVPMission.send.msg[3] = tempMoney/256;
 415   3                      sysVPMission.send.msg[4] = tempMoney%256;
 416   3                              }
 417   2                              break;
 418   2                      case VP_PAYOUT_RPT:
 419   2                          {
 420   3                                  sysVPMission.send.msgType = VP_PAYOUT_RPT;
 421   3                                      sysVPMission.send.datLen = 6;   
 422   3                      sysVPMission.send.msg[0] = sysVPMission.payOutDev;
 423   3                                      tempMoney = MoneySend(sysVPMission.payOutMoney1+sysVPMission.payOutMoney2);
 424   3                                      sysVPMission.send.msg[1] = tempMoney/256;
 425   3                                      sysVPMission.send.msg[2] = tempMoney%256;                               
 426   3                                      //PAYIN_RPT协议中末尾添加两个字节
 427   3                      //Total_Value：表示当前交易投币后，或者出货后，屏幕上显示的金额数 
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 8   

 428   3                                      //by gzz 20110721
 429   3                                      if( sysITLMission.billHoldingFlag == 1 )
 430   3                                      {
 431   4                                              CurrentMoney = CurrentPayed + sysITLMission.billHoldingValue;
 432   4                                      }
 433   3                                      else
 434   3                                      {
 435   4                                              CurrentMoney = CurrentPayed;
 436   4                                      }
 437   3                                      tempMoney = MoneySend(CurrentMoney);
 438   3                      sysVPMission.send.msg[3] = tempMoney/256;
 439   3                      sysVPMission.send.msg[4] = tempMoney%256;
 440   3                                      sysVPMission.send.msg[5] = sysVPMission.changeType;
 441   3                                      sysVPMission.changeType = 0;
 442   3                              }
 443   2                              break;
 444   2              case VP_COST_RPT://扣款操作;by gzz 20110823
 445   2                          {
 446   3                                  sysVPMission.send.msgType = VP_COST_RPT;
 447   3                                      sysVPMission.send.datLen = 6;   
 448   3                      sysVPMission.send.msg[0] = sysVPMission.costDev;
 449   3                                      tempMoney = MoneySend(sysVPMission.costMoney);
 450   3                                      sysVPMission.send.msg[1] = tempMoney/256;
 451   3                                      sysVPMission.send.msg[2] = tempMoney%256;                 
 452   3                                      //PAYIN_RPT协议中末尾添加两个字节
 453   3                      //Total_Value：表示当前交易投币后，或者出货后，屏幕上显示的金额数 
 454   3                                      //by gzz 20110721
 455   3                                      if( sysITLMission.billHoldingFlag == 1 )
 456   3                                      {
 457   4                                              CurrentMoney = CurrentPayed + sysITLMission.billHoldingValue;
 458   4                                      }
 459   3                                      else
 460   3                                      {
 461   4                                              CurrentMoney = CurrentPayed;
 462   4                                      }
 463   3                                      tempMoney = MoneySend(CurrentMoney);
 464   3                      sysVPMission.send.msg[3] = tempMoney/256;
 465   3                      sysVPMission.send.msg[4] = tempMoney%256;
 466   3                                      sysVPMission.send.msg[5] = sysVPMission.costType;
 467   3                                      sysVPMission.costType = 0;
 468   3                              }
 469   2                              break;
 470   2                              /*
 471   2                      case VP_DEBT_RPT://上报欠条操作;by gzz 20110825
 472   2                          {
 473   2                                  sysVPMission.send.msgType = VP_DEBT_RPT;
 474   2                                      sysVPMission.send.datLen = 4;   
 475   2                      sysVPMission.send.msg[0] = sysVPMission.debtType;
 476   2                                      sysVPMission.send.msg[1] = sysVPMission.debtDev;
 477   2                                      sysVPMission.send.msg[2] = sysVPMission.debtMoney/256;
 478   2                                      sysVPMission.send.msg[3] = sysVPMission.debtMoney%256;   
 479   2                              }
 480   2                              break;  */              
 481   2                      case VP_VENDOUT_RPT:
 482   2                          {
 483   3                                      sysVPMission.send.msgType = VP_VENDOUT_RPT;
 484   3                      sysVPMission.send.datLen = 9;
 485   3                                      sysVPMission.send.msg[0] = 0;
 486   3                                      sysVPMission.send.msg[1] = sysVPMission.vendSta;
 487   3                                      sysVPMission.send.msg[2] = sysVPMission.vendColumn;
 488   3                                      sysVPMission.send.msg[3] = sysVPMission.vendType;
 489   3                                      tempMoney = MoneySend(sysVPMission.vendCost);
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 9   

 490   3                                      sysVPMission.send.msg[4] = tempMoney/256;
 491   3                                      sysVPMission.send.msg[5] = tempMoney%256;
 492   3                                      //PAYIN_RPT协议中末尾添加两个字节
 493   3                      //Total_Value：表示当前交易投币后，或者出货后，屏幕上显示的金额数 
 494   3                                      //by gzz 20110721
 495   3                                      if( sysITLMission.billHoldingFlag == 1 )
 496   3                                      {
 497   4                                              CurrentMoney = CurrentPayed + sysITLMission.billHoldingValue;
 498   4                                      }
 499   3                                      else
 500   3                                      {
 501   4                                              CurrentMoney = CurrentPayed;
 502   4                                      }
 503   3                                      tempMoney = MoneySend(CurrentMoney);
 504   3                      sysVPMission.send.msg[6] = tempMoney/256;
 505   3                      sysVPMission.send.msg[7] = tempMoney%256;
 506   3                                      sysVPMission.send.msg[8] = sysVPMission.vendcolumnLeft;
 507   3                              }
 508   2                              break;
 509   2                      case VP_REQUEST: 
 510   2                  {
 511   3                                      sysVPMission.send.msgType = VP_REQUEST;
 512   3                                      sysVPMission.send.datLen = 1;
 513   3                                      sysVPMission.send.msg[0] = sysVPMission.request;
 514   3                              }
 515   2                              break;
 516   2                      case VP_ADMIN_RPT:
 517   2                          {
 518   3                                  sysVPMission.send.msgType =  VP_ADMIN_RPT;
 519   3      
 520   3                                      if( sysVPMission.ADM_Type == VP_ADMIN_COL_PRICE )
 521   3                                      {
 522   4                                          sysVPMission.send.datLen = 4;
 523   4                                              sysVPMission.send.msg[0] = sysVPMission.ADM_Type;
 524   4                                              sysVPMission.send.msg[1] = sysVPMission.ADM_Dat[0];
 525   4                                              sysVPMission.send.msg[2] = sysVPMission.ADM_Dat[1];     
 526   4                          sysVPMission.send.msg[3] = sysVPMission.ADM_Dat[2]; 
 527   4                                      }
 528   3                                      else if( sysVPMission.ADM_Type == VP_ADMIN_GOODSADDCOL )
 529   3                                      {
 530   4                                              sysVPMission.send.datLen = 3;
 531   4                                              sysVPMission.send.msg[0] = sysVPMission.ADM_Type;
 532   4                                              sysVPMission.send.msg[1] = sysVPMission.ADM_Dat[0];
 533   4                                              sysVPMission.send.msg[2] = sysVPMission.ADM_Dat[1];
 534   4                                      }
 535   3                      else if( sysVPMission.ADM_Type == VP_ADMIN_GOODSBUHUO )
 536   3                                      {
 537   4                                              sysVPMission.send.datLen = 1;
 538   4                                              sysVPMission.send.msg[0] = sysVPMission.ADM_Type;
 539   4                                              //sysVPMission.send.msg[1] = sysVPMission.ADM_Dat[0];
 540   4                                              //sysVPMission.send.msg[2] = sysVPMission.ADM_Dat[1];
 541   4                                      }
 542   3                                      else if( sysVPMission.ADM_Type == VP_ADMIN_GOODSADDTRAY ) //Add the tray's goods
 543   3                                      {
 544   4                                          sysVPMission.send.datLen = 2;
 545   4                                              sysVPMission.send.msg[0] = sysVPMission.ADM_Type;
 546   4                                              sysVPMission.send.msg[1] = sysVPMission.ADM_Dat[0];
 547   4                                      }
 548   3                                      else  //Add all columns' goods, chage, get bill
 549   3                                      {
 550   4                                          sysVPMission.send.datLen = 1;
 551   4                                              sysVPMission.send.msg[0] = sysVPMission.ADM_Type;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 10  

 552   4                                      }
 553   3                                      
 554   3                              }
 555   2                              break;
 556   2              case VP_ACTION_RPT:                 
 557   2                              sysVPMission.send.msgType = VP_ACTION_RPT;      
 558   2                              if( (sysVPMission.ACT_Type==VP_ACT_HEART)||(sysVPMission.ACT_Type==VP_ACT_ONLINE) )
 559   2                              {
 560   3                                      sysVPMission.send.datLen = 1;
 561   3                                      sysVPMission.send.msg[0] = sysVPMission.ACT_Type;
 562   3                              }
 563   2                              else if(sysVPMission.ACT_Type==VP_ACT_ADMIN)
 564   2                              {
 565   3                                      sysVPMission.send.datLen = 2;
 566   3                                      sysVPMission.send.msg[0] = sysVPMission.ACT_Type;
 567   3                                      sysVPMission.send.msg[1] = sysVPMission.ACT_Value;
 568   3                              }       
 569   2                              else if(sysVPMission.ACT_Type==VP_ACT_CHUHUO)
 570   2                              {
 571   3                                      sysVPMission.send.datLen = 8;
 572   3                                      sysVPMission.send.msg[0] = sysVPMission.ACT_Type;
 573   3                                      sysVPMission.send.msg[1] = 5;
 574   3                                      sysVPMission.send.msg[2] = sysVPMission.vendColumn+1;
 575   3                                      sysVPMission.send.msg[3] = sysVPMission.vendType;
 576   3                                      tempMoney = MoneySend(sysVPMission.vendCost);
 577   3                                      sysVPMission.send.msg[4] = tempMoney/256;
 578   3                                      sysVPMission.send.msg[5] = tempMoney%256;
 579   3                                      //PAYIN_RPT协议中末尾添加两个字节
 580   3                      //Total_Value：表示当前交易投币后，或者出货后，屏幕上显示的金额数 
 581   3                                      //by gzz 20110721
 582   3                                      if( sysITLMission.billHoldingFlag == 1 )
 583   3                                      {
 584   4                                              CurrentMoney = CurrentPayed + sysITLMission.billHoldingValue;
 585   4                                      }
 586   3                                      else
 587   3                                      {
 588   4                                              CurrentMoney = CurrentPayed;
 589   4                                      }
 590   3                                      tempMoney = MoneySend(CurrentMoney);
 591   3                      sysVPMission.send.msg[6] = tempMoney/256;
 592   3                      sysVPMission.send.msg[7] = tempMoney%256;
 593   3                              }
 594   2                              else if(sysVPMission.ACT_Type==VP_ACT_PAYOUT)
 595   2                              {
 596   3                                      sysVPMission.send.datLen = 7;
 597   3                                      sysVPMission.send.msg[0] = sysVPMission.ACT_Type;
 598   3                                      sysVPMission.send.msg[1] = CurrentDispenseCoin/50/2+1;                          
 599   3                                      tempMoney = MoneySend(CurrentDispenseCoin);
 600   3                                      sysVPMission.send.msg[2] = tempMoney/256;
 601   3                                      sysVPMission.send.msg[3] = tempMoney%256;
 602   3                                      //PAYIN_RPT协议中末尾添加两个字节 
 603   3                                      //Total_Value：表示当前交易投币后，或者出货后，屏幕上显示的金额数 
 604   3                                      //by gzz 20110721
 605   3                                      if( sysITLMission.billHoldingFlag == 1 )
 606   3                                      {
 607   4                                              CurrentMoney = CurrentPayed + sysITLMission.billHoldingValue;
 608   4                                      }
 609   3                                      else
 610   3                                      {
 611   4                                              CurrentMoney = CurrentPayed;
 612   4                                      }
 613   3                                      if(CurrentMoney)
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 11  

 614   3                                              tempMoney = MoneySend(CurrentMoney);
 615   3                                      else
 616   3                                              tempMoney = MoneySend(CurrentDispenseCoin);
 617   3                                      sysVPMission.send.msg[4] = tempMoney/256;
 618   3                                      sysVPMission.send.msg[5] = tempMoney%256;                               
 619   3                      sysVPMission.send.msg[6] = sysVPMission.changeType;
 620   3                              }       
 621   2                              break;
 622   2              case VP_BUTTON_RPT:                 
 623   2                              sysVPMission.send.msgType = VP_BUTTON_RPT;
 624   2                              if(sysVPMission.BUT_Type==VP_BUT_GOODS)
 625   2                              {
 626   3                                      sysVPMission.send.datLen = 3;
 627   3                                      sysVPMission.send.msg[0] = sysVPMission.BUT_Type;
 628   3                                      sysVPMission.send.msg[1] = 0;
 629   3                                      sysVPMission.send.msg[2] = sysVPMission.BUT_Value;
 630   3                              }
 631   2                              else if(sysVPMission.BUT_Type==VP_BUT_GAME)
 632   2                              {
 633   3                                      sysVPMission.send.datLen = 2;
 634   3                                      sysVPMission.send.msg[0] = sysVPMission.BUT_Type;
 635   3                                      sysVPMission.send.msg[1] = sysVPMission.BUT_Value;
 636   3                              }       
 637   2                              else if(sysVPMission.BUT_Type==VP_BUT_RETURN)
 638   2                              {
 639   3                                      sysVPMission.send.datLen = 2;
 640   3                                      sysVPMission.send.msg[0] = sysVPMission.BUT_Type;
 641   3                                      sysVPMission.send.msg[1] = sysVPMission.BUT_Value;
 642   3                              }       
 643   2                              break;
 644   2                      case VP_STATUS_RPT:
 645   2                          {
 646   3                                  sysVPMission.send.msgType = VP_STATUS_RPT;
 647   3                      //sysVPMission.send.datLen  = 15;
 648   3                                      sysVPMission.send.datLen  = 16;
 649   3      
 650   3                                      tempSend |= sysVPMission.STA_VMC;
 651   3                                      tempSend |= sysVPMission.STA_CoinA<<2;
 652   3                                      tempSend |= sysVPMission.STA_BillA<<4;
 653   3                                      tempSend |= sysVPMission.STA_ICCard<<6;                         
 654   3                                      sysVPMission.send.msg[0]  = tempSend;
 655   3                                      #ifdef   _SHUPING_
 656   3                                              tempSend = 0xff;
 657   3                                      #else
                                                      tempSend = 0;
                                                      tempSend |= sysVPMission.STA_Tep1;
                                                      tempSend |= sysVPMission.STA_Tep2<<2;
                                                      tempSend |= sysVPMission.STA_Tep3<<4;                                   
                                              #endif
 663   3                                      sysVPMission.send.msg[1]  = tempSend;
 664   3                                      
 665   3                                      tempMoney = MoneySend(sysMDBMission.coinAllValue);
 666   3                      sysVPMission.send.msg[2] = tempMoney/256;
 667   3                      sysVPMission.send.msg[3] = tempMoney%256;
 668   3                                      
 669   3                                      sysVPMission.send.msg[4]  = sysVPMission.E_Tem1;
 670   3                                      sysVPMission.send.msg[5]  = sysVPMission.E_Tem2;
 671   3                                      sysVPMission.send.msg[6]  = sysVPMission.E_Tem2;
 672   3                                      sysVPMission.send.msg[7]  = sysVPMission.E_Tem2;
 673   3                                      
 674   3                                      tempSend = 0;
 675   3                                      tempSend |= sysVPMission.ESTA_Tem1;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 12  

 676   3                                      tempSend |= sysVPMission.ESTA_Tem2<<2;
 677   3                                      tempSend |= sysVPMission.ESTA_Tem2<<4;
 678   3                                      tempSend |= sysVPMission.ESTA_Tem2<<6;  
 679   3                                      sysVPMission.send.msg[8]  = tempSend;
 680   3                                      
 681   3                                      sysVPMission.send.msg[9]  = sysVPMission.Payout_Time;
 682   3                                      
 683   3                                      sysVPMission.send.msg[10] = sysVPMission.STA_ChangeNum1;
 684   3                                      sysVPMission.send.msg[11] = sysVPMission.STA_ChangeNum2;
 685   3                                      sysVPMission.send.msg[12] = 0;
 686   3                                      sysVPMission.send.msg[13] = 0;
 687   3                                      sysVPMission.send.msg[14] = 0;
 688   3                                      sysVPMission.send.msg[15] = 0;                          
 689   3                              }
 690   2                              break;
 691   2              case VP_HUODAO_RPT:
 692   2                  {
 693   3                      sysVPMission.send.msgType = VP_HUODAO_RPT;
 694   3                      sysVPMission.send.datLen  = COLUMN_NUM_SET+1;    
 695   3                                      sysVPMission.send.msg[0]  = 0;
 696   3                      //
 697   3                  }
 698   2                  break;
 699   2              case VP_CARD_RPT:
 700   2                  {
 701   3                      sysVPMission.send.msgType = VP_CARD_RPT;  
 702   3                      sysVPMission.send.datLen  = sysBCMission.msgLen + 1;
 703   3                      sysVPMission.send.msg[0]  = 1;       
 704   3                      for( i=0; i<sysBCMission.msgLen; i++ )
 705   3                      {
 706   4                              sysVPMission.send.msg[i+1] = sysBCMission.msgBuf[i];    
 707   4                      }
 708   3                  }
 709   2                  break;
 710   2                      case VP_INFO_RPT://120419 by cq TotalSell 
 711   2                              {
 712   3                      sysVPMission.send.msgType = VP_INFO_RPT;  
 713   3                                      switch(sysVPMission.infoType)
 714   3                                      {
 715   4                                              case VP_INFO_TOTALVALUE:
 716   4                                                      sysVPMission.send.datLen  = 3;
 717   4                                                      sysVPMission.send.msg[0]  = VP_INFO_TOTALVALUE;
 718   4                                                      //Total_Value：表示当前交易投币后，或者出货后，屏幕上显示的金额数 
 719   4                                                      //by gzz 20110721
 720   4                                                      if( sysITLMission.billHoldingFlag == 1 )
 721   4                                                      {
 722   5                                                              CurrentMoney = CurrentPayed + sysITLMission.billHoldingValue;
 723   5                                                      }
 724   4                                                      else
 725   4                                                      {
 726   5                                                              CurrentMoney = CurrentPayed;
 727   5                                                      }
 728   4                                                      tempMoney = MoneySend(CurrentMoney);
 729   4                                                      //tempMoney = CurrentMoney;
 730   4                                      sysVPMission.send.msg[1] = tempMoney/256;
 731   4                                      sysVPMission.send.msg[2] = tempMoney%256;
 732   4                                                      break;
 733   4                                              case VP_INFO_CHUHUO:
 734   4                                                      sysVPMission.send.datLen  = 53;
 735   4                                                      sysVPMission.send.msg[0]  = VP_INFO_CHUHUO;
 736   4                                                      //全部出货数量
 737   4                                                      sysVPMission.send.msg[1]  = H0UINT32(TradeCounter.vpSuccessNum);       
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 13  

 738   4                                      sysVPMission.send.msg[2]  = H1UINT32(TradeCounter.vpSuccessNum);        
 739   4                                      sysVPMission.send.msg[3]  = L0UINT32(TradeCounter.vpSuccessNum);        
 740   4                                      sysVPMission.send.msg[4]  = L1UINT32(TradeCounter.vpSuccessNum);   
 741   4                                                      //全部出货金额                                          
 742   4                                                      //tradeMoney = MoneySendInfo(TradeCounter.vpSuccessMoney); 
 743   4                                                      //tradeMoney = TradeCounter.vpSuccessMoney; 
 744   4                                                      sysVPMission.send.msg[5]  = H0UINT32(TradeCounter.vpSuccessMoney);       
 745   4                                                      sysVPMission.send.msg[6]  = H1UINT32(TradeCounter.vpSuccessMoney);       
 746   4                                                      sysVPMission.send.msg[7]  = L0UINT32(TradeCounter.vpSuccessMoney);       
 747   4                                                      sysVPMission.send.msg[8]  = L1UINT32(TradeCounter.vpSuccessMoney);  
 748   4                                                      
 749   4                                                      //tradeMoney = MoneySendInfo(TradeCounter.vpSuccessMoney); 
 750   4                                                      //sysVPMission.send.msg[5]  = tradeMoney/256/256/256;            
 751   4                                                      //sysVPMission.send.msg[6]  = tradeMoney/256/256%256;            
 752   4                                                      //sysVPMission.send.msg[7]  = tradeMoney/256%256;                
 753   4                                                      //sysVPMission.send.msg[8]  = tradeMoney%256;
 754   4                                                      //len = sprintf( str, "%ld,%ld,%u,%u", TradeCounter.vpSuccessMoney, tradeMoney,sysVPMission.send.msg
             -[7],sysVPMission.send.msg[8] );
 755   4                                                      //DisplayStr( 0, 0, 1, str, len );
 756   4                                                      //len = sprintf( str, "%u,%u", tradeMoney/256%256, tradeMoney%256 );
 757   4                                                      //DisplayStr( 0, 1, 1, str, len );
 758   4                                                      //WaitForWork( 5000, NULL );
 759   4      
 760   4                                                      //现金出货数量
 761   4                                                      sysVPMission.send.msg[9]  = H0UINT32(TradeCounter.vpCashNum);    
 762   4                                                      sysVPMission.send.msg[10]  = H1UINT32(TradeCounter.vpCashNum);           
 763   4                                                      sysVPMission.send.msg[11]  = L0UINT32(TradeCounter.vpCashNum);                   
 764   4                                                      sysVPMission.send.msg[12]  = L1UINT32(TradeCounter.vpCashNum);  
 765   4                                                      //现金出货金额  
 766   4                                                      //tradeMoney = MoneySendInfo(TradeCounter.vpCashMoney); 
 767   4                                                      //tradeMoney = TradeCounter.vpCashMoney; 
 768   4                                                      sysVPMission.send.msg[13]  = H0UINT32(TradeCounter.vpCashMoney);                 
 769   4                                                      sysVPMission.send.msg[14]  = H1UINT32(TradeCounter.vpCashMoney);         
 770   4                                                      sysVPMission.send.msg[15]  = L0UINT32(TradeCounter.vpCashMoney);         
 771   4                                                      sysVPMission.send.msg[16]  = L1UINT32(TradeCounter.vpCashMoney); 
 772   4                                                      //游戏出货数量          
 773   4                                                      sysVPMission.send.msg[17]  = H0UINT32(TradeCounter.vpGameNum); 
 774   4                                                      sysVPMission.send.msg[18]  = H1UINT32(TradeCounter.vpGameNum);   
 775   4                                                      sysVPMission.send.msg[19]  = L0UINT32(TradeCounter.vpGameNum);           
 776   4                                                      sysVPMission.send.msg[20]  = L1UINT32(TradeCounter.vpGameNum); 
 777   4                                                      //游戏出货金额
 778   4                                                      tradeMoney = 0; 
 779   4                                                      sysVPMission.send.msg[21]  = tradeMoney;         
 780   4                                                      sysVPMission.send.msg[22]  = tradeMoney;         
 781   4                                                      sysVPMission.send.msg[23]  = tradeMoney;         
 782   4                                                      sysVPMission.send.msg[24]  = tradeMoney; 
 783   4                                                      //刷卡出货数量
 784   4                                                      sysVPMission.send.msg[25]  = H0UINT32(TradeCounter.vpCardNum);           
 785   4                                                      sysVPMission.send.msg[26]  = H1UINT32(TradeCounter.vpCardNum);                   
 786   4                                                      sysVPMission.send.msg[27]  = L0UINT32(TradeCounter.vpCardNum);                   
 787   4                                                      sysVPMission.send.msg[28]  = L1UINT32(TradeCounter.vpCardNum);   
 788   4                                                      //刷卡出货金额
 789   4                                                      tradeMoney =0; 
 790   4                                                      sysVPMission.send.msg[29]  = tradeMoney;         
 791   4                                                      sysVPMission.send.msg[30]  = tradeMoney;         
 792   4                                                      sysVPMission.send.msg[31]  = tradeMoney;         
 793   4                                                      sysVPMission.send.msg[32]  = tradeMoney;
 794   4                                                      //在线出货数量
 795   4                                                      sysVPMission.send.msg[33]  = H0UINT32(TradeCounter.vpOnlineNum);         
 796   4                                                      sysVPMission.send.msg[34]  = H1UINT32(TradeCounter.vpOnlineNum);         
 797   4                                                      sysVPMission.send.msg[35]  = L0UINT32(TradeCounter.vpOnlineNum);                         
 798   4                                                      sysVPMission.send.msg[36]  = L1UINT32(TradeCounter.vpOnlineNum);         
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 14  

 799   4                                                      //在线出货金额
 800   4                                                      tradeMoney = 0; 
 801   4                                                      sysVPMission.send.msg[37]  = tradeMoney;         
 802   4                                                      sysVPMission.send.msg[38]  = tradeMoney;         
 803   4                                                      sysVPMission.send.msg[39]  = tradeMoney;         
 804   4                                                      sysVPMission.send.msg[40]  = tradeMoney;
 805   4                                                      //硬币投入
 806   4                                                      //tradeMoney = MoneySendInfo(TradeCounter.CoinSum1y+TradeCounter.CoinSum5j); 
 807   4                                                      tradeMoney = (TradeCounter.CoinSum1y+TradeCounter.CoinSum5j); 
 808   4                                                      sysVPMission.send.msg[41]  = H0UINT32(tradeMoney);               
 809   4                                                      sysVPMission.send.msg[42]  = H1UINT32(tradeMoney);       
 810   4                                                      sysVPMission.send.msg[43]  = L0UINT32(tradeMoney);               
 811   4                                                      sysVPMission.send.msg[44]  = L1UINT32(tradeMoney);      
 812   4                                                      //纸币投入
 813   4                                                      //tradeMoney = MoneySendInfo(TradeCounter.CashSum); 
 814   4                                                      //tradeMoney = TradeCounter.CashSum; 
 815   4                                                      sysVPMission.send.msg[45]  = H0UINT32(TradeCounter.CashSum);      
 816   4                                                      sysVPMission.send.msg[46]  = H1UINT32(TradeCounter.CashSum);     
 817   4                                                      sysVPMission.send.msg[47]  = L0UINT32(TradeCounter.CashSum);     
 818   4                                                      sysVPMission.send.msg[48]  = L1UINT32(TradeCounter.CashSum);
 819   4                                                      //硬币出币
 820   4                                                      //tradeMoney = MoneySendInfo(TradeCounter.Hopper2Sum+TradeCounter.Hopper1Sum); 
 821   4                                                      tradeMoney = TradeCounter.Hopper2Sum+TradeCounter.Hopper1Sum; 
 822   4                                                      sysVPMission.send.msg[49]  = H0UINT32(tradeMoney);       
 823   4                                                      sysVPMission.send.msg[50]  = H1UINT32(tradeMoney);       
 824   4                                                      sysVPMission.send.msg[51]  = L0UINT32(tradeMoney);       
 825   4                                                      sysVPMission.send.msg[52]  = L1UINT32(tradeMoney);
 826   4                                                      break;
 827   4                                              case VP_INFO_HUODAO:
 828   4                                                      sysVPMission.send.datLen  = COLUMN_NUM_SET + 2;
 829   4                                                      sysVPMission.send.msg[0]  = VP_INFO_HUODAO;
 830   4                                                      sysVPMission.send.msg[1]  = 0; 
 831   4                                                      for( i=0; i<COLUMN_NUM_SET; i++ )
 832   4                                                      {
 833   5                                                              sysVPMission.send.msg[i+2]  = GoodsWaySetVal[i].GoodsType;
 834   5                                                      }
 835   4                                                      break;
 836   4                                              case VP_INFO_POSITION:
 837   4                                                      sysVPMission.send.datLen  = GOODSTYPEMAX + 2;
 838   4                                                      sysVPMission.send.msg[0]  = VP_INFO_POSITION;
 839   4                                                      sysVPMission.send.msg[1]  = 0; 
 840   4                                                      for( i=0; i<GOODSTYPEMAX; i++)
 841   4                                                      {
 842   5                                                              //sysVPMission.send.msg[i+2] = sysVPMission.selItem[i];
 843   5                                                              sysVPMission.send.msg[i+2] = SystemParameter.selItem[i];
 844   5                                                      }
 845   4                                                      break;
 846   4                                              case VP_INFO_SALEPRICE:
 847   4                                                      sysVPMission.send.datLen  = sysVPMission.GoodsRev*2+2;
 848   4                                                      sysVPMission.send.msg[0]  = VP_INFO_SALEPRICE;
 849   4                                                      sysVPMission.send.msg[1]  = 0;                                          
 850   4                                                      
 851   4                                                      /*for( i=0,j=2; i<4;  i++,j+=2 )
 852   4                                                      {
 853   4                                                              //tempMoney = sysGoodsMatrix[i].Price;
 854   4                                                              //tempMoney = GoodsWaySetVal[i].Price;
 855   4                                                              //tempMoney = MoneySend(sysVPMission.selPrice[i]);
 856   4                                                              tempMoney = MoneySend(sysGoodsMatrix[i].Price);
 857   4                                                              sysVPMission.send.msg[j]  = HUINT16(tempMoney);          
 858   4                                                              sysVPMission.send.msg[j+1]  = LUINT16(tempMoney);
 859   4                                                      }       */
 860   4                                                      for( salei=0,salej=2; salei<sysVPMission.GoodsRev;  salei++,salej+=2 )
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 15  

 861   4                                                      {
 862   5                                                              saleMoney = (sysVPMission.selPrice[salei]%10==0)?sysVPMission.selPrice[salei]:Price[salei];
 863   5                                                              tempMoney = MoneySend(saleMoney);
 864   5                                                              sysVPMission.send.msg[salej]  = HUINT16(tempMoney);      
 865   5                                                              sysVPMission.send.msg[salej+1]  = LUINT16(tempMoney);
 866   5                                                              //len = sprintf( str, "%02d=%02d,%02d", tempMoney,sysGoodsMatrix[salei].Price,sysVPMission.selPrice
             -[salei]);                                                
 867   5                                                              //DisplayStr( 0, 0, 1, str, len );
 868   5                                                              //WaitForWork( 5000, NULL );                                                    
 869   5                                                      }                                               
 870   4                                                      break;
 871   4                                              case VP_INFO_VMC:
 872   4                                                      sysVPMission.send.datLen  = 4;
 873   4                                                      sysVPMission.send.msg[0]  = VP_INFO_VMC;
 874   4                                                      sysVPMission.send.msg[1]  = 0; 
 875   4                                                      sysVPMission.send.msg[2]  = 0; 
 876   4                                                      sysVPMission.send.msg[3]  = COLUMN_NUM_SET + 1;
 877   4                                                      break;
 878   4                                              case VP_INFO_VER:
 879   4                                                      sysVPMission.send.datLen  = 31;
 880   4                                                      sysVPMission.send.msg[0]  = VP_INFO_VER;
 881   4                                                      // unpeng-zonghe-1.0(2012-11-07)
 882   4                                                      sysVPMission.send.msg[1]  = 'J';         
 883   4                                                      sysVPMission.send.msg[2]  = 'u';         
 884   4                                                      sysVPMission.send.msg[3]  = 'n';         
 885   4                                                      sysVPMission.send.msg[4]  = 'p';
 886   4                                                      sysVPMission.send.msg[5]  = 'e';         
 887   4                                                      sysVPMission.send.msg[6]  = 'n';         
 888   4                                                      sysVPMission.send.msg[7]  = 'g';         
 889   4                                                      sysVPMission.send.msg[8]  = '-';
 890   4                                                      sysVPMission.send.msg[9]  = 'z';         
 891   4                                                      sysVPMission.send.msg[10]  = 'o';        
 892   4                                                      sysVPMission.send.msg[11]  = 'n';
 893   4                                                      sysVPMission.send.msg[12]  = 'g';        
 894   4                                                      sysVPMission.send.msg[13]  = 'h';        
 895   4                                                      sysVPMission.send.msg[14]  = 'e';        
 896   4                                                      sysVPMission.send.msg[15]  = '-';
 897   4                                                      sysVPMission.send.msg[16]  = '1';        
 898   4                                                      sysVPMission.send.msg[17]  = '.';        
 899   4                                                      sysVPMission.send.msg[18]  = '0';
 900   4                                                      sysVPMission.send.msg[19]  = '(';        
 901   4                                                      sysVPMission.send.msg[20]  = '2';        
 902   4                                                      sysVPMission.send.msg[21]  = '0';        
 903   4                                                      sysVPMission.send.msg[22]  = '1';
 904   4                                                      sysVPMission.send.msg[23]  = '4';        
 905   4                                                      sysVPMission.send.msg[24]  = '-';        
 906   4                                                      sysVPMission.send.msg[25]  = '0';
 907   4                                                      sysVPMission.send.msg[26]  = '9';        
 908   4                                                      sysVPMission.send.msg[27]  = '-';        
 909   4                                                      sysVPMission.send.msg[28]  = '2';        
 910   4                                                      sysVPMission.send.msg[29]  = '2';
 911   4                                                      sysVPMission.send.msg[30]  = ')';
 912   4                                                      break;
 913   4                                              case VP_INFO_HARD:
 914   4                                                      sysVPMission.send.datLen  = 8;
 915   4                                                      sysVPMission.send.msg[0]  = VP_INFO_HARD;
 916   4                                                      sysVPMission.send.msg[1]  = 'p';         
 917   4                                                      sysVPMission.send.msg[2]  = '8';         
 918   4                                                      sysVPMission.send.msg[3]  = '9';         
 919   4                                                      sysVPMission.send.msg[4]  = 'c';
 920   4                                                      sysVPMission.send.msg[5]  = '6';         
 921   4                                                      sysVPMission.send.msg[6]  = '6';         
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 16  

 922   4                                                      sysVPMission.send.msg[7]  = '9';         
 923   4                                                      break;
 924   4                                              case VP_INFO_BILL:
 925   4                                                      sysVPMission.send.datLen  = 19+33;
 926   4                                                      sysVPMission.send.msg[0]  = VP_INFO_BILL;
 927   4                                                      sysVPMission.send.msg[1]  = sysMDBMission.Pc_billBuf[0];
 928   4                                                      sysVPMission.send.msg[2]  = sysMDBMission.Pc_billBuf[1];         
 929   4                                                      sysVPMission.send.msg[3]  = sysMDBMission.Pc_billBuf[2];         
 930   4                                                      sysVPMission.send.msg[4]  = sysMDBMission.Pc_billBuf[3];        
 931   4                                                      sysVPMission.send.msg[5]  = sysMDBMission.Pc_billBuf[4];                 
 932   4                                                      sysVPMission.send.msg[6]  = sysMDBMission.Pc_billBuf[5];         
 933   4                                                      sysVPMission.send.msg[7]  = sysMDBMission.Pc_billBuf[6];  
 934   4                                                      sysVPMission.send.msg[8]  = sysMDBMission.Pc_billBuf[7]; 
 935   4                                                      sysVPMission.send.msg[9]  = sysMDBMission.Pc_billBuf[8];         
 936   4                                                      sysVPMission.send.msg[10]  = sysMDBMission.Pc_billBuf[10];       
 937   4                                                      sysVPMission.send.msg[11]  = sysMDBMission.Pc_billBuf[11];
 938   4                                                      sysVPMission.send.msg[12]  = sysMDBMission.Pc_billBuf[12];       
 939   4                                                      sysVPMission.send.msg[13]  = sysMDBMission.Pc_billBuf[13];       
 940   4                                                      sysVPMission.send.msg[14]  = sysMDBMission.Pc_billBuf[14];       
 941   4                                                      sysVPMission.send.msg[15]  = sysMDBMission.Pc_billBuf[15];
 942   4                                                      sysVPMission.send.msg[16]  = sysMDBMission.Pc_billBuf[16];      
 943   4                                                      sysVPMission.send.msg[17]  = sysMDBMission.Pc_billBuf[17];
 944   4                                                      sysVPMission.send.msg[18]  = sysMDBMission.Pc_billBuf[18];
 945   4                                                      for(i=0;i<33;i++)
 946   4                                                      {
 947   5                                                              sysVPMission.send.msg[19+i]  = sysMDBMission.billIDENTITYBuf[i];
 948   5                                                      }
 949   4                                                      break;
 950   4                                              case VP_INFO_COIN:
 951   4                                                      sysVPMission.send.datLen  = 18+33;
 952   4                                                      sysVPMission.send.msg[0]  = VP_INFO_COIN;
 953   4                                                      sysVPMission.send.msg[1]  = sysMDBMission.Pc_coinBuf[0];
 954   4                                                      sysVPMission.send.msg[2]  = sysMDBMission.Pc_coinBuf[1];         
 955   4                                                      sysVPMission.send.msg[3]  = sysMDBMission.Pc_coinBuf[2];         
 956   4                                                      sysVPMission.send.msg[4]  = sysMDBMission.Pc_coinBuf[3];        
 957   4                                                      sysVPMission.send.msg[5]  = sysMDBMission.Pc_coinBuf[4];                 
 958   4                                                      sysVPMission.send.msg[6]  = sysMDBMission.Pc_coinBuf[7];         
 959   4                                                      sysVPMission.send.msg[7]  = sysMDBMission.Pc_coinBuf[8];  
 960   4                                                      sysVPMission.send.msg[8]  = sysMDBMission.Pc_coinBuf[9]; 
 961   4                                                      sysVPMission.send.msg[9]  = sysMDBMission.Pc_coinBuf[10];        
 962   4                                                      sysVPMission.send.msg[10]  = sysMDBMission.Pc_coinBuf[11];       
 963   4                                                      sysVPMission.send.msg[11]  = sysMDBMission.Pc_coinBuf[12];
 964   4                                                      sysVPMission.send.msg[12]  = sysMDBMission.Pc_coinBuf[7];        
 965   4                                                      sysVPMission.send.msg[13]  = sysMDBMission.Pc_coinBuf[8];        
 966   4                                                      sysVPMission.send.msg[14]  = sysMDBMission.Pc_coinBuf[9];        
 967   4                                                      sysVPMission.send.msg[15]  = sysMDBMission.Pc_coinBuf[10];
 968   4                                                      sysVPMission.send.msg[16]  = sysMDBMission.Pc_coinBuf[11];      
 969   4                                                      sysVPMission.send.msg[17]  = sysMDBMission.Pc_coinBuf[12];
 970   4                                                      for(i=0;i<33;i++)
 971   4                                                      {
 972   5                                                              sysVPMission.send.msg[18+i]  = sysMDBMission.coinIDENTITYBuf[i];
 973   5                                                      }
 974   4                                                      break;
 975   4                                              case VP_INFO_COMP:
 976   4                                                      sysVPMission.send.datLen  = 1;
 977   4                                                      sysVPMission.send.msg[0]  = VP_INFO_COMP;
 978   4                                                      break;
 979   4                                              case VP_INFO_ERR:
 980   4                                                      {       
 981   5                                                              //sysVPMission.infoErr = HardWareErr;
 982   5                                                          i = 0;                              
 983   5                                                              //sysVPMission.send.datLen = 2;   
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 17  

 984   5                                              //sysVPMission.send.msg[0] = sysVPMission.infoType;
 985   5                                                              //sysVPMission.send.msg[1] = sysVPMission.infoErr;
 986   5                                                              sysVPMission.send.msg[i++] = VP_INFO_ERR;                                                       
 987   5                                                              //纸币器故障
 988   5                                                              /*
 989   5                                                              if(sysVPMission.STA_BillA==2)
 990   5                                                              {
 991   5                                                                  //errcode = 0xFB;
 992   5                                                                      //sprintf( errCodeStr, "%s", "纸币器故障" );                    
 993   5                                                                      //sprintf( errCodeStr, "%s", "  " );
 994   5      
 995   5                                                                      //sprintf( sysVPMission.hardWareErrStr, "%s", "纸币器故障" );
 996   5                                                                      sysVPMission.send.msg[i++] = 0x00;
 997   5                                                                      sysVPMission.send.msg[i++] = 0xFB;
 998   5                                                              }
 999   5                                                              */
1000   5                                                              //纸币器故障
1001   5                                                              //具体故障情况
1002   5                                                              //钞箱已满                                                      
1003   5                                                              if(sysMDBMission.billIsFull == 1)
1004   5                                                              {
1005   6                                                                      sysVPMission.send.msg[i++] = 0x17;
1006   6                                                                      sysVPMission.send.msg[i++] = 0x78;
1007   6                                                              }
1008   5                                                              //钞箱移除报故障
1009   5                                                              if(sysMDBMission.billCashBuf == 1)//钞箱移除报故障;by gzz 20121224
1010   5                                                          {
1011   6                                                                      if( sysITLMission.billHoldingFlag == 1 )
1012   6                                                                      {
1013   7                                                                              CurrentMoney = CurrentPayed + sysITLMission.billHoldingValue;
1014   7                                                                      }
1015   6                                                                      else
1016   6                                                                      {
1017   7                                                                              CurrentMoney = CurrentPayed;
1018   7                                                                      }
1019   6                                                                      if( (CurrentMoney == 0)&&( sysITLMission.billHoldingFlag == 0 ) )
1020   6                                                                      {
1021   7                                                                              sysVPMission.send.msg[i++] = 0x17;
1022   7                                                                              sysVPMission.send.msg[i++] = 0x77;
1023   7                                                                      }
1024   6                                                              }
1025   5                                                              //电机异常
1026   5                                                              if(sysMDBMission.billOthErr & 0x01)
1027   5                                                              {
1028   6                                                                      sysVPMission.send.msg[i++] = 0x17;
1029   6                                                                      sysVPMission.send.msg[i++] = 0x73;
1030   6                                                              }
1031   5                                                              //传感器异常
1032   5                                                              if(sysMDBMission.billOthErr & 0x02)
1033   5                                                              {
1034   6                                                                      sysVPMission.send.msg[i++] = 0x17;
1035   6                                                                      sysVPMission.send.msg[i++] = 0x74;
1036   6                                                              }
1037   5                                                              //卡币
1038   5                                                              if(sysMDBMission.billOthErr & 0x08)
1039   5                                                              {
1040   6                                                                      sysVPMission.send.msg[i++] = 0x17;
1041   6                                                                      sysVPMission.send.msg[i++] = 0x76;
1042   6                                                              }
1043   5                                                              
1044   5                                                              //sysVPMission.send.msg[i++] = sysMDBMission.billOthErr;
1045   5      
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 18  

1046   5                                                              
1047   5                                                              //硬币器故障
1048   5                                                              /*
1049   5                                                              if( ( HardWareErr & 0x0002 )||( sysVPMission.STA_CoinA == 2 ) )
1050   5                                                              {
1051   5                                                                      //errcode = 0xF2;
1052   5                                                                      //sprintf( errCodeStr, "%s", "硬币器故障" );                    
1053   5                                                                      //sprintf( errCodeStr, "%s", "  请用其它方式购物" );
1054   5      
1055   5                                                                      //sprintf( sysVPMission.hardWareErrStr, "%s", "硬币器故障");
1056   5                                                                      sysVPMission.send.msg[i++] = 0x00;
1057   5                                                                      sysVPMission.send.msg[i++] = 0xF2;
1058   5                                                                      //sysVPMission.send.msg[i++] = 0x00;
1059   5                                                                      //sysVPMission.send.msg[i++] = 0xF3;
1060   5                                                              }
1061   5                                                              */
1062   5                                                              //硬币器故障
1063   5                                                              //具体故障情况
1064   5                                                              //添加币管没有锁紧故障;by gzz 20110827
1065   5                                                              if( sysMDBMission.tubeRemoved == 1 )
1066   5                                                              {
1067   6                                                                  //errcode = 0xF0;//币管没有锁紧故障
1068   6                                                                      //sprintf( errCodeStr, "%s", "币管未关闭" );                    
1069   6                                                                      //sprintf( errCodeStr, "%s", "  请用其它方式购物" );
1070   6      
1071   6                                                                      //sprintf( sysVPMission.hardWareErrStr, "%s", "币管未关闭" );
1072   6                                                                      sysVPMission.send.msg[i++] = 0x13;
1073   6                                                                      sysVPMission.send.msg[i++] = 0x8c;
1074   6                                                              }
1075   5                                                              //传感器异常
1076   5                                                              if(sysMDBMission.coinOthErr & 0x01)
1077   5                                                              {
1078   6                                                                      sysVPMission.send.msg[i++] = 0x13;
1079   6                                                                      sysVPMission.send.msg[i++] = 0x8b;
1080   6                                                              }
1081   5                                                              //出币卡币
1082   5                                                              if(sysMDBMission.coinOthErr & 0x02)
1083   5                                                              {
1084   6                                                                      sysVPMission.send.msg[i++] = 0x13;
1085   6                                                                      sysVPMission.send.msg[i++] = 0x8d;
1086   6                                                              }
1087   5                                                              //进币通道出错
1088   5                                                              if(sysMDBMission.coinOthErr & 0x08)
1089   5                                                              {
1090   6                                                                      sysVPMission.send.msg[i++] = 0x13;
1091   6                                                                      sysVPMission.send.msg[i++] = 0x8f;
1092   6                                                              }
1093   5                                                              //投币卡币
1094   5                                                              if(sysMDBMission.coinOthErr & 0x10)
1095   5                                                              {
1096   6                                                                      sysVPMission.send.msg[i++] = 0x13;
1097   6                                                                      sysVPMission.send.msg[i++] = 0x90;
1098   6                                                              }
1099   5                                                              //找币器故障
1100   5                                                              //if( ( HardWareErr & 0x0004 )||( sysVPMission.STA_CoinA == 2 ) )
1101   5                                                              //{
1102   5                                                                      //errcode = 0xF3;
1103   5                                                                      //sprintf( errCodeStr, "%s", "找币器故障" );                    
1104   5                                                                      //sprintf( errCodeStr, "%s", "  请用其它方式购物" );
1105   5      
1106   5                                                                      //sprintf( sysVPMission.hardWareErrStr, "%s", "找币器故障");
1107   5                                                                      //sysVPMission.send.msg[i++] = 0x00;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 19  

1108   5                                                                      //sysVPMission.send.msg[i++] = 0xF3;
1109   5                                                              //}
1110   5                                                              //找币器缺币
1111   5                                                              //if( HardWareErr & 0x0008 )
1112   5                                                              //{
1113   5                                                                      //errcode = 0xF4;
1114   5                                                          //sprintf( errCodeStr, "%s", "找币器缺币" );                        
1115   5                                                                      //sprintf( errCodeStr, "%s", "  请用其它方式购物" );
1116   5      
1117   5                                                                      //sprintf( sysVPMission.hardWareErrStr, "%s", "找币器缺币");
1118   5                                                                      //sysVPMission.send.msg[i++] = 0x00;
1119   5                                                                      //sysVPMission.send.msg[i++] = 0xF4;
1120   5                                                              //}
1121   5                                                              //if( HardWareErr & 0x0010 )
1122   5                                                              //{
1123   5                                                                      //errcode = 0xF5;                       
1124   5                                                                      //sprintf( errCodeStr, "%s", "  " );
1125   5      
1126   5                                                                      //sprintf( sysVPMission.hardWareErrStr, "%s", "所有货道无货");
1127   5                                                                      //sysVPMission.send.msg[i++] = 0x00;
1128   5                                                                      //sysVPMission.send.msg[i++] = 0xF5;
1129   5                                                              //}
1130   5                                                              //if( HardWareErr & 0x0020 )
1131   5                                                              //{
1132   5                                                                      //errcode = 0xF6;
1133   5                                                                      //sprintf( errCodeStr, "%s", "所有货道故障" );                  
1134   5                                                                      //sprintf( errCodeStr, "%s", "  " );
1135   5      
1136   5                                                                      //sprintf( sysVPMission.hardWareErrStr, "%s", "所有货道故障");
1137   5                                                                      //sysVPMission.send.msg[i++] = 0x00;
1138   5                                                                      //sysVPMission.send.msg[i++] = 0xF6;
1139   5                                                              //}
1140   5                                                              if( HardWareErr & 0x0040 )
1141   5                                                              {
1142   6                                                                      //errcode = 0xF7;       
1143   6                                                                      //sprintf( errCodeStr, "%s", "货道板故障" );                    
1144   6                                                                      //sprintf( errCodeStr, "%s", "  " );
1145   6      
1146   6                                                                      //sprintf( sysVPMission.hardWareErrStr, "%s", "货道板故障");
1147   6                                                                      sysVPMission.send.msg[i++] = 0x00;
1148   6                                                                      sysVPMission.send.msg[i++] = 0xF7;
1149   6                                                              }
1150   5                                                              if( HardWareErr & 0x0080 )
1151   5                                                              {
1152   6                                                                      //errcode = 0xF8;                               
1153   6                                                                      //sprintf( errCodeStr, "%s", "  " );
1154   6      
1155   6                                                                      //sprintf( sysVPMission.hardWareErrStr, "%s", "所有货道不能工作");
1156   6                                                                      sysVPMission.send.msg[i++] = 0x00;
1157   6                                                                      sysVPMission.send.msg[i++] = 0xF8;
1158   6                                                              }
1159   5                                                              if( HardWareErr & 0x0100 )
1160   5                                                              {
1161   6                                                                      //errcode = 0xF9;       
1162   6                                                                      //sprintf( errCodeStr, "%s", "系统参数故障" );                  
1163   6                                                                      //sprintf( errCodeStr, "%s", "  " );
1164   6      
1165   6                                                                      //sprintf( sysVPMission.hardWareErrStr, "%s", "系统参数故障");
1166   6                                                                      sysVPMission.send.msg[i++] = 0x00;
1167   6                                                                      sysVPMission.send.msg[i++] = 0xF9;
1168   6                                                              }
1169   5                                                              if( HardWareErr & 0x0200 )
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 20  

1170   5                                                              {
1171   6                                                                      //errcode = 0xFA;
1172   6                                                                      //sprintf( errCodeStr, "%s", "LCD 故障" );                      
1173   6                                                                      //sprintf( errCodeStr, "%s", "  " );
1174   6      
1175   6                                                                      //sprintf( sysVPMission.hardWareErrStr, "%s", "LCD 故障" );
1176   6                                                                      sysVPMission.send.msg[i++] = 0x00;
1177   6                                                                      sysVPMission.send.msg[i++] = 0xFA;
1178   6                                                              }       
1179   5      
1180   5                                                              /*
1181   5                                                              //出货检测故障          
1182   5                                                              if( ( HardWareErr & 0x0800 )||(sysVPMission.STA_ICCard==2) )
1183   5                                                              {
1184   5                                                                  //errcode = 0xFC;
1185   5                                                                      //sprintf( errCodeStr, "%s", "出货确认故障" );                  
1186   5                                                                      //sprintf( errCodeStr, "%s", "  " );
1187   5      
1188   5                                                                      //sprintf( sysVPMission.hardWareErrStr, "%s", "出货确认故障" );
1189   5                                                                      sysVPMission.send.msg[i++] = 0x00;
1190   5                                                                      sysVPMission.send.msg[i++] = 0xFC;
1191   5                                                              }
1192   5                                                              */
1193   5                                                              if( HardWareErr & 0x1000 )
1194   5                                                              {
1195   6                                                                  //errcode = 0xFD;
1196   6                                                                      //sprintf( errCodeStr, "%s", "选货模块故障" );                  
1197   6                                                                      //sprintf( errCodeStr, "%s", "  " );
1198   6      
1199   6                                                                      //sprintf( sysVPMission.hardWareErrStr, "%s", "选货模块故障" );
1200   6                                                                      sysVPMission.send.msg[i++] = 0x00;
1201   6                                                                      sysVPMission.send.msg[i++] = 0xFD;
1202   6                                                              }
1203   5                                                              if( HardWareErr & 0x2000 )
1204   5                                                              {
1205   6                                                                  //errcode = 0xFE;
1206   6                                                                      //sprintf( errCodeStr, "%s", "PC通信故障" );                    
1207   6                                                                      //sprintf( errCodeStr, "%s", "  " );
1208   6      
1209   6                                                                      //sprintf( sysVPMission.hardWareErrStr, "%s", "PC通信故障" );
1210   6                                                                      sysVPMission.send.msg[i++] = 0x1b;
1211   6                                                                      sysVPMission.send.msg[i++] = 0x5a;
1212   6                                                              }
1213   5                                                              //if( HardWareErr & 0x4000 )    
1214   5                                                              //{
1215   5                                                                  //errcode = 0xE1;
1216   5                                                                      //sprintf( errCodeStr, "%s", "pc离线" );                        
1217   5                                                                      //sprintf( errCodeStr, "%s", "  " );
1218   5      
1219   5                                                                      //sprintf( sysVPMission.hardWareErrStr, "%s", "pc离线" );
1220   5                                                                      //sysVPMission.send.msg[i++] = 0x00;
1221   5                                                                      //sysVPMission.send.msg[i++] = 0xE1;
1222   5                                                              //}                                             
1223   5                                                              sysVPMission.send.datLen = i;   
1224   5                                                      }
1225   4                                                      break;
1226   4                                      }
1227   3                                      /*
1228   3                      sysVPMission.send.datLen  = 9;
1229   3                      sysVPMission.send.msg[0]  = 6; 
1230   3                                      
1231   3                      sysVPMission.send.msg[1]  = TradeCounter.TotalSellNum/256/256/256;       
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 21  

1232   3                      sysVPMission.send.msg[2]  = TradeCounter.TotalSellNum/256/256%256;       
1233   3                      sysVPMission.send.msg[3]  = TradeCounter.TotalSellNum/256%256;       
1234   3                      sysVPMission.send.msg[4]  = TradeCounter.TotalSellNum%256; 
1235   3      
1236   3                                      sysVPMission.send.msg[5]  = TradeCounter.TotalSellMoeny/256/256/256;             
1237   3                                      sysVPMission.send.msg[6]  = TradeCounter.TotalSellMoeny/256/256%256;             
1238   3                                      sysVPMission.send.msg[7]  = TradeCounter.TotalSellMoeny/256%256;                 
1239   3                                      sysVPMission.send.msg[8]  = TradeCounter.TotalSellMoeny%256;    
1240   3                                      */
1241   3      
1242   3                              }
1243   2                              break;
1244   2                              case VP_OFFLINEDATA_RPT:
1245   2                  {
1246   3                      sysVPMission.send.msgType = VP_OFFLINEDATA_RPT;  
1247   3                      sysVPMission.send.datLen  = 5;
1248   3                      sysVPMission.send.msg[0]  = 1;    
1249   3                                      tradeMoney = MoneySendInfo(TradeCounter.offLineMoney);
1250   3                      //sysVPMission.send.msg[1]  = tempMoney/256;
1251   3                                      //sysVPMission.send.msg[2]  = tempMoney%256;
1252   3                                      sysVPMission.send.msg[1]  = tradeMoney/256%256;          
1253   3                                      sysVPMission.send.msg[2]  = tradeMoney%256;
1254   3                                      sysVPMission.send.msg[3]  = TradeCounter.offLineNum/256;
1255   3                                      sysVPMission.send.msg[4]  = TradeCounter.offLineNum%256;
1256   3                                      TradeCounter.offLineMoney = 0;
1257   3                                      TradeCounter.offLineNum = 0;
1258   3                  }
1259   2                  break;
1260   2                      default: break;
1261   2              }
1262   1              //
1263   1              sysVPMission.send.sf  = VP_SF;
1264   1              //
1265   1          sysVPMission.send.len = sysVPMission.send.datLen + 5;
1266   1              //
1267   1          sysVPMission.send.verFlag = VP_PROTOCOL_VER;
1268   1              if( flag == 1 )
1269   1              {
1270   2                  sysVPMission.send.verFlag += VP_PROTOCOL_ACK;
1271   2              }
1272   1              else
1273   1              {
1274   2                      sysVPMission.send.verFlag += VP_PROTOCOL_NAK;
1275   2              }
1276   1              //
1277   1              if( snCtr == 1 )
1278   1              {
1279   2                  if( sysVPMission.sysStatus != 0 )
1280   2                      {
1281   3                              sysVPMission.send.sn += 1;
1282   3              }
1283   2                      else
1284   2                      {
1285   3                              sysVPMission.sysStatus |= VPM_STA_FIRSTCOM;
1286   3                      }
1287   2              }
1288   1          sysVPMission.comLock = 1;
1289   1          VPBusTxMsg();
1290   1          sysVPMission.comLock = 0;
1291   1              return VP_ERR_NULL;
1292   1      }
1293          
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 22  

1294          /*//----------------------------------------------------------------------
1295          //PC--VMC command mission
1296          unsigned char VP_CMD_GoodsPar( void )
1297          {
1298                  
1299                  unsigned char i = 0;
1300                  unsigned char j = 0;
1301                  u_int  tempMoney = 0;
1302                  
1303                  
1304                  //if( sysVPMission.receive.datLen == (GOODSTYPEMAX+GOODSTYPEMAX*2)      )
1305                  if( sysVPMission.receive.datLen <= 124*2+1)
1306                  {
1307                          
1308                          if( sysVPMission.receive.verFlag & VP_PROTOCOL_ACK )
1309                          {
1310                                  VPMsgPackSend( VP_ACK_RPT, 0, 0 );
1311                          }
1312          
1313                          //----------------------------------
1314                          //      1...                      n
1315                          //SP1_Price...Sn_Price
1316                          sysVPMission.GoodsRev = (sysVPMission.receive.datLen - 1) / 2;  
1317                          for( i=0,  j=1; i<sysVPMission.GoodsRev; i++, j+=2 )
1318                          {
1319                                  sysGoodsMatrix[i].GoodsType = i+1;                      
1320                                  if((sysVPMission.receive.msg[j]*256+sysVPMission.receive.msg[j+1])>=6550)
1321                                  {
1322                                          sysGoodsMatrix[i].Price  = 65000;
1323                                  }
1324                                  else
1325                                  {       
1326                                          if(sysGoodsMatrix[i].Price  != MoneyRec(sysVPMission.receive.msg[j],sysVPMission.receive.msg[j+1]))
1327                                                  sysGoodsMatrix[i].Price  = MoneyRec(sysVPMission.receive.msg[j],sysVPMission.receive.msg[j+1]);                         
1328                                  }
1329                                  //sysVPMission.selItem[i]       = sysGoodsMatrix[i].GoodsType;
1330                                  sysVPMission.selPrice[i] = sysGoodsMatrix[i].Price;  
1331                                  if(sysVPMission.selPrice[i] >= tempMoney)
1332                                  {
1333                                          tempMoney = sysVPMission.selPrice[i];
1334                                          SystemParameter.BanknoteMax = sysVPMission.selPrice[i];
1335                                  }
1336                          }       
1337                          
1338                          sysVPMission.sysStatus |= VPM_STA_GOODSPAR;     
1339                  }
1340                  else
1341                  {
1342                          VPMsgPackSend( VP_NAK_RPT, 0, 0  );  //1, 0
1343                          return VP_ERR_PAR;
1344                  }
1345                  
1346                  return VP_ERR_NULL; 
1347          }
1348          */
1349          
1350          /*
1351          {
1352              unsigned char i = 0;
1353              unsigned char j = 0;
1354              if( sysVPMission.receive.datLen == (GOODSTYPEMAX+GOODSTYPEMAX*2)  )
1355                  {
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 23  

1356                  
1357                      if( sysVPMission.receive.verFlag & VP_PROTOCOL_ACK )
1358                  {
1359                          VPMsgPackSend( VP_ACK_RPT, 0, 0 );
1360                  }
1361                          //----------------------------------
1362                          //  1....17,   19...               54
1363                          //SP1....SP18, SP1_Price...SP18_Price
1364                  for( i=0; i<GOODSTYPEMAX; i++)
1365                          {
1366                                  sysGoodsMatrix[i].GoodsType = sysVPMission.receive.msg[i];
1367                      sysVPMission.selItem[i]     = sysVPMission.receive.msg[i];
1368                          }
1369                          for( i=0, j=GOODSTYPEMAX; i<GOODSTYPEMAX; i++,j+=2 )
1370                          {
1371                                  sysGoodsMatrix[i].Price  = sysVPMission.receive.msg[j]*256+sysVPMission.receive.msg[j+1]; 
1372                      sysVPMission.selPrice[i] = sysVPMission.receive.msg[j]*256+sysVPMission.receive.msg[j+1];    
1373                          }
1374                          sysVPMission.sysStatus |= VPM_STA_GOODSPAR;
1375                  }
1376                  else
1377                  {
1378                      VPMsgPackSend( VP_NAK_RPT, 0, 0  );  //1, 0
1379                          return VP_ERR_PAR;
1380                  }
1381              return VP_ERR_NULL; 
1382          }*/
1383          
1384          unsigned char VP_CMD_GoodsPos( void )
1385          {
1386   1          unsigned char i = 0;
1387   1          unsigned char j = 0;
1388   1              /**/
1389   1          //if( sysVPMission.receive.datLen == (GOODSTYPEMAX+GOODSTYPEMAX*2)  )
1390   1          if( sysVPMission.receive.datLen == GOODSTYPEMAX+1)
1391   1              {
1392   2              
1393   2                  if( sysVPMission.receive.verFlag & VP_PROTOCOL_ACK )
1394   2              {
1395   3                      VPMsgPackSend( VP_ACK_RPT, 0, 0 );
1396   3              }
1397   2      
1398   2                      for( i=0; i<GOODSTYPEMAX; i++)
1399   2                      {
1400   3                              //sysVPMission.selItem[i] = sysVPMission.receive.msg[i+1];
1401   3                              if(SystemParameter.selItem[i] != sysVPMission.receive.msg[i+1])
1402   3                                      SystemParameter.selItem[i] = sysVPMission.receive.msg[i+1];
1403   3                      }
1404   2                      SaveGlobalParam();
1405   2                      WaitForWork( 100, NULL );
1406   2              }
1407   1              else
1408   1              {
1409   2                  VPMsgPackSend( VP_NAK_RPT, 0, 0  );  //1, 0
1410   2                      return VP_ERR_PAR;
1411   2              }
1412   1          return VP_ERR_NULL; 
1413   1      }
1414          
1415          
1416          unsigned char VP_CMD_ColumnPar( void )
1417          {
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 24  

1418   1          unsigned char i = 0;
1419   1              unsigned char j = 0;
1420   1              if( sysVPMission.receive.datLen == COLUMN_NUM_SET+1 )
1421   1              {
1422   2              if( sysVPMission.receive.verFlag & VP_PROTOCOL_ACK )
1423   2              {
1424   3                      VPMsgPackSend( VP_ACK_RPT, 0, 0 );
1425   3              }
1426   2                      //-------------------------------------------------
1427   2                      //1...       48  49...        96
1428   2                      //colNum_1...48  colGoods_1...48
1429   2                      for( i=0; i<COLUMN_NUM_SET; i++ )
1430   2                      {
1431   3                              if( (sysVPMission.receive.msg[i+1]==0xff)||(sysVPMission.receive.msg[i+1]==0x0) )
1432   3                  {
1433   4                      GoodsWaySetVal[i].GoodsCurrentSum = 0;
1434   4                      GoodsWaySetVal[i].GoodsType = sysVPMission.receive.msg[i+1];
1435   4                                      GoodsWaySetVal[i].Price = 0;
1436   4                  }
1437   3                  else
1438   3                  {
1439   4                                      //GoodsWaySetVal[i].GoodsCurrentSum = sysVPMission.receive.msg[i];
1440   4                                      if(GoodsWaySetVal[i].GoodsType != sysVPMission.receive.msg[i+1])
1441   4                                              GoodsWaySetVal[i].GoodsType = sysVPMission.receive.msg[i+1];
1442   4                  }
1443   3                              GoodsWaySetVal[i].IsUsed = 0;
1444   3                      }
1445   2                      sysVPMission.sysStatus |= VPM_STA_COLUMNPAR;
1446   2                      
1447   2                      
1448   2              }
1449   1              else
1450   1              {
1451   2                      VPMsgPackSend( VP_NAK_RPT, 0, 0  );  //1,0
1452   2                      return VP_ERR_PAR;
1453   2              }
1454   1          return VP_ERR_NULL; 
1455   1      }       
1456          
1457          
1458          
1459          
1460          unsigned char VP_CMD_ColumnNo( void )
1461          {
1462   1          unsigned char i = 0;
1463   1              unsigned char j = 0;
1464   1              if( sysVPMission.receive.datLen == COLUMN_NUM_SET+1 )
1465   1              {
1466   2              if( sysVPMission.receive.verFlag & VP_PROTOCOL_ACK )
1467   2              {
1468   3                      VPMsgPackSend( VP_ACK_RPT, 0, 0 );
1469   3              }
1470   2                      //-------------------------------------------------
1471   2                      //1...       48  49...        96
1472   2                      //colNum_1...48  colGoods_1...48                
1473   2                      for( i=0; i<COLUMN_NUM_SET; i++)
1474   2                      {
1475   3                              if( (GoodsWaySetVal[i].GoodsType!=0xff)&&(GoodsWaySetVal[i].GoodsType!=0x0) )
1476   3                  {
1477   4                                      GoodsWaySetVal[i].GoodsCurrentSum = (sysVPMission.receive.msg[i+1]>63)?63:(sysVPMission.receive.msg[i+
             -1]&0x3f);
1478   4                                      //GoodsWaySetVal[i].GoodsType = sysVPMission.receive.msg[i+1];
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 25  

1479   4                              }
1480   3                      }               
1481   2                      sysVPMission.sysStatus |= VPM_STA_COLUMNPAR;
1482   2                      for( i=0; i<COLUMN_NUM_SET; i++ )
1483   2                      {
1484   3                     if( GoodsWaySetVal[i].GoodsCurrentSum > 0 )
1485   3                              {
1486   4                                  GoodsWaySetVal[i].WayState = 0x01;
1487   4                              }                                               
1488   3                      }               
1489   2                      SaveGoodsSet(); 
1490   2                      WaitForWork( 100, NULL );
1491   2              }
1492   1              else
1493   1              {
1494   2                      VPMsgPackSend( VP_NAK_RPT, 0, 0  );  //1,0
1495   2                      return VP_ERR_PAR;
1496   2              }
1497   1          return VP_ERR_NULL; 
1498   1      }
1499          
1500          
1501          unsigned char VP_CMD_Init_OK( void )
1502          {
1503   1          unsigned char i = 0;
1504   1              unsigned char j = 0;
1505   1              if( sysVPMission.receive.verFlag & VP_PROTOCOL_ACK )
1506   1              {
1507   2              VPMsgPackSend( VP_ACK_RPT, 0, 0 );
1508   2          }
1509   1          sysVPMission.sysStatus |= VPM_STA_INITOK;
1510   1              return VP_ERR_NULL;     
1511   1      }
1512          
1513          unsigned char VP_CMD_Vendout( void )
1514          {
1515   1          unsigned char i = 0;
1516   1          unsigned char j = 0;
1517   1              unsigned int  sel = 0xffff;
1518   1              unsigned char col = 0xff;
1519   1          unsigned int  moneyBuf = 0;
1520   1              unsigned char dspUpdate = 0;
1521   1              unsigned char method = 0;
1522   1              uchar xdata chuSet = 0;
1523   1              //u_char xdata str[20];
1524   1              //u_char xdata len = 0;
1525   1          
1526   1              //1.Check the data
1527   1          if( sysVPMission.receive.datLen != 6  )
1528   1              {
1529   2                      //DisplayStr( 0, 0, 1, "1", 1 ); 
1530   2                      //WaitForWork(5000,NULL);
1531   2                  VPMsgPackSend( VP_NAK_RPT, 0, 0  );  
1532   2                      return VP_ERR_PAR;
1533   2              }
1534   1              
1535   1              if(sysVPMission.ErrFlag2 == 1)
1536   1              {
1537   2                      //DisplayStr( 0, 0, 1, "2", 1 ); 
1538   2                      //WaitForWork(5000,NULL);
1539   2                  VPMsgPackSend( VP_NAK_RPT, 0, 0  );  
1540   2                      return VP_ERR_PAR;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 26  

1541   2              }       
1542   1      
1543   1          //2.Check the goods code in goods matrix //or in column matrix
1544   1              //
1545   1              if(DeviceStatus.Driver64 != 0x00)
1546   1              {
1547   2                      //DisplayStr( 0, 0, 1, "3", 1 ); 
1548   2                      //WaitForWork(5000,NULL);
1549   2                      VPMsgPackSend( VP_NAK_RPT, 0, 0  );     
1550   2                  return VP_ERR_PAR;
1551   2              }
1552   1              method = sysVPMission.receive.msg[1];
1553   1      
1554   1              if(method == 1)
1555   1              {
1556   2                      /*
1557   2                      for( i=0; i<sysVPMission.GoodsRev; i++ )
1558   2                      {
1559   2                              if( sysVPMission.receive.msg[2] == sysGoodsMatrix[i].GoodsType )
1560   2                              {
1561   2                              sel = i;
1562   2                                  break;
1563   2                              }
1564   2                      }
1565   2      
1566   2                  if( sel == 0xffff )
1567   2                      {
1568   2                      //VPMsgPackSend( VP_NAK_RPT, 0, 0  );   
1569   2                              //return VP_ERR_PAR;
1570   2                              //The goods code isn't in the goods window, find in the column matrix
1571   2                              for( i=0; i<COLUMN_NUM_SET; i++  )
1572   2                              {
1573   2                                      if( GoodsWaySetVal[i].GoodsType == sysVPMission.receive.msg[2] )
1574   2                          {
1575   2                                              if( (GoodsWaySetVal[i].GoodsCurrentSum >= 1) && ( GoodsWaySetVal[i].WayState == 0x01 ) )
1576   2                                              {
1577   2                                                      col = i;
1578   2                                  break;
1579   2                                              }
1580   2                                      }
1581   2                              }
1582   2                              if( i >= COLUMN_NUM_SET )
1583   2                              {
1584   2                                      DisplayStr( 0, 0, 1, "4", 1 ); 
1585   2                                      WaitForWork(5000,NULL);
1586   2                                      VPMsgPackSend( VP_NAK_RPT, 0, 0  );     
1587   2                                  return VP_ERR_PAR;
1588   2                              }
1589   2                      sysVPMission.goodsType2 = GOODSTYPEMAX;
1590   2      
1591   2                      }
1592   2                  else
1593   2                      {
1594   2                              if( ( sysGoodsMatrix[sel].ColumnNum == 0 )||( sysGoodsMatrix[sel].NextColumn == GOODS_MATRIX_NONE ) )
1595   2                              {
1596   2                                      DisplayStr( 0, 0, 1, "5", 1 ); 
1597   2                                      WaitForWork(5000,NULL);
1598   2                                      VPMsgPackSend( VP_NAK_RPT, 0, 0  );      
1599   2                                      return VP_ERR_PAR;              
1600   2                              }
1601   2                          else
1602   2                              {
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 27  

1603   2                                      col = sysGoodsMatrix[sel].NextColumn;
1604   2                                      sysVPMission.goodsType2 = sel;
1605   2                              }    
1606   2                      }
1607   2                      */
1608   2                      //1.判断是否有货物出货
1609   2                      for( i=0; i<COLUMN_NUM_SET; i++  )
1610   2                      {
1611   3                              if( GoodsWaySetVal[i].GoodsType == sysVPMission.receive.msg[2] )
1612   3                  {
1613   4                                      if( (GoodsWaySetVal[i].GoodsCurrentSum > 0) && (GoodStateLed(i)==1) )
1614   4                                      {
1615   5                                              col = i;
1616   5                          break;
1617   5                                      }
1618   4                              }
1619   3                      }
1620   2                      //没有货物出货
1621   2                      if( i >= COLUMN_NUM_SET )
1622   2                      {
1623   3                              //DisplayStr( 0, 0, 1, "4", 1 ); 
1624   3                              //WaitForWork(5000,NULL);
1625   3                              VPMsgPackSend( VP_NAK_RPT, 0, 0  );     
1626   3                          return VP_ERR_PAR;
1627   3                      }
1628   2                      //2.判断是这次轮流到哪个货道出货
1629   2                      while(chuSet==0)
1630   2                      {               
1631   3                              for( i=0; i<COLUMN_NUM_SET; i++ )
1632   3                          {
1633   4                              if( GoodsWaySetVal[i].GoodsType == sysVPMission.receive.msg[2] )
1634   4                              {
1635   5                                      //len = sprintf( str, "1=%02bu,%02bu,%02bu", i,GoodsWaySetVal[i].GoodsCurrentSum,GoodsWaySetVal[i]
             -.IsUsed );
1636   5                                              //              DisplayStr( 0, 1, 1, str, len );
1637   5                                              //              WaitForWork( 2000, NULL );
1638   5                                              if( ( GoodsWaySetVal[i].GoodsCurrentSum > 0 )&&(GoodStateLed(i)==1) &&( GoodsWaySetVal[i].IsUsed == 0
             - ) )
1639   5                                          {                   
1640   6                                              col = i;
1641   6                                                      chuSet = 1;
1642   6                                                      GoodsWaySetVal[i].IsUsed = 1;
1643   6                                                      //len = sprintf( str, "2=%02bu", i );
1644   6                                                      //      DisplayStr( 0, 1, 1, str, len );
1645   6                                                      //      WaitForWork( 2000, NULL );              
1646   6                                                      break;
1647   6                                          }
1648   5                              }
1649   4                          }
1650   3                              //都已经出货过一次了，重头开始出货
1651   3                          if(i>=COLUMN_NUM_SET)
1652   3                              {
1653   4                                      for( i=0; i<COLUMN_NUM_SET; i++ )
1654   4                                  {
1655   5                                      if( GoodsWaySetVal[i].GoodsType == sysVPMission.receive.msg[2] )
1656   5                                      {
1657   6                                              //len = sprintf( str, "%02bu,%02bu", sysVPMission.key,SystemParameter.selItem[sysVPMission.key] )
             -;
1658   6                                                      //              DisplayStr( 0, 1, 1, str, len );
1659   6                                                      //              WaitForWork( 2000, NULL );
1660   6                                                      //CurrentStockCode = i;         
1661   6                                                  if( ( GoodsWaySetVal[i].GoodsCurrentSum > 0 )&&(GoodStateLed(i)==1) )
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 28  

1662   6                                                  {                   
1663   7                                                      GoodsWaySetVal[i].IsUsed = 0;    
1664   7                                                  }
1665   6                                      }
1666   5                                  }
1667   4                          }
1668   3                      }
1669   2              sysVPMission.goodsType2 = GOODSTYPEMAX;
1670   2              }
1671   1              else if(method == 2)
1672   1              {
1673   2                      col = sysVPMission.receive.msg[2]-1;
1674   2                      
1675   2                      if( (!(GoodsWaySetVal[col].WayState & 0x01))||( GoodsWaySetVal[col].WayState & 0x0A )||( GoodsWaySetVal[
             -col].GoodsCurrentSum == 0 ) )
1676   2                      {
1677   3                              //DisplayStr( 0, 0, 1, "6", 1 ); 
1678   3                              //WaitForWork(5000,NULL);
1679   3                              VPMsgPackSend( VP_NAK_RPT, 0, 0  );      
1680   3                              return VP_ERR_PAR;                      
1681   3                      }
1682   2              }
1683   1      
1684   1          //3.Check the column's status
1685   1          
1686   1              //4.ACK
1687   1          sysVPMission.vendGoods = sysVPMission.receive.msg[2];
1688   1          sysVPMission.vendType  = sysVPMission.receive.msg[3];
1689   1          sysVPMission.vendCost  = MoneyRec(sysVPMission.receive.msg[4], sysVPMission.receive.msg[5]);
1690   1          sysVPMission.vendColumn = col;
1691   1              if(( sysVPMission.vendType > 0 )&&(sysVPMission.vendCost > 0))
1692   1              {
1693   2                      //DisplayStr( 0, 0, 1, "7", 1 ); 
1694   2                      //WaitForWork(5000,NULL);
1695   2                      VPMsgPackSend( VP_NAK_RPT, 0, 0  );      
1696   2                      return VP_ERR_PAR;                      
1697   2              }
1698   1              if(( sysVPMission.vendType == 0 )&&(sysVPMission.vendCost == 0))
1699   1              {
1700   2                      //DisplayStr( 0, 0, 1, "8", 1 ); 
1701   2                      //WaitForWork(5000,NULL);
1702   2                      VPMsgPackSend( VP_NAK_RPT, 0, 0  );      
1703   2                      return VP_ERR_PAR;                      
1704   2              }
1705   1          
1706   1          //---------------------------------------------------
1707   1          //2011.7.19 changed for 
1708   1          moneyBuf = CurrentPayed;
1709   1          if( sysITLMission.billHoldingFlag == 1 )
1710   1          {
1711   2              moneyBuf += sysITLMission.billHoldingValue;
1712   2          }
1713   1          //if( sysVPMission.vendCost > CurrentPayed )
1714   1          if( sysVPMission.vendCost > moneyBuf )
1715   1              {
1716   2                      //DisplayStr( 0, 0, 1, "3", 1 ); 
1717   2                      //WaitForWork(5000,NULL);
1718   2                      VPMsgPackSend( VP_NAK_RPT, 0, 0  );      
1719   2                      return VP_ERR_PAR;                      
1720   2              }
1721   1              //扣钱后不能找零
1722   1              if(!(IsCanChange(sysVPMission.vendCost)))
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 29  

1723   1              {
1724   2                      //DisplayStr( 0, 0, 1, "4", 1 ); 
1725   2                      //WaitForWork(5000,NULL);
1726   2              VPMsgPackSend( VP_NAK_RPT, 0, 0  );      
1727   2                      return VP_ERR_PAR;
1728   2              }       
1729   1          //
1730   1          if( ( sysITLMission.billHoldingFlag == 1 )&&(sysVPMission.vendCost > CurrentPayed) )
1731   1          {
1732   2              StackTheBillAPI();
1733   2              dspUpdate = 1;                  
1734   2          }
1735   1          if( sysVPMission.vendCost > CurrentPayed )
1736   1          {
1737   2              //DisplayStr( 0, 0, 1, "5", 1 ); 
1738   2                      //WaitForWork(5000,NULL);
1739   2                      VPMsgPackSend( VP_NAK_RPT, 0, 0  );      
1740   2                      return VP_ERR_PAR;          
1741   2              }
1742   1              
1743   1              //正在进行出货，找零，或扣款操作
1744   1              if(( sysVPMission.vendCmd == 1 )||(sysVPMission.changeCmd == 1)||(sysVPMission.costCmd == 1))
1745   1              {
1746   2              //DisplayStr( 0, 0, 1, "5", 1 ); 
1747   2                      //WaitForWork(5000,NULL);
1748   2                      VPMsgPackSend( VP_NAK_RPT, 0, 0  );      
1749   2                      return VP_ERR_PAR;          
1750   2              }       
1751   1              if( sysVPMission.receive.verFlag & VP_PROTOCOL_ACK )
1752   1              {
1753   2              VPMsgPackSend( VP_ACK_RPT, 0, 0 );
1754   2              }
1755   1              if( dspUpdate == 1 )
1756   1              {
1757   2                        //payin report
1758   2                        if( sysVPMission.payInCoinFlag == 1 )
1759   2                        {
1760   3                            VPMission_Payin_RPT( VP_DEV_COIN, sysVPMission.payInCoinMoney );
1761   3                            sysVPMission.payInCoinFlag = 0;
1762   3                            sysVPMission.payInCoinMoney = 0;
1763   3                                                              
1764   3                        }
1765   2                        if( sysVPMission.payInBillFlag == 1 )
1766   2                        {
1767   3                            VPMission_Payin_RPT( VP_DEV_BILL, sysVPMission.payInBillMoney );
1768   3                            sysVPMission.payInBillFlag = 0;
1769   3                            sysVPMission.payInBillMoney = 0;      
1770   3                        }
1771   2                        //
1772   2                        if( sysVPMission.escrowOutFlag == 1 )
1773   2                        {
1774   3                            VPMission_Payin_RPT( VP_DEV_ESCROWOUT, sysVPMission.escrowMoney );
1775   3                            sysVPMission.escrowOutFlag = 0;
1776   3                            sysVPMission.escrowMoney = 0;     
1777   3                        }
1778   2                        DisplayCurrentMoney( CurrentPayed );
1779   2              }
1780   1          //5.Vendout
1781   1          //OutGoods(1);   
1782   1              sysVPMission.vendCmd = 1;
1783   1              //6.Vendout_RPT
1784   1          //VPMission_Vendout_RPT( sysVPMission.vendSta, sysVPMission.vendColumn, sysVPMission.vendType, sysVPMi
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 30  

             -ssion.vendCost );
1785   1          //WaitForWork( 300, NULL );
1786   1          return VP_ERR_NULL; 
1787   1      }
1788          
1789          //添加扣款函数;by gzz 20110823
1790          unsigned char VP_CMD_Cost( void )
1791          {
1792   1          unsigned char i = 0;
1793   1          unsigned char j = 0;
1794   1              unsigned int data CurrentMoney=0;
1795   1              //u_char xdata len = 0;
1796   1              //u_char xdata str[20];
1797   1      
1798   1          //1.Check the data
1799   1          if( sysVPMission.receive.datLen != 4  )
1800   1              {
1801   2                  VPMsgPackSend( VP_NAK_RPT, 0, 0  );  
1802   2                      return VP_ERR_PAR;
1803   2              }
1804   1          sysVPMission.costDev = sysVPMission.receive.msg[0];
1805   1              sysVPMission.costMoney = MoneyRec(sysVPMission.receive.msg[1], sysVPMission.receive.msg[2]);
1806   1              //2.得到当前投入的金额
1807   1              if( sysITLMission.billHoldingFlag == 1 )
1808   1              {
1809   2                      CurrentMoney = CurrentPayed + sysITLMission.billHoldingValue;
1810   2              }
1811   1              else
1812   1              {
1813   2                      CurrentMoney = CurrentPayed;
1814   2              }
1815   1              //3.用户投币金额小于扣款金额时，返回NAK_RPT    
1816   1          if( (sysVPMission.costDev != 0) || (sysVPMission.costMoney > CurrentMoney ) )
1817   1              {
1818   2                      //len = sprintf( str, "1=%lu,%lu", sysVPMission.costMoney,CurrentMoney );
1819   2                      //DisplayStr( 0, 0, 1, str, strlen(str) );  
1820   2                      //WaitForWork(2000,NULL);
1821   2              VPMsgPackSend( VP_NAK_RPT, 0, 0  );      
1822   2                      return VP_ERR_PAR;
1823   2              }
1824   1              //扣钱后不能找零
1825   1              if(!(IsCanChange(sysVPMission.costMoney)))
1826   1              {
1827   2                      //DisplayStr( 0, 0, 1, "2", 1 );  
1828   2                      //WaitForWork(2000,NULL);
1829   2              VPMsgPackSend( VP_NAK_RPT, 0, 0  );      
1830   2                      return VP_ERR_PAR;
1831   2              }       
1832   1      
1833   1              //正在进行出货，找零，或扣款操作
1834   1              if(( sysVPMission.vendCmd == 1 )||(sysVPMission.changeCmd == 1)||(sysVPMission.costCmd == 1))
1835   1              {
1836   2              //DisplayStr( 0, 0, 1, "5", 1 ); 
1837   2                      //WaitForWork(5000,NULL);
1838   2                      VPMsgPackSend( VP_NAK_RPT, 0, 0  );      
1839   2                      return VP_ERR_PAR;          
1840   2              }       
1841   1              
1842   1              sysVPMission.costType = sysVPMission.receive.msg[3];
1843   1      
1844   1              //2.ACK
1845   1              if( sysVPMission.receive.verFlag & VP_PROTOCOL_ACK )
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 31  

1846   1              {
1847   2              VPMsgPackSend( VP_ACK_RPT, 0, 0 );
1848   2              }
1849   1              
1850   1      
1851   1          //3.Set command flag
1852   1              sysVPMission.costCmd = 1;
1853   1          return VP_ERR_NULL; 
1854   1      }
1855          
1856          unsigned char VP_CMD_Reset( void )
1857          {
1858   1          unsigned char i = 0;
1859   1          unsigned char j = 0;
1860   1          
1861   1              //1.Check the data
1862   1          if( sysVPMission.receive.datLen != 1  )
1863   1              {
1864   2                  VPMsgPackSend( VP_NAK_RPT, 0, 0  );  
1865   2                      return VP_ERR_PAR;
1866   2              }
1867   1          sysVPMission.resetDev = sysVPMission.receive.msg[0];
1868   1          //2.ACK
1869   1              if( sysVPMission.receive.verFlag & VP_PROTOCOL_ACK )
1870   1              {
1871   2              VPMsgPackSend( VP_ACK_RPT, 0, 0 );
1872   2              }
1873   1          //3.Reset action......
1874   1              sysVPMission.resetCmd = 1;
1875   1              sysVPMission.VPInit = 1;
1876   1          return VP_ERR_NULL; 
1877   1      }
1878          
1879          unsigned char VP_CMD_Control( void )
1880          {
1881   1          unsigned char i = 0;
1882   1          unsigned char j = 0;
1883   1          
1884   1              //1.Check the data
1885   1          if( sysVPMission.receive.datLen != 2  )
1886   1              {
1887   2                  VPMsgPackSend( VP_NAK_RPT, 0, 0  );  
1888   2                      return VP_ERR_PAR;
1889   2              }
1890   1              //if( !( ((sysVPMission.receive.msg[0]>=1)&&(sysVPMission.receive.msg[0]<=30))&&(sysVPMission.receive.msg
             -[1]<=1) )  )
1891   1              if( !( (sysVPMission.receive.msg[0]==2)||(sysVPMission.receive.msg[0]==6)||(sysVPMission.receive.msg[0]==
             -16)||(sysVPMission.receive.msg[0]==18) ))
1892   1              {
1893   2                  VPMsgPackSend( VP_NAK_RPT, 0, 0  );  
1894   2                      return VP_ERR_PAR;
1895   2              }
1896   1          sysVPMission.ctrType  = sysVPMission.receive.msg[0];
1897   1              sysVPMission.ctrValue = sysVPMission.receive.msg[1];
1898   1          //Judge the device status
1899   1          /*
1900   1           if( ((sysVPMission.ctrType==VP_DEV_CTR_LED1)||(sysVPMission.ctrType==VP_DEV_CTR_COMPRESSOR1))&&((Syst
             -emParameter.ACDCModule==0)||(DeviceStatus.ACDCModule!=0)) )
1901   1           {
1902   1               VPMsgPackSend( VP_NAK_RPT, 0, 0  );     
1903   1                      return VP_ERR_PAR;
1904   1           }
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 32  

1905   1              */
1906   1          //2.ACK     
1907   1              if( sysVPMission.receive.verFlag & VP_PROTOCOL_ACK )
1908   1          {
1909   2                      VPMsgPackSend( VP_ACK_RPT, 0, 0 );
1910   2              }
1911   1          //3.Action......
1912   1              if( sysVPMission.ctrType == VP_DEV_BILLCOIN )
1913   1              {
1914   2              if( sysVPMission.ctrValue == 0 )
1915   2                      {
1916   3                              sysVPMission.billCoinEnable = 0;
1917   3                      }
1918   2                      else
1919   2                      {
1920   3                              sysVPMission.billCoinEnable = 1;
1921   3                      }
1922   2              }
1923   1              else if( sysVPMission.ctrType == VP_DEV_PAYOUT )
1924   1              {
1925   2                      if( sysVPMission.ctrValue == 0 )
1926   2                      {
1927   3                              sysMDBMission.returnCmdFlag = 1;
1928   3                      }               
1929   2              }
1930   1              else if( sysVPMission.ctrType == VP_DEV_GAME_LED )
1931   1              {
1932   2              if( sysVPMission.ctrValue == 0 )
1933   2                      {
1934   3                              GameLedOff();
1935   3                      }
1936   2                      else
1937   2                      {
1938   3                              GameLedOn();
1939   3                      }
1940   2              }
1941   1              else if( sysVPMission.ctrType == VP_DEV_SCALFACTOR )
1942   1              {
1943   2                      if( sysVPMission.ctrValue >= 3  )
1944   2                      {
1945   3                              HardWareErr |= 0x2000;
1946   3                          VPMsgPackSend( VP_NAK_RPT, 0, 0  );  
1947   3                              return VP_ERR_PAR;
1948   3                      }
1949   2                      else
1950   2                      {
1951   3                              if(sysVPMission.decimalPlaces == sysVPMission.ctrValue)
1952   3                              {
1953   4                                      HardWareErr &=  ~(0x2000);
1954   4                              sysVPMission.decimalPlaces = sysVPMission.ctrValue;
1955   4                              }
1956   3                              else
1957   3                              {
1958   4                                      HardWareErr |= 0x2000;
1959   4                              }
1960   3                      }
1961   2              }
1962   1          return VP_ERR_NULL; 
1963   1      }
1964          
1965          unsigned char VP_CMD_GetStatus( void )
1966          {
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 33  

1967   1          unsigned char i = 0;
1968   1          unsigned char j = 0;
1969   1      
1970   1              //1.Check the data
1971   1          if( sysVPMission.receive.datLen != 0  )
1972   1              {
1973   2                  VPMsgPackSend( VP_NAK_RPT, 0, 0  );  
1974   2                      return VP_ERR_PAR;
1975   2              }
1976   1              if( sysVPMission.receive.verFlag & VP_PROTOCOL_ACK  )
1977   1              {
1978   2                      VPMsgPackSend( VP_ACK_RPT, 0, 0  );
1979   2              }
1980   1              //2.
1981   1          VPMission_Status_RPT();
1982   1          return VP_ERR_NULL; 
1983   1      }
1984          
1985          unsigned char VP_CMD_Payout( void )
1986          {
1987   1          unsigned char i = 0;
1988   1          unsigned char j = 0;
1989   1              u_int  xdata tempPrice;
1990   1              u_char xdata resultdisp[2] = {0, 0};
1991   1      
1992   1          //1.Check the data
1993   1          if( sysVPMission.receive.datLen != 4  )
1994   1              {
1995   2                  VPMsgPackSend( VP_NAK_RPT, 0, 0  );  
1996   2                      return VP_ERR_PAR;
1997   2              }
1998   1          sysVPMission.changeDev   = sysVPMission.receive.msg[0];
1999   1              sysVPMission.changeMoney = MoneyRec(sysVPMission.receive.msg[1],sysVPMission.receive.msg[2]);
2000   1              //if( (sysVPMission.changeDev != 0) || (sysVPMission.changeMoney < SystemParameter.HopperCoinPrice1 ) )
2001   1          if( (sysVPMission.changeDev != 0) || (sysVPMission.changeMoney > sysMDBMission.coinAllValue ) || (sysM
             -DBMission.coinDeviceStatus!=0) 
2002   1                      ||( sysMDBMission.coinDeviceStatus != 0 )||( sysMDBMission.tubeRemoved == 1 ))
2003   1              {
2004   2              VPMsgPackSend( VP_NAK_RPT, 0, 0  );      
2005   2                      return VP_ERR_PAR;
2006   2              }
2007   1              //扣钱后不能找零
2008   1              tempPrice = sysVPMission.changeMoney/10;
2009   1              if(!(changeCNY2(resultdisp,tempPrice)))
2010   1              {
2011   2              VPMsgPackSend( VP_NAK_RPT, 0, 0  );      
2012   2                      return VP_ERR_PAR;
2013   2              }
2014   1              //正在进行出货，找零，或扣款操作
2015   1              if(( sysVPMission.vendCmd == 1 )||(sysVPMission.changeCmd == 1)||(sysVPMission.costCmd == 1))
2016   1              {
2017   2              //DisplayStr( 0, 0, 1, "5", 1 ); 
2018   2                      //WaitForWork(5000,NULL);
2019   2                      VPMsgPackSend( VP_NAK_RPT, 0, 0  );      
2020   2                      return VP_ERR_PAR;          
2021   2              }
2022   1              sysVPMission.changeType = sysVPMission.receive.msg[3];
2023   1      
2024   1              //2.ACK
2025   1              if( sysVPMission.receive.verFlag & VP_PROTOCOL_ACK )
2026   1              {
2027   2              VPMsgPackSend( VP_ACK_RPT, 0, 0 );
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 34  

2028   2              }
2029   1      
2030   1          //3.Set command flag
2031   1              sysVPMission.changeCmd = 1;
2032   1          return VP_ERR_NULL; 
2033   1      }
2034          
2035          
2036          unsigned char VP_CMD_GetColumnSta( void )
2037          {
2038   1          unsigned char i = 0;
2039   1          unsigned char j = 0;
2040   1      
2041   1              //1.Check the data
2042   1              /*
2043   1          if( sysVPMission.receive.datLen != 0  )
2044   1              {
2045   1                  VPMsgPackSend( VP_NAK_RPT, 0, 0  );  
2046   1                      return VP_ERR_PAR;
2047   1              }
2048   1              if( sysVPMission.receive.verFlag & VP_PROTOCOL_ACK  )
2049   1              {
2050   1                      VPMsgPackSend( VP_ACK_RPT, 0, 0  );
2051   1              }
2052   1              */
2053   1              //2.
2054   1          VPMission_ColumnSta_RPT();
2055   1          return VP_ERR_NULL; 
2056   1      }
2057          
2058          //判断货道状态
2059          unsigned char GoodStateLed(u_char i)
2060          {
2061   1              if(( GoodsWaySetVal[i].WayState & 0x01 )!= 0x01)
2062   1              {
2063   2                  //未
2064   2                  return 0;
2065   2              }
2066   1              else if( GoodsWaySetVal[i].WayState & 0x0A )
2067   1              {
2068   2                  //故
2069   2                  return 2;
2070   2              }
2071   1              else if( (GoodsWaySetVal[i].WayState & 0x04) || (GoodsWaySetVal[i].GoodsCurrentSum == 0) )
2072   1              {
2073   2                  //缺
2074   2                  return 3;
2075   2              }
2076   1              else
2077   1              {
2078   2                  //正
2079   2                  return 1;
2080   2              }
2081   1      }
2082          
2083          //-----------------------------------------------------------------------------
2084          unsigned char isLed_Goods( u_char ledSel )//这个灯对应的商品是否有货1有货,0无货
2085          {
2086   1              u_char xdata i = 0;
2087   1              for( i=0; i<COLUMN_NUM_SET; i++ )
2088   1          {
2089   2              if(GoodsWaySetVal[i].GoodsType == SystemParameter.selItem[ledSel])
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 35  

2090   2              {
2091   3                      if( ( GoodsWaySetVal[i].GoodsCurrentSum > 0 )&&( GoodsWaySetVal[i].Price > 0 )&&(GoodStateLed(i)==1)
             - )
2092   3                      {
2093   4                              return 1;
2094   4                      }
2095   3              }
2096   2              }
2097   1              return 0;
2098   1      }
2099          
2100          unsigned int isLed_Price( u_char ledSel )//这个灯对应的商品是否有货1有货,0无货
2101          {
2102   1              u_char xdata i = 0;
2103   1              for( i=0; i<COLUMN_NUM_SET; i++ )
2104   1          {
2105   2              if(GoodsWaySetVal[i].GoodsType == SystemParameter.selItem[ledSel])
2106   2              {
2107   3                      return GoodsWaySetVal[i].Price;
2108   3              }
2109   2              }       
2110   1      }
2111          
2112          
2113          unsigned char UpdateSelectionLed_GoodsSta( void )
2114          {
2115   1              u_char xdata i = 0;
2116   1      
2117   1          sysVPMission.sel1ErrLed = 0;
2118   1          sysVPMission.sel1ReadyLed = 0;
2119   1              sysVPMission.sel2ErrLed = 0;
2120   1          sysVPMission.sel2ReadyLed = 0;
2121   1              sysVPMission.sel3ErrLed = 0;
2122   1          sysVPMission.sel3ReadyLed = 0;
2123   1      
2124   1              for( i=0; i<KEYEXTRAVAL; i++ )
2125   1          {
2126   2                      if(isLed_Goods(i)==0)
2127   2              {
2128   3                      sysVPMission.sel1ErrLed |= 1<<i;
2129   3              }
2130   2              else
2131   2              {
2132   3                  sysVPMission.sel1ReadyLed |= 1<<i;
2133   3              }
2134   2          }
2135   1          for( i=KEYEXTRAVAL; i<KEYEXTRAVAL*2; i++ )
2136   1          {
2137   2                      if(isLed_Goods(i)==0)
2138   2              {
2139   3                      sysVPMission.sel2ErrLed |= 1<<(i-KEYEXTRAVAL);
2140   3              }
2141   2              else
2142   2              {
2143   3                  sysVPMission.sel2ReadyLed |= 1<<(i-KEYEXTRAVAL);
2144   3              }
2145   2          }
2146   1              for( i=KEYEXTRAVAL*2; i<KEYEXTRAVAL*3; i++ )
2147   1          {
2148   2                      if(isLed_Goods(i)==0)
2149   2              {
2150   3                      sysVPMission.sel3ErrLed |= 1<<(i-KEYEXTRAVAL*2);
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 36  

2151   3              }
2152   2              else
2153   2              {
2154   3                  sysVPMission.sel3ReadyLed |= 1<<(i-KEYEXTRAVAL*2);
2155   3              }
2156   2          }
2157   1      
2158   1          return VP_ERR_NULL;
2159   1      }
2160          
2161          
2162          
2163          /**
2164          * 计算找零方案
2165          * @param in length 数组的长度
2166           
2167          * @param in coins
2168          * @param in lefts
2169           
2170          可找零币种
2171          每种币剩余量
2172           
2173          * @param out results 找零结果（返回结果"成功"时有效）
2174          * @param in money
2175           
2176          * @return
2177           
2178          返回1：成功；返回0：失败
2179           
2180          */
2181          u_char MakeChange2(int length, unsigned char* coins,
2182          unsigned char* lefts, unsigned char* results, int money)
2183          {
2184   1          unsigned char  i=0;
2185   1          unsigned char  count;
2186   1          //printf("allMoney=%d\n", money);
2187   1      
2188   1          for(i=0; i<length; ++i)
2189   1          {
2190   2              unsigned char coin = coins[i];
2191   2              unsigned char left = lefts[i];
2192   2      
2193   2              if(left <= 0 || coin > money)
2194   2              {
2195   3                  continue;
2196   3              }
2197   2              count = money / coin;
2198   2      
2199   2              if(count > left)
2200   2              {
2201   3                  count = left;
2202   3              }
2203   2              lefts[i] = left - count;
2204   2      
2205   2              //printf("%d=%d\n",coin,count);
2206   2              results[i] = count;
2207   2      
2208   2              money -= count*coin;
2209   2              if(money == 0)
2210   2              {
2211   3                  break;
2212   3              }
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 37  

2213   2          }
2214   1      
2215   1          if(money == 0)
2216   1          {
2217   2              return 1;
2218   2          }
2219   1          else
2220   1          {
2221   2              for(i=0; i<length; ++i)
2222   2              {
2223   3                  results[i] = 0;
2224   3              }
2225   2              return 0;
2226   2          }
2227   1      }
2228          
2229          //找零人民币/*找零money元,即3.5元=35(money)*/
2230          u_char changeCNY2(unsigned char* results, u_int money)
2231          {
2232   1          //*可找零硬币面额（人民币角）（面额从大到小）*
2233   1          unsigned char xdata coins[2] = {10, 5};
2234   1          //*每种面额硬币剩余个数 *
2235   1          unsigned char xdata lefts[2] = {0, 0};
2236   1              //u_char xdata len = 0;
2237   1              //u_char xdata str[20];
2238   1              
2239   1              lefts[0] = sysMDBMission.coin1yNum;
2240   1              lefts[1] = sysMDBMission.coin5jNum;
2241   1          //unsigned char xdata results[2] = {0, 0};
2242   1          //len = sprintf( str, "1.1:%u.%02u,%u,%u", money/10,money%10,lefts[0],lefts[1] );
2243   1              //DisplayStr( 0, 0, 1, str, len );
2244   1              //WaitForWork( 5000, NULL );
2245   1          if(MakeChange2(2, coins, lefts, results, money))
2246   1          {
2247   2              
2248   2              //printf("CNY Success\n");
2249   2              //DisplayStr( 0, 0, 1, "1CNY Success",12 );
2250   2                      //WaitForWork( 1000, NULL );
2251   2              return 1;
2252   2          }
2253   1          else
2254   1          {
2255   2              //printf("CNY Fail\n");
2256   2              //DisplayStr( 0, 0, 1, "1CNY Fail",9 );
2257   2                      //WaitForWork( 1000, NULL );
2258   2              return 0;
2259   2          }
2260   1      
2261   1      }
2262          
2263          
2264          //是否可以找零1可找，0不可找
2265          u_char IsCanChange(u_int    Price)
2266          {       
2267   1              u_char xdata mission = 0;
2268   1              u_int  xdata tempPrice;
2269   1              u_char xdata resultdisp[2] = {0, 0};
2270   1      
2271   1              //硬币器故障时只能扣款或购买与暂存纸币等额的商品
2272   1              if( ( sysMDBMission.coinDeviceStatus != 0 )||( sysMDBMission.tubeRemoved == 1 ) )
2273   1              {
2274   2                      if(Price > 0)
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 38  

2275   2                      {
2276   3                              if(Price != (CurrentPayed + sysITLMission.billHoldingValue) )
2277   3                              {
2278   4                                      return 0;
2279   4                              }
2280   3                              else
2281   3                                      return 1;
2282   3                      }
2283   2                      else
2284   2                              return 1;
2285   2              }
2286   1      
2287   1              //硬币器正常时判断
2288   1              if(Price > CurrentPayed)
2289   1              {
2290   2                      tempPrice = Price - CurrentPayed;
2291   2                      if( sysITLMission.billHoldingFlag == 1 )
2292   2                      {
2293   3                              tempPrice = sysITLMission.billHoldingValue - tempPrice;
2294   3                              tempPrice = tempPrice/10;
2295   3                              mission =changeCNY2(resultdisp,tempPrice);
2296   3                              if(mission == 0)        
2297   3                              {                               
2298   4                                      return 0;
2299   4                              }
2300   3                      }
2301   2              }
2302   1              else
2303   1              {               
2304   2                      tempPrice = CurrentPayed - Price;
2305   2                      tempPrice = tempPrice/10;
2306   2                      mission =changeCNY2(resultdisp,tempPrice);
2307   2                      if(mission == 0)                
2308   2                      {                       
2309   3                              return 0;
2310   3                      }
2311   2              }
2312   1              return 1;
2313   1      }
2314          
2315          unsigned char UpdateSelLed_Trade( void )
2316          {   
2317   1          u_char xdata i = 0;
2318   1              u_int  xdata moneyBuf = 0;
2319   1              //uchar xdata flag = 0;
2320   1              //u_char xdata str[20];
2321   1          
2322   1              //----------------------------------------------------------------
2323   1              //2011.5.19 added for the bill holding status judgement
2324   1              if( sysITLMission.billHoldingFlag == 1 )
2325   1              {
2326   2                      moneyBuf = CurrentPayed + sysITLMission.billHoldingValue;
2327   2              }
2328   1              else
2329   1              {
2330   2                  moneyBuf = CurrentPayed;
2331   2              }
2332   1              
2333   1          if( moneyBuf <= 0 )
2334   1              {
2335   2                      return VP_ERR_NULL;     
2336   2              }
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 39  

2337   1          //=================================================================
2338   1      
2339   1          //sysVPMission.sel1ErrLed = 0;
2340   1          sysVPMission.sel1ReadyLed = 0;
2341   1              //sysVPMission.sel2ErrLed = 0;
2342   1          sysVPMission.sel2ReadyLed = 0;
2343   1              //sysVPMission.sel3ErrLed = 0;
2344   1          sysVPMission.sel3ReadyLed = 0;
2345   1              
2346   1      
2347   1              for( i=0; i<KEYEXTRAVAL; i++ )
2348   1          {   
2349   2              if( (isLed_Goods(i)) && ( moneyBuf >= isLed_Price(i) ) )
2350   2              {        
2351   3                      if(IsCanChange(isLed_Price(i)))
2352   3                      {
2353   4                              sysVPMission.sel1ReadyLed |= 1<<i;
2354   4                                      sysVPMission.sel1ErrLed   &= ~(1<<i);
2355   4                      }
2356   3              }
2357   2              //by gzz 20110611 
2358   2              else if(isLed_Goods(i)==0)
2359   2              {
2360   3                      sysVPMission.sel1ErrLed   |= 1<<i;
2361   3                              sysVPMission.sel1ReadyLed &= ~(1<<i);
2362   3              }   
2363   2          }
2364   1              
2365   1          for( i=KEYEXTRAVAL; i<KEYEXTRAVAL*2; i++ )
2366   1          {
2367   2              if( (isLed_Goods(i)) && ( moneyBuf >= isLed_Price(i) ) )
2368   2              {
2369   3                      if(IsCanChange(isLed_Price(i)))
2370   3                      {
2371   4                              sysVPMission.sel2ReadyLed |= 1<<(i-KEYEXTRAVAL);
2372   4                                      sysVPMission.sel2ErrLed   &= ~(1<<(i-KEYEXTRAVAL));
2373   4                      }
2374   3              }
2375   2              //by gzz 20110611 
2376   2              else if(isLed_Goods(i)==0)
2377   2              {
2378   3                      sysVPMission.sel2ErrLed |= 1<<(i-KEYEXTRAVAL);
2379   3                              sysVPMission.sel2ReadyLed &= ~(1<<(i-KEYEXTRAVAL));
2380   3              }
2381   2          }
2382   1      
2383   1              for( i=KEYEXTRAVAL*2; i<KEYEXTRAVAL*3; i++ )
2384   1          {
2385   2              if( (isLed_Goods(i)) && ( moneyBuf >= isLed_Price(i) ) )
2386   2              {
2387   3                      if(IsCanChange(isLed_Price(i)))
2388   3                      {
2389   4                              sysVPMission.sel3ReadyLed |= 1<<(i-KEYEXTRAVAL*2);
2390   4                                      sysVPMission.sel3ErrLed   &= ~(1<<(i-KEYEXTRAVAL*2));
2391   4                      }
2392   3              }
2393   2              //by gzz 20110611 
2394   2              else if(isLed_Goods(i)==0)
2395   2              {
2396   3                      sysVPMission.sel3ErrLed   |= 1<<(i-KEYEXTRAVAL*2);
2397   3                              sysVPMission.sel3ReadyLed &= ~(1<<(i-KEYEXTRAVAL*2));
2398   3              }
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 40  

2399   2          }
2400   1              
2401   1              
2402   1          return VP_ERR_NULL;
2403   1          
2404   1      }
2405          
2406          unsigned char UpdateGoodsMatrixStatus( unsigned char goodsNum )
2407          {
2408   1          u_char xdata i = 0;
2409   1              u_char xdata j = 0;
2410   1              u_char xdata k = 0;
2411   1              u_char xdata oldOne = 0;
2412   1              u_char xdata position = 0;
2413   1              
2414   1              goodsNum=1;
2415   1              /*
2416   1              //-------------------------------------------------------------------------------------------------------
             -------------
2417   1              //Update the information for vending
2418   1              if( goodsNum == 0xff )
2419   1              {
2420   1                      for( i=0; i<GOODSTYPEMAX; i++)
2421   1                      {
2422   1                          //-------------------------------------------------
2423   1                          //oldOne = sysGoodsMatrix[i].NextColumn;
2424   1                              oldOne = sysGoodsMatrix[i].ColumnMatrix[0];
2425   1                              for( k=0; k<sysGoodsMatrix[i].ColumnNum; k++ )
2426   1                              {
2427   1                                      if( sysGoodsMatrix[i].NextColumn == sysGoodsMatrix[i].ColumnMatrix[k] )
2428   1                                      {
2429   1                                              oldOne = k;
2430   1                                              break;
2431   1                                      }
2432   1                              }
2433   1                              //=================================================
2434   1                              if( oldOne >= sysGoodsMatrix[i].ColumnNum-1 )
2435   1                              {
2436   1                                  //1.find in all stage
2437   1                                      sysGoodsMatrix[i].NextColumn = 0xff;
2438   1                                      for( j=0; j<sysGoodsMatrix[i].ColumnNum; j++)
2439   1                                      {
2440   1                                          k = sysGoodsMatrix[i].ColumnMatrix[j];
2441   1                                              if( /*(GoodsWaySetVal[k].Price > 0) && *n/(GoodsWaySetVal[k].GoodsCurrentSum > 0) && (GoodsWaySetVal[
             -k].WayState & 0x01) && ( (GoodsWaySetVal[k].WayState & 0x0A ) == 0x00 ) )  //0x01, 0x02
2442   1                                              {
2443   1                                                      sysGoodsMatrix[i].NextColumn = k;
2444   1                                                      break;
2445   1                                              }
2446   1                                      }       
2447   1                              }
2448   1                              else
2449   1                              {
2450   1                                  //2.find in ascending order stage
2451   1                                      sysGoodsMatrix[i].NextColumn = 0xff;
2452   1                                      position = oldOne+1;
2453   1                                      for( j=position; j<sysGoodsMatrix[i].ColumnNum; j++)
2454   1                                      {
2455   1                                          k = sysGoodsMatrix[i].ColumnMatrix[j];
2456   1                                              if( /*(GoodsWaySetVal[k].Price > 0) && * /(GoodsWaySetVal[k].GoodsCurrentSum > 0) && (GoodsWaySetVal[
             -k].WayState & 0x01) && ( (GoodsWaySetVal[k].WayState & 0x0A ) == 0x00 ) )  //0x01, 0x02
2457   1                                              {
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 41  

2458   1                                                      sysGoodsMatrix[i].NextColumn = k;
2459   1                                                      break;
2460   1                                              }
2461   1                                      }
2462   1                                      //3.find in descending order stage
2463   1                                      if( sysGoodsMatrix[i].NextColumn == GOODS_MATRIX_NONE )
2464   1                                      {
2465   1                                              sysGoodsMatrix[i].NextColumn = 0xff;
2466   1                                              for( j=0; j<sysGoodsMatrix[i].ColumnNum; j++)
2467   1                                              {
2468   1                                                  k = sysGoodsMatrix[i].ColumnMatrix[j];
2469   1                                                      if( /*(GoodsWaySetVal[k].Price > 0) && * /(GoodsWaySetVal[k].GoodsCurrentSum > 0) && (GoodsWaySetVal
             -[k].WayState & 0x01) && ( (GoodsWaySetVal[k].WayState & 0x0A ) == 0x00 ) )  //0x01, 0x02
2470   1                                                      {
2471   1                                                              sysGoodsMatrix[i].NextColumn = k;
2472   1                                                              break;
2473   1                                                      }
2474   1                                              }       
2475   1                                      }
2476   1                              }
2477   1                          
2478   1                      }
2479   1                      
2480   1          }
2481   1      
2482   1              //
2483   1              if( (goodsNum>=0)&&(goodsNum<GOODSTYPEMAX) )
2484   1              {    
2485   1                  i = goodsNum;
2486   1                      //-------------------------------------------------
2487   1                  //oldOne = sysGoodsMatrix[i].NextColumn;
2488   1                      oldOne = sysGoodsMatrix[i].ColumnMatrix[0];
2489   1                      for( k=0; k<sysGoodsMatrix[i].ColumnNum; k++ )
2490   1                      {
2491   1                              if( sysGoodsMatrix[i].NextColumn == sysGoodsMatrix[i].ColumnMatrix[k] )
2492   1                              {
2493   1                                      oldOne = k;
2494   1                                      break;
2495   1                              }
2496   1                      }
2497   1                      //=================================================
2498   1                      if( oldOne >= sysGoodsMatrix[i].ColumnNum-1 )
2499   1                      {
2500   1                          //1.find in all stage
2501   1                              sysGoodsMatrix[i].NextColumn = 0xff;
2502   1                              for( j=0; j<sysGoodsMatrix[i].ColumnNum; j++)
2503   1                              {
2504   1                                  k = sysGoodsMatrix[i].ColumnMatrix[j];
2505   1                                      if( /*(GoodsWaySetVal[k].Price > 0) && * /(GoodsWaySetVal[k].GoodsCurrentSum > 0) && (GoodsWaySetVal[k
             -].WayState & 0x01) && ( (GoodsWaySetVal[k].WayState & 0x0A ) == 0x00 ) )  //0x01, 0x02
2506   1                                      {
2507   1                                              sysGoodsMatrix[i].NextColumn = k;
2508   1                                              break;
2509   1                                      }
2510   1                              }       
2511   1                      }
2512   1                      else
2513   1                      {
2514   1                          //2.find in ascending order stage
2515   1                              sysGoodsMatrix[i].NextColumn = 0xff;
2516   1                              position = oldOne+1;
2517   1                              for( j=position; j<sysGoodsMatrix[i].ColumnNum; j++)
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 42  

2518   1                              {
2519   1                                  k = sysGoodsMatrix[i].ColumnMatrix[j];
2520   1                                      if( /*(GoodsWaySetVal[k].Price > 0) && * /(GoodsWaySetVal[k].GoodsCurrentSum > 0) && (GoodsWaySetVal[k
             -].WayState & 0x01) && ( (GoodsWaySetVal[k].WayState & 0x0A ) == 0x00 ) )  //0x01, 0x02
2521   1                                      {
2522   1                                              sysGoodsMatrix[i].NextColumn = k;
2523   1                                              break;
2524   1                                      }
2525   1                              }
2526   1                              //3.find in descending order stage
2527   1                              if( sysGoodsMatrix[i].NextColumn == GOODS_MATRIX_NONE )
2528   1                              {
2529   1                                      sysGoodsMatrix[i].NextColumn = 0xff;
2530   1                                      for( j=0; j<sysGoodsMatrix[i].ColumnNum; j++)
2531   1                                      {
2532   1                                          k = sysGoodsMatrix[i].ColumnMatrix[j];
2533   1                                              if( /*(GoodsWaySetVal[k].Price > 0) && * /(GoodsWaySetVal[k].GoodsCurrentSum > 0) && (GoodsWaySetVal[
             -k].WayState & 0x01) && ( (GoodsWaySetVal[k].WayState & 0x0A ) == 0x00 ) )  //0x01, 0x02
2534   1                                              {
2535   1                                                      sysGoodsMatrix[i].NextColumn = k;
2536   1                                                      break;
2537   1                                              }
2538   1                                      }       
2539   1                              }
2540   1                      }
2541   1                      //--------------------------------------------------------------------------------------
2542   1                      for( i=0; i<GOODSTYPEMAX; i++ )
2543   1                  {
2544   1                      if( sysGoodsMatrix[i].GoodsType == sysGoodsMatrix[goodsNum].GoodsType )
2545   1                              {
2546   1                                      sysGoodsMatrix[i].NextColumn = sysGoodsMatrix[goodsNum].NextColumn;
2547   1                                      //
2548   1                              }
2549   1                  }
2550   1              }
2551   1          //------------------------------------------------------------------------------------------
2552   1          /*
2553   1              for( i=0; i<GOODSTYPEMAX-1; i++ )
2554   1              {
2555   1                      for( j=i+1; j<GOODSTYPEMAX; j++ )
2556   1                      {
2557   1                              if( sysGoodsMatrix[i].GoodsType == sysGoodsMatrix[j].GoodsType )
2558   1                              {
2559   1                      if( sysGoodsMatrix[i].NextColumn != GOODS_MATRIX_NONE )
2560   1                      {
2561   1                                              sysGoodsMatrix[j].NextColumn = sysGoodsMatrix[i].NextColumn;
2562   1                                        //sysGoodsMatrix[j].ColumnNum  = sysGoodsMatrix[i].ColumnNum;
2563   1                      }
2564   1                      else if( sysGoodsMatrix[j].NextColumn != GOODS_MATRIX_NONE )
2565   1                      {
2566   1                          sysGoodsMatrix[i].NextColumn = sysGoodsMatrix[j].NextColumn;
2567   1                      }
2568   1                              }
2569   1                      }
2570   1              }
2571   1          * /
2572   1          
2573   1          //------------------------------------------------------------------------------------------
2574   1              for( i=0; i<GOODSTYPEMAX; i++)
2575   1              {
2576   1                      //Trace("\n sysGoodsMatrix[%bu].GoodsType = %u", i, sysGoodsMatrix[i].GoodsType );
2577   1                      //Trace("\n sysGoodsMatrix[%bu].ColumnNumber = %bu", i, sysGoodsMatrix[i].ColumnNumber );
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 43  

2578   1                      //Trace("\n sysGoodsMatrix[%bu].NextColumn = %u", i, sysGoodsMatrix[i].NextColumn );
2579   1                      for( j=0; j<sysGoodsMatrix[i].ColumnNum; j++ )
2580   1                      {
2581   1                              //Trace("\n sysGoodsMatrix[%bu].ColumnMatrix[%bu] = %u", i, j, sysGoodsMatrix[i].ColumnMatrix[j] );
2582   1                      }
2583   1              }
2584   1          */
2585   1          //Update the selection led status
2586   1              //2011.5.19 added judgement for the trade mode
2587   1          if( (CurrentPayed+sysITLMission.billHoldingValue) == 0 )
2588   1              {
2589   2                      UpdateSelectionLed_GoodsSta();
2590   2              }
2591   1          return VP_ERR_NULL;
2592   1      }
2593          
2594          unsigned char VP_Update_ColumnGoodsPar( void )
2595          {
2596   1          unsigned char i = 0;
2597   1              unsigned char j = 0;
2598   1              u_int  tempMoney = 0;
2599   1              //DisplayStr( 0, 0, 1, "1", 1 );  
2600   1              //WaitForWork(2000,NULL);
2601   1              //1.配置商品price
2602   1              if( sysVPMission.receive.datLen <= 124*2+1)
2603   1              {
2604   2                      
2605   2                      if( sysVPMission.receive.verFlag & VP_PROTOCOL_ACK )
2606   2                      {
2607   3                              VPMsgPackSend( VP_ACK_RPT, 0, 0 );
2608   3                      }
2609   2      
2610   2                      //----------------------------------
2611   2                      //      1...                      n
2612   2                      //SP1_Price...Sn_Price
2613   2                      sysVPMission.GoodsRev = (sysVPMission.receive.datLen - 1) / 2;  
2614   2                      for( i=0,  j=1; i<sysVPMission.GoodsRev; i++, j+=2 )
2615   2                      {
2616   3                              GoodsType[i] = i+1;                     
2617   3                              if((sysVPMission.receive.msg[j]*256+sysVPMission.receive.msg[j+1])>=6550)
2618   3                              {
2619   4                                      Price[i]  = 65000;
2620   4                              }
2621   3                              else
2622   3                              {       
2623   4                                      if(Price[i]  != MoneyRec(sysVPMission.receive.msg[j],sysVPMission.receive.msg[j+1]))
2624   4                                              Price[i]  = MoneyRec(sysVPMission.receive.msg[j],sysVPMission.receive.msg[j+1]);                                
2625   4                              }
2626   3                              //sysVPMission.selItem[i]       = sysGoodsMatrix[i].GoodsType;
2627   3                              sysVPMission.selPrice[i] = Price[i];  
2628   3                              if(sysVPMission.selPrice[i] >= tempMoney)
2629   3                              {
2630   4                                      tempMoney = sysVPMission.selPrice[i];
2631   4                                      SystemParameter.BanknoteMax = sysVPMission.selPrice[i];
2632   4                              }
2633   3                      }       
2634   2                      
2635   2                      sysVPMission.sysStatus |= VPM_STA_GOODSPAR;     
2636   2              }
2637   1              else
2638   1              {
2639   2                      VPMsgPackSend( VP_NAK_RPT, 0, 0  );  //1, 0
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 44  

2640   2                      return VP_ERR_PAR;
2641   2              }
2642   1              
2643   1              //2.Update the storage status
2644   1          for( i=0; i<COLUMN_NUM_SET; i++ )
2645   1              {
2646   2              //GoodsWaySetVal[i].WayState = 0x01;  //Clear the error status 
2647   2                      if( GoodsWaySetVal[i].GoodsCurrentSum > 0 )
2648   2                      {
2649   3                          GoodsWaySetVal[i].WayState = 0x01;
2650   3                      }               
2651   2                      GoodsWaySetVal[j].Price = 0;//所有货道单价都设为0
2652   2              }
2653   1              //DisplayStr( 0, 0, 1, "2", 1 );  
2654   1              //WaitForWork(2000,NULL);
2655   1              //2.Update the goods matrix and column's price
2656   1              //for( i=0; i<GOODSTYPEMAX; i++ )
2657   1              //{
2658   1              //    sysGoodsMatrix[i].ColumnNum = 0;
2659   1              //}
2660   1              //3.
2661   1              for( j=0; j<COLUMN_NUM_SET; j++)
2662   1              {
2663   2                      for( i=0; i<sysVPMission.GoodsRev; i++ )
2664   2                      {                   
2665   3                              if( GoodsWaySetVal[j].GoodsType == GoodsType[i] )
2666   3                              {
2667   4                      //sysGoodsMatrix[i].ColumnMatrix[sysGoodsMatrix[i].ColumnNum++] = j;
2668   4                                      //if(sysGoodsMatrix[i].Price>=65535)
2669   4                                      //{
2670   4                                      //      GoodsWaySetVal[j].Price = 0;
2671   4                                      //}
2672   4                                      //else
2673   4                                      //{
2674   4                                      GoodsWaySetVal[j].Price = Price[i];
2675   4                                      //}
2676   4                                      break;
2677   4                              }
2678   3                      }
2679   2              }
2680   1              //DisplayStr( 0, 0, 1, "3", 1 );  
2681   1              //WaitForWork(2000,NULL);
2682   1              /*
2683   1              for( i=0; i<sysVPMission.GoodsRev; i++ )
2684   1              {
2685   1                  sysGoodsMatrix[i].ColumnNum = 0;
2686   1                      for( j=0; j<COLUMN_NUM_SET; j++)
2687   1                      {
2688   1                              if( GoodsWaySetVal[j].GoodsType == sysGoodsMatrix[i].GoodsType )
2689   1                              {
2690   1                      sysGoodsMatrix[i].ColumnMatrix[sysGoodsMatrix[i].ColumnNum++] = j;
2691   1                                      //GoodsWaySetVal[j].Price = sysGoodsMatrix[i].Price;
2692   1                              }
2693   1                      }
2694   1              }
2695   1              */
2696   1              
2697   1              //3.Update goods matirx trade status
2698   1              UpdateGoodsMatrixStatus( 0xff );
2699   1          //4.Update flash status
2700   1          //-------------------------------------------------------------------
2701   1          //SaveGoodsSet();
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 45  

2702   1          //SaveGoodsParSet();
2703   1          //===================================================================
2704   1              return VP_ERR_NULL;
2705   1      }       
2706          /*{
2707              unsigned char i = 0;
2708                  unsigned char j = 0;
2709          
2710                  //1.Update the storage status
2711              for( i=0; i<COLUMN_NUM_SET; i++ )
2712                  {
2713                  //GoodsWaySetVal[i].WayState = 0x01;  //Clear the error status 
2714                          if( GoodsWaySetVal[i].GoodsCurrentSum > 0 )
2715                          {
2716                              GoodsWaySetVal[i].WayState &= 0xFB;
2717                          }
2718                          else
2719                          {
2720                                  GoodsWaySetVal[i].WayState |= 0x04;
2721                          }
2722                  }
2723                  //2.Update the goods matrix and column's price
2724                  for( i=0; i<GOODSTYPEMAX; i++ )
2725                  {
2726                      sysGoodsMatrix[i].ColumnNum = 0;
2727                          for( j=0; j<COLUMN_NUM_SET; j++)
2728                          {
2729                                  if( GoodsWaySetVal[j].GoodsType == sysGoodsMatrix[i].GoodsType )
2730                                  {
2731                          sysGoodsMatrix[i].ColumnMatrix[sysGoodsMatrix[i].ColumnNum++] = j;
2732                                          GoodsWaySetVal[j].Price = sysGoodsMatrix[i].Price;
2733                                  }
2734                          }
2735                  }
2736                  //3.Update goods matirx trade status
2737                  UpdateGoodsMatrixStatus( 0xff );
2738              //4.Update flash status
2739              //-------------------------------------------------------------------
2740              //SaveGoodsSet();
2741              //SaveGoodsParSet();
2742              //===================================================================
2743                  return VP_ERR_NULL;
2744          }*/
2745          //=======================================================================
2746          
2747          //-----------------------------------------------------------------------
2748          //VMC--PC command mission
2749          
2750          //120419 by cq TotalSell
2751          unsigned char VPMission_Startup_RPT_1( void )
2752          {
2753   1          unsigned char retry = 0;
2754   1              unsigned char i = 0;
2755   1              unsigned char flag = 0;
2756   1      
2757   1          retry = VP_COM_RETRY;
2758   1      TAB_VPM_STARPT_RETRY:
2759   1              flag = VPMsgPackSend( VP_STARTUP_RPT_1, 1, 1);
2760   1              //flag = VPMsgPackSend( VP_STARTUP_RPT, 1, 1);
2761   1          if( flag != VP_ERR_NULL )
2762   1          {
2763   2                      return VP_ERR_PAR;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 46  

2764   2              }
2765   1              sysVPMission.msTimer2 = VP_TIME_OUT;
2766   1              while( sysVPMission.msTimer2 )
2767   1              {
2768   2                      if( VPBusFrameUnPack() )
2769   2                      {
2770   3                          sysVPMission.comErrNum = 0;
2771   3                              goto TAB_VPM_STARPT_COM_OK;
2772   3                      }
2773   2              }
2774   1              
2775   1              //if( retry-- )//120419 by cq TotalSell 
2776   1              if(0)
2777   1              {
2778   2                      goto TAB_VPM_STARPT_RETRY;
2779   2              }
2780   1              else
2781   1              {
2782   2                      sysVPMission.comErrNum++;
2783   2                      //
2784   2              return VP_ERR_COM;
2785   2              }
2786   1      TAB_VPM_STARPT_COM_OK:
2787   1          switch( sysVPMission.receive.msgType )
2788   1              {
2789   2                      default:
2790   2                          break;
2791   2              }
2792   1              return VP_ERR_NULL;
2793   1      }
2794          
2795          
2796          unsigned char VPMission_Startup_RPT( void )
2797          {
2798   1          unsigned char retry = 0;
2799   1              unsigned char i = 0;
2800   1              unsigned char flag = 0;
2801   1      
2802   1          retry = VP_COM_RETRY;
2803   1      TAB_VPM_STARPT_RETRY:
2804   1              flag = VPMsgPackSend( VP_STARTUP_RPT, 1, 1);
2805   1          if( flag != VP_ERR_NULL )
2806   1          {
2807   2                      return VP_ERR_PAR;
2808   2              }
2809   1              sysVPMission.msTimer2 = VP_TIME_OUT;
2810   1              while( sysVPMission.msTimer2 )
2811   1              {
2812   2                      if( VPBusFrameUnPack() )
2813   2                      {
2814   3                          sysVPMission.comErrNum = 0;
2815   3                              goto TAB_VPM_STARPT_COM_OK;
2816   3                      }
2817   2              }
2818   1              if( retry-- )
2819   1              {
2820   2                      goto TAB_VPM_STARPT_RETRY;
2821   2              }
2822   1              else
2823   1              {
2824   2                      sysVPMission.comErrNum++;
2825   2                      //
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 47  

2826   2              return VP_ERR_COM;
2827   2              }
2828   1      TAB_VPM_STARPT_COM_OK:
2829   1          switch( sysVPMission.receive.msgType )
2830   1              {
2831   2                      default:
2832   2                          break;
2833   2              }
2834   1              return VP_ERR_NULL;
2835   1      }
2836          
2837          unsigned char VPMission_Setup_RPT( void )
2838          {
2839   1          unsigned char retry = 0;
2840   1              unsigned char i = 0;
2841   1              unsigned char flag = 0;
2842   1      
2843   1          retry = VP_COM_RETRY;
2844   1      TAB_VPM_SETUP_RETRY:
2845   1          //-------------------------------------------
2846   1              //Fixed by VMC or controlled by PC?
2847   1          //sysVPMission.proVer = VP_PRO_VER;
2848   1              sysVPMission.columnNumSet = COLUMN_NUM_SET;
2849   1              #ifdef   _SHUPING_
2850   1                      sysVPMission.selectionNumSet = 0;
2851   1              #else
                              sysVPMission.selectionNumSet = GOODSTYPEMAX;
                      #endif
2854   1              
2855   1              //Added the machine VER
2856   1          //sysVPMission.send.msg[3] = VP_MAC_SET_H;
2857   1          //sysVPMission.send.msg[4] = VP_MAC_SET_L;
2858   1              //===========================================
2859   1              flag = VPMsgPackSend( VP_VMC_SETUP, 1, 1);
2860   1              //DisplayStr( 0, 0, 1, "2", 1 );  
2861   1              //WaitForWork(2000,NULL);
2862   1          if( flag != VP_ERR_NULL )
2863   1          {
2864   2                      return VP_ERR_PAR;
2865   2              }
2866   1              sysVPMission.msTimer2 = VP_TIME_OUT;
2867   1              while( sysVPMission.msTimer2 )
2868   1              {
2869   2                      //DisplayStr( 0, 0, 1, "3", 1 );  
2870   2                      WaitForWork(1000,NULL);
2871   2                      if( VPBusFrameUnPack() )
2872   2                      {
2873   3                              //DisplayStr( 0, 0, 1, "4", 1 );  
2874   3                              //WaitForWork(2000,NULL);
2875   3                          sysVPMission.comErrNum = 0;
2876   3                              goto TAB_VPM_SETUP_COM_OK;
2877   3                      }
2878   2              }
2879   1              if( retry-- )
2880   1              {
2881   2                      goto TAB_VPM_SETUP_RETRY;
2882   2              }
2883   1              else
2884   1              {
2885   2                      sysVPMission.comErrNum++;
2886   2                      //
2887   2              return VP_ERR_COM;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 48  

2888   2              }
2889   1      TAB_VPM_SETUP_COM_OK:
2890   1          switch( sysVPMission.receive.msgType )
2891   1              {
2892   2                      default:
2893   2                          break;
2894   2              }
2895   1              return VP_ERR_NULL;
2896   1      }
2897          
2898          
2899          unsigned char VPMission_Payin_RPT( unsigned char dev, unsigned int money )
2900          {
2901   1          unsigned char retry = 0;
2902   1              unsigned char i = 0;
2903   1              unsigned char flag = 0;
2904   1      
2905   1              if(sysVPMission.offLineFlag == 1)
2906   1              {               
2907   2                      return VP_ERR_NULL;
2908   2              }
2909   1              //
2910   1          retry = VP_COM_RETRY;
2911   1      //TAB_VPM_PAYIN_RETRY:
2912   1          //-------------------------------------------
2913   1          sysVPMission.payInDev = dev;
2914   1              sysVPMission.payInMoney = money;
2915   1              //===========================================
2916   1              flag = VPMsgPackSend( VP_PAYIN_RPT, 0, 1);
2917   1          if( flag != VP_ERR_NULL )
2918   1          {
2919   2                      return VP_ERR_PAR;
2920   2              }
2921   1              /*
2922   1              sysVPMission.msTimer2 = VP_TIME_OUT;
2923   1              while( sysVPMission.msTimer2 )
2924   1              {
2925   1                      if( VPBusFrameUnPack() )
2926   1                      {                       
2927   1                          sysVPMission.comErrNum = 0;
2928   1                              if(sysVPMission.offLineFlag == 1)
2929   1                              {
2930   1                                      sysVPMission.offLineFlag = 0;
2931   1                                      VPMission_Act_RPT(VP_ACT_ONLINE,0);
2932   1                              }
2933   1                              goto TAB_VPM_PAYIN_COM_OK;
2934   1                      }
2935   1              }
2936   1              if( retry-- )
2937   1              {
2938   1                      goto TAB_VPM_PAYIN_RETRY;
2939   1              }
2940   1              else
2941   1              {
2942   1                      sysVPMission.comErrNum++;
2943   1                      //-----------------------------------
2944   1                      //3 次PC仍无响应，则跳过该消息，同时打印“PAYIN_RPT Err, device=类型,val=金额”
2945   1                      if((  sysVPMission.comErrNum >= VP_TIME_OUNT_NUM )&&(sysVPMission.offLineFlag != 1) )
2946   1                      {
2947   1                              sysVPMission.offLineFlag = 1;
2948   1                      }
2949   1              
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 49  

2950   1              return VP_ERR_COM;
2951   1              }
2952   1      TAB_VPM_PAYIN_COM_OK:
2953   1          switch( sysVPMission.receive.msgType )
2954   1              {
2955   1                      default:
2956   1                          break;
2957   1              }
2958   1              */
2959   1              return VP_ERR_NULL;
2960   1      }
2961          
2962          
2963          unsigned char VPMission_Payout_RPT( unsigned char dev, unsigned int money1, unsigned int money2 )
2964          {
2965   1          unsigned char retry = 0;
2966   1              unsigned char i = 0;
2967   1              unsigned char flag = 0;
2968   1      
2969   1              if(sysVPMission.offLineFlag == 1)
2970   1              {
2971   2                      return VP_ERR_NULL;
2972   2              }
2973   1              //
2974   1          retry = VP_COM_RETRY;
2975   1      TAB_VPM_PAYOUT_RETRY:
2976   1          //-------------------------------------------
2977   1          sysVPMission.payOutDev = dev;
2978   1              sysVPMission.payOutMoney1 = money1;
2979   1              sysVPMission.payOutMoney2 = money2;
2980   1              //===========================================
2981   1              flag = VPMsgPackSend( VP_PAYOUT_RPT, 1, 1);
2982   1          if( flag != VP_ERR_NULL )
2983   1          {
2984   2                      return VP_ERR_PAR;
2985   2              }
2986   1              sysVPMission.msTimer2 = VP_TIME_OUT;
2987   1              while( sysVPMission.msTimer2 )
2988   1              {
2989   2                      if( VPBusFrameUnPack() )
2990   2                      {
2991   3                          sysVPMission.comErrNum = 0;
2992   3                              if(sysVPMission.offLineFlag == 1)
2993   3                              {
2994   4                                      sysVPMission.offLineFlag = 0;
2995   4                                      VPMission_Act_RPT(VP_ACT_ONLINE,0);
2996   4                              }
2997   3                              goto TAB_VPM_PAYOUT_COM_OK;
2998   3                      }
2999   2              }
3000   1              if( retry-- )
3001   1              {
3002   2                      goto TAB_VPM_PAYOUT_RETRY;
3003   2              }
3004   1              else
3005   1              {
3006   2                      sysVPMission.comErrNum++;
3007   2                      //-----------------------------------
3008   2                      //?
3009   2              if((  sysVPMission.comErrNum >= VP_TIME_OUNT_NUM )&&(sysVPMission.offLineFlag != 1) )
3010   2                      {
3011   3                              sysVPMission.offLineFlag = 1;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 50  

3012   3                      }
3013   2              return VP_ERR_COM;
3014   2              }
3015   1      TAB_VPM_PAYOUT_COM_OK:
3016   1          switch( sysVPMission.receive.msgType )
3017   1              {
3018   2                      default:
3019   2                          break;
3020   2              }
3021   1              return VP_ERR_NULL;
3022   1      }
3023          
3024          
3025          unsigned char VPMission_Payout_RPTNOACK( unsigned char dev, unsigned int money1, unsigned int money2 )
3026          {
3027   1          unsigned char retry = 0;
3028   1              unsigned char i = 0;
3029   1              unsigned char flag = 0;
3030   1      
3031   1              if(sysVPMission.offLineFlag == 1)
3032   1              {
3033   2                      return VP_ERR_NULL;
3034   2              }
3035   1              //
3036   1          retry = VP_COM_RETRY;
3037   1      //TAB_VPM_PAYOUT_RETRY:
3038   1          //-------------------------------------------
3039   1          sysVPMission.payOutDev = dev;
3040   1              sysVPMission.payOutMoney1 = money1;
3041   1              sysVPMission.payOutMoney2 = money2;
3042   1              //===========================================
3043   1              flag = VPMsgPackSend( VP_PAYOUT_RPT, 0, 1);
3044   1          if( flag != VP_ERR_NULL )
3045   1          {
3046   2                      return VP_ERR_PAR;
3047   2              }
3048   1              /*
3049   1              sysVPMission.msTimer2 = VP_TIME_OUT;
3050   1              while( sysVPMission.msTimer2 )
3051   1              {
3052   1                      if( VPBusFrameUnPack() )
3053   1                      {
3054   1                          sysVPMission.comErrNum = 0;
3055   1                              if(sysVPMission.offLineFlag == 1)
3056   1                              {
3057   1                                      sysVPMission.offLineFlag = 0;
3058   1                                      VPMission_Act_RPT(VP_ACT_ONLINE,0);
3059   1                              }
3060   1                              goto TAB_VPM_PAYOUT_COM_OK;
3061   1                      }
3062   1              }
3063   1              if( retry-- )
3064   1              {
3065   1                      goto TAB_VPM_PAYOUT_RETRY;
3066   1              }
3067   1              else
3068   1              {
3069   1                      sysVPMission.comErrNum++;
3070   1                      //-----------------------------------
3071   1                      //?
3072   1              if((  sysVPMission.comErrNum >= VP_TIME_OUNT_NUM )&&(sysVPMission.offLineFlag != 1) )
3073   1                      {
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 51  

3074   1                              sysVPMission.offLineFlag = 1;
3075   1                      }
3076   1              return VP_ERR_COM;
3077   1              }
3078   1      TAB_VPM_PAYOUT_COM_OK:
3079   1          switch( sysVPMission.receive.msgType )
3080   1              {
3081   1                      default:
3082   1                          break;
3083   1              }
3084   1              */
3085   1              return VP_ERR_NULL;
3086   1      }
3087          
3088          
3089          //发送pc扣款后金额;by gzz 20110823
3090          unsigned char VPMission_Cost_RPT( unsigned char dev, unsigned int money,unsigned char type )
3091          {
3092   1          unsigned char retry = 0;
3093   1              unsigned char i = 0;
3094   1              unsigned char flag = 0;
3095   1      
3096   1              if(sysVPMission.offLineFlag == 1)
3097   1              {
3098   2                      return VP_ERR_NULL;
3099   2              }
3100   1              //
3101   1          retry = VP_COM_RETRY;
3102   1      TAB_VPM_COST_RETRY:  
3103   1          //-------------------------------------------
3104   1          sysVPMission.costDev = dev;
3105   1              sysVPMission.costMoney = money;
3106   1          sysVPMission.costType = type;
3107   1              //全部扣款
3108   1              SellAccumulateMoney(&TradeCounter.vpSuccessMoney,sysVPMission.costMoney);
3109   1              //现金出货
3110   1              SellAccumulateMoney(&TradeCounter.vpCashMoney,sysVPMission.costMoney);
3111   1              //累计销售
3112   1              //SellAccumulateMoney(&TradeCounter.TotalSellMoeny,sysVPMission.costMoney);     
3113   1              //===========================================
3114   1              flag = VPMsgPackSend( VP_COST_RPT, 1, 1);
3115   1          if( flag != VP_ERR_NULL )
3116   1          {
3117   2                      return VP_ERR_PAR;
3118   2              }
3119   1              sysVPMission.msTimer2 = VP_TIME_OUT;
3120   1              while( sysVPMission.msTimer2 )
3121   1              {
3122   2                      if( VPBusFrameUnPack() )
3123   2                      {
3124   3                          sysVPMission.comErrNum = 0;
3125   3                              if(sysVPMission.offLineFlag == 1)
3126   3                              {
3127   4                                      sysVPMission.offLineFlag = 0;
3128   4                                      VPMission_Act_RPT(VP_ACT_ONLINE,0);
3129   4                              }
3130   3                              goto TAB_VPM_COST_COM_OK;
3131   3                      }
3132   2              }
3133   1              if( retry-- )
3134   1              {
3135   2                      goto TAB_VPM_COST_RETRY;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 52  

3136   2              }
3137   1              else
3138   1              {
3139   2                      sysVPMission.comErrNum++;
3140   2                      //-----------------------------------
3141   2                      //?
3142   2              if((  sysVPMission.comErrNum >= VP_TIME_OUNT_NUM )&&(sysVPMission.offLineFlag != 1) )
3143   2                      {
3144   3                              sysVPMission.offLineFlag = 1;
3145   3                      }
3146   2              return VP_ERR_COM;
3147   2              }
3148   1      TAB_VPM_COST_COM_OK:
3149   1          switch( sysVPMission.receive.msgType )
3150   1              {
3151   2                      default:
3152   2                          break;
3153   2              }
3154   1              return VP_ERR_NULL;
3155   1      }
3156          
3157          
3158          
3159          
3160          //当上报欠款时，上报pc端;by gzz 20110825
3161          unsigned char VPMission_Debt_RPT( unsigned char type, unsigned char dev, unsigned int money )
3162          {
3163   1              
3164   1      
3165   1          unsigned char retry = 0;
3166   1              unsigned char i = 0;
3167   1              unsigned char flag = 0;
3168   1          
3169   1              //
3170   1          retry = VP_COM_RETRY;
3171   1      //TAB_VPM_DEBT_RETRY:  
3172   1          //-------------------------------------------
3173   1          sysVPMission.debtType = type;
3174   1          sysVPMission.debtDev = dev;
3175   1              sysVPMission.debtMoney = money;
3176   1              //===========================================
3177   1              //flag = VPMsgPackSend( VP_DEBT_RPT, 0, 1);//120419 by cq TotalSell
3178   1          if( flag != VP_ERR_NULL )
3179   1          {
3180   2                      return VP_ERR_PAR;
3181   2              }       
3182   1              return VP_ERR_NULL;
3183   1              
3184   1      }
3185          
3186          
3187          //120521 by cq SellAccumulate
3188          void SellAccumulateNum(unsigned long * ul_num)
3189          {
3190   1              (*ul_num)++;
3191   1              if(*ul_num >= 100000)
3192   1                      *ul_num -= 100000;
3193   1      }
3194          
3195          //120521 by cq SellAccumulate
3196          void SellAccumulateMoney(unsigned long * ul_money, unsigned int ui_cost)
3197          {
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 53  

3198   1              *ul_money += ui_cost;
3199   1              if(*ul_money >= 10000000)
3200   1                      *ul_money -= 10000000;
3201   1      }
3202          
3203          
3204          void changeFailedBeep()
3205          {
3206   1              Beep();
3207   1              WaitForWork(200,NULL);
3208   1              Beep();
3209   1      }
3210          
3211          unsigned char VPMission_Vendout_RPT( unsigned char status, unsigned char column, unsigned char type, unsig
             -ned int cost, unsigned char columnLeft )
3212          {
3213   1          unsigned char retry = 0;
3214   1              unsigned char i = 0;
3215   1              unsigned char flag = 0; 
3216   1      
3217   1              
3218   1              //--------------------------------------------
3219   1              /*
3220   1              #ifndef MACHINE_SET_VMC_PC
3221   1                 return VP_ERR_NULL;
3222   1              #endif
3223   1              */
3224   1          //============================================
3225   1      
3226   1              //120419 by cq TotalSell
3227   1              //120521 by cq SellAccumulate
3228   1              if(status == 0)
3229   1              {
3230   2                      /*
3231   2                      TradeCounter.TotalSellNum++;
3232   2                      if(TradeCounter.TotalSellNum > 9999999)
3233   2                              TradeCounter.TotalSellNum = 0;
3234   2                      
3235   2                      TradeCounter.TotalSellMoeny += cost;
3236   2                      if(TradeCounter.TotalSellMoeny > 999999999)
3237   2                              TradeCounter.TotalSellMoeny = 0;
3238   2                      */
3239   2                      
3240   2                      //累计销售
3241   2                      //SellAccumulateNum(&TradeCounter.TotalSellNum);
3242   2                      //SellAccumulateMoney(&TradeCounter.TotalSellMoeny,cost);
3243   2      
3244   2                      //全部出货
3245   2                      SellAccumulateNum(&TradeCounter.vpSuccessNum);
3246   2                      if(type == 0)
3247   2                      {
3248   3                              SellAccumulateMoney(&TradeCounter.vpSuccessMoney,cost);
3249   3                      }
3250   2      
3251   2                      if(type == 0)//现金出货
3252   2                      {       
3253   3                              SellAccumulateNum(&TradeCounter.vpCashNum);
3254   3                              SellAccumulateMoney(&TradeCounter.vpCashMoney,cost);
3255   3                      }
3256   2                      else if(type == 1)//游戏出货
3257   2                      {
3258   3                              SellAccumulateNum(&TradeCounter.vpGameNum);
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 54  

3259   3                              //SellAccumulateMoney(&TradeCounter.vpGameMoney,cost);
3260   3                      }               
3261   2                      //else if(type == 5 || (type >= 101 && type <= 255))//刷卡出货
3262   2                      else if(type == 5 || type >= 101 )//刷卡出货
3263   2                      {
3264   3                              SellAccumulateNum(&TradeCounter.vpCardNum);
3265   3                              //SellAccumulateMoney(&TradeCounter.vpCardMoney,cost);
3266   3                      }
3267   2                      //else if((type >= 2 && type <= 4) || (type >= 6 && type <= 100))//在线出货
3268   2                      else//在线出货
3269   2                      {
3270   3                              SellAccumulateNum(&TradeCounter.vpOnlineNum);
3271   3                              //SellAccumulateMoney(&TradeCounter.vpOnlineMoney,cost);
3272   3                      }               
3273   2              }
3274   1              else if(status == 2)
3275   1              {
3276   2                      changeFailedBeep();
3277   2                      //离线时不上报
3278   2                      if(sysVPMission.offLineFlag == 0)
3279   2                      {
3280   3                              VP_CMD_GetColumnSta();
3281   3                      }
3282   2              }
3283   1      
3284   1              //离线时不上报
3285   1              if(sysVPMission.offLineFlag == 1)
3286   1              {
3287   2                      return VP_ERR_NULL;
3288   2              }
3289   1          retry = VP_COM_RETRY;
3290   1      TAB_VPM_VENDOUT_RETRY:
3291   1          //-------------------------------------------
3292   1          sysVPMission.vendSta = status;
3293   1              sysVPMission.vendColumn = column+1;
3294   1              sysVPMission.vendType = type;
3295   1              sysVPMission.vendCost = cost;
3296   1              sysVPMission.vendcolumnLeft = columnLeft;
3297   1              
3298   1      
3299   1              
3300   1              //TradeCounter.TotalSellNum = 1234567;//120419 by cq TotalSell
3301   1              //TradeCounter.TotalSellMoeny = 123456789;//120419 by cq TotalSell
3302   1              //TradeCounter.TotalSellNum = 9999997;//120419 by cq TotalSell
3303   1              //TradeCounter.TotalSellMoeny = 999999989;//120419 by cq TotalSell
3304   1              
3305   1              //===========================================
3306   1              flag = VPMsgPackSend( VP_VENDOUT_RPT, 1, 1);
3307   1          if( flag != VP_ERR_NULL )
3308   1          {
3309   2                      return VP_ERR_PAR;
3310   2              }
3311   1              sysVPMission.msTimer2 = VP_TIME_OUT;
3312   1              while( sysVPMission.msTimer2 )
3313   1              {
3314   2                      if( VPBusFrameUnPack() )
3315   2                      {
3316   3                          sysVPMission.comErrNum = 0;
3317   3                              if(sysVPMission.offLineFlag == 1)
3318   3                              {
3319   4                                      sysVPMission.offLineFlag = 0;
3320   4                                      VPMission_Act_RPT(VP_ACT_ONLINE,0);
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 55  

3321   4                              }
3322   3                              goto TAB_VPM_VENDOUT_COM_OK;
3323   3                      }
3324   2              }
3325   1              if( retry-- )
3326   1              {
3327   2                      goto TAB_VPM_VENDOUT_RETRY;
3328   2              }
3329   1              else
3330   1              {
3331   2                      sysVPMission.comErrNum++;
3332   2                      //-----------------------------------
3333   2                      //?
3334   2              if((  sysVPMission.comErrNum >= VP_TIME_OUNT_NUM )&&(sysVPMission.offLineFlag != 1) )
3335   2                      {
3336   3                              sysVPMission.offLineFlag = 1;
3337   3                      }
3338   2              return VP_ERR_COM;
3339   2              }
3340   1      TAB_VPM_VENDOUT_COM_OK:
3341   1          switch( sysVPMission.receive.msgType )
3342   1              {
3343   2                      default:
3344   2                          break;
3345   2              }
3346   1              return VP_ERR_NULL;
3347   1      }
3348          
3349          
3350          unsigned char VPMission_Request( unsigned char type )
3351          {
3352   1          unsigned char retry = 0;
3353   1              unsigned char i = 0;
3354   1              unsigned char flag = 0;
3355   1      
3356   1              if(sysVPMission.offLineFlag == 1)
3357   1              {
3358   2                      return VP_ERR_NULL;
3359   2              }
3360   1          retry = VP_COM_RETRY;
3361   1      TAB_VPM_REQUEST_RETRY:
3362   1          //-------------------------------------------
3363   1          sysVPMission.request = type;
3364   1              //===========================================
3365   1              flag = VPMsgPackSend( VP_REQUEST, 1, 1);
3366   1          if( flag != VP_ERR_NULL )
3367   1          {
3368   2                      return VP_ERR_PAR;
3369   2              }
3370   1              sysVPMission.msTimer2 = VP_TIME_OUT;
3371   1              while( sysVPMission.msTimer2 )
3372   1              {
3373   2                      if( VPBusFrameUnPack() )
3374   2                      {
3375   3                          sysVPMission.comErrNum = 0;
3376   3                              if(sysVPMission.offLineFlag == 1)
3377   3                              {
3378   4                                      sysVPMission.offLineFlag = 0;
3379   4                                      VPMission_Act_RPT(VP_ACT_ONLINE,0);
3380   4                              }
3381   3                              goto TAB_VPM_REQUEST_COM_OK;
3382   3                      }
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 56  

3383   2              }
3384   1              if( retry-- )
3385   1              {
3386   2                      goto TAB_VPM_REQUEST_RETRY;
3387   2              }
3388   1              else
3389   1              {
3390   2                      sysVPMission.comErrNum++;
3391   2                      //-----------------------------------
3392   2                      //?
3393   2              if((  sysVPMission.comErrNum >= VP_TIME_OUNT_NUM )&&(sysVPMission.offLineFlag != 1) )
3394   2                      {
3395   3                              sysVPMission.offLineFlag = 1;
3396   3                      }
3397   2              return VP_ERR_COM;
3398   2              }
3399   1      TAB_VPM_REQUEST_COM_OK:
3400   1          switch( sysVPMission.receive.msgType )
3401   1              {
3402   2                      default:
3403   2                          break;
3404   2              }
3405   1              return VP_ERR_NULL;
3406   1      }
3407          
3408          //unsigned char VPMission_Admin_RPT( unsigned char type, unsigned char column, unsigned char num )
3409          unsigned char VPMission_Admin_RPT( unsigned char type, unsigned char column, unsigned int num )
3410          {
3411   1          unsigned char retry = 0;
3412   1              unsigned char i = 0;
3413   1              unsigned char flag = 0;
3414   1              //u_char xdata str[20];
3415   1              //u_char xdata len = 0;
3416   1      
3417   1              if(sysVPMission.offLineFlag == 1)
3418   1              {
3419   2                      return VP_ERR_NULL;
3420   2              }
3421   1              //
3422   1          retry = VP_COM_RETRY;
3423   1      TAB_VPM_ADMIN_RETRY:
3424   1          //-------------------------------------------
3425   1              if( type == VP_ADMIN_COL_PRICE )    //price
3426   1              {
3427   2                      sysVPMission.ADM_Type   = type;
3428   2                      sysVPMission.ADM_Dat[0] = column;
3429   2                      sysVPMission.ADM_Dat[1] = num/256;
3430   2              sysVPMission.ADM_Dat[2] = num%256;
3431   2              }
3432   1              else  //the single column's goods, all columns' goods, or the tray columns'goods
3433   1              {
3434   2              sysVPMission.ADM_Type   = type;
3435   2                      sysVPMission.ADM_Dat[0] = column;
3436   2                      sysVPMission.ADM_Dat[1] = num;
3437   2              }
3438   1              //===========================================
3439   1              flag = VPMsgPackSend( VP_ADMIN_RPT, 1, 1);
3440   1              //DisplayStr( 0, 0, 1, "01", 2 );  
3441   1              WaitForWork(2000,NULL);
3442   1          if( flag != VP_ERR_NULL )
3443   1          {
3444   2                      return VP_ERR_PAR;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 57  

3445   2              }
3446   1              sysVPMission.msTimer2 = VP_TIME_OUT;
3447   1              while( sysVPMission.msTimer2 )
3448   1              {
3449   2                      //DisplayStr( 0, 0, 1, "02", 2 );  
3450   2                      //WaitForWork(2000,NULL);
3451   2                      if( VPBusFrameUnPack() )
3452   2                      {
3453   3                              //len = sprintf( str, "01:%02bu", sysVPMission.receive.msgType );
3454   3                              //DisplayStr( 0, 0, 1, str, strlen(str) ); 
3455   3                              //WaitForWork(2000,NULL);
3456   3                          sysVPMission.comErrNum = 0;
3457   3                              if(sysVPMission.offLineFlag == 1)
3458   3                              {
3459   4                                      sysVPMission.offLineFlag = 0;
3460   4                                      VPMission_Act_RPT(VP_ACT_ONLINE,0);
3461   4                              }
3462   3                              goto TAB_VPM_ADMIN_COM_OK;
3463   3                      }
3464   2                      //DisplayStr( 0, 0, 1, "04", 2 );  
3465   2                      //WaitForWork(2000,NULL);
3466   2              }
3467   1              if( retry-- )
3468   1              {
3469   2                      goto TAB_VPM_ADMIN_RETRY;
3470   2              }
3471   1              else
3472   1              {
3473   2                      sysVPMission.comErrNum++;
3474   2                      //?
3475   2                      if((  sysVPMission.comErrNum >= VP_TIME_OUNT_NUM )&&(sysVPMission.offLineFlag != 1) )
3476   2                      {
3477   3                              sysVPMission.offLineFlag = 1;
3478   3                      }
3479   2              return VP_ERR_COM;
3480   2              }
3481   1      TAB_VPM_ADMIN_COM_OK:
3482   1          switch( sysVPMission.receive.msgType )
3483   1              {               
3484   2              case VP_NAK:
3485   2                              changeFailedBeep();
3486   2                  return VP_NAK;
3487   2                      break;
3488   2                      case VP_ACK:
3489   2                          return VP_ACK;
3490   2                          break;
3491   2                      case VP_HOUDAO_IND:
3492   2                              //DisplayStr( 0, 0, 1, "2", 1 );  
3493   2                              //WaitForWork(2000,NULL);
3494   2                          VP_CMD_ColumnPar();
3495   2                              //if( sysVPMission.sysStatus & VPM_STA_PCPAROK )
3496   2                              {
3497   3                                      //UpdateGoodsMatrixStatus( 0xff );
3498   3                     // VP_Update_ColumnGoodsPar();
3499   3                              }
3500   2                          break;
3501   2                      case VP_HUODAO_SET_IND: 
3502   2                              //DisplayStr( 0, 0, 1, "02", 2 );  
3503   2                              //WaitForWork(2000,NULL);
3504   2                              VP_CMD_ColumnNo();      
3505   2                              //len = sprintf( str, "1.1:%02bu",sysVPMission.sysStatus);
3506   2                      //DisplayStr( 0, 0, 1, str, strlen(str) ); 
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 58  

3507   2                              //WaitForWork(2000,NULL);
3508   2                              break;  
3509   2                      case VP_POSITION_IND:
3510   2                              //DisplayStr( 0, 0, 1, "4", 1 );  
3511   2                              //WaitForWork(2000,NULL);
3512   2                          VP_CMD_GoodsPos();                  
3513   2                              break;  
3514   2                      case VP_SALEPRICE_IND:
3515   2                              //DisplayStr( 0, 0, 1, "5", 1 );  
3516   2                              //WaitForWork(2000,NULL);
3517   2                              //VP_CMD_GoodsPar();
3518   2                              //if( sysVPMission.sysStatus & VPM_STA_PCPAROK )
3519   2                              {
3520   3                                      //UpdateGoodsMatrixStatus( 0xff );
3521   3                      VP_Update_ColumnGoodsPar();
3522   3                                      SaveGoodsSet();
3523   3                                      WaitForWork( 100, NULL );
3524   3                              }
3525   2                              break;  
3526   2                      default:
3527   2                          break;
3528   2              }
3529   1              return VP_ERR_NULL;
3530   1      
3531   1      }
3532          
3533          
3534          
3535          unsigned char VPMission_Button_RPT( unsigned char type, unsigned char value )
3536          {
3537   1          unsigned char retry = 0;
3538   1              unsigned char i = 0;
3539   1              unsigned char flag = 0;
3540   1      
3541   1              if(sysVPMission.offLineFlag == 1)
3542   1              {
3543   2                      if(type==VP_BUT_GAME)//游戏按键蜂鸣器响;by gzz 20110721
3544   2                  {   
3545   3                      Beep();
3546   3                  }
3547   2                      return VP_ERR_NULL;
3548   2              }
3549   1              //
3550   1          retry = VP_COM_RETRY;
3551   1      //TAB_VPM_BUTTON_RETRY:
3552   1          //-------------------------------------------
3553   1          sysVPMission.BUT_Type   = type;
3554   1              sysVPMission.BUT_Value  = value;
3555   1          if(type==VP_BUT_GAME)//游戏按键蜂鸣器响;by gzz 20110721
3556   1          {  
3557   2              //return VP_ERR_PAR;
3558   2              Beep();
3559   2          }
3560   1              //===========================================
3561   1          //1-0: button message, not need ACK
3562   1              flag = VPMsgPackSend( VP_BUTTON_RPT, 0, 1);   
3563   1          if( flag != VP_ERR_NULL )
3564   1          {
3565   2                      return VP_ERR_PAR;
3566   2              }
3567   1          /*
3568   1              sysVPMission.msTimer2 = VP_TIME_OUT;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 59  

3569   1              while( sysVPMission.msTimer2 )
3570   1              {
3571   1                      if( VPBusFrameUnPack() )
3572   1                      {
3573   1                              goto TAB_VPM_BUTTON_COM_OK;
3574   1                      }
3575   1              }
3576   1              if( retry-- )
3577   1              {
3578   1                      goto TAB_VPM_BUTTON_RETRY;
3579   1              }
3580   1              else
3581   1              {
3582   1                      sysVPMission.comErrNum++;
3583   1                      //-----------------------------------
3584   1                      //?
3585   1              
3586   1              return VP_ERR_COM;
3587   1              }
3588   1      TAB_VPM_BUTTON_COM_OK:
3589   1          switch( sysVPMission.receive.msgType )
3590   1              {
3591   1                      default:
3592   1                          break;
3593   1              }
3594   1          */
3595   1              return VP_ERR_NULL;
3596   1      
3597   1      }
3598          
3599          unsigned char VPMission_Status_RPT( void )
3600          {
3601   1          unsigned char retry = 0;
3602   1              unsigned char i = 0;
3603   1              unsigned char flag = 0;
3604   1              unsigned int data CurrentMoney=0;
3605   1      
3606   1              if(sysVPMission.offLineFlag == 1)
3607   1              {
3608   2                      return VP_ERR_NULL;
3609   2              }
3610   1          retry = VP_COM_RETRY;
3611   1              //------------------------------------------------------
3612   1          //1.硬币器状态cc_st
3613   1              //if( DeviceStatus.CoinAccepter != 0 )
3614   1              if(sysVPMission.billCoinEnable == 0)
3615   1              {
3616   2              sysVPMission.STA_CoinA = 1;
3617   2          }   
3618   1          else if( sysMDBMission.coinDeviceStatus != 0 )
3619   1              {
3620   2              sysVPMission.STA_CoinA = 3;
3621   2          }
3622   1          //币管没关紧，上报故障;by gzz 20110902
3623   1              else if( sysMDBMission.tubeRemoved == 1 )
3624   1              {
3625   2                      sysVPMission.STA_CoinA = 2;
3626   2              }
3627   1              //硬币器其他故障
3628   1              else if(sysMDBMission.coinOthErr != 0)
3629   1              {
3630   2                      sysVPMission.STA_CoinA = 2;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 60  

3631   2              }       
3632   1              else if(sysMDBMission.coinIsEnable == 0)
3633   1              {
3634   2              sysVPMission.STA_CoinA = 1;
3635   2          }   
3636   1              else
3637   1              {
3638   2                      sysVPMission.STA_CoinA = 0;
3639   2              }
3640   1      
3641   1          //2.机器中当前可用于找零的5角硬币量cnt5j
3642   1          //if( DeviceStatus.ChangeUnit1 == 0 )
3643   1          if( ( sysMDBMission.coinDeviceStatus == 0x00 )&&(sysMDBMission.coin5jNum > 0) )
3644   1              sysVPMission.STA_ChangeNum1 = sysMDBMission.coin5jNum;   //VP_STA_CHANGE_ENOUGH;
3645   1          else
3646   1                  sysVPMission.STA_ChangeNum1 = 0;
3647   1      
3648   1          //3.机器中当前可用于找零的1元硬币量cnt1y
3649   1          //if( DeviceStatus.ChangeUnit2 == 0 )
3650   1          if( ( sysMDBMission.coinDeviceStatus == 0x00 )&&(sysMDBMission.coin1yNum > 0) )
3651   1              sysVPMission.STA_ChangeNum2 = sysMDBMission.coin1yNum;   //VP_STA_CHANGE_ENOUGH;
3652   1          else
3653   1                  sysVPMission.STA_ChangeNum2 = 0;
3654   1      
3655   1          //4.纸币器状态bv_st
3656   1              //1. 
3657   1              if( SystemParameter.BillNo == 1 )
3658   1              {
3659   2                  //if( DeviceStatus.BillAccepter == 0 )
3660   2                  if(sysVPMission.billCoinEnable == 0)
3661   2                      {
3662   3                      sysVPMission.STA_BillA = 1;
3663   3                  }   
3664   2                      //钞箱已满
3665   2                      else if(sysMDBMission.billIsFull == 1)
3666   2                      {
3667   3                              sysVPMission.STA_BillA = 2;     
3668   3                      }
3669   2                      else if(sysMDBMission.billCashBuf == 1)//钞箱移除报故障;by gzz 20121224
3670   2                  {
3671   3                              if( sysITLMission.billHoldingFlag == 1 )
3672   3                              {
3673   4                                      CurrentMoney = CurrentPayed + sysITLMission.billHoldingValue;
3674   4                              }
3675   3                              else
3676   3                              {
3677   4                                      CurrentMoney = CurrentPayed;
3678   4                              }
3679   3                              if( (CurrentMoney == 0)&&( sysITLMission.billHoldingFlag == 0 ) )
3680   3                              {
3681   4                                      sysVPMission.STA_BillA = 2;     
3682   4                              }
3683   3                              else
3684   3                              {
3685   4                                      sysVPMission.STA_BillA = 0;     
3686   4                              }                               
3687   3                      }               
3688   2                  else if( sysMDBMission.billDeviceStatus == 0 )
3689   2                      {
3690   3                              if(sysMDBMission.billIsEnable == 0)
3691   3                              {
3692   4                                      sysVPMission.STA_BillA = 1;                     
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 61  

3693   4                              }
3694   3                              else
3695   3                              {
3696   4                                      sysVPMission.STA_BillA = 0;
3697   4                              }
3698   3                  
3699   3                              //sysVPMission.STA_BillCount = 0;//by gzz 20110905
3700   3                      }
3701   2                      //纸币器其他故障
3702   2                      else if(sysMDBMission.billOthErr != 0)
3703   2                      {
3704   3                              sysVPMission.STA_BillA = 2;                     
3705   3                      }
3706   2                      /*
3707   2              //1)如果发现此次纸币器和硬币器同时故障，则全部上报
3708   2              //2)pc轮询时，如果只有纸币器故障，给予累加，只有连续故障次数大于5次时，才上报
3709   2                      //by gzz 20110905
3710   2                      else if(( sysMDBMission.coinDeviceStatus != 0 )||( sysVPMission.STA_BillCount >= 1 ))
3711   2                      {
3712   2                              sysVPMission.STA_BillA = 2;                     
3713   2                      }               
3714   2                      else//by gzz 20110905 
3715   2                      {
3716   2                          sysVPMission.STA_BillA = 0;
3717   2                              sysVPMission.STA_BillCount ++;
3718   2                      }
3719   2                      */
3720   2                      else//by gzz 20110905 
3721   2                      {
3722   3                          sysVPMission.STA_BillA = 3;
3723   3                      }
3724   2              }
3725   1              else
3726   1              {
3727   2                      sysVPMission.STA_BillA = 3;
3728   2              }
3729   1      
3730   1          //5.找零设备状态ch1_st,ch2_st
3731   1              //2.
3732   1          if( SystemParameter.HopperCoinPrice1 > 0 )
3733   1              {
3734   2                      //if( DeviceStatus.ChangeUnit1 == 1 )
3735   2              if( sysMDBMission.coinDeviceStatus != 0 )
3736   2                      {
3737   3                              sysVPMission.STA_Changer1 = 2;
3738   3                      }
3739   2                      //币管没关紧，上报故障;by gzz 20110901
3740   2                      else if( sysMDBMission.tubeRemoved == 1 )
3741   2                      {
3742   3                              sysVPMission.STA_Changer1 = 2;
3743   3                      }
3744   2                      else
3745   2                      {
3746   3                              sysVPMission.STA_Changer1 = 0;
3747   3                      }
3748   2              }
3749   1              else
3750   1              {
3751   2                      sysVPMission.STA_Changer1 = 3;
3752   2              }
3753   1          //
3754   1              if( SystemParameter.HopperCoinPrice2 > 0 )
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 62  

3755   1              {
3756   2                  
3757   2                      //if( DeviceStatus.ChangeUnit2 == 1 )
3758   2              if( sysMDBMission.coinDeviceStatus != 0 )
3759   2                      {
3760   3                              sysVPMission.STA_Changer2 = 2;
3761   3                      }
3762   2                      //币管没关紧，上报故障;by gzz 20110901
3763   2                      else if( sysMDBMission.tubeRemoved == 1 )
3764   2                      {
3765   3                              sysVPMission.STA_Changer2 = 2;
3766   3                      }
3767   2                      else
3768   2                      {
3769   3                              sysVPMission.STA_Changer2 = 0;
3770   3                      }
3771   2      
3772   2              }
3773   1              else
3774   1              {
3775   2                      sysVPMission.STA_Changer2 = 3;
3776   2              }
3777   1          
3778   1          //6.主控器状态vmc_st
3779   1              //只有机器因故障而不能工作后，才上报故障信息;by gzz 20110902
3780   1              //if( HardWareErr == 0 )
3781   1              if(( HardWareErr & 0x0010 )||( HardWareErr & 0x0080 ))
3782   1          {
3783   2                  sysVPMission.STA_VMC = 1;
3784   2              }
3785   1              //else if(( HardWareErr & 0x0020 )||( HardWareErr & 0x0040 )||( HardWareErr & 0x0100 )
3786   1              //         ||( HardWareErr & 0x0200 )||( HardWareErr & 0x1000 )||( HardWareErr & 0x2000 ))
3787   1              else if( HardWareErr != 0)
3788   1          {
3789   2                  sysVPMission.STA_VMC = 2;
3790   2              }
3791   1              else if(sysVPMission.adminType == 1)
3792   1              {
3793   2                      sysVPMission.STA_VMC = 3;
3794   2              }
3795   1          else
3796   1              {
3797   2                      sysVPMission.STA_VMC = 0;
3798   2              }
3799   1              
3800   1              
3801   1              
3802   1          //7.选货1,选货2,选货3状态
3803   1              //sysVPMission.STA_Tep1    = 0x7f;
3804   1          //sysVPMission.STA_Tep2    = 0x7f;
3805   1              if( DeviceStatus.Selection[0] == 0 )
3806   1              {
3807   2                      sysVPMission.STA_Tep1 = 0;
3808   2              }
3809   1              else
3810   1              {
3811   2                      sysVPMission.STA_Tep1 = 2;      
3812   2              }
3813   1          //
3814   1          if( DeviceStatus.Selection[1] == 0 )
3815   1              {
3816   2                      sysVPMission.STA_Tep2 = 0;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 63  

3817   2              }
3818   1              else
3819   1              {
3820   2                      sysVPMission.STA_Tep2 = 2;      
3821   2              }
3822   1          
3823   1              //sysVPMission.STA_Bank   = 3;
3824   1              if( DeviceStatus.Selection[2] == 0 )
3825   1              {
3826   2                      sysVPMission.STA_Tep3 = 0;
3827   2              }
3828   1              else
3829   1              {
3830   2                      sysVPMission.STA_Tep3 = 2;      
3831   2              }
3832   1          
3833   1      
3834   1          
3835   1      
3836   1              //8.出货检测
3837   1              //sysVPMission.STA_ICCard    = 3;
3838   1              if( SystemParameter.GOCOn == 1 )
3839   1              {
3840   2              //只有确认出货检测故障，才发送故障信息给pc端;by cq 20110815
3841   2              /*                  
3842   2              if( DeviceStatus.GOCStatus & 0x01 )
3843   2                      {
3844   2                              sysVPMission.STA_ICCard = 2;
3845   2                      }
3846   2                      else 
3847   2                      {
3848   2                              sysVPMission.STA_ICCard = 0;
3849   2                      } 
3850   2              */
3851   2              if( DeviceStatus.GOCStatus == 0 )
3852   2              {
3853   3                      sysVPMission.STA_ICCard = 0;
3854   3                  sysVPMission.STA_ICCardCount = 0;//by gzz 20111012
3855   3              }
3856   2              else if(( DeviceStatus.GOCStatus & 0x01 )&&( sysVPMission.STA_ICCardCount > 5 ))
3857   2              {
3858   3                              sysVPMission.STA_ICCard = 2;
3859   3                      }
3860   2              else 
3861   2                      {
3862   3                              sysVPMission.STA_ICCard = 0;
3863   3                  sysVPMission.STA_ICCardCount ++;
3864   3                      } 
3865   2              }
3866   1              else
3867   1              {
3868   2                      sysVPMission.STA_ICCard = 1;
3869   2              }
3870   1              /*
3871   1              //8.公交一卡通gj
3872   1              if( SystemParameter.busCardOn == 1 )
3873   1              {
3874   1                  if( DeviceStatus.BusCard == 0 )
3875   1                      {
3876   1                              sysVPMission.STA_Bus = 0;
3877   1                      }
3878   1              else if( DeviceStatus.BusCard & BC_DEV_ERR_BUSY )
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 64  

3879   1              {
3880   1                  sysVPMission.STA_Bus = 1;
3881   1              }
3882   1                      else
3883   1                      {
3884   1                              sysVPMission.STA_Bus = 2;       
3885   1                      }
3886   1              }
3887   1              else
3888   1              {
3889   1                      sysVPMission.STA_Bus = 3;
3890   1              }
3891   1              */
3892   1              //9.货仓1状态
3893   1              if(sysVPMission.ACDCCompressorCtr == 1)
3894   1                      sysVPMission.ESTA_Tem1 = 1;
3895   1              else
3896   1                      sysVPMission.ESTA_Tem1 = 0;
3897   1              //10.货仓1温度tem1
3898   1              if( SystemParameter.ACDCModule == 1 )
3899   1              {
3900   2              if( DeviceStatus.ACDCModule == 0x00 )
3901   2                      {
3902   3                              sysVPMission.E_Tem1 = 0xfd;//0xfd表示温度无意义;by gzz 20110721
3903   3                      }
3904   2                      else
3905   2                      {
3906   3                              sysVPMission.E_Tem1 = 0xff;//故障
3907   3                      }
3908   2              }
3909   1              else
3910   1              {  
3911   2                      sysVPMission.E_Tem1 = 0xfe;//不存在此货仓
3912   2              }
3913   1              //11.货仓2,3,4状态
3914   1              sysVPMission.ESTA_Tem2 = 3;//不存在此货仓
3915   1              //12，货仓2,3,4温度tem2,表示
3916   1              sysVPMission.E_Tem2 = 0xfe;//不存在此货仓
3917   1      
3918   1          //13交易时间
3919   1              sysVPMission.Payout_Time = SystemParameter.tradeTime;
3920   1      
3921   1              //==============================================================
3922   1      //TAB_VPM_STATUS_RETRY:
3923   1          flag = VPMsgPackSend( VP_STATUS_RPT, 0, 1);  //1-0, not need ACK
3924   1          if( flag != VP_ERR_NULL )
3925   1          {
3926   2                      return VP_ERR_PAR;
3927   2              }
3928   1              /*
3929   1              sysVPMission.msTimer2 = VP_TIME_OUT;
3930   1              while( sysVPMission.msTimer2 )
3931   1              {
3932   1                      if( VPBusFrameUnPack() )
3933   1                      {
3934   1                          sysVPMission.comErrNum = 0;
3935   1                              goto TAB_VPM_STATUS_COM_OK;
3936   1                      }
3937   1              }
3938   1              if( retry-- )
3939   1              {
3940   1                      goto TAB_VPM_STATUS_RETRY;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 65  

3941   1              }
3942   1              else
3943   1              {
3944   1                      sysVPMission.comErrNum++;
3945   1                      //? 
3946   1              return VP_ERR_COM;
3947   1              }
3948   1      TAB_VPM_STATUS_COM_OK:
3949   1          switch( sysVPMission.receive.msgType )
3950   1              {
3951   1                      default:
3952   1                          break;
3953   1              }
3954   1              */
3955   1              return VP_ERR_NULL;
3956   1      
3957   1      }
3958          
3959          unsigned char VPMission_ColumnSta_RPT( void )
3960          {
3961   1          unsigned char retry = 0;
3962   1              unsigned char i = 0;
3963   1              unsigned char flag = 0;  
3964   1              
3965   1          retry = VP_COM_RETRY;
3966   1              //--------------------------------------------
3967   1          for(i=0; i<COLUMN_NUM_SET+1; i++)
3968   1              {
3969   2                      sysVPMission.send.msg[i] = 0;
3970   2              }
3971   1          for(i=0; i<COLUMN_NUM_SET; i++)
3972   1              {
3973   2              if( !(GoodsWaySetVal[i].WayState & 0x01) )
3974   2              {
3975   3                          sysVPMission.send.msg[i+1] |= 0x40;   //Error flag Added by Andy 2011.5.5   
3976   3              }
3977   2                      if( GoodsWaySetVal[i].WayState & 0x0A )
3978   2                      {
3979   3                              sysVPMission.send.msg[i+1] |= 0x40;   //Error flag 
3980   3                      }
3981   2                      /*
3982   2              if( ( GoodsWaySetVal[i].WayState & 0x04 )&&( GoodsWaySetVal[i].GoodsCurrentSum >= 1 )  )
3983   2              {
3984   2                  sysVPMission.send.msg[i] |= 0x80;    
3985   2              }
3986   2              */
3987   2                      sysVPMission.send.msg[i+1] += GoodsWaySetVal[i].GoodsCurrentSum & 0x3F; 
3988   2              }
3989   1              //============================================
3990   1      //TAB_VPM_COLUMNSTA_RETRY:      
3991   1              flag = VPMsgPackSend( VP_HUODAO_RPT, 0, 1);   //Not need ACK
3992   1          if( flag != VP_ERR_NULL )
3993   1          {
3994   2                      return VP_ERR_PAR;
3995   2              }
3996   1              /*
3997   1              sysVPMission.msTimer2 = VP_TIME_OUT;
3998   1              while( sysVPMission.msTimer2 )
3999   1              {
4000   1                      if( VPBusFrameUnPack() )
4001   1                      {
4002   1                              goto TAB_VPM_COLUMNSTA_COM_OK;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 66  

4003   1                      }
4004   1              }
4005   1              if( retry-- )
4006   1              {
4007   1                      goto TAB_VPM_COLUMNSTA_RETRY;
4008   1              }
4009   1              else
4010   1              {
4011   1                      sysVPMission.comErrNum++;
4012   1                      //   
4013   1              return VP_ERR_COM;
4014   1              }
4015   1      TAB_VPM_COLUMNSTA_COM_OK:
4016   1          switch( sysVPMission.receive.msgType )
4017   1              {
4018   1                      default:
4019   1                          break;
4020   1              }
4021   1              */
4022   1              return VP_ERR_NULL;
4023   1      
4024   1      }
4025          
4026          unsigned char VPMission_Card_RPT( void )
4027          {
4028   1          unsigned char retry = 0;
4029   1              unsigned char i = 0;
4030   1              unsigned char flag = 0;  
4031   1          retry = VP_COM_RETRY;
4032   1          //1-0: button message, not need ACK
4033   1              flag = VPMsgPackSend( VP_CARD_RPT, 0, 1);   
4034   1          if( flag != VP_ERR_NULL )
4035   1          {
4036   2                      return VP_ERR_PAR;
4037   2              }
4038   1              return VP_ERR_NULL;
4039   1      
4040   1      }
4041          
4042          //120419 by cq TotalSell
4043          unsigned char VPMission_Info_RPT( unsigned char type )
4044          {
4045   1          unsigned char retry = 0;
4046   1              unsigned char i = 0;
4047   1              unsigned char flag = 0; 
4048   1              #ifdef   _SHUPING_
4049   1                              unsigned char unuseType[14] = {1,2,4,5,7,8,9,11,18,19,20,21,22,254};//未回复的type类型
4050   1                          retry = VP_COM_RETRY;       
4051   1                              sysVPMission.infoType = type;   
4052   1                              for(i=0;i<14;i++)
4053   1                              {
4054   2                                      if(sysVPMission.infoType == unuseType[i])
4055   2                                              break;
4056   2                              }
4057   1                              if(i >= 14)     
4058   1                              {
4059   2                                  //1-0: button message, not need ACK
4060   2                                      flag = VPMsgPackSend( VP_INFO_RPT, 0, 1);   
4061   2                                  if( flag != VP_ERR_NULL )
4062   2                                  {
4063   3                                              return VP_ERR_PAR;
4064   3                                      }
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 67  

4065   2                              }
4066   1              #else
                                      unsigned char unuseType[13] = {1,2,4,5,7,8,9,18,19,20,21,22,254};//未回复的type类型
                                  retry = VP_COM_RETRY;       
                                      sysVPMission.infoType = type;   
                                      for(i=0;i<13;i++)
                                      {
                                              if(sysVPMission.infoType == unuseType[i])
                                                      break;
                                      }
                                      if(i >= 13)     
                                      {
                                          //1-0: button message, not need ACK
                                              flag = VPMsgPackSend( VP_INFO_RPT, 0, 1);   
                                          if( flag != VP_ERR_NULL )
                                          {
                                                      return VP_ERR_PAR;
                                              }
                                      }
                      #endif
4085   1              //else
4086   1              //{
4087   1              //      VPMsgPackSend( VP_NAK_RPT, 0, 0  );      //1, 0
4088   1              //}
4089   1              return VP_ERR_NULL;
4090   1      }
4091          
4092          
4093          unsigned char VPMission_Act_RPT( unsigned char type, unsigned char value )
4094          {
4095   1          unsigned char retry = 0;
4096   1              unsigned char i = 0;
4097   1              unsigned char flag = 0;
4098   1          
4099   1              //
4100   1          retry = VP_COM_RETRY;
4101   1      //TAB_VPM_BUTTON_RETRY:
4102   1          //-------------------------------------------
4103   1          sysVPMission.ACT_Type   = type;
4104   1              sysVPMission.ACT_Value  = value;    
4105   1              //===========================================
4106   1          //1-0: button message, not need ACK
4107   1              flag = VPMsgPackSend( VP_ACTION_RPT, 0, 1);   
4108   1          if( flag != VP_ERR_NULL )
4109   1          {
4110   2                      return VP_ERR_PAR;
4111   2              }
4112   1              return VP_ERR_NULL;
4113   1      }
4114          
4115          
4116          unsigned char VPMission_OfflineData_RPT( void )
4117          {
4118   1              unsigned char retry = 0;
4119   1              unsigned char i = 0;
4120   1              unsigned char flag = 0;
4121   1      
4122   1              if(sysVPMission.offLineFlag == 1)
4123   1              {
4124   2                      return VP_ERR_NULL;
4125   2              }
4126   1              //
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 68  

4127   1              retry = VP_COM_RETRY;
4128   1      TAB_VPM_OFFDATA_RETRY:
4129   1              //-------------------------------------------
4130   1              //sysVPMission.payInDev = dev;
4131   1              //sysVPMission.payInMoney = money;
4132   1              //===========================================
4133   1              flag = VPMsgPackSend( VP_OFFLINEDATA_RPT, 1, 1);
4134   1              if( flag != VP_ERR_NULL )
4135   1              {
4136   2                      return VP_ERR_PAR;
4137   2              }
4138   1              sysVPMission.msTimer2 = VP_TIME_OUT;
4139   1              while( sysVPMission.msTimer2 )
4140   1              {
4141   2                      if( VPBusFrameUnPack() )
4142   2                      {
4143   3                              sysVPMission.comErrNum = 0;
4144   3                              if(sysVPMission.offLineFlag == 1)
4145   3                              {
4146   4                                      sysVPMission.offLineFlag = 0;
4147   4                                      VPMission_Act_RPT(VP_ACT_ONLINE,0);
4148   4                              }
4149   3                              goto TAB_VPM_OFFDATA_COM_OK;
4150   3                      }
4151   2              }
4152   1              if( retry-- )
4153   1              {
4154   2                      goto TAB_VPM_OFFDATA_RETRY;
4155   2              }
4156   1              else
4157   1              {
4158   2                      sysVPMission.comErrNum++;
4159   2                      //-----------------------------------
4160   2                      //3 次PC仍无响应，则跳过该消息，同时打印“PAYIN_RPT Err, device=类型,val=金额”
4161   2                      if((  sysVPMission.comErrNum >= VP_TIME_OUNT_NUM )&&(sysVPMission.offLineFlag != 1) )
4162   2                      {
4163   3                              sysVPMission.offLineFlag = 1;
4164   3                      }
4165   2                      return VP_ERR_COM;
4166   2              }
4167   1      TAB_VPM_OFFDATA_COM_OK:
4168   1              switch( sysVPMission.receive.msgType )
4169   1              {
4170   2                      default:
4171   2                              break;
4172   2              }
4173   1              return VP_ERR_NULL;
4174   1      }
4175          
4176          
4177          
4178          
4179          unsigned char VPMission_Poll( void )
4180          {
4181   1          unsigned char retry = 0;
4182   1              unsigned char i = 0;
4183   1              unsigned char flag = 0;
4184   1      
4185   1              if(sysVPMission.offLineFlag == 1)
4186   1              {               
4187   2                      if(sysVPMission.sTimerOffLine < 3)
4188   2                      {       
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 69  

4189   3                              sysVPMission.sTimerOffLine++;
4190   3                              return VP_ERR_NULL;
4191   3                      }
4192   2                      sysVPMission.sTimerOffLine = 0;
4193   2              }       
4194   1      
4195   1              if(sysVPMission.offLineFlag == 0)
4196   1              {
4197   2                      if(sysVPMission.sTimerHeart == 0)
4198   2                      {
4199   3                              sysVPMission.sTimerHeart = 10;
4200   3                              VPMission_Act_RPT(VP_ACT_HEART,0);
4201   3                              WaitForWork(1000,NULL);
4202   3                      }
4203   2              }
4204   1              if( ( sysVPMission.vendCmd == 1 )||(sysVPMission.changeCmd == 1)||(sysVPMission.costCmd == 1)||(sysVPMiss
             -ion.returnCmd == 1) )
4205   1                      return VP_ERR_NULL;
4206   1              
4207   1          retry = VP_COM_RETRY;
4208   1              //DisplayStr( 0, 0, 1, "1", 1 );  
4209   1              //WaitForWork(2000,NULL);
4210   1      TAB_VPM_P_RETRY:
4211   1              flag = VPMsgPackSend( VP_POLL, 1, 1);
4212   1              //DisplayStr( 0, 0, 1, "2", 1 );  
4213   1              //WaitForWork(2000,NULL);
4214   1          if( flag != VP_ERR_NULL )
4215   1          {
4216   2                      return VP_ERR_PAR;
4217   2              }
4218   1              sysVPMission.msTimer2 = VP_TIME_POLL;
4219   1              while( sysVPMission.msTimer2 )
4220   1              {
4221   2                      //DisplayStr( 0, 0, 1, "System 1", 10 );  
4222   2                      //WaitForWork(2000,NULL);
4223   2                      if( VPBusFrameUnPack() )
4224   2                      {
4225   3                          sysVPMission.comErrNum = 0;
4226   3                              if(sysVPMission.offLineFlag == 1)
4227   3                              {
4228   4                                      sysVPMission.offLineFlag = 0;
4229   4                                      VPMission_Act_RPT(VP_ACT_ONLINE,0);
4230   4                              }
4231   3                              goto TAB_VPM_P_COM_OK;
4232   3                      }
4233   2              }
4234   1              if( retry-- )
4235   1              {
4236   2                      goto TAB_VPM_P_RETRY;
4237   2              }
4238   1              else
4239   1              {
4240   2                      sysVPMission.comErrNum++;
4241   2                      //
4242   2                      if((  sysVPMission.comErrNum >= VP_TIME_OUNT_NUM )&&(sysVPMission.offLineFlag != 1) )
4243   2                      {
4244   3                              sysVPMission.offLineFlag = 1;
4245   3                      }
4246   2              return VP_ERR_COM;
4247   2              }
4248   1      TAB_VPM_P_COM_OK:
4249   1              //DisplayStr( 0, 0, 1, "System 2", 10 );  
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 70  

4250   1              //WaitForWork(2000,NULL);
4251   1          switch( sysVPMission.receive.msgType )
4252   1              {
4253   2                  case VP_INITIAL_OK:
4254   2                          VP_CMD_Init_OK();
4255   2                              break;
4256   2                      case VP_VENDOUT_IND:
4257   2                          VP_CMD_Vendout();
4258   2                          break;
4259   2                      case VP_RESET_IND:
4260   2                          VP_CMD_Reset();
4261   2                          break;
4262   2                      case VP_CONTROL_IND:
4263   2                          VP_CMD_Control();
4264   2                          break;
4265   2                      case VP_GET_STATUS:
4266   2                          VP_CMD_GetStatus();
4267   2                          break;
4268   2                      case VP_HOUDAO_IND:
4269   2                          VP_CMD_ColumnPar();
4270   2                              //if( sysVPMission.sysStatus & VPM_STA_PCPAROK )
4271   2                              {
4272   3                                      //UpdateGoodsMatrixStatus( 0xff );
4273   3                     // VP_Update_ColumnGoodsPar();
4274   3                              }
4275   2                          break;
4276   2                      case VP_HUODAO_SET_IND: 
4277   2                              VP_CMD_ColumnNo();                      
4278   2                              break;  
4279   2                      case VP_POSITION_IND:
4280   2                          VP_CMD_GoodsPos();                  
4281   2                              break;  
4282   2                      case VP_SALEPRICE_IND:
4283   2                              //VP_CMD_GoodsPar();
4284   2                              //if( sysVPMission.sysStatus & VPM_STA_PCPAROK )
4285   2                              {
4286   3                                      //UpdateGoodsMatrixStatus( 0xff );
4287   3                      VP_Update_ColumnGoodsPar();
4288   3                                      SaveGoodsSet();
4289   3                                      WaitForWork( 100, NULL );
4290   3                              }
4291   2                              break;                          
4292   2                  case VP_PAYOUT_IND:
4293   2                          VP_CMD_Payout();
4294   2                          break;
4295   2              case VP_GET_HUODAO:
4296   2                  VP_CMD_GetColumnSta();
4297   2                  break;
4298   2              case VP_COST_IND://添加扣款函数;by gzz 20110823
4299   2                          VP_CMD_Cost();
4300   2                          break;
4301   2                      case VP_GETINFO_IND://120419 by cq TotalSell                    
4302   2                              VPMission_Info_RPT(sysVPMission.receive.msg[0]);
4303   2                              break;  
4304   2                      //case VP_SALETIME_IND:
4305   2                      //      VPMission_Info_RPT();
4306   2                      //      break;                  
4307   2                      case VP_GET_SETUP_IND: 
4308   2                              //VPMission_Info_RPT();
4309   2                              //DisplayStr( 0, 0, 1, "1", 1 );  
4310   2                              //WaitForWork(2000,NULL);
4311   2                              VPMission_Setup_RPT();
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 71  

4312   2                              break;  
4313   2                      case VP_GET_OFFLINEDATA_IND:
4314   2                              VPMission_OfflineData_RPT();
4315   2                              break;  
4316   2                      default:
4317   2                          break;
4318   2              }
4319   1              return VP_ERR_NULL;
4320   1      }
4321          
4322          unsigned char VPMission_Init( void )
4323          {
4324   1          unsigned char i = 0;
4325   1              unsigned char j = 0,time=0;
4326   1              unsigned char result = 0;
4327   1              
4328   1         
4329   1      #ifdef _CHINA_
4330   1              DisplayStr( 0, 0, 1, "系统\xd5\xfd在启动, 请稍等", 20 );   
4331   1              ClearDisplayLine( 2 );  
4332   1      #else           
                      DisplayStr( 0, 0, 1, "System reset...wait!", 20 );  
                      ClearDisplayLine( 2 );  
              #endif  
4336   1              VPSerialInit();
4337   1      
4338   1              
4339   1          //2.disable the cash or cashless device
4340   1          DisableBillDev();
4341   1      
4342   1              sysVPMission.sel1ReadyLed = 0x00;
4343   1          sysVPMission.sel1ErrLed   = 0xff;
4344   1          sysVPMission.sel2ReadyLed = 0x00;
4345   1          sysVPMission.sel2ErrLed   = 0xff;
4346   1          sysVPMission.sel3ReadyLed = 0x00;
4347   1          sysVPMission.sel3ErrLed   = 0xff;
4348   1          GetSelectionState( 1, &Selection1 );
4349   1              GetSelectionState( 2, &Selection2 );
4350   1              GetSelectionState( 3, &Selection3 );
4351   1      
4352   1          
4353   1              
4354   1      
4355   1      
4356   1              //120419 by cq TotalSell
4357   1              //result = VPMission_Startup_RPT_1();
4358   1              //if( result == VP_ERR_NULL)
4359   1                      //InitAllCounter_1();   
4360   1      
4361   1              //1.startup
4362   1      //TAB_VPM_INIT_STARTUP:
4363   1              //do
4364   1              //{
4365   1          //  result = VPMission_Startup_RPT();
4366   1              //}while( result != VP_ERR_NULL );
4367   1          
4368   1              //2.setup
4369   1              //result = VPMission_Setup_RPT();
4370   1              //if( result != VP_ERR_NULL ) goto TAB_VPM_INIT_STARTUP;
4371   1      
4372   1          /*
4373   1              //3.wait goods set
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 72  

4374   1              result = VPMission_Poll();
4375   1          if( result != VP_ERR_NULL ) goto TAB_VPM_INIT_STARTUP;      
4376   1              //4.wait column set
4377   1              result = VPMission_Poll();
4378   1              if( result != VP_ERR_NULL ) goto TAB_VPM_INIT_STARTUP;
4379   1              //5.wait initial ok
4380   1              result = VPMission_Poll();
4381   1              if( result != VP_ERR_NULL ) goto TAB_VPM_INIT_STARTUP;
4382   1          if( (sysVPMission.sysStatus & VPM_STA_GOODSPAR)&&(sysVPMission.sysStatus & VPM_STA_COLUMNPAR) )
4383   1              {
4384   1                      VP_Update_ColumnGoodsPar();
4385   1              sysVPMission.sysStatus &= ~VPM_STA_COLUMNPAR;
4386   1              sysVPMission.sysStatus &= ~VPM_STA_GOODSPAR;
4387   1              sysVPMission.VPMode = 1;
4388   1              }
4389   1          else
4390   1          {
4391   1              goto TAB_VPM_INIT_STARTUP;
4392   1          }
4393   1          */
4394   1              
4395   1          sysVPMission.resetCmd = 0;
4396   1          //启动不成功，重试三次;by gzz 20111025
4397   1          i=0;
4398   1          if(( SystemParameter.BillNo == 1 )&&( sysITLMission.ITLSet == 1 ))
4399   1          {
4400   2              do
4401   2              {
4402   3                      MDBMission_Bill_Init();
4403   3                  i++;             
4404   3              }
4405   2              while((sysMDBMission.billDeviceStatus!=0)&&(i<3));
4406   2          }
4407   1      
4408   1          i=0;
4409   1              //if( SystemParameter.BillNo == 1 )
4410   1              {
4411   2                  do
4412   2                  {
4413   3                          MDBMission_Coin_Init();
4414   3                          i++;         
4415   3                  }
4416   2                  while((sysMDBMission.coinDeviceStatus!=0)&&(i<3));
4417   2              }
4418   1              sysVPMission.billCoinEnable = 1;
4419   1      
4420   1      
4421   1      
4422   1              VPMission_Act_RPT(VP_ACT_ONLINE,0);
4423   1              sysVPMission.offLineFlag = 0;
4424   1              sysVPMission.sysStatus = 0;  
4425   1              while( (sysVPMission.VPInit == 0)&&(sysVPMission.offLineFlag == 0)&&(time<5) )
4426   1          {
4427   2                  
4428   2              result = VPMission_Poll();
4429   2              //if( result == VP_ERR_NULL ) break;//goto TAB_VPM_INIT_STARTUP;
4430   2              /*
4431   2              if( (sysVPMission.sysStatus & VPM_STA_INITOK)&&(sysVPMission.sysStatus & VPM_STA_GOODSPAR)&&(sysVP
             -Mission.sysStatus & VPM_STA_COLUMNPAR) )
4432   2              {
4433   2                      VP_Update_ColumnGoodsPar();
4434   2                      sysVPMission.sysStatus &= ~VPM_STA_COLUMNPAR;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 73  

4435   2                      sysVPMission.sysStatus &= ~VPM_STA_GOODSPAR;
4436   2                  sysVPMission.sysStatus &= ~VPM_STA_INITOK;
4437   2                      sysVPMission.VPMode = 1;
4438   2                  break;
4439   2              }
4440   2              */
4441   2              if( (sysVPMission.sysStatus & VPM_STA_GOODSPAR)&&(sysVPMission.sysStatus & VPM_STA_COLUMNPAR) )
4442   2                      {
4443   3                      //VP_Update_ColumnGoodsPar();
4444   3                      sysVPMission.sysStatus &= ~VPM_STA_COLUMNPAR;
4445   3                      sysVPMission.sysStatus &= ~VPM_STA_GOODSPAR;
4446   3                  //sysVPMission.sysStatus &= ~VPM_STA_INITOK;
4447   3                      sysVPMission.VPMode = 1;
4448   3                              sysVPMission.VPInit = 1;
4449   3                  break;
4450   3              }
4451   2                      time++;
4452   2                      WaitForWork(2000,NULL);
4453   2      
4454   2          }
4455   1              sysVPMission.sysStatus &= ~VPM_STA_COLUMNPAR;
4456   1          sysVPMission.sysStatus &= ~VPM_STA_GOODSPAR;
4457   1              sysVPMission.VPMode = 1;
4458   1      
4459   1          sysVPMission.dspUpdateFlag = 1;
4460   1          sysVPMission.dspTimer1  = VP_DSP_TIME1;
4461   1              sysVPMission.sysStatus |= VPM_STA_PCPAROK;
4462   1      
4463   1              
4464   1          //Open the watch dog
4465   1          WatchDogInit();
4466   1          //isShowLcd = 1;
4467   1              DeviceStatus.Selection[0] = 0;
4468   1              DeviceStatus.Selection[1] = 0;
4469   1              DeviceStatus.Selection[2] = 0;
4470   1              return VP_ERR_NULL;
4471   1      }
4472          
4473          //Flag=1更新主机参数，Flag=2更新从机参数;by gzz 20110509
4474          unsigned char VPAddSingleColGoods( unsigned char col, unsigned char num, unsigned char oldNum, unsigned ch
             -ar Flag )
4475          {   
4476   1          u_char xdata i    = 0;
4477   1              u_char xdata key  = 0;
4478   1              u_char xdata flag = 0;
4479   1      
4480   1              /*
4481   1      #ifdef _CHINA_
4482   1              DisplayStr( 0, 0, 1, "    你确定更改吗?", 17 );   
4483   1              DisplayStr( 0, 1, 1, "确定ENTER 取消CANCEL", 20 );      
4484   1      #else           
4485   1              DisplayStr( 0, 0, 1, "   Are you sure ?", 17 );  
4486   1              DisplayStr( 0, 1, 1, "   ENTER   CANCEL", 17 ); 
4487   1      #endif                                                                                                  
4488   1              while( 1 )
4489   1              {
4490   1                      key = GetKey();
4491   1                      if( ( key == KEY_CANCEL ) || (key == KEY_SUBMIT) )
4492   1                              break;
4493   1                      WaitForWork( 100, NULL );       
4494   1              }
4495   1              if( key == KEY_CANCEL ) 
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 74  

4496   1              {
4497   1                      if(Flag == 1)
4498   1                      GoodsWaySetVal[col].GoodsCurrentSum = oldNum;
4499   1                      return 0;
4500   1              }
4501   1              */
4502   1      
4503   1              //Display the message
4504   1      #ifdef _CHINA_
4505   1              DisplayStr( 0, 0, 1, "\xd5\xfd在更改商品余量...", 19 );    
4506   1              ClearDisplayLine( 2 );  
4507   1      #else           
                      DisplayStr( 0, 0, 1, "Please wait...", 14 );    
                      ClearDisplayLine( 2 );
              #endif
4511   1          WaitForWork( 200, NULL );           //1000, 500, 200
4512   1          while( 1 )
4513   1          {
4514   2                      if(Flag == 1)
4515   2                              flag = VPMission_Admin_RPT( VP_ADMIN_GOODSADDCOL, col+1, num );
4516   2                      else if(Flag == 2)
4517   2                              flag = VPMission_Admin_RPT( VP_ADMIN_GOODSBUHUO, col+1, num );
4518   2      
4519   2                      if( (flag==VP_ERR_NULL)||(flag==VP_ACK)||(flag==VP_NAK) ) break;
4520   2              if( flag == VP_ERR_COM ) break;
4521   2              WaitForWork( 500, NULL );
4522   2              }
4523   1      
4524   1          if( flag == VP_ERR_COM )
4525   1              {
4526   2                      changeFailedBeep();
4527   2              #ifdef _CHINA_
4528   2                              DisplayStr( 0, 0, 1, "商品余量更改失败!", 17 );    
4529   2                              ClearDisplayLine( 2 );  
4530   2                      #else           
                                      DisplayStr( 0, 0, 1, "Operate fail!", 13 );    
                                      ClearDisplayLine( 2 );
                              #endif
4534   2                      if(Flag == 1)
4535   2                      GoodsWaySetVal[col].GoodsCurrentSum = oldNum; 
4536   2                      WaitForWork( 2000, NULL );
4537   2              }
4538   1              else if( sysVPMission.receive.msgType == VP_ACK )
4539   1              {
4540   2                      /*
4541   2              //by gzz 20120223
4542   2                  VPMission_Request(1);
4543   2                  sysVPMission.sysStatus &= ~VPM_STA_COLUMNPAR;
4544   2                  while( 1 )
4545   2                  {
4546   2                              flag = VPMission_Poll();
4547   2                              if( flag == VP_ERR_COM ) break;
4548   2                              if( (sysVPMission.sysStatus & VPM_STA_COLUMNPAR) )
4549   2                          {
4550   2                                      VP_Update_ColumnGoodsPar();
4551   2                                      break;
4552   2                          }
4553   2                      WaitForWork( 500, NULL );
4554   2                      }
4555   2                      */
4556   2                      
4557   2                  //GoodsSetSave = 1;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 75  

4558   2                      //if(Flag == 1)
4559   2                      {
4560   3                              GoodsSetSave = 1;
4561   3                              //VP_Update_ColumnGoodsPar();   
4562   3      
4563   3                      /*
4564   3      #ifdef _CHINA_
4565   3                              DisplayStr( 0, 0, 1, "商品余量更改成功!", 17 );    
4566   3                              ClearDisplayLine( 2 );  
4567   3      #else           
4568   3                              DisplayStr( 0, 0, 1, "Operate successfully", 20 );    
4569   3                              ClearDisplayLine( 2 );
4570   3      #endif*/
4571   3                      }
4572   2                      
4573   2          }
4574   1              else
4575   1              {
4576   2                      //changeFailedBeep();
4577   2                      #ifdef _CHINA_
4578   2                              DisplayStr( 0, 0, 1, "商品余量更改失败!", 17 );    
4579   2                              ClearDisplayLine( 2 );  
4580   2                      #else           
                                      DisplayStr( 0, 0, 1, "Operate fail!", 13 );    
                                      ClearDisplayLine( 2 );
                              #endif
4584   2                      if(Flag == 1)
4585   2                      GoodsWaySetVal[col].GoodsCurrentSum = oldNum;
4586   2                      WaitForWork( 2000, NULL );
4587   2              }
4588   1          //WaitForWork( 3000, NULL );        
4589   1              return 0;
4590   1      
4591   1      }
4592          
4593          unsigned char VPChangeColPrice( unsigned char col, unsigned int price, unsigned int oldPrice )
4594          {   
4595   1          u_char xdata i    = 0;
4596   1              u_char xdata key  = 0;
4597   1              u_char xdata flag = 0;
4598   1      
4599   1      #ifdef _CHINA_
4600   1              DisplayStr( 0, 0, 1, "    你确定更改吗?", 17 );   
4601   1              DisplayStr( 0, 1, 1, "确定ENTER 取消CANCEL", 20 );      
4602   1      #else           
                      DisplayStr( 0, 0, 1, "   Are you sure ?", 17 );  
                      DisplayStr( 0, 1, 1, "   ENTER   CANCEL", 17 ); 
              #endif                                                                                                  
4606   1              while( 1 )
4607   1              {
4608   2                      key = GetKey();
4609   2                      if( ( key == KEY_CANCEL ) || (key == KEY_SUBMIT) )
4610   2                              break;
4611   2                      WaitForWork( 100, NULL );       
4612   2              }
4613   1              if( key == KEY_CANCEL ) 
4614   1              {
4615   2                  GoodsWaySetVal[col].Price = oldPrice;
4616   2                      return 0;
4617   2              }
4618   1              //Display the message
4619   1      #ifdef _CHINA_
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 76  

4620   1              DisplayStr( 0, 0, 1, "\xd5\xfd在更改商品价格...", 19 );    
4621   1              ClearDisplayLine( 2 );  
4622   1      #else           
                      DisplayStr( 0, 0, 1, "Please wait...", 14 );    
                      ClearDisplayLine( 2 );
              #endif
4626   1          WaitForWork( 200, NULL );           //1000-200
4627   1          while( 1 )
4628   1          {
4629   2                      flag = VPMission_Admin_RPT( VP_ADMIN_COL_PRICE, col+1, price );
4630   2              if( (flag==VP_ERR_NULL)||(flag==VP_ACK)||(flag==VP_NAK) ) break;
4631   2              if( flag == VP_ERR_COM ) break;
4632   2              WaitForWork( 500, NULL );
4633   2              }  
4634   1       
4635   1              if( flag == VP_ERR_COM )
4636   1              {
4637   2                  #ifdef _CHINA_
4638   2                              DisplayStr( 0, 0, 1, "商品价格更改失败!", 17 );    
4639   2                              ClearDisplayLine( 2 );  
4640   2                      #else           
                                      DisplayStr( 0, 0, 1, "Operate fail!", 13 );    
                                      ClearDisplayLine( 2 );
                              #endif
4644   2              GoodsWaySetVal[col].Price = oldPrice;
4645   2              }
4646   1          else if( sysVPMission.receive.msgType == VP_ACK )
4647   1              {
4648   2                      /*
4649   2              VPMission_Request(1);
4650   2                  sysVPMission.sysStatus &= ~VPM_STA_COLUMNPAR;
4651   2                  sysVPMission.sysStatus &= ~VPM_STA_GOODSPAR;
4652   2                  while( 1 )
4653   2                  {
4654   2                              VPMission_Poll();
4655   2                              if( (sysVPMission.sysStatus & VPM_STA_GOODSPAR)&&(sysVPMission.sysStatus & VPM_STA_COLUMNPAR) )
4656   2                          {
4657   2                                      VP_Update_ColumnGoodsPar();
4658   2                                      break;
4659   2                          }
4660   2                      WaitForWork( 500, NULL );
4661   2                      }
4662   2                      */
4663   2                  GoodsSetSave = 1;
4664   2                      #ifdef _CHINA_
4665   2                              DisplayStr( 0, 0, 1, "商品价格更改成功!", 17 );    
4666   2                              ClearDisplayLine( 2 );  
4667   2                      #else           
                                      DisplayStr( 0, 0, 1, "Operate successfully", 20 );    
                                      ClearDisplayLine( 2 );
                              #endif             
4671   2          }
4672   1              else
4673   1              {
4674   2                      #ifdef _CHINA_
4675   2                              DisplayStr( 0, 0, 1, "商品价格更改失败!", 17 );    
4676   2                              ClearDisplayLine( 2 );  
4677   2                      #else           
                                      DisplayStr( 0, 0, 1, "Operate fail!", 13 );    
                                      ClearDisplayLine( 2 );
                              #endif
4681   2              GoodsWaySetVal[col].Price = oldPrice;
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 77  

4682   2              }
4683   1          WaitForWork( 3000, NULL );  
4684   1              return 0;
4685   1      
4686   1      }
4687          
4688          unsigned char VPAddAllColGoods( void )
4689          {   
4690   1          u_char xdata i    = 0;
4691   1              u_char xdata key  = 0;
4692   1              u_char xdata flag = 0;
4693   1              u_char xdata tryFlag = 3;
4694   1      
4695   1      #ifdef _CHINA_
4696   1              DisplayStr( 0, 0, 1, "    你确定添满吗?", 17 );   
4697   1              DisplayStr( 0, 1, 1, "确定ENTER 取消CANCEL", 20 );      
4698   1      #else           
                      DisplayStr( 0, 0, 1, "   Are you sure ?", 17 );  
                      DisplayStr( 0, 1, 1, "   ENTER   CANCEL", 17 ); 
              #endif                                                                                                  
4702   1              while( 1 )
4703   1              {
4704   2                      key = GetKey();
4705   2                      if( ( key == KEY_CANCEL ) || (key == KEY_SUBMIT) )
4706   2                              break;
4707   2                      WaitForWork( 100, NULL );       
4708   2                      if(sysVPMission.msActTimer == 0)
4709   2                      {
4710   3                              sysVPMission.msActTimer = 100;
4711   3                              VPMission_Act_RPT(VP_ACT_ADMIN,VP_ACT_ENTERADMIN);
4712   3                      }
4713   2              }
4714   1              if( key == KEY_CANCEL ) return 0;
4715   1              //---------------------------------------------------------------------------------
4716   1          /*                                          
4717   1              for( key = 0; key < GOODSWAYNUM; key ++ )
4718   1              {       
4719   1                      if( InputGoodsWayList[key].UseState != 1 )
4720   1              {
4721   1                              continue;
4722   1              }
4723   1                      else
4724   1                      {
4725   1                              if( InputGoodsWayList[key].GoodsWayNo == GoodsWaySetVal[key].WayNo )
4726   1                              {
4727   1                      //--------------------------------------------------------------------
4728   1                      if( SystemParameter.GOCOn == 0x01 )
4729   1                      {
4730   1                              GoodsWaySetVal[key].WayState &= 0xfb;
4731   1                      }
4732   1                      else
4733   1                                      {
4734   1                                              GoodsWaySetVal[key].GoodsCurrentSum = InputGoodsWayList[key].GoodsMax;
4735   1                                          if( ( GoodsWaySetVal[key].WayState & 0x04 ) == 0x04 )
4736   1                                                      GoodsWaySetVal[key].WayState &= 0xfb;
4737   1                                      }
4738   1                      //====================================================================
4739   1                              }
4740   1                              else
4741   1                  {
4742   1                                      GoodsWaySetVal[key].GoodsCurrentSum = 0;
4743   1                  }
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 78  

4744   1                      }                                                               
4745   1              }
4746   1          */
4747   1              //Display the message
4748   1      #ifdef _CHINA_
4749   1              DisplayStr( 0, 0, 1, "\xd5\xfd在添满...", 11 );    
4750   1              ClearDisplayLine( 2 );  
4751   1      #else           
                      DisplayStr( 0, 0, 1, "Please waiting...", 17 );    
                      ClearDisplayLine( 2 );
              #endif
4755   1          WaitForWork( 1000, NULL );  
4756   1              sysVPMission.sysStatus &= ~VPM_STA_COLUMNPAR;    
4757   1          //sysVPMission.requestFlag = 1;
4758   1              //VPMission_Request(1);    
4759   1          while( tryFlag )
4760   1          {
4761   2              tryFlag--;
4762   2                      //flag = VPMission_Poll();
4763   2                      VPMission_Admin_RPT( VP_ADMIN_GOODSADDALL, 0, 0);
4764   2      
4765   2                      //if( flag == VP_ERR_COM ) break;
4766   2                      //DisplayStr( 0, 0, 1, "03", 2 );  
4767   2                      //WaitForWork(2000,NULL);
4768   2      
4769   2                      if( /*(sysVPMission.sysStatus & VPM_STA_GOODSPAR)&&*/ (sysVPMission.sysStatus & VPM_STA_COLUMNPAR) )
4770   2                  {
4771   3                              //VP_Update_ColumnGoodsPar();
4772   3                              //DisplayStr( 0, 0, 1, "05", 2 );  
4773   3                              //WaitForWork(2000,NULL);
4774   3                              break;
4775   3                  }
4776   2                      //DisplayStr( 0, 0, 1, "04", 2 );  
4777   2                      //WaitForWork(2000,NULL);
4778   2              WaitForWork( 1000, NULL );
4779   2              }
4780   1      
4781   1          if( tryFlag == 0  )
4782   1              {
4783   2                      changeFailedBeep();
4784   2              #ifdef _CHINA_
4785   2                      DisplayStr( 0, 0, 1, "添满操作失败!", 13 );    
4786   2                      ClearDisplayLine( 2 );  
4787   2              #else           
                              DisplayStr( 0, 0, 1, "Operate fail!", 13 );    
                              ClearDisplayLine( 2 );
                      #endif
4791   2      
4792   2              }
4793   1              else
4794   1              {
4795   2                  GoodsSetSave = 1;
4796   2              #ifdef _CHINA_
4797   2                      DisplayStr( 0, 0, 1, "添满操作成功!", 13 );    
4798   2                      ClearDisplayLine( 2 );  
4799   2              #else           
                              DisplayStr( 0, 0, 1, "Operate successfully", 20 );    
                              ClearDisplayLine( 2 );
                      #endif
4803   2          }
4804   1          WaitForWork( 3000, NULL );
4805   1                      
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 79  

4806   1              return 0;
4807   1      
4808   1      }
4809          
4810          //填满层架货道;by gzz 20110429
4811          unsigned char VPAddLayerColGoods( void )
4812          {
4813   1              u_char xdata i    = 0;
4814   1              u_char xdata key  = 0;
4815   1              u_char xdata flag = 0;
4816   1              u_char xdata RackNo = 0;
4817   1          u_char xdata Tempstr[8];
4818   1          u_char xdata len = 0;
4819   1              u_char xdata tryFlag = 3;
4820   1      
4821   1          ClearKey();
4822   1              ClearDisplayLine( 1 );
4823   1              ClearDisplayLine( 2 );
4824   1          while( 1 )
4825   1              {               
4826   2                      //ClearDisplayLine( 1 );
4827   2                      //ClearDisplayLine( 2 );                
4828   2                      len = 1;
4829   2                      memset( Tempstr,0, sizeof( Tempstr ) ); 
4830   2               #ifdef _CHINA_
4831   2                      key = GetLine( "输入层架编号:", 13 , 0, Tempstr, &len );
4832   2               #else
                              key = GetLine( "Input Tray code:", 16 , 0, Tempstr, &len );
                       #endif
4835   2                      WaitForWork( 500, NULL );       
4836   2                      ClearKey();                             
4837   2                      if( key == 1 )//Enter   
4838   2                      {                       
4839   3                              DisplayCursorState( 0, 0, 0, 0, 1 );                    
4840   3                              for( i = 0; i < len; i ++ )
4841   3                              {
4842   4                                      if( ( Tempstr[i] >= 0 ) && ( Tempstr[i] <= 9 ) )
4843   4                                      {
4844   5                                              RackNo = Tempstr[i];                            
4845   5                                              break;
4846   5                                      }
4847   4                              }                               
4848   3                              ClearKey();                     
4849   3                              if( ( RackNo <= 0 ) || ( RackNo > 6 ))
4850   3                          {
4851   4                                      #ifdef _CHINA_
4852   4                                              DisplayStr( 0, 0, 1, "编号输入错误", 12 );
4853   4                                              DisplayStr( 0, 1, 1, "请输入其它编号", 14 );
4854   4                                      #else
                                                      DisplayStr( 0, 0, 1, "Input code error", 16 );
                                                      DisplayStr( 0, 1, 1, "Input other code", 16 );                          
                                              #endif                                  
4858   4                                      WaitForWork( 2000, NULL );
4859   4                                      ClearDisplayLine( 1 );
4860   4                              ClearDisplayLine( 2 );
4861   4                                      continue;
4862   4                              }
4863   3                              else
4864   3                                      break;
4865   3                  }
4866   2                      else
4867   2                  {
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 80  

4868   3                              return 0;
4869   3                      }
4870   2          } 
4871   1              ClearKey();     
4872   1      #ifdef _CHINA_
4873   1              DisplayStr( 0, 0, 1, "你确定添满此层架吗?", 19 );   
4874   1              DisplayStr( 0, 1, 1, "确定ENTER 取消CANCEL", 20 );      
4875   1      #else           
                      DisplayStr( 0, 0, 1, "   Are you sure ?", 17 );  
                      DisplayStr( 0, 1, 1, "   ENTER   CANCEL", 17 ); 
              #endif                                                                                                  
4879   1              while( 1 )
4880   1              {
4881   2                      key = GetKey();
4882   2                      if( ( key == KEY_CANCEL ) || (key == KEY_SUBMIT) )
4883   2                              break;
4884   2                      WaitForWork( 100, NULL );       
4885   2                      if(sysVPMission.msActTimer == 0)
4886   2                      {
4887   3                              sysVPMission.msActTimer = 100;
4888   3                              VPMission_Act_RPT(VP_ACT_ADMIN,VP_ACT_ENTERADMIN);
4889   3                      }
4890   2              }
4891   1              if( key == KEY_CANCEL ) return 0;
4892   1      #ifdef _CHINA_
4893   1              DisplayStr( 0, 0, 1, "\xd5\xfd在添满当前层架...", 19 );    
4894   1              ClearDisplayLine( 2 );  
4895   1      #else           
                      DisplayStr( 0, 0, 1, "Adding the tray...", 18 );    
                      ClearDisplayLine( 2 );
              #endif
4899   1          WaitForWork( 1000, NULL );  
4900   1          //--------------------------------------------------------------
4901   1          sysVPMission.sysStatus &= ~VPM_STA_COLUMNPAR;    
4902   1          //sysVPMission.requestFlag = 1;
4903   1              //VPMission_Request(1);    
4904   1          while( tryFlag )
4905   1          {           
4906   2              tryFlag--;
4907   2                      //flag = VPMission_Poll();
4908   2                      VPMission_Admin_RPT( VP_ADMIN_GOODSADDTRAY, RackNo, 0);
4909   2                      //if( flag == VP_ERR_COM ) break;
4910   2                      if( /*(sysVPMission.sysStatus & VPM_STA_GOODSPAR)&&*/ (sysVPMission.sysStatus & VPM_STA_COLUMNPAR) )
4911   2                  {
4912   3                              //VP_Update_ColumnGoodsPar();
4913   3                              break;
4914   3                  }
4915   2              WaitForWork( 500, NULL );
4916   2              }
4917   1              //==============================================================
4918   1              if( tryFlag == 0  )
4919   1              {
4920   2                      changeFailedBeep();
4921   2              #ifdef _CHINA_
4922   2                      DisplayStr( 0, 0, 1, "层架添满操作失败!", 17 );    
4923   2                      ClearDisplayLine( 2 );  
4924   2              #else           
                              DisplayStr( 0, 0, 1, "Add the tray fail!", 18 );    
                              ClearDisplayLine( 2 );
                      #endif
4928   2      
4929   2              }
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 81  

4930   1              else
4931   1              {
4932   2                  GoodsSetSave = 1;
4933   2              #ifdef _CHINA_
4934   2                      DisplayStr( 0, 0, 1, "层架添满操作成功!", 17 );    
4935   2                      ClearDisplayLine( 2 );  
4936   2              #else           
                              DisplayStr( 0, 0, 1, "Operate successfully", 20 );    
                              ClearDisplayLine( 2 );
                      #endif
4940   2          }
4941   1          WaitForWork( 3000, NULL );
4942   1              return 0;
4943   1      
4944   1      }
4945          
4946          //by gzz 20110506
4947          unsigned char VPAddChanges( uchar xdata testDev )
4948          {  
4949   1          u_char xdata i    = 0;
4950   1              u_char xdata key  = 0;
4951   1              u_char xdata flag = 0;
4952   1              u_char xdata DevStr[10];
4953   1              u_char xdata str[20];
4954   1              u_char xdata len = 0;
4955   1      
4956   1              if(testDev == 1)
4957   1              {
4958   2                      #ifdef _CHINA_
4959   2                              sprintf( DevStr, "%s", "补硬币" );
4960   2                      #else
                                      sprintf( DevStr, "%s", "Coin" );
                              #endif          
4963   2              }
4964   1              else if(testDev == 2)
4965   1              {
4966   2                      #ifdef _CHINA_
4967   2                              sprintf( DevStr, "%s", "取纸币" );
4968   2                      #else
                                      sprintf( DevStr, "%s", "Cash" );
                              #endif          
4971   2              }
4972   1      
4973   1      #ifdef _CHINA_ 
4974   1          len = sprintf( str, "  你确定%s吗?", DevStr );     
4975   1              DisplayStr( 0, 0, 1, str, len );   
4976   1              DisplayStr( 0, 1, 1, "确定ENTER 取消CANCEL", 20 );      
4977   1      #else           
                      DisplayStr( 0, 0, 1, "   Are you sure ?", 17 );  
                      DisplayStr( 0, 1, 1, "   ENTER   CANCEL", 17 ); 
              #endif  
4981   1                                                                                                      
4982   1              while( 1 )
4983   1              {
4984   2                      key = GetKey();
4985   2                      if( ( key == KEY_CANCEL ) || (key == KEY_SUBMIT) )
4986   2                              break;
4987   2                      WaitForWork( 100, NULL );       
4988   2                      if(sysVPMission.msActTimer == 0)
4989   2                      {
4990   3                              sysVPMission.msActTimer = 100;
4991   3                              VPMission_Act_RPT(VP_ACT_ADMIN,VP_ACT_ENTERADMIN);
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 82  

4992   3                      }
4993   2              }
4994   1              if( key == KEY_CANCEL ) return 0;
4995   1              //Display the message
4996   1      #ifdef _CHINA_   
4997   1          len = sprintf( str, "  \xd5\xfd在%s", DevStr );
4998   1              DisplayStr( 0, 0, 1, str, len ); 
4999   1              ClearDisplayLine( 2 );  
5000   1      #else           
                      DisplayStr( 0, 0, 1, "Please wait...", 14 );    
                      ClearDisplayLine( 2 );
              #endif
5004   1          WaitForWork( 1000, NULL );          
5005   1          while( 1 )
5006   1          {
5007   2                      if(testDev == 1)
5008   2                      {
5009   3                              flag = VPMission_Admin_RPT( VP_ADMIN_CHANGEADD, 0, 0 );
5010   3                      }
5011   2                      else if(testDev == 2)
5012   2                      {
5013   3                              flag = VPMission_Admin_RPT( VP_ADMIN_GETBILL, 0, 0 );
5014   3                      }
5015   2                      if(sysVPMission.offLineFlag == 1)
5016   2                      {
5017   3                              flag =VP_ERR_COM;
5018   3                      }
5019   2                      if( (flag==VP_ERR_NULL)||(flag==VP_ACK)||(flag==VP_NAK) ) break;
5020   2                      if( flag == VP_ERR_COM ) break;
5021   2              WaitForWork( 500, NULL );
5022   2              }
5023   1      
5024   1              if( flag == VP_ERR_COM )
5025   1          {
5026   2              changeFailedBeep();
5027   2                      #ifdef _CHINA_                   
5028   2                          len = sprintf( str, "%s失败!", DevStr );
5029   2                      DisplayStr( 0, 0, 1, str, len ); 
5030   2                              ClearDisplayLine( 2 );  
5031   2                      #else           
                                      DisplayStr( 0, 0, 1, "Operate fail!", 13 );    
                                      ClearDisplayLine( 2 );
                              #endif
5035   2              }
5036   1          else if( sysVPMission.receive.msgType == VP_ACK )
5037   1              {
5038   2                      #ifdef _CHINA_                  
5039   2                          len = sprintf( str, "%s成功!", DevStr );
5040   2                      DisplayStr( 0, 0, 1, str, len ); 
5041   2                              ClearDisplayLine( 2 );  
5042   2                      #else           
                                      DisplayStr( 0, 0, 1, "Operate successfully", 20 );    
                                      ClearDisplayLine( 2 );
                              #endif
5046   2                      /*
5047   2              if(testDev == 1)
5048   2                      {                               
5049   2                  TradeCounter.CoinSum5jBack = TradeCounter.CoinSum5j;                        
5050   2                              TradeCounter.CoinSum5jID++;
5051   2                  TradeCounter.CoinSum1yBack = TradeCounter.CoinSum1y;                        
5052   2                              TradeCounter.CoinSum1yID++;
5053   2                 
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 83  

5054   2                  TradeCounter.Hopper1SumBack = TradeCounter.Hopper1Sum;                      
5055   2                              TradeCounter.Hopper1SumID++;
5056   2                  TradeCounter.Hopper2SumBack = TradeCounter.Hopper2Sum;                      
5057   2                              TradeCounter.Hopper2SumID++;
5058   2                  TradeCounter.Hopper3SumBack = TradeCounter.Hopper3Sum;                      
5059   2                              TradeCounter.Hopper3SumID++;
5060   2                      }
5061   2                      else if(testDev == 2)
5062   2                      {
5063   2                              TradeCounter.CashSumBack = TradeCounter.CashSum;                        
5064   2                              TradeCounter.CashSumID++;
5065   2                      }    
5066   2                      */
5067   2              SaveTradeParam();//by gzz 20110610
5068   2          }
5069   1              else
5070   1              {
5071   2                      #ifdef _CHINA_                    
5072   2                          len = sprintf( str, "%s失败!", DevStr );
5073   2                      DisplayStr( 0, 0, 1, str, len ); 
5074   2                              ClearDisplayLine( 2 );  
5075   2                      #else           
                                      DisplayStr( 0, 0, 1, "Operate fail!", 13 );    
                                      ClearDisplayLine( 2 );
                              #endif
5079   2              }
5080   1          WaitForWork( 3000, NULL );          
5081   1              return 0;
5082   1        
5083   1      }
5084          
5085          unsigned char VPSynGoodsCol( void )
5086          {   
5087   1          u_char xdata i = 0;
5088   1              u_char xdata key = 0;
5089   1          u_char xdata flag = 0;
5090   1      
5091   1              if(sysVPMission.offLineFlag == 1)
5092   1              {       
5093   2                      #ifdef _CHINA_
5094   2                              DisplayStr( 0, 0, 1, "    同步失败", 12 ); 
5095   2                              DisplayStr( 0, 1, 1, "                    ", 20 );      
5096   2                      #else           
                                      DisplayStr( 0, 0, 1, "   Fail", 7 ); 
                                      DisplayStr( 0, 1, 1, "                    ", 20 );      
                              #endif
5100   2                      WaitForWork( 2000, NULL );
5101   2                      changeFailedBeep();     
5102   2                      return VP_ERR_NULL;
5103   2              }
5104   1      #ifdef _CHINA_
5105   1              DisplayStr( 0, 0, 1, "    你确定同步吗?", 17 );   
5106   1              DisplayStr( 0, 1, 1, "确定ENTER 取消CANCEL", 20 );      
5107   1      #else           
                      DisplayStr( 0, 0, 1, "   Are you sure ?", 17 );  
                      DisplayStr( 0, 1, 1, "   ENTER   CANCEL", 17 ); 
              #endif
5111   1                                                                                                              
5112   1              while( 1 )
5113   1              {
5114   2                      key = GetKey();
5115   2                      if( ( key == KEY_CANCEL ) || (key == KEY_SUBMIT) )
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 84  

5116   2                              break;
5117   2                      WaitForWork( 100, NULL );       
5118   2                      if(sysVPMission.msActTimer == 0)
5119   2                      {
5120   3                              sysVPMission.msActTimer = 100;
5121   3                              VPMission_Act_RPT(VP_ACT_ADMIN,VP_ACT_ENTERADMIN);
5122   3                      }
5123   2              }
5124   1              if( key == KEY_CANCEL ) return 0;
5125   1              
5126   1              //Display the message
5127   1      #ifdef _CHINA_
5128   1              DisplayStr( 0, 0, 1, "\xd5\xfd在同步, 请稍等...", 19 );    
5129   1              ClearDisplayLine( 2 );  
5130   1      #else           
                      DisplayStr( 0, 0, 1, "Please waiting...", 17 );    
                      ClearDisplayLine( 2 );
              #endif
5134   1          WaitForWork( 1000, NULL );
5135   1      
5136   1              /*
5137   1          flag = VPMission_Admin_RPT( VP_ADMIN_GOODSCOLUMN, 0, 0);
5138   1          if( flag != VP_ERR_NULL )
5139   1          {
5140   1              #ifdef _CHINA_
5141   1                              DisplayStr( 0, 0, 1, "操作失败!", 9 );    
5142   1                              ClearDisplayLine( 2 );  
5143   1                      #else           
5144   1                              DisplayStr( 0, 0, 1, "Operate fail!", 13 );    
5145   1                              ClearDisplayLine( 2 );
5146   1                      #endif
5147   1                  WaitForWork( 2000, NULL );          
5148   1                  return 0;   
5149   1          }
5150   1          */
5151   1      
5152   1          while( 1 )
5153   1              {
5154   2                       flag = VPMission_Admin_RPT( VP_ADMIN_GOODSCOLUMN, 0, 0);
5155   2                       if( flag == VP_ACK )  break;
5156   2                       //if(flag == VP_NAK)
5157   2                       //     changeFailedBeep();
5158   2               WaitForWork( 800, NULL );
5159   2              }
5160   1              /*
5161   1          //sysVPMission.requestFlag = 1;
5162   1              //VPMission_Request(1);
5163   1          sysVPMission.sysStatus &= ~VPM_STA_COLUMNPAR;
5164   1          sysVPMission.sysStatus &= ~VPM_STA_GOODSPAR;
5165   1          while( 1 )
5166   1          {
5167   1                      VPMission_Poll();
5168   1                      if( (sysVPMission.sysStatus & VPM_STA_GOODSPAR)&&(sysVPMission.sysStatus & VPM_STA_COLUMNPAR) )
5169   1                  {
5170   1                              VP_Update_ColumnGoodsPar();
5171   1                              break;
5172   1                  }
5173   1              WaitForWork( 500, NULL );
5174   1              }
5175   1          GoodsSetSave = 1;
5176   1          */
5177   1      #ifdef _CHINA_
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 85  

5178   1              DisplayStr( 0, 0, 1, "同步操作成功!", 13 );    
5179   1              ClearDisplayLine( 2 );  
5180   1      #else           
                      DisplayStr( 0, 0, 1, "Operate successfully", 20 );    
                      ClearDisplayLine( 2 );
              #endif
5184   1          WaitForWork( 2000, NULL );          
5185   1              return 0;
5186   1      
5187   1      }
5188          
5189          unsigned char VPBuhuoCol( void )
5190          {  
5191   1              u_char xdata i    = 0;
5192   1              u_char xdata key  = 0;
5193   1              u_char xdata flag = 0;
5194   1              
5195   1      
5196   1      #ifdef _CHINA_
5197   1              DisplayStr( 0, 0, 1, "    你确定补货吗?", 17 );   
5198   1              DisplayStr( 0, 1, 1, "确定ENTER 取消CANCEL", 20 );      
5199   1      #else           
                      DisplayStr( 0, 0, 1, "   Are you sure ?", 17 );  
                      DisplayStr( 0, 1, 1, "   ENTER   CANCEL", 17 ); 
              #endif
5203   1                                                                                                      
5204   1              while( 1 )
5205   1              {
5206   2                      key = GetKey();
5207   2                      if( ( key == KEY_CANCEL ) || (key == KEY_SUBMIT) )
5208   2                              break;
5209   2                      WaitForWork( 100, NULL );       
5210   2                      if(sysVPMission.msActTimer == 0)
5211   2                      {
5212   3                              sysVPMission.msActTimer = 100;
5213   3                              VPMission_Act_RPT(VP_ACT_ADMIN,VP_ACT_ENTERADMIN);
5214   3                      }
5215   2              }
5216   1              if( key == KEY_CANCEL ) return 0;
5217   1              
5218   1              //Display the message
5219   1      #ifdef _CHINA_
5220   1              DisplayStr( 0, 0, 1, "\xd5\xfd在补货, 请稍等...", 19 );    
5221   1              ClearDisplayLine( 2 );  
5222   1      #else           
                      DisplayStr( 0, 0, 1, "Please waiting...", 17 );    
                      ClearDisplayLine( 2 );
              #endif
5226   1          WaitForWork( 1000, NULL );          
5227   1              while( 1 )
5228   1              {               
5229   2                      
5230   2                      flag = VPMission_Admin_RPT( VP_ADMIN_GOODSBUHUO, 0, 0 );
5231   2                      
5232   2                      if( (flag==VP_ERR_NULL)||(flag==VP_ACK)||(flag==VP_NAK) ) break;
5233   2                      if( flag == VP_ERR_COM ) break;
5234   2                      WaitForWork( 500, NULL );
5235   2              }
5236   1      
5237   1              if( flag == VP_ERR_COM )
5238   1              {
5239   2                      changeFailedBeep();
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 86  

5240   2              #ifdef _CHINA_
5241   2                      DisplayStr( 0, 0, 1, "补货操作失败!", 13 );    
5242   2                      ClearDisplayLine( 2 );  
5243   2              #else           
                              DisplayStr( 0, 0, 1, "Operate successfully", 20 );    
                              ClearDisplayLine( 2 );
                      #endif
5247   2              }
5248   1              else if( sysVPMission.receive.msgType == VP_ACK )
5249   1              {
5250   2                      WaitForWork( 500, NULL );
5251   2                      VPMission_Status_RPT();
5252   2                      WaitForWork( 500, NULL );
5253   2                      VPMission_Info_RPT( VP_INFO_CHUHUO);
5254   2              #ifdef _CHINA_
5255   2                      DisplayStr( 0, 0, 1, "补货操作成功!", 13 );    
5256   2                      ClearDisplayLine( 2 );  
5257   2              #else           
                              DisplayStr( 0, 0, 1, "Operate successfully", 20 );    
                              ClearDisplayLine( 2 );
                      #endif          
5261   2              }
5262   1              else
5263   1              {
5264   2              #ifdef _CHINA_
5265   2                      DisplayStr( 0, 0, 1, "补货操作失败!", 13 );    
5266   2                      ClearDisplayLine( 2 );  
5267   2              #else           
                              DisplayStr( 0, 0, 1, "Operate successfully", 20 );    
                              ClearDisplayLine( 2 );
                      #endif
5271   2              }
5272   1              WaitForWork( 3000, NULL );              
5273   1              return 0;
5274   1        
5275   1      }
5276          
5277          
5278          
5279          unsigned char VPCountCoin( unsigned char hopperNum )
5280          {   
5281   1          u_char xdata i = 0;
5282   1              u_char xdata key = 0;
5283   1          u_char xdata flag = 0;
5284   1              u_char xdata ret = 0;
5285   1              u_char xdata coin1flag = 0; 
5286   1          u_int  xdata coinNum   = 0;
5287   1          u_int  xdata coinMoney = 0;
5288   1          u_int  xdata coinPrice = 0;
5289   1              u_char xdata str[20];
5290   1              u_char xdata len = 0;
5291   1          struct DEVICE xdata *HopperDev;
5292   1          u_char xdata *devHopperSta;
5293   1      
5294   1              //if( !((hopperNum>=1)&&(hopperNum<=2)) )  return 0;
5295   1          
5296   1              if( hopperNum == 1 )
5297   1              {
5298   2                      HopperDev = &Hopper1;
5299   2              coinPrice = SystemParameter.HopperCoinPrice1;
5300   2              devHopperSta = &DeviceStatus.ChangeUnit1;       
5301   2              }
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 87  

5302   1              else if( hopperNum == 2 )
5303   1              {
5304   2                  HopperDev = &Hopper2;
5305   2              coinPrice = SystemParameter.HopperCoinPrice2;
5306   2              devHopperSta = &DeviceStatus.ChangeUnit1;       
5307   2              }
5308   1              else
5309   1              {
5310   2                      return 0;
5311   2              }
5312   1      
5313   1      #ifdef _CHINA_
5314   1              DisplayStr( 0, 0, 1, "  你确定清点吗?", 15 );   
5315   1              DisplayStr( 0, 1, 1, "确定ENTER 取消CANCEL", 20 );      
5316   1      #else           
                      DisplayStr( 0, 0, 1, "   Are you sure?", 16 );  
                      DisplayStr( 0, 1, 1, "   ENTER   CANCEL", 17 ); 
              #endif
5320   1                                                                                                              
5321   1              while( 1 )
5322   1              {
5323   2                      key = GetKey();
5324   2                      if( ( key == KEY_CANCEL ) || (key == KEY_SUBMIT) )
5325   2                              break;
5326   2                      WaitForWork( 100, NULL );       
5327   2              }
5328   1              if( key == KEY_CANCEL ) return 0;
5329   1              
5330   1              //Display the message
5331   1      #ifdef _CHINA_
5332   1              DisplayStr( 0, 0, 1, "\xd5\xfd在清点, 请稍等...", 19 );    
5333   1              ClearDisplayLine( 2 );  
5334   1      #else           
                      DisplayStr( 0, 0, 1, "Please waiting...", 17 );    
                      ClearDisplayLine( 2 );
              #endif
5338   1          //WaitForWork( 1000, NULL );
5339   1          if( HopperOutCoin( 1000, hopperNum, HopperDev ) == 0 )              
5340   1              {   
5341   2              WaitForWork( 1000, NULL );
5342   2                      //查询出币结果  
5343   2                      ret = 0;
5344   2                      while( ret < 2 )
5345   2                      {
5346   3                              if( GetHardWareDeviceState( hopperNum, HopperDev ) != 1 ) //更新状态成功
5347   3                              {
5348   4                                      if( HopperDev->State &  0x50 )   //红外线传感有问题或系统故障
5349   4                                              coin1flag |= 4;              //硬件故障                 
5350   4                                      if( HopperDev->State &  0x20 )   //实际无币或光测无币
5351   4                                              coin1flag |= 2;              //币不足
5352   4                                      //--------------------------------------------------------
5353   4                                      if( HopperDev->State & 0x08 )    //Empty
5354   4                                          coin1flag |= 8;
5355   4                                      //========================================================
5356   4                                      coinNum = HopperGetCoinOut( hopperNum );
5357   4                      coinMoney = coinNum*coinPrice;
5358   4                                      Trace( "\n outMoney1 = %d", coinNum );          
5359   4                                      ret = 0;
5360   4                                      break;
5361   4                              }
5362   3                              else    //查询状态超时
5363   3                              {
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 88  

5364   4                                      ret++;
5365   4                                      WaitForWork( 1000, NULL );      
5366   4                              }
5367   3                      }
5368   2                      if( ret >= 2 )  coin1flag |= 4;
5369   2              }
5370   1              else
5371   1              {
5372   2                      coin1flag |= 4;
5373   2              }
5374   1      
5375   1          //update the hopper status
5376   1          for( i = 0; i < 3; i ++ )
5377   1              {
5378   2                      if( HopperSetList[i].HopperIndex == hopperNum)                                  
5379   2                      {
5380   3                              if( coin1flag & 4 )     
5381   3                              {
5382   4                                      //DeviceStatus.ChangeUnit1 = 1;
5383   4                      *devHopperSta = 1;
5384   4                                      HopperSetList[i].HopperState = 2;
5385   4                              }
5386   3                              else if( coin1flag & 8 )                 //Empty
5387   3                              {
5388   4                                  //DeviceStatus.ChangeUnit1 = 4;      //Empty
5389   4                      *devHopperSta = 4;
5390   4                                      HopperSetList[i].HopperState = 2;
5391   4                              }
5392   3                              else if( coin1flag & 2 ) 
5393   3                              {
5394   4                                      //DeviceStatus.ChangeUnit1 = 2;
5395   4                      *devHopperSta = 2; 
5396   4                                      HopperSetList[i].HopperState = 2;
5397   4                              }
5398   3                              break;
5399   3                      }                       
5400   2              }
5401   1      
5402   1              //display the counting result           
5403   1      #ifdef _CHINA_
5404   1              DisplayStr( 0, 0, 1, "清点完毕，请核对!", 17 );
5405   1              //DisplayStr( 0, 1, 1, "硬币金额: ", 10 );
5406   1      #else
                      DisplayStr( 0, 0, 1, "Pls check the result", 20 );
                      //DisplayStr( 0, 1, 1, "Coin:", 5 );
              #endif
5410   1                      
5411   1          //if( flag == 1 )
5412   1              {       
5413   2                      switch( SystemParameter.curUnit )
5414   2                      {
5415   3                              case 1:
5416   3                      #ifdef _CHINA_
5417   3                                      len = sprintf( str, "清点金额: %u", coinMoney );        
5418   3                      #else
                                              len = sprintf( str, "Payout: %u", coinMoney );          
                              #endif  
5421   3                              break;                          
5422   3                              case 10:
5423   3                      #ifdef _CHINA_
5424   3                                      len = sprintf( str, "清点金额: %u.%u", coinMoney/SystemParameter.curUnit, coinMoney%SystemParameter.cu
             -rUnit );        
CX51 COMPILER V7.50   VMC_PC                                                               10/23/2014 09:48:33 PAGE 89  

5425   3                      #else
                                              len = sprintf( str, "Payout: %u.%u", coinMoney/SystemParameter.curUnit, coinMoney%SystemParameter.curU
             -nit );                
                              #endif  
5428   3                              break;
5429   3                              case 100:
5430   3                      #ifdef _CHINA_
5431   3                                      len = sprintf( str, "清点金额: %u.%02u", coinMoney/SystemParameter.curUnit, coinMoney%SystemParameter.
             -curUnit );        
5432   3                      #else
                                              len = sprintf( str, "Payout: %u.%02u", coinMoney/SystemParameter.curUnit, coinMoney%SystemParameter.cu
             -rUnit );                
                              #endif  
5435   3                              break;
5436   3                              default:
5437   3                                      len = 0;
5438   3                                      memset( str, 0, sizeof( str ) );
5439   3                              break;
5440   3                      }
5441   2                      if( len != 0 )
5442   2                      {
5443   3                              DisplayStr( 0, 1, 1, str, len );
5444   3                      }
5445   2              }
5446   1          //
5447   1              while( 1 )
5448   1              {
5449   2                      key = GetKey();         
5450   2                      if( ( key  == KEY_SUBMIT ) || ( key  == KEY_CANCEL ) )
5451   2                  {
5452   3                              break;
5453   3                  }
5454   2          }
5455   1              return 0;
5456   1      }
5457          
5458          
5459          
5460          
5461          
5462          
5463          
5464          
5465          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =  19282    ----
   CONSTANT SIZE    =    661    ----
   XDATA SIZE       =    927     306
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      17
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


CX51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
